"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DebugStack = void 0;
const path = __importStar(require("path"));
const cdk = __importStar(require("aws-cdk-lib"));
const s3 = __importStar(require("aws-cdk-lib/aws-s3"));
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const logs = __importStar(require("aws-cdk-lib/aws-logs"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const apig = __importStar(require("aws-cdk-lib/aws-apigatewayv2"));
const dynamodb = __importStar(require("aws-cdk-lib/aws-dynamodb"));
/**
 * The `DebugStack` construct is used internally to create the resources needed to power [Live Lambda Development](../live-lambda-development). Note that, the `DebugStack` construct should only be created inside the [`DebugApp`](DebugApp).
 *
 * It extends [`cdk.Stack`](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.Stack.html). It automatically prefixes the stack names with the stage and app name to ensure that they can be deployed to multiple regions in the same AWS account. It also ensures that the stack uses the same AWS profile and region as the app.
 *
 * @example
 */
class DebugStack extends cdk.Stack {
    constructor(scope, id, props) {
        const app = scope.node.root;
        const stackId = app.logicalPrefixedName(id);
        DebugStack.checkForEnvInProps(id, props);
        super(scope, stackId, Object.assign(Object.assign({}, props), { env: {
                account: app.account,
                region: app.region,
            } }));
        this.stage = app.stage;
        // Create connection table
        this.table = new dynamodb.Table(this, "Table", {
            partitionKey: { name: "pk", type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // Create S3 bucket for storing large payloads
        this.bucket = (props === null || props === void 0 ? void 0 : props.payloadBucketArn)
            ? s3.Bucket.fromBucketArn(this, "Bucket", props.payloadBucketArn)
            : new s3.Bucket(this, "Bucket", {
                lifecycleRules: [
                    {
                        expiration: cdk.Duration.days(1),
                        prefix: "payloads/",
                    },
                ],
                encryption: s3.BucketEncryption.S3_MANAGED,
                removalPolicy: cdk.RemovalPolicy.DESTROY,
                autoDeleteObjects: true,
                blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,
            });
        // Create API
        this.api = new apig.CfnApi(this, "Api", {
            name: `${this.stackName}-api`,
            protocolType: "WEBSOCKET",
            routeSelectionExpression: "$request.body.action",
        });
        new apig.CfnStage(this, "ApiStage", {
            apiId: this.api.ref,
            autoDeploy: true,
            stageName: this.stage,
        });
        // Create API routes
        const role = (props === null || props === void 0 ? void 0 : props.websocketHandlerRoleArn)
            ? iam.Role.fromRoleArn(this, "HandlerRole", props.websocketHandlerRoleArn)
            : undefined;
        this.addApiRoute("Connect", "$connect", "wsConnect.main", role);
        this.addApiRoute("Disconnect", "$disconnect", "wsDisconnect.main", role);
        this.addApiRoute("Default", "$default", "wsDefault.main", role);
        // Stack Output
        new cdk.CfnOutput(this, "Endpoint", {
            value: `${this.api.attrApiEndpoint}/${this.stage}`,
        });
        new cdk.CfnOutput(this, "BucketArn", {
            value: this.bucket.bucketArn,
        });
        new cdk.CfnOutput(this, "BucketName", {
            value: this.bucket.bucketName,
        });
    }
    addApiRoute(id, routeKey, handler, role) {
        // Create execution policy
        const policyStatement = new iam.PolicyStatement();
        policyStatement.addAllResources();
        policyStatement.addActions("apigateway:*", "dynamodb:*", "execute-api:ManageConnections");
        // Create Lambda
        const lambdaFunc = new lambda.Function(this, id, {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/DebugStack")),
            handler,
            runtime: lambda.Runtime.NODEJS_12_X,
            timeout: cdk.Duration.seconds(10),
            memorySize: 256,
            logRetention: logs.RetentionDays.ONE_WEEK,
            logRetentionRole: role,
            environment: {
                TABLE_NAME: this.table.tableName,
            },
            role,
            initialPolicy: [policyStatement],
        });
        lambdaFunc.addPermission(`${id}Permission`, {
            principal: new iam.ServicePrincipal("apigateway.amazonaws.com"),
        });
        // Create API integrations
        const integration = new apig.CfnIntegration(this, `${id}Integration`, {
            apiId: this.api.ref,
            integrationType: "AWS_PROXY",
            integrationUri: `arn:${this.partition}:apigateway:${this.region}:lambda:path/2015-03-31/functions/${lambdaFunc.functionArn}/invocations`,
        });
        // Create API routes
        new apig.CfnRoute(this, `${id}Route`, {
            apiId: this.api.ref,
            routeKey,
            authorizationType: "NONE",
            target: `integrations/${integration.ref}`,
        });
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    static checkForEnvInProps(id, props) {
        if (props && props.env) {
            let envS = "";
            try {
                envS = " (" + JSON.stringify(props.env) + ")";
            }
            catch (e) {
                // Ignore
            }
            throw new Error(`Do not set the "env" prop while initializing "${id}" stack${envS}. Use the "AWS_PROFILE" environment variable and "--region" CLI option instead.`);
        }
    }
}
exports.DebugStack = DebugStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGVidWdTdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9EZWJ1Z1N0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQTZCO0FBRTdCLGlEQUFtQztBQUNuQyx1REFBeUM7QUFDekMseURBQTJDO0FBQzNDLDJEQUE2QztBQUM3QywrREFBaUQ7QUFDakQsbUVBQXFEO0FBQ3JELG1FQUFxRDtBQWlCckQ7Ozs7OztHQU1HO0FBQ0gsTUFBYSxVQUFXLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFNdkMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUF1QjtRQUMvRCxNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQWdCLENBQUM7UUFDeEMsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLG1CQUFtQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRTVDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFekMsS0FBSyxDQUFDLEtBQUssRUFBRSxPQUFPLGtDQUNmLEtBQUssS0FDUixHQUFHLEVBQUU7Z0JBQ0gsT0FBTyxFQUFFLEdBQUcsQ0FBQyxPQUFPO2dCQUNwQixNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU07YUFDbkIsSUFDRCxDQUFDO1FBRUgsSUFBSSxDQUFDLEtBQUssR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDO1FBRXZCLDBCQUEwQjtRQUMxQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFO1lBQzdDLFlBQVksRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFO1lBQ2pFLFdBQVcsRUFBRSxRQUFRLENBQUMsV0FBVyxDQUFDLGVBQWU7WUFDakQsYUFBYSxFQUFFLEdBQUcsQ0FBQyxhQUFhLENBQUMsT0FBTztTQUN6QyxDQUFDLENBQUM7UUFFSCw4Q0FBOEM7UUFDOUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFBLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxnQkFBZ0I7WUFDbkMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLGdCQUFnQixDQUFDO1lBQ2pFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRTtnQkFDNUIsY0FBYyxFQUFFO29CQUNkO3dCQUNFLFVBQVUsRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7d0JBQ2hDLE1BQU0sRUFBRSxXQUFXO3FCQUNwQjtpQkFDRjtnQkFDRCxVQUFVLEVBQUUsRUFBRSxDQUFDLGdCQUFnQixDQUFDLFVBQVU7Z0JBQzFDLGFBQWEsRUFBRSxHQUFHLENBQUMsYUFBYSxDQUFDLE9BQU87Z0JBQ3hDLGlCQUFpQixFQUFFLElBQUk7Z0JBQ3ZCLGlCQUFpQixFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTO2FBQ2xELENBQUMsQ0FBQztRQUVQLGFBQWE7UUFDYixJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFO1lBQ3RDLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTLE1BQU07WUFDN0IsWUFBWSxFQUFFLFdBQVc7WUFDekIsd0JBQXdCLEVBQUUsc0JBQXNCO1NBQ2pELENBQUMsQ0FBQztRQUNILElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsVUFBVSxFQUFFO1lBQ2xDLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUc7WUFDbkIsVUFBVSxFQUFFLElBQUk7WUFDaEIsU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLO1NBQ3RCLENBQUMsQ0FBQztRQUVILG9CQUFvQjtRQUNwQixNQUFNLElBQUksR0FBRyxDQUFBLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSx1QkFBdUI7WUFDekMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxhQUFhLEVBQUUsS0FBSyxDQUFDLHVCQUF1QixDQUFDO1lBQzFFLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDZCxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsYUFBYSxFQUFFLG1CQUFtQixFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3pFLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVoRSxlQUFlO1FBQ2YsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxVQUFVLEVBQUU7WUFDbEMsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtTQUNuRCxDQUFDLENBQUM7UUFDSCxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRTtZQUNuQyxLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTO1NBQzdCLENBQUMsQ0FBQztRQUNILElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsWUFBWSxFQUFFO1lBQ3BDLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVU7U0FDOUIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLFdBQVcsQ0FDakIsRUFBVSxFQUNWLFFBQWdCLEVBQ2hCLE9BQWUsRUFDZixJQUFnQjtRQUVoQiwwQkFBMEI7UUFDMUIsTUFBTSxlQUFlLEdBQUcsSUFBSSxHQUFHLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDbEQsZUFBZSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ2xDLGVBQWUsQ0FBQyxVQUFVLENBQ3hCLGNBQWMsRUFDZCxZQUFZLEVBQ1osK0JBQStCLENBQ2hDLENBQUM7UUFFRixnQkFBZ0I7UUFDaEIsTUFBTSxVQUFVLEdBQUcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFLEVBQUU7WUFDL0MsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLHNCQUFzQixDQUFDLENBQUM7WUFDekUsT0FBTztZQUNQLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7WUFDbkMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUNqQyxVQUFVLEVBQUUsR0FBRztZQUNmLFlBQVksRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVE7WUFDekMsZ0JBQWdCLEVBQUUsSUFBSTtZQUN0QixXQUFXLEVBQUU7Z0JBQ1gsVUFBVSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUzthQUNqQztZQUNELElBQUk7WUFDSixhQUFhLEVBQUUsQ0FBQyxlQUFlLENBQUM7U0FDakMsQ0FBQyxDQUFDO1FBQ0gsVUFBVSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsWUFBWSxFQUFFO1lBQzFDLFNBQVMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQywwQkFBMEIsQ0FBQztTQUNoRSxDQUFDLENBQUM7UUFFSCwwQkFBMEI7UUFDMUIsTUFBTSxXQUFXLEdBQUcsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsYUFBYSxFQUFFO1lBQ3BFLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUc7WUFDbkIsZUFBZSxFQUFFLFdBQVc7WUFDNUIsY0FBYyxFQUFFLE9BQU8sSUFBSSxDQUFDLFNBQVMsZUFBZSxJQUFJLENBQUMsTUFBTSxxQ0FBcUMsVUFBVSxDQUFDLFdBQVcsY0FBYztTQUN6SSxDQUFDLENBQUM7UUFFSCxvQkFBb0I7UUFDcEIsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFO1lBQ3BDLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUc7WUFDbkIsUUFBUTtZQUNSLGlCQUFpQixFQUFFLE1BQU07WUFDekIsTUFBTSxFQUFFLGdCQUFnQixXQUFXLENBQUMsR0FBRyxFQUFFO1NBQzFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCw4REFBOEQ7SUFDdEQsTUFBTSxDQUFDLGtCQUFrQixDQUFDLEVBQVUsRUFBRSxLQUFXO1FBQ3ZELElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxHQUFHLEVBQUU7WUFDdEIsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDO1lBRWQsSUFBSTtnQkFDRixJQUFJLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQzthQUMvQztZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNWLFNBQVM7YUFDVjtZQUVELE1BQU0sSUFBSSxLQUFLLENBQ2IsaURBQWlELEVBQUUsVUFBVSxJQUFJLGlGQUFpRixDQUNuSixDQUFDO1NBQ0g7SUFDSCxDQUFDO0NBQ0Y7QUEvSUQsZ0NBK0lDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCAqIGFzIGNkayBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCAqIGFzIHMzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtczNcIjtcbmltcG9ydCAqIGFzIGlhbSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xuaW1wb3J0ICogYXMgbG9ncyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxvZ3NcIjtcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYVwiO1xuaW1wb3J0ICogYXMgYXBpZyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWFwaWdhdGV3YXl2MlwiO1xuaW1wb3J0ICogYXMgZHluYW1vZGIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1keW5hbW9kYlwiO1xuaW1wb3J0IHsgRGVidWdBcHAgfSBmcm9tIFwiLi9EZWJ1Z0FwcFwiO1xuXG4vKipcbiAqIFN0YWNrIHByb3BlcnRpZXMgZm9yIHRoZSBEZWJ1Z1N0YWNrLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIERlYnVnU3RhY2tQcm9wcyBleHRlbmRzIGNkay5TdGFja1Byb3BzIHtcbiAgLyoqXG4gICAqIFMzIGJ1Y2tldCB0byBzdG9yZSBsYXJnZSB3ZWJzb2NrZXQgcGF5bG9hZHMuXG4gICAqL1xuICBwYXlsb2FkQnVja2V0QXJuPzogc3RyaW5nO1xuICAvKipcbiAgICogTGFtYmRhIGZ1bmN0aW9uIHByb3BzIGZvciBXZWJTb2NrZXQgcmVxdWVzdCBoYW5kbGVycy5cbiAgICovXG4gIHdlYnNvY2tldEhhbmRsZXJSb2xlQXJuPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIFRoZSBgRGVidWdTdGFja2AgY29uc3RydWN0IGlzIHVzZWQgaW50ZXJuYWxseSB0byBjcmVhdGUgdGhlIHJlc291cmNlcyBuZWVkZWQgdG8gcG93ZXIgW0xpdmUgTGFtYmRhIERldmVsb3BtZW50XSguLi9saXZlLWxhbWJkYS1kZXZlbG9wbWVudCkuIE5vdGUgdGhhdCwgdGhlIGBEZWJ1Z1N0YWNrYCBjb25zdHJ1Y3Qgc2hvdWxkIG9ubHkgYmUgY3JlYXRlZCBpbnNpZGUgdGhlIFtgRGVidWdBcHBgXShEZWJ1Z0FwcCkuXG4gKlxuICogSXQgZXh0ZW5kcyBbYGNkay5TdGFja2BdKGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9jZGsvYXBpL3YyL2RvY3MvYXdzLWNkay1saWIuU3RhY2suaHRtbCkuIEl0IGF1dG9tYXRpY2FsbHkgcHJlZml4ZXMgdGhlIHN0YWNrIG5hbWVzIHdpdGggdGhlIHN0YWdlIGFuZCBhcHAgbmFtZSB0byBlbnN1cmUgdGhhdCB0aGV5IGNhbiBiZSBkZXBsb3llZCB0byBtdWx0aXBsZSByZWdpb25zIGluIHRoZSBzYW1lIEFXUyBhY2NvdW50LiBJdCBhbHNvIGVuc3VyZXMgdGhhdCB0aGUgc3RhY2sgdXNlcyB0aGUgc2FtZSBBV1MgcHJvZmlsZSBhbmQgcmVnaW9uIGFzIHRoZSBhcHAuXG4gKlxuICogQGV4YW1wbGVcbiAqL1xuZXhwb3J0IGNsYXNzIERlYnVnU3RhY2sgZXh0ZW5kcyBjZGsuU3RhY2sge1xuICBwdWJsaWMgcmVhZG9ubHkgc3RhZ2U6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBhcGk6IGFwaWcuQ2ZuQXBpO1xuICBwcml2YXRlIHJlYWRvbmx5IHRhYmxlOiBkeW5hbW9kYi5UYWJsZTtcbiAgcHJpdmF0ZSByZWFkb25seSBidWNrZXQ6IHMzLklCdWNrZXQ7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBEZWJ1Z1N0YWNrUHJvcHMpIHtcbiAgICBjb25zdCBhcHAgPSBzY29wZS5ub2RlLnJvb3QgYXMgRGVidWdBcHA7XG4gICAgY29uc3Qgc3RhY2tJZCA9IGFwcC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKTtcblxuICAgIERlYnVnU3RhY2suY2hlY2tGb3JFbnZJblByb3BzKGlkLCBwcm9wcyk7XG5cbiAgICBzdXBlcihzY29wZSwgc3RhY2tJZCwge1xuICAgICAgLi4ucHJvcHMsXG4gICAgICBlbnY6IHtcbiAgICAgICAgYWNjb3VudDogYXBwLmFjY291bnQsXG4gICAgICAgIHJlZ2lvbjogYXBwLnJlZ2lvbixcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICB0aGlzLnN0YWdlID0gYXBwLnN0YWdlO1xuXG4gICAgLy8gQ3JlYXRlIGNvbm5lY3Rpb24gdGFibGVcbiAgICB0aGlzLnRhYmxlID0gbmV3IGR5bmFtb2RiLlRhYmxlKHRoaXMsIFwiVGFibGVcIiwge1xuICAgICAgcGFydGl0aW9uS2V5OiB7IG5hbWU6IFwicGtcIiwgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcgfSxcbiAgICAgIGJpbGxpbmdNb2RlOiBkeW5hbW9kYi5CaWxsaW5nTW9kZS5QQVlfUEVSX1JFUVVFU1QsXG4gICAgICByZW1vdmFsUG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgIH0pO1xuXG4gICAgLy8gQ3JlYXRlIFMzIGJ1Y2tldCBmb3Igc3RvcmluZyBsYXJnZSBwYXlsb2Fkc1xuICAgIHRoaXMuYnVja2V0ID0gcHJvcHM/LnBheWxvYWRCdWNrZXRBcm5cbiAgICAgID8gczMuQnVja2V0LmZyb21CdWNrZXRBcm4odGhpcywgXCJCdWNrZXRcIiwgcHJvcHMucGF5bG9hZEJ1Y2tldEFybilcbiAgICAgIDogbmV3IHMzLkJ1Y2tldCh0aGlzLCBcIkJ1Y2tldFwiLCB7XG4gICAgICAgICAgbGlmZWN5Y2xlUnVsZXM6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgZXhwaXJhdGlvbjogY2RrLkR1cmF0aW9uLmRheXMoMSksXG4gICAgICAgICAgICAgIHByZWZpeDogXCJwYXlsb2Fkcy9cIixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgICBlbmNyeXB0aW9uOiBzMy5CdWNrZXRFbmNyeXB0aW9uLlMzX01BTkFHRUQsXG4gICAgICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICAgICAgICBhdXRvRGVsZXRlT2JqZWN0czogdHJ1ZSxcbiAgICAgICAgICBibG9ja1B1YmxpY0FjY2VzczogczMuQmxvY2tQdWJsaWNBY2Nlc3MuQkxPQ0tfQUxMLFxuICAgICAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBBUElcbiAgICB0aGlzLmFwaSA9IG5ldyBhcGlnLkNmbkFwaSh0aGlzLCBcIkFwaVwiLCB7XG4gICAgICBuYW1lOiBgJHt0aGlzLnN0YWNrTmFtZX0tYXBpYCxcbiAgICAgIHByb3RvY29sVHlwZTogXCJXRUJTT0NLRVRcIixcbiAgICAgIHJvdXRlU2VsZWN0aW9uRXhwcmVzc2lvbjogXCIkcmVxdWVzdC5ib2R5LmFjdGlvblwiLFxuICAgIH0pO1xuICAgIG5ldyBhcGlnLkNmblN0YWdlKHRoaXMsIFwiQXBpU3RhZ2VcIiwge1xuICAgICAgYXBpSWQ6IHRoaXMuYXBpLnJlZixcbiAgICAgIGF1dG9EZXBsb3k6IHRydWUsXG4gICAgICBzdGFnZU5hbWU6IHRoaXMuc3RhZ2UsXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgQVBJIHJvdXRlc1xuICAgIGNvbnN0IHJvbGUgPSBwcm9wcz8ud2Vic29ja2V0SGFuZGxlclJvbGVBcm5cbiAgICAgID8gaWFtLlJvbGUuZnJvbVJvbGVBcm4odGhpcywgXCJIYW5kbGVyUm9sZVwiLCBwcm9wcy53ZWJzb2NrZXRIYW5kbGVyUm9sZUFybilcbiAgICAgIDogdW5kZWZpbmVkO1xuICAgIHRoaXMuYWRkQXBpUm91dGUoXCJDb25uZWN0XCIsIFwiJGNvbm5lY3RcIiwgXCJ3c0Nvbm5lY3QubWFpblwiLCByb2xlKTtcbiAgICB0aGlzLmFkZEFwaVJvdXRlKFwiRGlzY29ubmVjdFwiLCBcIiRkaXNjb25uZWN0XCIsIFwid3NEaXNjb25uZWN0Lm1haW5cIiwgcm9sZSk7XG4gICAgdGhpcy5hZGRBcGlSb3V0ZShcIkRlZmF1bHRcIiwgXCIkZGVmYXVsdFwiLCBcIndzRGVmYXVsdC5tYWluXCIsIHJvbGUpO1xuXG4gICAgLy8gU3RhY2sgT3V0cHV0XG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgXCJFbmRwb2ludFwiLCB7XG4gICAgICB2YWx1ZTogYCR7dGhpcy5hcGkuYXR0ckFwaUVuZHBvaW50fS8ke3RoaXMuc3RhZ2V9YCxcbiAgICB9KTtcbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCBcIkJ1Y2tldEFyblwiLCB7XG4gICAgICB2YWx1ZTogdGhpcy5idWNrZXQuYnVja2V0QXJuLFxuICAgIH0pO1xuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsIFwiQnVja2V0TmFtZVwiLCB7XG4gICAgICB2YWx1ZTogdGhpcy5idWNrZXQuYnVja2V0TmFtZSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkQXBpUm91dGUoXG4gICAgaWQ6IHN0cmluZyxcbiAgICByb3V0ZUtleTogc3RyaW5nLFxuICAgIGhhbmRsZXI6IHN0cmluZyxcbiAgICByb2xlPzogaWFtLklSb2xlXG4gICkge1xuICAgIC8vIENyZWF0ZSBleGVjdXRpb24gcG9saWN5XG4gICAgY29uc3QgcG9saWN5U3RhdGVtZW50ID0gbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoKTtcbiAgICBwb2xpY3lTdGF0ZW1lbnQuYWRkQWxsUmVzb3VyY2VzKCk7XG4gICAgcG9saWN5U3RhdGVtZW50LmFkZEFjdGlvbnMoXG4gICAgICBcImFwaWdhdGV3YXk6KlwiLFxuICAgICAgXCJkeW5hbW9kYjoqXCIsXG4gICAgICBcImV4ZWN1dGUtYXBpOk1hbmFnZUNvbm5lY3Rpb25zXCJcbiAgICApO1xuXG4gICAgLy8gQ3JlYXRlIExhbWJkYVxuICAgIGNvbnN0IGxhbWJkYUZ1bmMgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIGlkLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi9hc3NldHMvRGVidWdTdGFja1wiKSksXG4gICAgICBoYW5kbGVyLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzEyX1gsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcygxMCksXG4gICAgICBtZW1vcnlTaXplOiAyNTYsXG4gICAgICBsb2dSZXRlbnRpb246IGxvZ3MuUmV0ZW50aW9uRGF5cy5PTkVfV0VFSyxcbiAgICAgIGxvZ1JldGVudGlvblJvbGU6IHJvbGUsXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBUQUJMRV9OQU1FOiB0aGlzLnRhYmxlLnRhYmxlTmFtZSxcbiAgICAgIH0sXG4gICAgICByb2xlLFxuICAgICAgaW5pdGlhbFBvbGljeTogW3BvbGljeVN0YXRlbWVudF0sXG4gICAgfSk7XG4gICAgbGFtYmRhRnVuYy5hZGRQZXJtaXNzaW9uKGAke2lkfVBlcm1pc3Npb25gLCB7XG4gICAgICBwcmluY2lwYWw6IG5ldyBpYW0uU2VydmljZVByaW5jaXBhbChcImFwaWdhdGV3YXkuYW1hem9uYXdzLmNvbVwiKSxcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBBUEkgaW50ZWdyYXRpb25zXG4gICAgY29uc3QgaW50ZWdyYXRpb24gPSBuZXcgYXBpZy5DZm5JbnRlZ3JhdGlvbih0aGlzLCBgJHtpZH1JbnRlZ3JhdGlvbmAsIHtcbiAgICAgIGFwaUlkOiB0aGlzLmFwaS5yZWYsXG4gICAgICBpbnRlZ3JhdGlvblR5cGU6IFwiQVdTX1BST1hZXCIsXG4gICAgICBpbnRlZ3JhdGlvblVyaTogYGFybjoke3RoaXMucGFydGl0aW9ufTphcGlnYXRld2F5OiR7dGhpcy5yZWdpb259OmxhbWJkYTpwYXRoLzIwMTUtMDMtMzEvZnVuY3Rpb25zLyR7bGFtYmRhRnVuYy5mdW5jdGlvbkFybn0vaW52b2NhdGlvbnNgLFxuICAgIH0pO1xuXG4gICAgLy8gQ3JlYXRlIEFQSSByb3V0ZXNcbiAgICBuZXcgYXBpZy5DZm5Sb3V0ZSh0aGlzLCBgJHtpZH1Sb3V0ZWAsIHtcbiAgICAgIGFwaUlkOiB0aGlzLmFwaS5yZWYsXG4gICAgICByb3V0ZUtleSxcbiAgICAgIGF1dGhvcml6YXRpb25UeXBlOiBcIk5PTkVcIixcbiAgICAgIHRhcmdldDogYGludGVncmF0aW9ucy8ke2ludGVncmF0aW9uLnJlZn1gLFxuICAgIH0pO1xuICB9XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgcHJpdmF0ZSBzdGF0aWMgY2hlY2tGb3JFbnZJblByb3BzKGlkOiBzdHJpbmcsIHByb3BzPzogYW55KSB7XG4gICAgaWYgKHByb3BzICYmIHByb3BzLmVudikge1xuICAgICAgbGV0IGVudlMgPSBcIlwiO1xuXG4gICAgICB0cnkge1xuICAgICAgICBlbnZTID0gXCIgKFwiICsgSlNPTi5zdHJpbmdpZnkocHJvcHMuZW52KSArIFwiKVwiO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAvLyBJZ25vcmVcbiAgICAgIH1cblxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRG8gbm90IHNldCB0aGUgXCJlbnZcIiBwcm9wIHdoaWxlIGluaXRpYWxpemluZyBcIiR7aWR9XCIgc3RhY2ske2VudlN9LiBVc2UgdGhlIFwiQVdTX1BST0ZJTEVcIiBlbnZpcm9ubWVudCB2YXJpYWJsZSBhbmQgXCItLXJlZ2lvblwiIENMSSBvcHRpb24gaW5zdGVhZC5gXG4gICAgICApO1xuICAgIH1cbiAgfVxufVxuIl19