"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.cleanupLogGroupName = exports.buildAccessLogData = void 0;
const logs = __importStar(require("aws-cdk-lib/aws-logs"));
const apig = __importStar(require("@aws-cdk/aws-apigatewayv2-alpha"));
const defaultHttpFields = [
    // request info
    `"requestTime":"$context.requestTime"`,
    `"requestId":"$context.requestId"`,
    `"httpMethod":"$context.httpMethod"`,
    `"path":"$context.path"`,
    `"routeKey":"$context.routeKey"`,
    `"status":$context.status`,
    `"responseLatency":$context.responseLatency`,
    // integration info
    `"integrationRequestId":"$context.integration.requestId"`,
    `"integrationStatus":"$context.integration.status"`,
    `"integrationLatency":"$context.integration.latency"`,
    `"integrationServiceStatus":"$context.integration.integrationStatus"`,
    // caller info
    `"ip":"$context.identity.sourceIp"`,
    `"userAgent":"$context.identity.userAgent"`,
    `"cognitoIdentityId":"$context.identity.cognitoIdentityId"`,
];
const defaultWebSocketFields = [
    // request info
    `"requestTime":"$context.requestTime"`,
    `"requestId":"$context.requestId"`,
    `"eventType":"$context.eventType"`,
    `"routeKey":"$context.routeKey"`,
    `"status":$context.status`,
    // integration info
    `"integrationRequestId":"$context.awsEndpointRequestId"`,
    `"integrationStatus":"$context.integrationStatus"`,
    `"integrationLatency":"$context.integrationLatency"`,
    `"integrationServiceStatus":"$context.integration.integrationStatus"`,
    // caller info
    `"ip":"$context.identity.sourceIp"`,
    `"userAgent":"$context.identity.userAgent"`,
    `"cognitoIdentityId":"$context.identity.cognitoIdentityId"`,
    `"connectedAt":"$context.connectedAt"`,
    `"connectionId":"$context.connectionId"`,
];
function buildAccessLogData(scope, accessLog, apiStage, isDefaultStage) {
    if (accessLog === false) {
        return;
    }
    const isWebSocketApi = apiStage instanceof apig.WebSocketStage;
    // note: Access log configuration is not supported by L2 constructs as of CDK v1.85.0. We
    //       need to define it at L1 construct level.
    // create log group
    let logGroup;
    let destinationArn;
    if (accessLog && accessLog.destinationArn) {
        destinationArn = accessLog.destinationArn;
    }
    else {
        const root = scope.node.root;
        const apiName = root.logicalPrefixedName(scope.node.id);
        // Backwards compatibility, only suffix if not default stage
        const logGroupName = "LogGroup" + (isDefaultStage ? "" : apiStage.stageName);
        logGroup = new logs.LogGroup(scope, logGroupName, {
            logGroupName: [
                `/aws/vendedlogs/apis`,
                `/${cleanupLogGroupName(apiName)}-${apiStage.api.apiId}`,
                `/${cleanupLogGroupName(apiStage.stageName)}`,
            ].join(""),
            retention: buildLogGroupRetention(accessLog),
        });
        destinationArn = logGroup.logGroupArn;
    }
    // get log format
    let format;
    if (accessLog && accessLog.format) {
        format = accessLog.format;
    }
    else if (typeof accessLog === "string") {
        format = accessLog;
    }
    else {
        format = isWebSocketApi
            ? "{" + defaultWebSocketFields.join(",") + "}"
            : "{" + defaultHttpFields.join(",") + "}";
    }
    // get L1 cfnStage construct
    if (!(apiStage === null || apiStage === void 0 ? void 0 : apiStage.node.defaultChild)) {
        throw new Error(`Failed to define the default stage for Http API`);
    }
    // set access log settings
    const cfnStage = apiStage.node.defaultChild;
    cfnStage.accessLogSettings = { format, destinationArn };
    return logGroup;
}
exports.buildAccessLogData = buildAccessLogData;
function cleanupLogGroupName(str) {
    return str.replace(/[^.\-_/#A-Za-z0-9]/g, "");
}
exports.cleanupLogGroupName = cleanupLogGroupName;
function buildLogGroupRetention(accessLog) {
    const retention = accessLog && accessLog.retention;
    if (!retention) {
        return logs.RetentionDays.INFINITE;
    }
    // Case: retention is string
    const retentionValue = logs.RetentionDays[retention.toUpperCase()];
    // validate retention
    if (!retentionValue) {
        throw new Error(`Invalid access log retention value "${retention}".`);
    }
    return retentionValue;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpR2F0ZXdheVYyQWNjZXNzTG9nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWwvYXBpR2F0ZXdheVYyQWNjZXNzTG9nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQ0EsMkRBQTZDO0FBRTdDLHNFQUF3RDtBQVN4RCxNQUFNLGlCQUFpQixHQUFHO0lBQ3hCLGVBQWU7SUFDZixzQ0FBc0M7SUFDdEMsa0NBQWtDO0lBQ2xDLG9DQUFvQztJQUNwQyx3QkFBd0I7SUFDeEIsZ0NBQWdDO0lBQ2hDLDBCQUEwQjtJQUMxQiw0Q0FBNEM7SUFDNUMsbUJBQW1CO0lBQ25CLHlEQUF5RDtJQUN6RCxtREFBbUQ7SUFDbkQscURBQXFEO0lBQ3JELHFFQUFxRTtJQUNyRSxjQUFjO0lBQ2QsbUNBQW1DO0lBQ25DLDJDQUEyQztJQUMzQywyREFBMkQ7Q0FDNUQsQ0FBQztBQUVGLE1BQU0sc0JBQXNCLEdBQUc7SUFDN0IsZUFBZTtJQUNmLHNDQUFzQztJQUN0QyxrQ0FBa0M7SUFDbEMsa0NBQWtDO0lBQ2xDLGdDQUFnQztJQUNoQywwQkFBMEI7SUFDMUIsbUJBQW1CO0lBQ25CLHdEQUF3RDtJQUN4RCxrREFBa0Q7SUFDbEQsb0RBQW9EO0lBQ3BELHFFQUFxRTtJQUNyRSxjQUFjO0lBQ2QsbUNBQW1DO0lBQ25DLDJDQUEyQztJQUMzQywyREFBMkQ7SUFDM0Qsc0NBQXNDO0lBQ3RDLHdDQUF3QztDQUN6QyxDQUFDO0FBRUYsU0FBZ0Isa0JBQWtCLENBQ2hDLEtBQWdCLEVBQ2hCLFNBQXdELEVBQ3hELFFBQThDLEVBQzlDLGNBQXVCO0lBRXZCLElBQUksU0FBUyxLQUFLLEtBQUssRUFBRTtRQUN2QixPQUFPO0tBQ1I7SUFFRCxNQUFNLGNBQWMsR0FBRyxRQUFRLFlBQVksSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUUvRCx5RkFBeUY7SUFDekYsaURBQWlEO0lBRWpELG1CQUFtQjtJQUNuQixJQUFJ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dkU7SUFFRCxPQUFPLGNBQWMsQ0FBQztBQUN4QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCAqIGFzIGxvZ3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sb2dzXCI7XG5pbXBvcnQgKiBhcyBjZm5BcGlnIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtYXBpZ2F0ZXdheXYyXCI7XG5pbXBvcnQgKiBhcyBhcGlnIGZyb20gXCJAYXdzLWNkay9hd3MtYXBpZ2F0ZXdheXYyLWFscGhhXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi4vQXBwXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWNjZXNzTG9nUHJvcHMge1xuICBmb3JtYXQ/OiBzdHJpbmc7XG4gIGRlc3RpbmF0aW9uQXJuPzogc3RyaW5nO1xuICByZXRlbnRpb24/OiBMb3dlcmNhc2U8a2V5b2YgdHlwZW9mIGxvZ3MuUmV0ZW50aW9uRGF5cz47XG59XG5cbmNvbnN0IGRlZmF1bHRIdHRwRmllbGRzID0gW1xuICAvLyByZXF1ZXN0IGluZm9cbiAgYFwicmVxdWVzdFRpbWVcIjpcIiRjb250ZXh0LnJlcXVlc3RUaW1lXCJgLFxuICBgXCJyZXF1ZXN0SWRcIjpcIiRjb250ZXh0LnJlcXVlc3RJZFwiYCxcbiAgYFwiaHR0cE1ldGhvZFwiOlwiJGNvbnRleHQuaHR0cE1ldGhvZFwiYCxcbiAgYFwicGF0aFwiOlwiJGNvbnRleHQucGF0aFwiYCxcbiAgYFwicm91dGVLZXlcIjpcIiRjb250ZXh0LnJvdXRlS2V5XCJgLFxuICBgXCJzdGF0dXNcIjokY29udGV4dC5zdGF0dXNgLCAvLyBpbnRlZ2VyIHZhbHVlLCBkbyBub3Qgd3JhcCBpbiBxdW90ZXNcbiAgYFwicmVzcG9uc2VMYXRlbmN5XCI6JGNvbnRleHQucmVzcG9uc2VMYXRlbmN5YCwgLy8gaW50ZWdlciB2YWx1ZSwgZG8gbm90IHdyYXAgaW4gcXVvdGVzXG4gIC8vIGludGVncmF0aW9uIGluZm9cbiAgYFwiaW50ZWdyYXRpb25SZXF1ZXN0SWRcIjpcIiRjb250ZXh0LmludGVncmF0aW9uLnJlcXVlc3RJZFwiYCxcbiAgYFwiaW50ZWdyYXRpb25TdGF0dXNcIjpcIiRjb250ZXh0LmludGVncmF0aW9uLnN0YXR1c1wiYCxcbiAgYFwiaW50ZWdyYXRpb25MYXRlbmN5XCI6XCIkY29udGV4dC5pbnRlZ3JhdGlvbi5sYXRlbmN5XCJgLFxuICBgXCJpbnRlZ3JhdGlvblNlcnZpY2VTdGF0dXNcIjpcIiRjb250ZXh0LmludGVncmF0aW9uLmludGVncmF0aW9uU3RhdHVzXCJgLFxuICAvLyBjYWxsZXIgaW5mb1xuICBgXCJpcFwiOlwiJGNvbnRleHQuaWRlbnRpdHkuc291cmNlSXBcImAsXG4gIGBcInVzZXJBZ2VudFwiOlwiJGNvbnRleHQuaWRlbnRpdHkudXNlckFnZW50XCJgLFxuICBgXCJjb2duaXRvSWRlbnRpdHlJZFwiOlwiJGNvbnRleHQuaWRlbnRpdHkuY29nbml0b0lkZW50aXR5SWRcImAsXG5dO1xuXG5jb25zdCBkZWZhdWx0V2ViU29ja2V0RmllbGRzID0gW1xuICAvLyByZXF1ZXN0IGluZm9cbiAgYFwicmVxdWVzdFRpbWVcIjpcIiRjb250ZXh0LnJlcXVlc3RUaW1lXCJgLFxuICBgXCJyZXF1ZXN0SWRcIjpcIiRjb250ZXh0LnJlcXVlc3RJZFwiYCxcbiAgYFwiZXZlbnRUeXBlXCI6XCIkY29udGV4dC5ldmVudFR5cGVcImAsXG4gIGBcInJvdXRlS2V5XCI6XCIkY29udGV4dC5yb3V0ZUtleVwiYCxcbiAgYFwic3RhdHVzXCI6JGNvbnRleHQuc3RhdHVzYCwgLy8gaW50ZWdlciB2YWx1ZSwgZG8gbm90IHdyYXAgaW4gcXVvdGVzXG4gIC8vIGludGVncmF0aW9uIGluZm9cbiAgYFwiaW50ZWdyYXRpb25SZXF1ZXN0SWRcIjpcIiRjb250ZXh0LmF3c0VuZHBvaW50UmVxdWVzdElkXCJgLFxuICBgXCJpbnRlZ3JhdGlvblN0YXR1c1wiOlwiJGNvbnRleHQuaW50ZWdyYXRpb25TdGF0dXNcImAsXG4gIGBcImludGVncmF0aW9uTGF0ZW5jeVwiOlwiJGNvbnRleHQuaW50ZWdyYXRpb25MYXRlbmN5XCJgLFxuICBgXCJpbnRlZ3JhdGlvblNlcnZpY2VTdGF0dXNcIjpcIiRjb250ZXh0LmludGVncmF0aW9uLmludGVncmF0aW9uU3RhdHVzXCJgLFxuICAvLyBjYWxsZXIgaW5mb1xuICBgXCJpcFwiOlwiJGNvbnRleHQuaWRlbnRpdHkuc291cmNlSXBcImAsXG4gIGBcInVzZXJBZ2VudFwiOlwiJGNvbnRleHQuaWRlbnRpdHkudXNlckFnZW50XCJgLFxuICBgXCJjb2duaXRvSWRlbnRpdHlJZFwiOlwiJGNvbnRleHQuaWRlbnRpdHkuY29nbml0b0lkZW50aXR5SWRcImAsXG4gIGBcImNvbm5lY3RlZEF0XCI6XCIkY29udGV4dC5jb25uZWN0ZWRBdFwiYCxcbiAgYFwiY29ubmVjdGlvbklkXCI6XCIkY29udGV4dC5jb25uZWN0aW9uSWRcImAsXG5dO1xuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRBY2Nlc3NMb2dEYXRhKFxuICBzY29wZTogQ29uc3RydWN0LFxuICBhY2Nlc3NMb2c6IGJvb2xlYW4gfCBzdHJpbmcgfCBBY2Nlc3NMb2dQcm9wcyB8IHVuZGVmaW5lZCxcbiAgYXBpU3RhZ2U6IGFwaWcuV2ViU29ja2V0U3RhZ2UgfCBhcGlnLkh0dHBTdGFnZSxcbiAgaXNEZWZhdWx0U3RhZ2U6IGJvb2xlYW5cbik6IGxvZ3MuTG9nR3JvdXAgfCB1bmRlZmluZWQge1xuICBpZiAoYWNjZXNzTG9nID09PSBmYWxzZSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IGlzV2ViU29ja2V0QXBpID0gYXBpU3RhZ2UgaW5zdGFuY2VvZiBhcGlnLldlYlNvY2tldFN0YWdlO1xuXG4gIC8vIG5vdGU6IEFjY2VzcyBsb2cgY29uZmlndXJhdGlvbiBpcyBub3Qgc3VwcG9ydGVkIGJ5IEwyIGNvbnN0cnVjdHMgYXMgb2YgQ0RLIHYxLjg1LjAuIFdlXG4gIC8vICAgICAgIG5lZWQgdG8gZGVmaW5lIGl0IGF0IEwxIGNvbnN0cnVjdCBsZXZlbC5cblxuICAvLyBjcmVhdGUgbG9nIGdyb3VwXG4gIGxldCBsb2dHcm91cDtcbiAgbGV0IGRlc3RpbmF0aW9uQXJuO1xuICBpZiAoYWNjZXNzTG9nICYmIChhY2Nlc3NMb2cgYXMgQWNjZXNzTG9nUHJvcHMpLmRlc3RpbmF0aW9uQXJuKSB7XG4gICAgZGVzdGluYXRpb25Bcm4gPSAoYWNjZXNzTG9nIGFzIEFjY2Vzc0xvZ1Byb3BzKS5kZXN0aW5hdGlvbkFybjtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCByb290ID0gc2NvcGUubm9kZS5yb290IGFzIEFwcDtcbiAgICBjb25zdCBhcGlOYW1lID0gcm9vdC5sb2dpY2FsUHJlZml4ZWROYW1lKHNjb3BlLm5vZGUuaWQpO1xuICAgIC8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCBvbmx5IHN1ZmZpeCBpZiBub3QgZGVmYXVsdCBzdGFnZVxuICAgIGNvbnN0IGxvZ0dyb3VwTmFtZSA9XG4gICAgICBcIkxvZ0dyb3VwXCIgKyAoaXNEZWZhdWx0U3RhZ2UgPyBcIlwiIDogYXBpU3RhZ2Uuc3RhZ2VOYW1lKTtcblxuICAgIGxvZ0dyb3VwID0gbmV3IGxvZ3MuTG9nR3JvdXAoc2NvcGUsIGxvZ0dyb3VwTmFtZSwge1xuICAgICAgbG9nR3JvdXBOYW1lOiBbXG4gICAgICAgIGAvYXdzL3ZlbmRlZGxvZ3MvYXBpc2AsXG4gICAgICAgIGAvJHtjbGVhbnVwTG9nR3JvdXBOYW1lKGFwaU5hbWUpfS0ke2FwaVN0YWdlLmFwaS5hcGlJZH1gLFxuICAgICAgICBgLyR7Y2xlYW51cExvZ0dyb3VwTmFtZShhcGlTdGFnZS5zdGFnZU5hbWUpfWAsXG4gICAgICBdLmpvaW4oXCJcIiksXG4gICAgICByZXRlbnRpb246IGJ1aWxkTG9nR3JvdXBSZXRlbnRpb24oYWNjZXNzTG9nKSxcbiAgICB9KTtcbiAgICBkZXN0aW5hdGlvbkFybiA9IGxvZ0dyb3VwLmxvZ0dyb3VwQXJuO1xuICB9XG5cbiAgLy8gZ2V0IGxvZyBmb3JtYXRcbiAgbGV0IGZvcm1hdDtcbiAgaWYgKGFjY2Vzc0xvZyAmJiAoYWNjZXNzTG9nIGFzIEFjY2Vzc0xvZ1Byb3BzKS5mb3JtYXQpIHtcbiAgICBmb3JtYXQgPSAoYWNjZXNzTG9nIGFzIEFjY2Vzc0xvZ1Byb3BzKS5mb3JtYXQ7XG4gIH0gZWxzZSBpZiAodHlwZW9mIGFjY2Vzc0xvZyA9PT0gXCJzdHJpbmdcIikge1xuICAgIGZvcm1hdCA9IGFjY2Vzc0xvZztcbiAgfSBlbHNlIHtcbiAgICBmb3JtYXQgPSBpc1dlYlNvY2tldEFwaVxuICAgICAgPyBcIntcIiArIGRlZmF1bHRXZWJTb2NrZXRGaWVsZHMuam9pbihcIixcIikgKyBcIn1cIlxuICAgICAgOiBcIntcIiArIGRlZmF1bHRIdHRwRmllbGRzLmpvaW4oXCIsXCIpICsgXCJ9XCI7XG4gIH1cblxuICAvLyBnZXQgTDEgY2ZuU3RhZ2UgY29uc3RydWN0XG4gIGlmICghYXBpU3RhZ2U/Lm5vZGUuZGVmYXVsdENoaWxkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZGVmaW5lIHRoZSBkZWZhdWx0IHN0YWdlIGZvciBIdHRwIEFQSWApO1xuICB9XG5cbiAgLy8gc2V0IGFjY2VzcyBsb2cgc2V0dGluZ3NcbiAgY29uc3QgY2ZuU3RhZ2UgPSBhcGlTdGFnZS5ub2RlLmRlZmF1bHRDaGlsZCBhcyBjZm5BcGlnLkNmblN0YWdlO1xuICBjZm5TdGFnZS5hY2Nlc3NMb2dTZXR0aW5ncyA9IHsgZm9ybWF0LCBkZXN0aW5hdGlvbkFybiB9O1xuXG4gIHJldHVybiBsb2dHcm91cDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsZWFudXBMb2dHcm91cE5hbWUoc3RyOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gc3RyLnJlcGxhY2UoL1teLlxcLV8vI0EtWmEtejAtOV0vZywgXCJcIik7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkTG9nR3JvdXBSZXRlbnRpb24oXG4gIGFjY2Vzc0xvZz86IGJvb2xlYW4gfCBzdHJpbmcgfCBBY2Nlc3NMb2dQcm9wc1xuKTogbG9ncy5SZXRlbnRpb25EYXlzIHtcbiAgY29uc3QgcmV0ZW50aW9uID0gYWNjZXNzTG9nICYmIChhY2Nlc3NMb2cgYXMgQWNjZXNzTG9nUHJvcHMpLnJldGVudGlvbjtcbiAgaWYgKCFyZXRlbnRpb24pIHtcbiAgICByZXR1cm4gbG9ncy5SZXRlbnRpb25EYXlzLklORklOSVRFO1xuICB9XG5cbiAgLy8gQ2FzZTogcmV0ZW50aW9uIGlzIHN0cmluZ1xuICBjb25zdCByZXRlbnRpb25WYWx1ZSA9XG4gICAgbG9ncy5SZXRlbnRpb25EYXlzW1xuICAgICAgcmV0ZW50aW9uLnRvVXBwZXJDYXNlKCkgYXMga2V5b2YgdHlwZW9mIGxvZ3MuUmV0ZW50aW9uRGF5c1xuICAgIF07XG5cbiAgLy8gdmFsaWRhdGUgcmV0ZW50aW9uXG4gIGlmICghcmV0ZW50aW9uVmFsdWUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgYWNjZXNzIGxvZyByZXRlbnRpb24gdmFsdWUgXCIke3JldGVudGlvbn1cIi5gKTtcbiAgfVxuXG4gIHJldHVybiByZXRlbnRpb25WYWx1ZTtcbn1cbiJdfQ==