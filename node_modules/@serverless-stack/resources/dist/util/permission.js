"use strict";
/* eslint-disable @typescript-eslint/ban-ts-comment*/
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.attachPermissionsToRole = void 0;
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const core_1 = require("@serverless-stack/core");
const index_1 = require("../index");
const Construct_1 = require("../Construct");
const logger = (0, core_1.getChildLogger)("resources");
function attachPermissionsToRole(role, permissions) {
    // Four patterns
    //
    // attachPermissions("*");
    // attachPermissions([ 'sns', 'sqs' ]);
    // attachPermissions([ event, queue ]);
    // attachPermissions([
    //   [ event.snsTopic, 'grantPublish' ],
    //   [ queue.sqsQueue, 'grantSendMessages' ],
    // ]);
    // attachPermissions([
    //   new iam.PolicyStatement({
    //     actions: ["s3:*"],
    //     effect: iam.Effect.ALLOW,
    //     resources: [
    //       bucket.bucketArn + "/private/${cognito-identity.amazonaws.com:sub}/*",
    //     ],
    //   })
    // ]);
    ////////////////////////////////////
    // Case: 'admin' permissions => '*'
    ////////////////////////////////////
    if (permissions === "*") {
        role.addToPolicy(buildPolicy(permissions, ["*"]));
        return;
    }
    if (!Array.isArray(permissions)) {
        throw new Error(`The specified permissions are not supported. They are expected to be "*" or an array.`);
    }
    // Handle array of permissions
    permissions.forEach((permission) => {
        ////////////////////////////////////
        // Case: string ie. 's3' or 's3:*'
        ////////////////////////////////////
        if (typeof permission === "string") {
            const perm = permission.indexOf(":") === -1 ? `${permission}:*` : permission;
            role.addToPolicy(buildPolicy(perm, ["*"]));
        }
        ////////////////////////////////////
        // Case: iam.PolicyStatement
        ////////////////////////////////////
        else if ((0, Construct_1.isCDKConstructOf)(permission, "aws-cdk-lib.aws_iam.PolicyStatement")) {
            role.addToPolicy(permission);
        }
        ////////////////////////////////////
        // Case: SST construct
        ////////////////////////////////////
        else if (permission instanceof index_1.Api) {
            const httpApi = permission.cdk.httpApi;
            const { account, region } = index_1.Stack.of(httpApi);
            role.addToPolicy(buildPolicy("execute-api:Invoke", [
                `arn:aws:execute-api:${region}:${account}:${httpApi.httpApiId}/*`,
            ]));
        }
        else if (permission instanceof index_1.ApiGatewayV1Api) {
            const restApi = permission.cdk.restApi;
            const { account, region } = index_1.Stack.of(restApi);
            role.addToPolicy(buildPolicy("execute-api:Invoke", [
                `arn:aws:execute-api:${region}:${account}:${restApi.restApiId}/*`,
            ]));
        }
        else if (permission instanceof index_1.WebSocketApi) {
            const webSocketApi = permission.cdk.webSocketApi;
            const { account, region } = index_1.Stack.of(webSocketApi);
            role.addToPolicy(buildPolicy("execute-api:Invoke", [
                `arn:aws:execute-api:${region}:${account}:${webSocketApi.apiId}/*`,
            ]));
            role.addToPolicy(buildPolicy("execute-api:ManageConnections", [
                permission._connectionsArn,
            ]));
        }
        else if (permission instanceof index_1.AppSyncApi) {
            const graphqlApi = permission.cdk.graphqlApi;
            const { account, region } = index_1.Stack.of(graphqlApi);
            role.addToPolicy(buildPolicy("appsync:GraphQL", [
                `arn:aws:appsync:${region}:${account}:apis/${graphqlApi.apiId}/*`,
            ]));
        }
        else if (permission instanceof index_1.Table) {
            const tableArn = permission.cdk.table.tableArn;
            role.addToPolicy(buildPolicy("dynamodb:*", [tableArn, `${tableArn}/*`]));
        }
        else if (permission instanceof index_1.Topic) {
            role.addToPolicy(buildPolicy("sns:*", [permission.cdk.topic.topicArn]));
        }
        else if (permission instanceof index_1.Queue) {
            role.addToPolicy(buildPolicy("sqs:*", [permission.cdk.queue.queueArn]));
        }
        else if (permission instanceof index_1.EventBus) {
            role.addToPolicy(buildPolicy("events:*", [permission.cdk.eventBus.eventBusArn]));
        }
        else if (permission instanceof index_1.KinesisStream) {
            role.addToPolicy(buildPolicy("kinesis:*", [permission.cdk.stream.streamArn]));
        }
        else if (permission instanceof index_1.Bucket) {
            const bucketArn = permission.cdk.bucket.bucketArn;
            role.addToPolicy(buildPolicy("s3:*", [bucketArn, `${bucketArn}/*`]));
        }
        else if (permission instanceof index_1.RDS) {
            role.addToPolicy(buildPolicy("rds-data:*", [permission.clusterArn]));
            if (permission.cdk.cluster.secret) {
                role.addToPolicy(buildPolicy(["secretsmanager:GetSecretValue", "secretsmanager:DescribeSecret"], [permission.cdk.cluster.secret.secretArn]));
            }
        }
        else if (permission instanceof index_1.Function) {
            role.addToPolicy(buildPolicy("lambda:*", [permission.functionArn]));
        }
        ////////////////////////////////////
        // Case: CDK constructs
        ////////////////////////////////////
        else if (permission.tableArn && permission.tableName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            const tableArn = permission.tableArn;
            role.addToPolicy(buildPolicy("dynamodb:*", [tableArn, `${tableArn}/*`]));
        }
        else if (permission.topicArn && permission.topicName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("sns:*", [permission.topicArn]));
        }
        else if (permission.queueArn && permission.queueName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("sqs:*", [permission.queueArn]));
        }
        else if (permission.eventBusArn &&
            permission.eventBusName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("events:*", [permission.eventBusArn]));
        }
        else if (permission.streamArn &&
            permission.streamName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("kinesis:*", [permission.streamArn]));
        }
        else if (permission.deliveryStreamArn &&
            permission.deliveryStreamName) {
            role.addToPolicy(buildPolicy("firehose:*", [permission.deliveryStreamArn]));
        }
        else if (permission.bucketArn &&
            permission.bucketName) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            const bucketArn = permission.bucketArn;
            role.addToPolicy(buildPolicy("s3:*", [bucketArn, `${bucketArn}/*`]));
        }
        else if (permission.clusterArn) {
            // For ServerlessCluster, we need to grant:
            // - permisssions to access the Data API;
            // - permisssions to access the Secret Manager (required by Data API).
            // No need to grant the permissions for IAM database authentication
            role.addToPolicy(buildPolicy("rds-data:*", [permission.clusterArn]));
            const secret = permission.secret;
            if (secret) {
                role.addToPolicy(buildPolicy(["secretsmanager:GetSecretValue", "secretsmanager:DescribeSecret"], [secret.secretArn]));
            }
        }
        ////////////////////////////////////
        // Case: grant method
        ////////////////////////////////////
        else if (Array.isArray(permission) &&
            permission.length === 2 &&
            (0, Construct_1.isCDKConstruct)(permission[0]) &&
            typeof permission[1] === "string") {
            const construct = permission[0];
            const methodName = permission[1];
            if (typeof construct[methodName] !== "function")
                throw new Error(`The specified grant method is incorrect.
          Check the available methods that prefixed with grants on the Construct`);
            construct[methodName](role);
        }
        else {
            logger.debug("permission object", permission);
            throw new Error(`The specified permissions are not supported.`);
        }
    });
}
exports.attachPermissionsToRole = attachPermissionsToRole;
function buildPolicy(actions, resources) {
    return new iam.PolicyStatement({
        effect: iam.Effect.ALLOW,
        actions: typeof actions === "string" ? [actions] : actions,
        resources,
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL3Blcm1pc3Npb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHFEQUFxRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFHckQseURBQTJDO0FBQzNDLGlEQUF3RDtBQUN4RCxvQ0Fja0I7QUFDbEIsNENBQWdFO0FBRWhFLE1BQU0sTUFBTSxHQUFHLElBQUEscUJBQWMsRUFBQyxXQUFXLENBQUMsQ0FBQztBQXVCM0MsU0FBZ0IsdUJBQXVCLENBQ3JDLElBQWMsRUFDZCxXQUF3QjtJQUV4QixnQkFBZ0I7SUFDaEIsRUFBRTtJQUNGLDBCQUEwQjtJQUMxQix1Q0FBdUM7SUFDdkMsdUNBQXVDO0lBQ3ZDLHNCQUFzQjtJQUN0Qix3Q0FBd0M7SUFDeEMsNkNBQTZDO0lBQzdDLE1BQU07SUFDTixzQkFBc0I7SUFDdEIsOEJBQThCO0lBQzlCLHlCQUF5QjtJQUN6QixnQ0FBZ0M7SUFDaEMsbUJBQW1CO0lBQ25CLCtFQUErRTtJQUMvRSxTQUFTO0lBQ1QsT0FBTztJQUNQLE1BQU07SUFFTixvQ0FBb0M7SUFDcEMsbUNBQW1DO0lBQ25DLG9DQUFvQztJQUNwQyxJQUFJLFdBQVcsS0FBSyxHQUFHLEVBQUU7UUFDdkIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2xELE9BQU87S0FDUjtJQUVELElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFFO1FBQy9CLE1BQU0sSUFBSSxLQUFLLENBQ2IsdUZBQXVGLENBQ3hGLENBQUM7S0FDSDtJQUVELDhCQUE4QjtJQUM5QixXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBc0IsRUFBRSxFQUFFO1FBQzdDLG9DQUFvQztRQUNwQyxrQ0FBa0M7UUFDbEMsb0NBQW9DO1FBQ3BDLElBQUksT0FBTyxVQUFVLEtBQUssUUFBUSxFQUFFO1lBQ2xDLE1BQU0sSUFBSSxHQUNSLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsVUFBVSxJQUFJLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQztZQUNsRSxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDNUM7UUFDRCxvQ0FBb0M7UUFDcEMsNEJBQTRCO1FBQzVCLG9DQUFvQzthQUMvQixJQUNILElBQUEsNEJBQWdCLEVBQ2QsVUFBdUIsRUFDdkIscUNBQXFDLENBQ3RDLEVBQ0Q7WUFDQSxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQWlDLENBQUMsQ0FBQztTQUNyRDtRQUNELG9DQUFvQztRQUNwQyxzQkFBc0I7UUFDdEIsb0NBQW9DO2FBQy9CLElBQUksVUFBVSxZQUFZLFdBQUcsRUFBRTtZQUNsQyxNQUFNLE9BQU8sR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQztZQUN2QyxNQUFNLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLGFBQUssQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDOUMsSUFBSSxDQUFDLFdBQVcsQ0FDZCxXQUFXLENBQUMsb0JBQW9CLEVBQUU7Z0JBQ2hDLHVCQUF1QixNQUFNLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxTQUFTLElBQUk7YUFDbEUsQ0FBQyxDQUNILENBQUM7U0FDSDthQUFNLElBQUksVUFBVSxZQUFZLHVCQUFlLEVBQUU7WUFDaEQsTUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUM7WUFDdkMsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxhQUFLLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzlDLElBQUksQ0FBQyxXQUFXLENBQ2QsV0FBVyxDQUFDLG9CQUFvQixFQUFFO2dCQUNoQyx1QkFBdUIsTUFBTSxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsU0FBUyxJQUFJO2FBQ2xFLENBQUMsQ0FDSCxDQUFDO1NBQ0g7YUFBTSxJQUFJLFVBQVUsWUFBWSxvQkFBWSxFQUFFO1lBQzdDLE1BQU0sWUFBWSxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDO1lBQ2pELE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsYUFBSyxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNuRCxJQUFJLENBQUMsV0FBVyxDQUNkLFdBQVcsQ0FBQyxvQkFBb0IsRUFBRTtnQkFDaEMsdUJBQXVCLE1BQU0sSUFBSSxPQUFPLElBQUksWUFBWSxDQUFDLEtBQUssSUFBSTthQUNuRSxDQUFDLENBQ0gsQ0FBQztZQUNGLElBQUksQ0FBQyxXQUFXLENBQ2QsV0FBVyxDQUFDLCtCQUErQixFQUFFO2dCQUMzQyxVQUFVLENBQUMsZUFBZTthQUMzQixDQUFDLENBQ0gsQ0FBQztTQUNIO2FBQU0sSUFBSSxVQUFVLFlBQVksa0JBQVUsRUFBRTtZQUMzQyxNQUFNLFVBQVUsR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQztZQUM3QyxNQUFNLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLGFBQUssQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDakQsSUFBSSxDQUFDLFdBQVcsQ0FDZCxXQUFXLENBQUMsaUJBQWlCLEVBQUU7Z0JBQzdCLG1CQUFtQixNQUFNLElBQUksT0FBTyxTQUFTLFVBQVUsQ0FBQyxLQUFLLElBQUk7YUFDbEUsQ0FBQyxDQUNILENBQUM7U0FDSDthQUFNLElBQUksVUFBVSxZQUFZLGFBQUssRUFBRTtZQUN0QyxNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUM7WUFDL0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsWUFBWSxFQUFFLENBQUMsUUFBUSxFQUFFLEdBQUcsUUFBUSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDMUU7YUFBTSxJQUFJLFVBQVUsWUFBWSxhQUFLLEVBQUU7WUFDdEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3pFO2FBQU0sSUFBSSxVQUFVLFlBQVksYUFBSyxFQUFFO1lBQ3RDLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN6RTthQUFNLElBQUksVUFBVSxZQUFZLGdCQUFRLEVBQUU7WUFDekMsSUFBSSxDQUFDLFdBQVcsQ0FDZCxXQUFXLENBQUMsVUFBVSxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FDL0QsQ0FBQztTQUNIO2FBQU0sSUFBSSxVQUFVLFlBQVkscUJBQWEsRUFBRTtZQUM5QyxJQUFJLENBQUMsV0FBVyxDQUNkLFdBQVcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUM1RCxDQUFDO1NBQ0g7YUFBTSxJQUFJLFVBQVUsWUFBWSxjQUFNLEVBQUU7WUFDdkMsTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDO1lBQ2xELElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDLFNBQVMsRUFBRSxHQUFHLFNBQVMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3RFO2FBQU0sSUFBSSxVQUFVLFlBQVksV0FBRyxFQUFFO1lBQ3BDLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckUsSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUU7Z0JBQ2pDLElBQUksQ0FBQyxXQUFXLENBQ2QsV0FBVyxDQUNULENBQUMsK0JBQStCLEVBQUUsK0JBQStCLENBQUMsRUFDbEUsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQzFDLENBQ0YsQ0FBQzthQUNIO1NBQ0Y7YUFBTSxJQUFJLFVBQVUsWUFBWSxnQkFBUSxFQUFFO1lBQ3pDLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDckU7UUFDRCxvQ0FBb0M7UUFDcEMsdUJBQXVCO1FBQ3ZCLG9DQUFvQzthQUMvQixJQUFLLFVBQWtCLENBQUMsUUFBUSxJQUFLLFVBQWtCLENBQUMsU0FBUyxFQUFFO1lBQ3RFLDhFQUE4RTtZQUM5RSxNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsUUFBUSxDQUFDO1lBQ3JDLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRSxDQUFDLFFBQVEsRUFBRSxHQUFHLFFBQVEsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzFFO2FBQU0sSUFBSyxVQUFrQixDQUFDLFFBQVEsSUFBSyxVQUFrQixDQUFDLFNBQVMsRUFBRTtZQUN4RSw4RUFBOEU7WUFDOUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMvRDthQUFNLElBQUssVUFBa0IsQ0FBQyxRQUFRLElBQUssVUFBa0IsQ0FBQyxTQUFTLEVBQUU7WUFDeEUsOEVBQThFO1lBQzlFLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDL0Q7YUFBTSxJQUNKLFVBQWtCLENBQUMsV0FBVztZQUM5QixVQUFrQixDQUFDLFlBQVksRUFDaEM7WUFDQSw4RUFBOEU7WUFDOUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNyRTthQUFNLElBQ0osVUFBa0IsQ0FBQyxTQUFTO1lBQzVCLFVBQWtCLENBQUMsVUFBVSxFQUM5QjtZQUNBLDhFQUE4RTtZQUM5RSxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3BFO2FBQU0sSUFDSixVQUFrQixDQUFDLGlCQUFpQjtZQUNwQyxVQUFrQixDQUFDLGtCQUFrQixFQUN0QztZQUNBLElBQUksQ0FBQyxXQUFXLENBQ2QsV0FBVyxDQUFDLFlBQVksRUFBRSxDQUFFLFVBQWtCLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUNuRSxDQUFDO1NBQ0g7YUFBTSxJQUNKLFVBQWtCLENBQUMsU0FBUztZQUM1QixVQUFrQixDQUFDLFVBQVUsRUFDOUI7WUFDQSw4RUFBOEU7WUFDOUUsTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQztZQUN2QyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxTQUFTLEVBQUUsR0FBRyxTQUFTLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN0RTthQUFNLElBQUssVUFBa0IsQ0FBQyxVQUFVLEVBQUU7WUFDekMsMkNBQTJDO1lBQzNDLHlDQUF5QztZQUN6QyxzRUFBc0U7WUFDdEUsbUVBQW1FO1lBQ25FLElBQUksQ0FBQyxXQUFXLENBQ2QsV0FBVyxDQUFDLFlBQVksRUFBRSxDQUFFLFVBQWtCLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FDNUQsQ0FBQztZQUNGLE1BQU0sTUFBTSxHQUFJLFVBQWtCLENBQUMsTUFBTSxDQUFDO1lBQzFDLElBQUksTUFBTSxFQUFFO2dCQUNWLElBQUksQ0FBQyxXQUFXLENBQ2QsV0FBVyxDQUNULENBQUMsK0JBQStCLEVBQUUsK0JBQStCLENBQUMsRUFDbEUsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQ25CLENBQ0YsQ0FBQzthQUNIO1NBQ0Y7UUFDRCxvQ0FBb0M7UUFDcEMscUJBQXFCO1FBQ3JCLG9DQUFvQzthQUMvQixJQUNILEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDO1lBQ3pCLFVBQVUsQ0FBQyxNQUFNLEtBQUssQ0FBQztZQUN2QixJQUFBLDBCQUFjLEVBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdCLE9BQU8sVUFBVSxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsRUFDakM7WUFDQSxNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUMsQ0FBQyxDQUFjLENBQUM7WUFDN0MsTUFBTSxVQUFVLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBb0IsQ0FBQztZQUNwRCxJQUFJLE9BQU8sU0FBUyxDQUFDLFVBQVUsQ0FBQyxLQUFLLFVBQVU7Z0JBQzdDLE1BQU0sSUFBSSxLQUFLLENBQ2I7aUZBQ3VFLENBQ3hFLENBQUM7WUFDSCxTQUFTLENBQUMsVUFBVSxDQUFzQyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ25FO2FBQU07WUFDTCxNQUFNLENBQUMsS0FBSyxDQUFDLG1CQUFtQixFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQzlDLE1BQU0sSUFBSSxLQUFLLENBQUMsOENBQThDLENBQUMsQ0FBQztTQUNqRTtJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQWhORCwwREFnTkM7QUFFRCxTQUFTLFdBQVcsQ0FDbEIsT0FBMEIsRUFDMUIsU0FBbUI7SUFFbkIsT0FBTyxJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUM7UUFDN0IsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSztRQUN4QixPQUFPLEVBQUUsT0FBTyxPQUFPLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPO1FBQzFELFNBQVM7S0FDVixDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10cy1jb21tZW50Ki9cblxuaW1wb3J0IHsgQ29uc3RydWN0LCBJQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCAqIGFzIGlhbSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xuaW1wb3J0IHsgZ2V0Q2hpbGRMb2dnZXIgfSBmcm9tIFwiQHNlcnZlcmxlc3Mtc3RhY2svY29yZVwiO1xuaW1wb3J0IHtcbiAgQXBpLFxuICBSRFMsXG4gIFRhYmxlLFxuICBUb3BpYyxcbiAgUXVldWUsXG4gIEJ1Y2tldCxcbiAgRXZlbnRCdXMsXG4gIEZ1bmN0aW9uLFxuICBBcHBTeW5jQXBpLFxuICBXZWJTb2NrZXRBcGksXG4gIEtpbmVzaXNTdHJlYW0sXG4gIEFwaUdhdGV3YXlWMUFwaSxcbiAgU3RhY2ssXG59IGZyb20gXCIuLi9pbmRleFwiO1xuaW1wb3J0IHsgaXNDREtDb25zdHJ1Y3QsIGlzQ0RLQ29uc3RydWN0T2YgfSBmcm9tIFwiLi4vQ29uc3RydWN0XCI7XG5cbmNvbnN0IGxvZ2dlciA9IGdldENoaWxkTG9nZ2VyKFwicmVzb3VyY2VzXCIpO1xuXG5leHBvcnQgdHlwZSBQZXJtaXNzaW9ucyA9IFwiKlwiIHwgUGVybWlzc2lvbltdO1xudHlwZSBTdXBwb3J0ZWRQZXJtaXNzaW9ucyA9XG4gIHwgXCJleGVjdXRlLWFwaVwiXG4gIHwgXCJhcHBzeW5jXCJcbiAgfCBcImR5bmFtb2RiXCJcbiAgfCBcInNuc1wiXG4gIHwgXCJzcXNcIlxuICB8IFwiZXZlbnRzXCJcbiAgfCBcImtpbmVzaXNcIlxuICB8IFwiczNcIlxuICB8IFwicmRzLWRhdGFcIlxuICB8IFwic2VjcmV0c21hbmFnZXJcIlxuICB8IFwibGFtYmRhXCJcbiAgfCBcInNzbVwiO1xudHlwZSBQZXJtaXNzaW9uID1cbiAgfCBTdXBwb3J0ZWRQZXJtaXNzaW9uc1xuICB8IE9taXQ8c3RyaW5nLCBTdXBwb3J0ZWRQZXJtaXNzaW9ucz5cbiAgfCBJQ29uc3RydWN0XG4gIHwgW0lDb25zdHJ1Y3QsIHN0cmluZ11cbiAgfCBpYW0uUG9saWN5U3RhdGVtZW50O1xuXG5leHBvcnQgZnVuY3Rpb24gYXR0YWNoUGVybWlzc2lvbnNUb1JvbGUoXG4gIHJvbGU6IGlhbS5Sb2xlLFxuICBwZXJtaXNzaW9uczogUGVybWlzc2lvbnNcbik6IHZvaWQge1xuICAvLyBGb3VyIHBhdHRlcm5zXG4gIC8vXG4gIC8vIGF0dGFjaFBlcm1pc3Npb25zKFwiKlwiKTtcbiAgLy8gYXR0YWNoUGVybWlzc2lvbnMoWyAnc25zJywgJ3NxcycgXSk7XG4gIC8vIGF0dGFjaFBlcm1pc3Npb25zKFsgZXZlbnQsIHF1ZXVlIF0pO1xuICAvLyBhdHRhY2hQZXJtaXNzaW9ucyhbXG4gIC8vICAgWyBldmVudC5zbnNUb3BpYywgJ2dyYW50UHVibGlzaCcgXSxcbiAgLy8gICBbIHF1ZXVlLnNxc1F1ZXVlLCAnZ3JhbnRTZW5kTWVzc2FnZXMnIF0sXG4gIC8vIF0pO1xuICAvLyBhdHRhY2hQZXJtaXNzaW9ucyhbXG4gIC8vICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAvLyAgICAgYWN0aW9uczogW1wiczM6KlwiXSxcbiAgLy8gICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgLy8gICAgIHJlc291cmNlczogW1xuICAvLyAgICAgICBidWNrZXQuYnVja2V0QXJuICsgXCIvcHJpdmF0ZS8ke2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTpzdWJ9LypcIixcbiAgLy8gICAgIF0sXG4gIC8vICAgfSlcbiAgLy8gXSk7XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vIENhc2U6ICdhZG1pbicgcGVybWlzc2lvbnMgPT4gJyonXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICBpZiAocGVybWlzc2lvbnMgPT09IFwiKlwiKSB7XG4gICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShwZXJtaXNzaW9ucywgW1wiKlwiXSkpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmICghQXJyYXkuaXNBcnJheShwZXJtaXNzaW9ucykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgVGhlIHNwZWNpZmllZCBwZXJtaXNzaW9ucyBhcmUgbm90IHN1cHBvcnRlZC4gVGhleSBhcmUgZXhwZWN0ZWQgdG8gYmUgXCIqXCIgb3IgYW4gYXJyYXkuYFxuICAgICk7XG4gIH1cblxuICAvLyBIYW5kbGUgYXJyYXkgb2YgcGVybWlzc2lvbnNcbiAgcGVybWlzc2lvbnMuZm9yRWFjaCgocGVybWlzc2lvbjogUGVybWlzc2lvbikgPT4ge1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENhc2U6IHN0cmluZyBpZS4gJ3MzJyBvciAnczM6KidcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBpZiAodHlwZW9mIHBlcm1pc3Npb24gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGNvbnN0IHBlcm0gPVxuICAgICAgICBwZXJtaXNzaW9uLmluZGV4T2YoXCI6XCIpID09PSAtMSA/IGAke3Blcm1pc3Npb259OipgIDogcGVybWlzc2lvbjtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3kocGVybSwgW1wiKlwiXSkpO1xuICAgIH1cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDYXNlOiBpYW0uUG9saWN5U3RhdGVtZW50XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgZWxzZSBpZiAoXG4gICAgICBpc0NES0NvbnN0cnVjdE9mKFxuICAgICAgICBwZXJtaXNzaW9uIGFzIENvbnN0cnVjdCxcbiAgICAgICAgXCJhd3MtY2RrLWxpYi5hd3NfaWFtLlBvbGljeVN0YXRlbWVudFwiXG4gICAgICApXG4gICAgKSB7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KHBlcm1pc3Npb24gYXMgaWFtLlBvbGljeVN0YXRlbWVudCk7XG4gICAgfVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENhc2U6IFNTVCBjb25zdHJ1Y3RcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgQXBpKSB7XG4gICAgICBjb25zdCBodHRwQXBpID0gcGVybWlzc2lvbi5jZGsuaHR0cEFwaTtcbiAgICAgIGNvbnN0IHsgYWNjb3VudCwgcmVnaW9uIH0gPSBTdGFjay5vZihodHRwQXBpKTtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgIGJ1aWxkUG9saWN5KFwiZXhlY3V0ZS1hcGk6SW52b2tlXCIsIFtcbiAgICAgICAgICBgYXJuOmF3czpleGVjdXRlLWFwaToke3JlZ2lvbn06JHthY2NvdW50fToke2h0dHBBcGkuaHR0cEFwaUlkfS8qYCxcbiAgICAgICAgXSlcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgQXBpR2F0ZXdheVYxQXBpKSB7XG4gICAgICBjb25zdCByZXN0QXBpID0gcGVybWlzc2lvbi5jZGsucmVzdEFwaTtcbiAgICAgIGNvbnN0IHsgYWNjb3VudCwgcmVnaW9uIH0gPSBTdGFjay5vZihyZXN0QXBpKTtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgIGJ1aWxkUG9saWN5KFwiZXhlY3V0ZS1hcGk6SW52b2tlXCIsIFtcbiAgICAgICAgICBgYXJuOmF3czpleGVjdXRlLWFwaToke3JlZ2lvbn06JHthY2NvdW50fToke3Jlc3RBcGkucmVzdEFwaUlkfS8qYCxcbiAgICAgICAgXSlcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgV2ViU29ja2V0QXBpKSB7XG4gICAgICBjb25zdCB3ZWJTb2NrZXRBcGkgPSBwZXJtaXNzaW9uLmNkay53ZWJTb2NrZXRBcGk7XG4gICAgICBjb25zdCB7IGFjY291bnQsIHJlZ2lvbiB9ID0gU3RhY2sub2Yod2ViU29ja2V0QXBpKTtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgIGJ1aWxkUG9saWN5KFwiZXhlY3V0ZS1hcGk6SW52b2tlXCIsIFtcbiAgICAgICAgICBgYXJuOmF3czpleGVjdXRlLWFwaToke3JlZ2lvbn06JHthY2NvdW50fToke3dlYlNvY2tldEFwaS5hcGlJZH0vKmAsXG4gICAgICAgIF0pXG4gICAgICApO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShcbiAgICAgICAgYnVpbGRQb2xpY3koXCJleGVjdXRlLWFwaTpNYW5hZ2VDb25uZWN0aW9uc1wiLCBbXG4gICAgICAgICAgcGVybWlzc2lvbi5fY29ubmVjdGlvbnNBcm4sXG4gICAgICAgIF0pXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIEFwcFN5bmNBcGkpIHtcbiAgICAgIGNvbnN0IGdyYXBocWxBcGkgPSBwZXJtaXNzaW9uLmNkay5ncmFwaHFsQXBpO1xuICAgICAgY29uc3QgeyBhY2NvdW50LCByZWdpb24gfSA9IFN0YWNrLm9mKGdyYXBocWxBcGkpO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShcbiAgICAgICAgYnVpbGRQb2xpY3koXCJhcHBzeW5jOkdyYXBoUUxcIiwgW1xuICAgICAgICAgIGBhcm46YXdzOmFwcHN5bmM6JHtyZWdpb259OiR7YWNjb3VudH06YXBpcy8ke2dyYXBocWxBcGkuYXBpSWR9LypgLFxuICAgICAgICBdKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHBlcm1pc3Npb24gaW5zdGFuY2VvZiBUYWJsZSkge1xuICAgICAgY29uc3QgdGFibGVBcm4gPSBwZXJtaXNzaW9uLmNkay50YWJsZS50YWJsZUFybjtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJkeW5hbW9kYjoqXCIsIFt0YWJsZUFybiwgYCR7dGFibGVBcm59LypgXSkpO1xuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIFRvcGljKSB7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwic25zOipcIiwgW3Blcm1pc3Npb24uY2RrLnRvcGljLnRvcGljQXJuXSkpO1xuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIFF1ZXVlKSB7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwic3FzOipcIiwgW3Blcm1pc3Npb24uY2RrLnF1ZXVlLnF1ZXVlQXJuXSkpO1xuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIEV2ZW50QnVzKSB7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICBidWlsZFBvbGljeShcImV2ZW50czoqXCIsIFtwZXJtaXNzaW9uLmNkay5ldmVudEJ1cy5ldmVudEJ1c0Fybl0pXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIEtpbmVzaXNTdHJlYW0pIHtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgIGJ1aWxkUG9saWN5KFwia2luZXNpczoqXCIsIFtwZXJtaXNzaW9uLmNkay5zdHJlYW0uc3RyZWFtQXJuXSlcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgQnVja2V0KSB7XG4gICAgICBjb25zdCBidWNrZXRBcm4gPSBwZXJtaXNzaW9uLmNkay5idWNrZXQuYnVja2V0QXJuO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcInMzOipcIiwgW2J1Y2tldEFybiwgYCR7YnVja2V0QXJufS8qYF0pKTtcbiAgICB9IGVsc2UgaWYgKHBlcm1pc3Npb24gaW5zdGFuY2VvZiBSRFMpIHtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJyZHMtZGF0YToqXCIsIFtwZXJtaXNzaW9uLmNsdXN0ZXJBcm5dKSk7XG4gICAgICBpZiAocGVybWlzc2lvbi5jZGsuY2x1c3Rlci5zZWNyZXQpIHtcbiAgICAgICAgcm9sZS5hZGRUb1BvbGljeShcbiAgICAgICAgICBidWlsZFBvbGljeShcbiAgICAgICAgICAgIFtcInNlY3JldHNtYW5hZ2VyOkdldFNlY3JldFZhbHVlXCIsIFwic2VjcmV0c21hbmFnZXI6RGVzY3JpYmVTZWNyZXRcIl0sXG4gICAgICAgICAgICBbcGVybWlzc2lvbi5jZGsuY2x1c3Rlci5zZWNyZXQuc2VjcmV0QXJuXVxuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHBlcm1pc3Npb24gaW5zdGFuY2VvZiBGdW5jdGlvbikge1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcImxhbWJkYToqXCIsIFtwZXJtaXNzaW9uLmZ1bmN0aW9uQXJuXSkpO1xuICAgIH1cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDYXNlOiBDREsgY29uc3RydWN0c1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGVsc2UgaWYgKChwZXJtaXNzaW9uIGFzIGFueSkudGFibGVBcm4gJiYgKHBlcm1pc3Npb24gYXMgYW55KS50YWJsZU5hbWUpIHtcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgV2UgZG8gbm90IHdhbnQgdG8gaW1wb3J0IHRoZSBjZGsgbW9kdWxlcywganVzdCBjYXN0IHRvIGFueVxuICAgICAgY29uc3QgdGFibGVBcm4gPSBwZXJtaXNzaW9uLnRhYmxlQXJuO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcImR5bmFtb2RiOipcIiwgW3RhYmxlQXJuLCBgJHt0YWJsZUFybn0vKmBdKSk7XG4gICAgfSBlbHNlIGlmICgocGVybWlzc2lvbiBhcyBhbnkpLnRvcGljQXJuICYmIChwZXJtaXNzaW9uIGFzIGFueSkudG9waWNOYW1lKSB7XG4gICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIFdlIGRvIG5vdCB3YW50IHRvIGltcG9ydCB0aGUgY2RrIG1vZHVsZXMsIGp1c3QgY2FzdCB0byBhbnlcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJzbnM6KlwiLCBbcGVybWlzc2lvbi50b3BpY0Fybl0pKTtcbiAgICB9IGVsc2UgaWYgKChwZXJtaXNzaW9uIGFzIGFueSkucXVldWVBcm4gJiYgKHBlcm1pc3Npb24gYXMgYW55KS5xdWV1ZU5hbWUpIHtcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgV2UgZG8gbm90IHdhbnQgdG8gaW1wb3J0IHRoZSBjZGsgbW9kdWxlcywganVzdCBjYXN0IHRvIGFueVxuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcInNxczoqXCIsIFtwZXJtaXNzaW9uLnF1ZXVlQXJuXSkpO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICAocGVybWlzc2lvbiBhcyBhbnkpLmV2ZW50QnVzQXJuICYmXG4gICAgICAocGVybWlzc2lvbiBhcyBhbnkpLmV2ZW50QnVzTmFtZVxuICAgICkge1xuICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBXZSBkbyBub3Qgd2FudCB0byBpbXBvcnQgdGhlIGNkayBtb2R1bGVzLCBqdXN0IGNhc3QgdG8gYW55XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwiZXZlbnRzOipcIiwgW3Blcm1pc3Npb24uZXZlbnRCdXNBcm5dKSk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIChwZXJtaXNzaW9uIGFzIGFueSkuc3RyZWFtQXJuICYmXG4gICAgICAocGVybWlzc2lvbiBhcyBhbnkpLnN0cmVhbU5hbWVcbiAgICApIHtcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgV2UgZG8gbm90IHdhbnQgdG8gaW1wb3J0IHRoZSBjZGsgbW9kdWxlcywganVzdCBjYXN0IHRvIGFueVxuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcImtpbmVzaXM6KlwiLCBbcGVybWlzc2lvbi5zdHJlYW1Bcm5dKSk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIChwZXJtaXNzaW9uIGFzIGFueSkuZGVsaXZlcnlTdHJlYW1Bcm4gJiZcbiAgICAgIChwZXJtaXNzaW9uIGFzIGFueSkuZGVsaXZlcnlTdHJlYW1OYW1lXG4gICAgKSB7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICBidWlsZFBvbGljeShcImZpcmVob3NlOipcIiwgWyhwZXJtaXNzaW9uIGFzIGFueSkuZGVsaXZlcnlTdHJlYW1Bcm5dKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgKHBlcm1pc3Npb24gYXMgYW55KS5idWNrZXRBcm4gJiZcbiAgICAgIChwZXJtaXNzaW9uIGFzIGFueSkuYnVja2V0TmFtZVxuICAgICkge1xuICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBXZSBkbyBub3Qgd2FudCB0byBpbXBvcnQgdGhlIGNkayBtb2R1bGVzLCBqdXN0IGNhc3QgdG8gYW55XG4gICAgICBjb25zdCBidWNrZXRBcm4gPSBwZXJtaXNzaW9uLmJ1Y2tldEFybjtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJzMzoqXCIsIFtidWNrZXRBcm4sIGAke2J1Y2tldEFybn0vKmBdKSk7XG4gICAgfSBlbHNlIGlmICgocGVybWlzc2lvbiBhcyBhbnkpLmNsdXN0ZXJBcm4pIHtcbiAgICAgIC8vIEZvciBTZXJ2ZXJsZXNzQ2x1c3Rlciwgd2UgbmVlZCB0byBncmFudDpcbiAgICAgIC8vIC0gcGVybWlzc3Npb25zIHRvIGFjY2VzcyB0aGUgRGF0YSBBUEk7XG4gICAgICAvLyAtIHBlcm1pc3NzaW9ucyB0byBhY2Nlc3MgdGhlIFNlY3JldCBNYW5hZ2VyIChyZXF1aXJlZCBieSBEYXRhIEFQSSkuXG4gICAgICAvLyBObyBuZWVkIHRvIGdyYW50IHRoZSBwZXJtaXNzaW9ucyBmb3IgSUFNIGRhdGFiYXNlIGF1dGhlbnRpY2F0aW9uXG4gICAgICByb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICBidWlsZFBvbGljeShcInJkcy1kYXRhOipcIiwgWyhwZXJtaXNzaW9uIGFzIGFueSkuY2x1c3RlckFybl0pXG4gICAgICApO1xuICAgICAgY29uc3Qgc2VjcmV0ID0gKHBlcm1pc3Npb24gYXMgYW55KS5zZWNyZXQ7XG4gICAgICBpZiAoc2VjcmV0KSB7XG4gICAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgICAgYnVpbGRQb2xpY3koXG4gICAgICAgICAgICBbXCJzZWNyZXRzbWFuYWdlcjpHZXRTZWNyZXRWYWx1ZVwiLCBcInNlY3JldHNtYW5hZ2VyOkRlc2NyaWJlU2VjcmV0XCJdLFxuICAgICAgICAgICAgW3NlY3JldC5zZWNyZXRBcm5dXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDYXNlOiBncmFudCBtZXRob2RcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBlbHNlIGlmIChcbiAgICAgIEFycmF5LmlzQXJyYXkocGVybWlzc2lvbikgJiZcbiAgICAgIHBlcm1pc3Npb24ubGVuZ3RoID09PSAyICYmXG4gICAgICBpc0NES0NvbnN0cnVjdChwZXJtaXNzaW9uWzBdKSAmJlxuICAgICAgdHlwZW9mIHBlcm1pc3Npb25bMV0gPT09IFwic3RyaW5nXCJcbiAgICApIHtcbiAgICAgIGNvbnN0IGNvbnN0cnVjdCA9IHBlcm1pc3Npb25bMF0gYXMgQ29uc3RydWN0O1xuICAgICAgY29uc3QgbWV0aG9kTmFtZSA9IHBlcm1pc3Npb25bMV0gYXMga2V5b2YgQ29uc3RydWN0O1xuICAgICAgaWYgKHR5cGVvZiBjb25zdHJ1Y3RbbWV0aG9kTmFtZV0gIT09IFwiZnVuY3Rpb25cIilcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBUaGUgc3BlY2lmaWVkIGdyYW50IG1ldGhvZCBpcyBpbmNvcnJlY3QuXG4gICAgICAgICAgQ2hlY2sgdGhlIGF2YWlsYWJsZSBtZXRob2RzIHRoYXQgcHJlZml4ZWQgd2l0aCBncmFudHMgb24gdGhlIENvbnN0cnVjdGBcbiAgICAgICAgKTtcbiAgICAgIChjb25zdHJ1Y3RbbWV0aG9kTmFtZV0gYXMgeyAoY29uc3RydWN0OiBDb25zdHJ1Y3QpOiB2b2lkIH0pKHJvbGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIuZGVidWcoXCJwZXJtaXNzaW9uIG9iamVjdFwiLCBwZXJtaXNzaW9uKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHNwZWNpZmllZCBwZXJtaXNzaW9ucyBhcmUgbm90IHN1cHBvcnRlZC5gKTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBidWlsZFBvbGljeShcbiAgYWN0aW9uczogc3RyaW5nIHwgc3RyaW5nW10sXG4gIHJlc291cmNlczogc3RyaW5nW11cbik6IGlhbS5Qb2xpY3lTdGF0ZW1lbnQge1xuICByZXR1cm4gbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICBhY3Rpb25zOiB0eXBlb2YgYWN0aW9ucyA9PT0gXCJzdHJpbmdcIiA/IFthY3Rpb25zXSA6IGFjdGlvbnMsXG4gICAgcmVzb3VyY2VzLFxuICB9KTtcbn1cbiJdfQ==