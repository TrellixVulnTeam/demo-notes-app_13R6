"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildCustomDomainData = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const route53 = __importStar(require("aws-cdk-lib/aws-route53"));
const acm = __importStar(require("aws-cdk-lib/aws-certificatemanager"));
function buildCustomDomainData(scope, customDomain) {
    if (customDomain === undefined) {
        return;
    }
    // customDomain is a string
    else if (typeof customDomain === "string") {
        return buildDataForStringInput(scope, customDomain);
    }
    // customDomain.domainName is a string
    else if (customDomain.domainName) {
        return customDomain.isExternalDomain
            ? buildDataForExternalDomainInput(scope, customDomain)
            : buildDataForInternalDomainInput(scope, customDomain);
    }
    // customDomain.domainName not exists
    throw new Error(`Missing "domainName" in sst.AppSyncApi's customDomain setting`);
}
exports.buildCustomDomainData = buildCustomDomainData;
function buildDataForStringInput(scope, customDomain) {
    // validate: customDomain is a TOKEN string
    // ie. imported SSM value: ssm.StringParameter.valueForStringParameter()
    if (aws_cdk_lib_1.Token.isUnresolved(customDomain)) {
        throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
    }
    assertDomainNameIsLowerCase(customDomain);
    const domainName = customDomain;
    const hostedZoneDomain = domainName.split(".").slice(1).join(".");
    const hostedZone = lookupHostedZone(scope, hostedZoneDomain);
    const certificate = createCertificate(scope, domainName, hostedZone);
    createRecord(scope, hostedZone, domainName);
    return {
        certificate,
        domainName,
    };
}
function buildDataForInternalDomainInput(scope, customDomain) {
    var _a, _b;
    // If customDomain is a TOKEN string, "hostedZone" has to be passed in. This
    // is because "hostedZone" cannot be parsed from a TOKEN value.
    if (aws_cdk_lib_1.Token.isUnresolved(customDomain.domainName)) {
        if (!customDomain.hostedZone) {
            throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
        }
    }
    else {
        assertDomainNameIsLowerCase(customDomain.domainName);
    }
    const domainName = customDomain.domainName;
    // Lookup hosted zone
    // Note: Allow user passing in `hostedZone` object. The use case is when
    //       there are multiple HostedZones with the same domain, but one is
    //       public, and one is private.
    let hostedZone;
    if (customDomain.hostedZone) {
        const hostedZoneDomain = customDomain.hostedZone;
        hostedZone = lookupHostedZone(scope, hostedZoneDomain);
    }
    else if ((_a = customDomain.cdk) === null || _a === void 0 ? void 0 : _a.hostedZone) {
        hostedZone = customDomain.cdk.hostedZone;
    }
    else {
        const hostedZoneDomain = domainName.split(".").slice(1).join(".");
        hostedZone = lookupHostedZone(scope, hostedZoneDomain);
    }
    // Create certificate
    // Note: Allow user passing in `certificate` object. The use case is for
    //       user to create wildcard certificate or using an imported certificate.
    const certificate = ((_b = customDomain.cdk) === null || _b === void 0 ? void 0 : _b.certificate)
        ? customDomain.cdk.certificate
        : createCertificate(scope, domainName, hostedZone);
    createRecord(scope, hostedZone, domainName);
    return {
        certificate,
        domainName,
    };
}
function buildDataForExternalDomainInput(scope, customDomain) {
    var _a, _b;
    // if it is external, then a certificate is required
    if (!((_a = customDomain.cdk) === null || _a === void 0 ? void 0 : _a.certificate)) {
        throw new Error(`A valid certificate is required when "isExternalDomain" is set to "true".`);
    }
    // if it is external, then the hostedZone is not required
    if (customDomain.hostedZone || ((_b = customDomain.cdk) === null || _b === void 0 ? void 0 : _b.hostedZone)) {
        throw new Error(`Hosted zones can only be configured for domains hosted on Amazon Route 53. Do not set the "hostedZone" when "isExternalDomain" is enabled.`);
    }
    const domainName = customDomain.domainName;
    assertDomainNameIsLowerCase(domainName);
    const certificate = customDomain.cdk.certificate;
    return {
        certificate,
        domainName,
    };
}
function lookupHostedZone(scope, hostedZoneDomain) {
    return route53.HostedZone.fromLookup(scope, "HostedZone", {
        domainName: hostedZoneDomain,
    });
}
function createCertificate(scope, domainName, hostedZone) {
    return new acm.Certificate(scope, "Certificate", {
        domainName,
        validation: acm.CertificateValidation.fromDns(hostedZone),
    });
}
function createRecord(scope, hostedZone, domainName) {
    // create DNS record
    const record = new route53.CnameRecord(scope, "CnameRecord", {
        recordName: domainName,
        zone: hostedZone,
        domainName: aws_cdk_lib_1.Lazy.string({
            produce() {
                return scope._cfnDomainName.attrAppSyncDomainName;
            },
        }),
    });
    // note: If domainName is a TOKEN string ie. ${TOKEN..}, the route53.ARecord
    //       construct will append ".${hostedZoneName}" to the end of the domain.
    //       This is because the construct tries to check if the record name
    //       ends with the domain name. If not, it will append the domain name.
    //       So, we need remove this behavior.
    if (aws_cdk_lib_1.Token.isUnresolved(domainName)) {
        const cfnRecord = record.node.defaultChild;
        cfnRecord.name = domainName;
    }
}
function assertDomainNameIsLowerCase(domainName) {
    if (domainName !== domainName.toLowerCase()) {
        throw new Error(`The domain name needs to be in lowercase`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwU3luY0FwaURvbWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL2FwcFN5bmNBcGlEb21haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSw2Q0FBMEM7QUFDMUMsaUVBQW1EO0FBRW5ELHdFQUEwRDtBQTRCMUQsU0FBZ0IscUJBQXFCLENBQ25DLEtBQWlCLEVBQ2pCLFlBQW9EO0lBRXBELElBQUksWUFBWSxLQUFLLFNBQVMsRUFBRTtRQUM5QixPQUFPO0tBQ1I7SUFDRCwyQkFBMkI7U0FDdEIsSUFBSSxPQUFPLFlBQVksS0FBSyxRQUFRLEVBQUU7UUFDekMsT0FBTyx1QkFBdUIsQ0FBQyxLQUFLLEVBQUUsWUFBWSxDQUFDLENBQUM7S0FDckQ7SUFDRCxzQ0FBc0M7U0FDakMsSUFBSSxZQUFZLENBQUMsVUFBVSxFQUFFO1FBQ2hDLE9BQU8sWUFBWSxDQUFDLGdCQUFnQjtZQUNsQyxDQUFDLENBQUMsK0JBQStCLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQztZQUN0RCxDQUFDLENBQUMsK0JBQStCLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDO0tBQzFEO0lBQ0QscUNBQXFDO0lBQ3JDLE1BQU0sSUFBSSxLQUFLLENBQ2IsK0RBQStELENBQ2hFLENBQUM7QUFDSixDQUFDO0FBckJELHNEQXFCQztBQUVELFNBQVMsdUJBQXVCLENBQzlCLEtBQWlCLEVBQ2pCLFlBQW9CO0lBRXBCLDJDQUEyQztJQUMzQyx3RUFBd0U7SUFDeEUsSUFBSSxtQkFBSyxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsRUFBRTtRQUNwQyxNQUFNLElBQUksS0FBSyxDQUNiLDRGQUE0RixDQUM3RixDQUFDO0tBQ0g7SUFFRCwyQkFBMkIsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUUxQyxNQUFNLFVBQVUsR0FBRyxZQUFZLENBQUM7SUFDaEMsTUFBTSxnQkFBZ0IsR0FBRyxVQUFVLENB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Q0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDO0tBQzdCO0FBQ0gsQ0FBQztBQUVELFNBQVMsMkJBQTJCLENBQUMsVUFBa0I7SUFDckQsSUFBSSxVQUFVLEtBQUssVUFBVSxDQUFDLFdBQVcsRUFBRSxFQUFFO1FBQzNDLE1BQU0sSUFBSSxLQUFLLENBQUMsMENBQTBDLENBQUMsQ0FBQztLQUM3RDtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUb2tlbiwgTGF6eSB9IGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgcm91dGU1MyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXJvdXRlNTNcIjtcbmltcG9ydCAqIGFzIGFwcHN5bmMgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcHBzeW5jLWFscGhhXCI7XG5pbXBvcnQgKiBhcyBhY20gZnJvbSBcImF3cy1jZGstbGliL2F3cy1jZXJ0aWZpY2F0ZW1hbmFnZXJcIjtcbmltcG9ydCB7IEFwcFN5bmNBcGkgfSBmcm9tIFwiLi4vQXBwU3luY0FwaVwiO1xuXG5leHBvcnQgaW50ZXJmYWNlIEN1c3RvbURvbWFpblByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBkb21haW4gdG8gYmUgYXNzaWduZWQgdG8gdGhlIEFQSSBlbmRwb2ludCAoaWUuIGFwaS5kb21haW4uY29tKVxuICAgKi9cbiAgZG9tYWluTmFtZT86IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBob3N0ZWQgem9uZSBpbiBSb3V0ZSA1MyB0aGF0IGNvbnRhaW5zIHRoZSBkb21haW4uIEJ5IGRlZmF1bHQsIFNTVCB3aWxsIGxvb2sgZm9yIGEgaG9zdGVkIHpvbmUgYnkgc3RyaXBwaW5nIG91dCB0aGUgZmlyc3QgcGFydCBvZiB0aGUgZG9tYWluTmFtZSB0aGF0J3MgcGFzc2VkIGluLiBTbywgaWYgeW91ciBkb21haW5OYW1lIGlzIGFwaS5kb21haW4uY29tLiBTU1Qgd2lsbCBkZWZhdWx0IHRoZSBob3N0ZWRab25lIHRvIGRvbWFpbi5jb20uXG4gICAqL1xuICBob3N0ZWRab25lPzogc3RyaW5nO1xuICAvKipcbiAgICogU2V0IHRoaXMgb3B0aW9uIGlmIHRoZSBkb21haW4gaXMgbm90IGhvc3RlZCBvbiBBbWF6b24gUm91dGUgNTMuXG4gICAqL1xuICBpc0V4dGVybmFsRG9tYWluPzogYm9vbGVhbjtcbiAgY2RrPzoge1xuICAgIC8qKlxuICAgICAqIE92ZXJyaWRlIHRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgaG9zdGVkIHpvbmVcbiAgICAgKi9cbiAgICBob3N0ZWRab25lPzogcm91dGU1My5JSG9zdGVkWm9uZTtcbiAgICAvKipcbiAgICAgKiBPdmVycmlkZSB0aGUgaW50ZXJuYWxseSBjcmVhdGVkIGNlcnRpZmljYXRlXG4gICAgICovXG4gICAgY2VydGlmaWNhdGU/OiBhY20uSUNlcnRpZmljYXRlO1xuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRDdXN0b21Eb21haW5EYXRhKFxuICBzY29wZTogQXBwU3luY0FwaSxcbiAgY3VzdG9tRG9tYWluOiBzdHJpbmcgfCBDdXN0b21Eb21haW5Qcm9wcyB8IHVuZGVmaW5lZFxuKTogYXBwc3luYy5Eb21haW5PcHRpb25zIHwgdW5kZWZpbmVkIHtcbiAgaWYgKGN1c3RvbURvbWFpbiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIC8vIGN1c3RvbURvbWFpbiBpcyBhIHN0cmluZ1xuICBlbHNlIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgcmV0dXJuIGJ1aWxkRGF0YUZvclN0cmluZ0lucHV0KHNjb3BlLCBjdXN0b21Eb21haW4pO1xuICB9XG4gIC8vIGN1c3RvbURvbWFpbi5kb21haW5OYW1lIGlzIGEgc3RyaW5nXG4gIGVsc2UgaWYgKGN1c3RvbURvbWFpbi5kb21haW5OYW1lKSB7XG4gICAgcmV0dXJuIGN1c3RvbURvbWFpbi5pc0V4dGVybmFsRG9tYWluXG4gICAgICA/IGJ1aWxkRGF0YUZvckV4dGVybmFsRG9tYWluSW5wdXQoc2NvcGUsIGN1c3RvbURvbWFpbilcbiAgICAgIDogYnVpbGREYXRhRm9ySW50ZXJuYWxEb21haW5JbnB1dChzY29wZSwgY3VzdG9tRG9tYWluKTtcbiAgfVxuICAvLyBjdXN0b21Eb21haW4uZG9tYWluTmFtZSBub3QgZXhpc3RzXG4gIHRocm93IG5ldyBFcnJvcihcbiAgICBgTWlzc2luZyBcImRvbWFpbk5hbWVcIiBpbiBzc3QuQXBwU3luY0FwaSdzIGN1c3RvbURvbWFpbiBzZXR0aW5nYFxuICApO1xufVxuXG5mdW5jdGlvbiBidWlsZERhdGFGb3JTdHJpbmdJbnB1dChcbiAgc2NvcGU6IEFwcFN5bmNBcGksXG4gIGN1c3RvbURvbWFpbjogc3RyaW5nXG4pOiBhcHBzeW5jLkRvbWFpbk9wdGlvbnMge1xuICAvLyB2YWxpZGF0ZTogY3VzdG9tRG9tYWluIGlzIGEgVE9LRU4gc3RyaW5nXG4gIC8vIGllLiBpbXBvcnRlZCBTU00gdmFsdWU6IHNzbS5TdHJpbmdQYXJhbWV0ZXIudmFsdWVGb3JTdHJpbmdQYXJhbWV0ZXIoKVxuICBpZiAoVG9rZW4uaXNVbnJlc29sdmVkKGN1c3RvbURvbWFpbikpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgWW91IGFsc28gbmVlZCB0byBzcGVjaWZ5IHRoZSBcImhvc3RlZFpvbmVcIiBpZiB0aGUgXCJkb21haW5OYW1lXCIgaXMgcGFzc2VkIGluIGFzIGEgcmVmZXJlbmNlLmBcbiAgICApO1xuICB9XG5cbiAgYXNzZXJ0RG9tYWluTmFtZUlzTG93ZXJDYXNlKGN1c3RvbURvbWFpbik7XG5cbiAgY29uc3QgZG9tYWluTmFtZSA9IGN1c3RvbURvbWFpbjtcbiAgY29uc3QgaG9zdGVkWm9uZURvbWFpbiA9IGRvbWFpbk5hbWUuc3BsaXQoXCIuXCIpLnNsaWNlKDEpLmpvaW4oXCIuXCIpO1xuICBjb25zdCBob3N0ZWRab25lID0gbG9va3VwSG9zdGVkWm9uZShzY29wZSwgaG9zdGVkWm9uZURvbWFpbik7XG4gIGNvbnN0IGNlcnRpZmljYXRlID0gY3JlYXRlQ2VydGlmaWNhdGUoc2NvcGUsIGRvbWFpbk5hbWUsIGhvc3RlZFpvbmUpO1xuICBjcmVhdGVSZWNvcmQoc2NvcGUsIGhvc3RlZFpvbmUsIGRvbWFpbk5hbWUpO1xuXG4gIHJldHVybiB7XG4gICAgY2VydGlmaWNhdGUsXG4gICAgZG9tYWluTmFtZSxcbiAgfTtcbn1cblxuZnVuY3Rpb24gYnVpbGREYXRhRm9ySW50ZXJuYWxEb21haW5JbnB1dChcbiAgc2NvcGU6IEFwcFN5bmNBcGksXG4gIGN1c3RvbURvbWFpbjogQ3VzdG9tRG9tYWluUHJvcHNcbik6IGFwcHN5bmMuRG9tYWluT3B0aW9ucyB7XG4gIC8vIElmIGN1c3RvbURvbWFpbiBpcyBhIFRPS0VOIHN0cmluZywgXCJob3N0ZWRab25lXCIgaGFzIHRvIGJlIHBhc3NlZCBpbi4gVGhpc1xuICAvLyBpcyBiZWNhdXNlIFwiaG9zdGVkWm9uZVwiIGNhbm5vdCBiZSBwYXJzZWQgZnJvbSBhIFRPS0VOIHZhbHVlLlxuICBpZiAoVG9rZW4uaXNVbnJlc29sdmVkKGN1c3RvbURvbWFpbi5kb21haW5OYW1lKSkge1xuICAgIGlmICghY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFlvdSBhbHNvIG5lZWQgdG8gc3BlY2lmeSB0aGUgXCJob3N0ZWRab25lXCIgaWYgdGhlIFwiZG9tYWluTmFtZVwiIGlzIHBhc3NlZCBpbiBhcyBhIHJlZmVyZW5jZS5gXG4gICAgICApO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBhc3NlcnREb21haW5OYW1lSXNMb3dlckNhc2UoY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUgYXMgc3RyaW5nKTtcbiAgfVxuXG4gIGNvbnN0IGRvbWFpbk5hbWUgPSBjdXN0b21Eb21haW4uZG9tYWluTmFtZSBhcyBzdHJpbmc7XG5cbiAgLy8gTG9va3VwIGhvc3RlZCB6b25lXG4gIC8vIE5vdGU6IEFsbG93IHVzZXIgcGFzc2luZyBpbiBgaG9zdGVkWm9uZWAgb2JqZWN0LiBUaGUgdXNlIGNhc2UgaXMgd2hlblxuICAvLyAgICAgICB0aGVyZSBhcmUgbXVsdGlwbGUgSG9zdGVkWm9uZXMgd2l0aCB0aGUgc2FtZSBkb21haW4sIGJ1dCBvbmUgaXNcbiAgLy8gICAgICAgcHVibGljLCBhbmQgb25lIGlzIHByaXZhdGUuXG4gIGxldCBob3N0ZWRab25lOiByb3V0ZTUzLklIb3N0ZWRab25lO1xuICBpZiAoY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUpIHtcbiAgICBjb25zdCBob3N0ZWRab25lRG9tYWluID0gY3VzdG9tRG9tYWluLmhvc3RlZFpvbmU7XG4gICAgaG9zdGVkWm9uZSA9IGxvb2t1cEhvc3RlZFpvbmUoc2NvcGUsIGhvc3RlZFpvbmVEb21haW4pO1xuICB9IGVsc2UgaWYgKGN1c3RvbURvbWFpbi5jZGs/Lmhvc3RlZFpvbmUpIHtcbiAgICBob3N0ZWRab25lID0gY3VzdG9tRG9tYWluLmNkay5ob3N0ZWRab25lO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IGhvc3RlZFpvbmVEb21haW4gPSBkb21haW5OYW1lLnNwbGl0KFwiLlwiKS5zbGljZSgxKS5qb2luKFwiLlwiKTtcbiAgICBob3N0ZWRab25lID0gbG9va3VwSG9zdGVkWm9uZShzY29wZSwgaG9zdGVkWm9uZURvbWFpbik7XG4gIH1cblxuICAvLyBDcmVhdGUgY2VydGlmaWNhdGVcbiAgLy8gTm90ZTogQWxsb3cgdXNlciBwYXNzaW5nIGluIGBjZXJ0aWZpY2F0ZWAgb2JqZWN0LiBUaGUgdXNlIGNhc2UgaXMgZm9yXG4gIC8vICAgICAgIHVzZXIgdG8gY3JlYXRlIHdpbGRjYXJkIGNlcnRpZmljYXRlIG9yIHVzaW5nIGFuIGltcG9ydGVkIGNlcnRpZmljYXRlLlxuICBjb25zdCBjZXJ0aWZpY2F0ZSA9IGN1c3RvbURvbWFpbi5jZGs/LmNlcnRpZmljYXRlXG4gICAgPyBjdXN0b21Eb21haW4uY2RrLmNlcnRpZmljYXRlXG4gICAgOiBjcmVhdGVDZXJ0aWZpY2F0ZShzY29wZSwgZG9tYWluTmFtZSwgaG9zdGVkWm9uZSk7XG5cbiAgY3JlYXRlUmVjb3JkKHNjb3BlLCBob3N0ZWRab25lLCBkb21haW5OYW1lKTtcblxuICByZXR1cm4ge1xuICAgIGNlcnRpZmljYXRlLFxuICAgIGRvbWFpbk5hbWUsXG4gIH07XG59XG5cbmZ1bmN0aW9uIGJ1aWxkRGF0YUZvckV4dGVybmFsRG9tYWluSW5wdXQoXG4gIHNjb3BlOiBBcHBTeW5jQXBpLFxuICBjdXN0b21Eb21haW46IEN1c3RvbURvbWFpblByb3BzXG4pOiBhcHBzeW5jLkRvbWFpbk9wdGlvbnMge1xuICAvLyBpZiBpdCBpcyBleHRlcm5hbCwgdGhlbiBhIGNlcnRpZmljYXRlIGlzIHJlcXVpcmVkXG4gIGlmICghY3VzdG9tRG9tYWluLmNkaz8uY2VydGlmaWNhdGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgQSB2YWxpZCBjZXJ0aWZpY2F0ZSBpcyByZXF1aXJlZCB3aGVuIFwiaXNFeHRlcm5hbERvbWFpblwiIGlzIHNldCB0byBcInRydWVcIi5gXG4gICAgKTtcbiAgfVxuICAvLyBpZiBpdCBpcyBleHRlcm5hbCwgdGhlbiB0aGUgaG9zdGVkWm9uZSBpcyBub3QgcmVxdWlyZWRcbiAgaWYgKGN1c3RvbURvbWFpbi5ob3N0ZWRab25lIHx8IGN1c3RvbURvbWFpbi5jZGs/Lmhvc3RlZFpvbmUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgSG9zdGVkIHpvbmVzIGNhbiBvbmx5IGJlIGNvbmZpZ3VyZWQgZm9yIGRvbWFpbnMgaG9zdGVkIG9uIEFtYXpvbiBSb3V0ZSA1My4gRG8gbm90IHNldCB0aGUgXCJob3N0ZWRab25lXCIgd2hlbiBcImlzRXh0ZXJuYWxEb21haW5cIiBpcyBlbmFibGVkLmBcbiAgICApO1xuICB9XG5cbiAgY29uc3QgZG9tYWluTmFtZSA9IGN1c3RvbURvbWFpbi5kb21haW5OYW1lIGFzIHN0cmluZztcbiAgYXNzZXJ0RG9tYWluTmFtZUlzTG93ZXJDYXNlKGRvbWFpbk5hbWUpO1xuICBjb25zdCBjZXJ0aWZpY2F0ZSA9IGN1c3RvbURvbWFpbi5jZGsuY2VydGlmaWNhdGU7XG5cbiAgcmV0dXJuIHtcbiAgICBjZXJ0aWZpY2F0ZSxcbiAgICBkb21haW5OYW1lLFxuICB9O1xufVxuXG5mdW5jdGlvbiBsb29rdXBIb3N0ZWRab25lKHNjb3BlOiBBcHBTeW5jQXBpLCBob3N0ZWRab25lRG9tYWluOiBzdHJpbmcpIHtcbiAgcmV0dXJuIHJvdXRlNTMuSG9zdGVkWm9uZS5mcm9tTG9va3VwKHNjb3BlLCBcIkhvc3RlZFpvbmVcIiwge1xuICAgIGRvbWFpbk5hbWU6IGhvc3RlZFpvbmVEb21haW4sXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVDZXJ0aWZpY2F0ZShcbiAgc2NvcGU6IEFwcFN5bmNBcGksXG4gIGRvbWFpbk5hbWU6IHN0cmluZyxcbiAgaG9zdGVkWm9uZTogcm91dGU1My5JSG9zdGVkWm9uZVxuKSB7XG4gIHJldHVybiBuZXcgYWNtLkNlcnRpZmljYXRlKHNjb3BlLCBcIkNlcnRpZmljYXRlXCIsIHtcbiAgICBkb21haW5OYW1lLFxuICAgIHZhbGlkYXRpb246IGFjbS5DZXJ0aWZpY2F0ZVZhbGlkYXRpb24uZnJvbURucyhob3N0ZWRab25lKSxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVJlY29yZChcbiAgc2NvcGU6IEFwcFN5bmNBcGksXG4gIGhvc3RlZFpvbmU6IHJvdXRlNTMuSUhvc3RlZFpvbmUsXG4gIGRvbWFpbk5hbWU6IHN0cmluZ1xuKSB7XG4gIC8vIGNyZWF0ZSBETlMgcmVjb3JkXG4gIGNvbnN0IHJlY29yZCA9IG5ldyByb3V0ZTUzLkNuYW1lUmVjb3JkKHNjb3BlLCBcIkNuYW1lUmVjb3JkXCIsIHtcbiAgICByZWNvcmROYW1lOiBkb21haW5OYW1lLFxuICAgIHpvbmU6IGhvc3RlZFpvbmUsXG4gICAgZG9tYWluTmFtZTogTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZSgpIHtcbiAgICAgICAgcmV0dXJuIHNjb3BlLl9jZm5Eb21haW5OYW1lIS5hdHRyQXBwU3luY0RvbWFpbk5hbWU7XG4gICAgICB9LFxuICAgIH0pLFxuICB9KTtcblxuICAvLyBub3RlOiBJZiBkb21haW5OYW1lIGlzIGEgVE9LRU4gc3RyaW5nIGllLiAke1RPS0VOLi59LCB0aGUgcm91dGU1My5BUmVjb3JkXG4gIC8vICAgICAgIGNvbnN0cnVjdCB3aWxsIGFwcGVuZCBcIi4ke2hvc3RlZFpvbmVOYW1lfVwiIHRvIHRoZSBlbmQgb2YgdGhlIGRvbWFpbi5cbiAgLy8gICAgICAgVGhpcyBpcyBiZWNhdXNlIHRoZSBjb25zdHJ1Y3QgdHJpZXMgdG8gY2hlY2sgaWYgdGhlIHJlY29yZCBuYW1lXG4gIC8vICAgICAgIGVuZHMgd2l0aCB0aGUgZG9tYWluIG5hbWUuIElmIG5vdCwgaXQgd2lsbCBhcHBlbmQgdGhlIGRvbWFpbiBuYW1lLlxuICAvLyAgICAgICBTbywgd2UgbmVlZCByZW1vdmUgdGhpcyBiZWhhdmlvci5cbiAgaWYgKFRva2VuLmlzVW5yZXNvbHZlZChkb21haW5OYW1lKSkge1xuICAgIGNvbnN0IGNmblJlY29yZCA9IHJlY29yZC5ub2RlLmRlZmF1bHRDaGlsZCBhcyByb3V0ZTUzLkNmblJlY29yZFNldDtcbiAgICBjZm5SZWNvcmQubmFtZSA9IGRvbWFpbk5hbWU7XG4gIH1cbn1cblxuZnVuY3Rpb24gYXNzZXJ0RG9tYWluTmFtZUlzTG93ZXJDYXNlKGRvbWFpbk5hbWU6IHN0cmluZyk6IHZvaWQge1xuICBpZiAoZG9tYWluTmFtZSAhPT0gZG9tYWluTmFtZS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgZG9tYWluIG5hbWUgbmVlZHMgdG8gYmUgaW4gbG93ZXJjYXNlYCk7XG4gIH1cbn1cbiJdfQ==