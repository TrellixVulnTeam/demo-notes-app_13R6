"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildCustomDomainData = void 0;
const cdk = __importStar(require("aws-cdk-lib"));
const apig = __importStar(require("@aws-cdk/aws-apigatewayv2-alpha"));
const route53 = __importStar(require("aws-cdk-lib/aws-route53"));
const route53Targets = __importStar(require("aws-cdk-lib/aws-route53-targets"));
const acm = __importStar(require("aws-cdk-lib/aws-certificatemanager"));
function buildCustomDomainData(scope, customDomain) {
    var _a;
    if (customDomain === undefined) {
        return;
    }
    // customDomain is a string
    else if (typeof customDomain === "string") {
        return buildDataForStringInput(scope, customDomain);
    }
    // customDomain.domainName is a string
    else if (customDomain.domainName) {
        return customDomain.isExternalDomain
            ? buildDataForExternalDomainInput(scope, customDomain)
            : buildDataForInternalDomainInput(scope, customDomain);
    }
    // customDomain.domainName is a construct
    else if ((_a = customDomain.cdk) === null || _a === void 0 ? void 0 : _a.domainName) {
        return buildDataForConstructInput(scope, customDomain);
    }
    // customDomain.domainName not exists
    throw new Error(`Missing "domainName" in sst.Api's customDomain setting`);
}
exports.buildCustomDomainData = buildCustomDomainData;
function buildDataForStringInput(scope, customDomain) {
    // validate: customDomain is a TOKEN string
    // ie. imported SSM value: ssm.StringParameter.valueForStringParameter()
    if (cdk.Token.isUnresolved(customDomain)) {
        throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
    }
    assertDomainNameIsLowerCase(customDomain);
    const domainName = customDomain;
    const hostedZoneDomain = domainName.split(".").slice(1).join(".");
    const hostedZone = lookupHostedZone(scope, hostedZoneDomain);
    const certificate = createCertificate(scope, domainName, hostedZone);
    const apigDomain = createApigDomain(scope, domainName, certificate);
    createARecords(scope, hostedZone, domainName, apigDomain);
    return {
        apigDomain,
        certificate,
        isApigDomainCreated: true,
        isCertificatedCreated: true,
        url: buildDomainUrl(domainName),
    };
}
function buildDataForInternalDomainInput(scope, customDomain) {
    var _a, _b;
    // If customDomain is a TOKEN string, "hostedZone" has to be passed in. This
    // is because "hostedZone" cannot be parsed from a TOKEN value.
    if (cdk.Token.isUnresolved(customDomain.domainName)) {
        if (!customDomain.hostedZone) {
            throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
        }
    }
    else {
        assertDomainNameIsLowerCase(customDomain.domainName);
    }
    const domainName = customDomain.domainName;
    // Lookup hosted zone
    // Note: Allow user passing in `hostedZone` object. The use case is when
    //       there are multiple HostedZones with the same domain, but one is
    //       public, and one is private.
    let hostedZone;
    if (customDomain.hostedZone) {
        const hostedZoneDomain = customDomain.hostedZone;
        hostedZone = lookupHostedZone(scope, hostedZoneDomain);
    }
    else if ((_a = customDomain.cdk) === null || _a === void 0 ? void 0 : _a.hostedZone) {
        hostedZone = customDomain.cdk.hostedZone;
    }
    else {
        const hostedZoneDomain = domainName.split(".").slice(1).join(".");
        hostedZone = lookupHostedZone(scope, hostedZoneDomain);
    }
    // Create certificate
    // Note: Allow user passing in `certificate` object. The use case is for
    //       user to create wildcard certificate or using an imported certificate.
    let certificate;
    let isCertificatedCreated;
    if ((_b = customDomain.cdk) === null || _b === void 0 ? void 0 : _b.certificate) {
        certificate = customDomain.cdk.certificate;
        isCertificatedCreated = false;
    }
    else {
        certificate = createCertificate(scope, domainName, hostedZone);
        isCertificatedCreated = true;
    }
    const apigDomain = createApigDomain(scope, domainName, certificate);
    const mappingKey = customDomain.path;
    createARecords(scope, hostedZone, domainName, apigDomain);
    return {
        apigDomain,
        mappingKey,
        certificate,
        isApigDomainCreated: true,
        isCertificatedCreated,
        url: buildDomainUrl(domainName, mappingKey),
    };
}
function buildDataForExternalDomainInput(scope, customDomain) {
    var _a, _b;
    // if it is external, then a certificate is required
    if (!((_a = customDomain.cdk) === null || _a === void 0 ? void 0 : _a.certificate)) {
        throw new Error(`A valid certificate is required when "isExternalDomain" is set to "true".`);
    }
    // if it is external, then the hostedZone is not required
    if (customDomain.hostedZone || ((_b = customDomain.cdk) === null || _b === void 0 ? void 0 : _b.hostedZone)) {
        throw new Error(`Hosted zones can only be configured for domains hosted on Amazon Route 53. Do not set the "hostedZone" when "isExternalDomain" is enabled.`);
    }
    const domainName = customDomain.domainName;
    assertDomainNameIsLowerCase(domainName);
    const certificate = customDomain.cdk.certificate;
    const apigDomain = createApigDomain(scope, domainName, certificate);
    const mappingKey = customDomain.path;
    return {
        apigDomain,
        mappingKey,
        certificate,
        isApigDomainCreated: true,
        isCertificatedCreated: false,
        url: buildDomainUrl(domainName, mappingKey),
    };
}
function buildDataForConstructInput(scope, customDomain) {
    //  Allow user passing in `apigDomain` object. The use case is a user creates
    //  multiple API endpoints, and is mapping them under the same custom domain.
    //  `sst.Api` needs to expose the `apigDomain` construct created in the first
    //  Api, and lets user pass it in when creating the second Api.
    var _a, _b, _c;
    if (customDomain.hostedZone || ((_a = customDomain.cdk) === null || _a === void 0 ? void 0 : _a.hostedZone)) {
        throw new Error(`Cannot configure the "hostedZone" when the "domainName" is a construct`);
    }
    if ((_b = customDomain.cdk) === null || _b === void 0 ? void 0 : _b.certificate) {
        throw new Error(`Cannot configure the "certificate" when the "domainName" is a construct`);
    }
    const apigDomain = (_c = customDomain.cdk) === null || _c === void 0 ? void 0 : _c.domainName;
    const domainName = apigDomain.name;
    const mappingKey = customDomain.path;
    return {
        apigDomain,
        mappingKey,
        certificate: undefined,
        isApigDomainCreated: false,
        isCertificatedCreated: false,
        url: buildDomainUrl(domainName, mappingKey),
    };
}
function lookupHostedZone(scope, hostedZoneDomain) {
    return route53.HostedZone.fromLookup(scope, "HostedZone", {
        domainName: hostedZoneDomain,
    });
}
function createCertificate(scope, domainName, hostedZone) {
    return new acm.Certificate(scope, "Certificate", {
        domainName,
        validation: acm.CertificateValidation.fromDns(hostedZone),
    });
}
function createApigDomain(scope, domainName, certificate) {
    return new apig.DomainName(scope, "DomainName", {
        domainName,
        certificate,
    });
}
function createARecords(scope, hostedZone, domainName, apigDomain) {
    // create DNS record
    const recordProps = {
        recordName: domainName,
        zone: hostedZone,
        target: route53.RecordTarget.fromAlias(new route53Targets.ApiGatewayv2DomainProperties(apigDomain.regionalDomainName, apigDomain.regionalHostedZoneId)),
    };
    const records = [
        new route53.ARecord(scope, "AliasRecord", recordProps),
        new route53.AaaaRecord(scope, "AliasRecordAAAA", recordProps),
    ];
    // note: If domainName is a TOKEN string ie. ${TOKEN..}, the route53.ARecord
    //       construct will append ".${hostedZoneName}" to the end of the domain.
    //       This is because the construct tries to check if the record name
    //       ends with the domain name. If not, it will append the domain name.
    //       So, we need remove this behavior.
    if (cdk.Token.isUnresolved(domainName)) {
        records.forEach((record) => {
            const cfnRecord = record.node.defaultChild;
            cfnRecord.name = domainName;
        });
    }
}
function buildDomainUrl(domainName, mappingKey) {
    // Note: If mapping key is set, the URL needs a trailing slash. Without the
    //       trailing slash, the API fails with the error
    //       {"message":"Not Found"}
    return mappingKey ? `${domainName}/${mappingKey}/` : domainName;
}
function assertDomainNameIsLowerCase(domainName) {
    if (domainName !== domainName.toLowerCase()) {
        throw new Error(`The domain name needs to be in lowercase`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpR2F0ZXdheVYyRG9tYWluLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWwvYXBpR2F0ZXdheVYyRG9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQ0EsaURBQW1DO0FBQ25DLHNFQUF3RDtBQUN4RCxpRUFBbUQ7QUFDbkQsZ0ZBQWtFO0FBQ2xFLHdFQUEwRDtBQThDMUQsU0FBZ0IscUJBQXFCLENBQ25DLEtBQWdCLEVBQ2hCLFlBQW9EOztJQUVwRCxJQUFJLFlBQVksS0FBSyxTQUFTLEVBQUU7UUFDOUIsT0FBTztLQUNSO0lBQ0QsMkJBQTJCO1NBQ3RCLElBQUksT0FBTyxZQUFZLEtBQUssUUFBUSxFQUFFO1FBQ3pDLE9BQU8sdUJBQXVCLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDO0tBQ3JEO0lBQ0Qsc0NBQXNDO1NBQ2pDLElBQUksWUFBWSxDQUFDLFVBQVUsRUFBRTtRQUNoQyxPQUFPLFlBQVksQ0FBQyxnQkFBZ0I7WUFDbEMsQ0FBQyxDQUFDLCtCQUErQixDQUFDLEtBQUssRUFBRSxZQUFZLENBQUM7WUFDdEQsQ0FBQyxDQUFDLCtCQUErQixDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQztLQUMxRDtJQUNELHlDQUF5QztTQUNwQyxJQUFJLE1BQUEsWUFBWSxDQUFDLEdBQUcsMENBQUUsVUFBVSxFQUFFO1FBQ3JDLE9BQU8sMEJBQTBCLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDO0tBQ3hEO0lBQ0QscUNBQXFDO0lBQ3JDLE1BQU0sSUFBSSxLQUFLLENBQUMsd0RBQXdELENBQUMsQ0FBQztBQUM1RSxDQUFDO0FBdkJELHNEQXVCQztBQUVELFNBQVMsdUJBQXVCLENBQzlCLEtBQWdCLEVBQ2hCLFlBQW9CO0lBRXBCLDJDQUEyQztJQUMzQyx3RUFBd0U7SUFDeEUsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxZQUFZ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RSxTQUFTLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQztRQUM5QixDQUFDLENBQUMsQ0FBQztLQUNKO0FBQ0gsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLFVBQWtCLEVBQUUsVUFBbUI7SUFDN0QsMkVBQTJFO0lBQzNFLHFEQUFxRDtJQUNyRCxnQ0FBZ0M7SUFDaEMsT0FBTyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsVUFBVSxJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUM7QUFDbEUsQ0FBQztBQUVELFNBQVMsMkJBQTJCLENBQUMsVUFBa0I7SUFDckQsSUFBSSxVQUFVLEtBQUssVUFBVSxDQUFDLFdBQVcsRUFBRSxFQUFFO1FBQzNDLE1BQU0sSUFBSSxLQUFLLENBQUMsMENBQTBDLENBQUMsQ0FBQztLQUM3RDtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgYXBpZyBmcm9tIFwiQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXl2Mi1hbHBoYVwiO1xuaW1wb3J0ICogYXMgcm91dGU1MyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXJvdXRlNTNcIjtcbmltcG9ydCAqIGFzIHJvdXRlNTNUYXJnZXRzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtcm91dGU1My10YXJnZXRzXCI7XG5pbXBvcnQgKiBhcyBhY20gZnJvbSBcImF3cy1jZGstbGliL2F3cy1jZXJ0aWZpY2F0ZW1hbmFnZXJcIjtcblxuZXhwb3J0IGludGVyZmFjZSBDdXN0b21Eb21haW5Qcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgZG9tYWluIHRvIGJlIGFzc2lnbmVkIHRvIHRoZSBBUEkgZW5kcG9pbnQgKGllLiBhcGkuZG9tYWluLmNvbSlcbiAgICovXG4gIGRvbWFpbk5hbWU/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgaG9zdGVkIHpvbmUgaW4gUm91dGUgNTMgdGhhdCBjb250YWlucyB0aGUgZG9tYWluLiBCeSBkZWZhdWx0LCBTU1Qgd2lsbCBsb29rIGZvciBhIGhvc3RlZCB6b25lIGJ5IHN0cmlwcGluZyBvdXQgdGhlIGZpcnN0IHBhcnQgb2YgdGhlIGRvbWFpbk5hbWUgdGhhdCdzIHBhc3NlZCBpbi4gU28sIGlmIHlvdXIgZG9tYWluTmFtZSBpcyBhcGkuZG9tYWluLmNvbS4gU1NUIHdpbGwgZGVmYXVsdCB0aGUgaG9zdGVkWm9uZSB0byBkb21haW4uY29tLlxuICAgKi9cbiAgaG9zdGVkWm9uZT86IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBiYXNlIG1hcHBpbmcgZm9yIHRoZSBjdXN0b20gZG9tYWluLlxuICAgKlxuICAgKiBGb3IgZXhhbXBsZSwgYnkgc2V0dGluZyB0aGUgZG9tYWluTmFtZSB0byBhcGkuZG9tYWluLmNvbSBhbmQgdGhlIHBhdGggdG8gdjEsIHRoZSBjdXN0b20gZG9tYWluIFVSTCBvZiB0aGUgQVBJIHdpbGwgYmVjb21lIGh0dHBzOi8vYXBpLmRvbWFpbi5jb20vdjEvLiBJZiB0aGUgcGF0aCBpcyBub3Qgc2V0LCB0aGUgY3VzdG9tIGRvbWFpbiBVUkwgd2lsbCBiZSBodHRwczovL2FwaS5kb21haW4uY29tLiBOb3RlIHRoZSBhZGRpdGlvbmFsIHRyYWlsaW5nIHNsYXNoIGluIHRoZSBmb3JtZXIgY2FzZS5cbiAgICovXG4gIHBhdGg/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBTZXQgdGhpcyBvcHRpb24gaWYgdGhlIGRvbWFpbiBpcyBub3QgaG9zdGVkIG9uIEFtYXpvbiBSb3V0ZSA1My5cbiAgICovXG4gIGlzRXh0ZXJuYWxEb21haW4/OiBib29sZWFuO1xuICBjZGs/OiB7XG4gICAgLyoqXG4gICAgICogT3ZlcnJpZGUgdGhlIGludGVybmFsbHkgY3JlYXRlZCBkb21haW4gbmFtZVxuICAgICAqL1xuICAgIGRvbWFpbk5hbWU/OiBhcGlnLklEb21haW5OYW1lO1xuICAgIC8qKlxuICAgICAqIE92ZXJyaWRlIHRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgaG9zdGVkIHpvbmVcbiAgICAgKi9cbiAgICBob3N0ZWRab25lPzogcm91dGU1My5JSG9zdGVkWm9uZTtcbiAgICAvKipcbiAgICAgKiBPdmVycmlkZSB0aGUgaW50ZXJuYWxseSBjcmVhdGVkIGNlcnRpZmljYXRlXG4gICAgICovXG4gICAgY2VydGlmaWNhdGU/OiBhY20uSUNlcnRpZmljYXRlO1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEN1c3RvbURvbWFpbkRhdGEge1xuICByZWFkb25seSBhcGlnRG9tYWluOiBhcGlnLklEb21haW5OYW1lO1xuICByZWFkb25seSBtYXBwaW5nS2V5Pzogc3RyaW5nO1xuICByZWFkb25seSBjZXJ0aWZpY2F0ZT86IGFjbS5JQ2VydGlmaWNhdGU7XG4gIHJlYWRvbmx5IGlzQXBpZ0RvbWFpbkNyZWF0ZWQ6IGJvb2xlYW47XG4gIHJlYWRvbmx5IGlzQ2VydGlmaWNhdGVkQ3JlYXRlZDogYm9vbGVhbjtcbiAgcmVhZG9ubHkgdXJsOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZEN1c3RvbURvbWFpbkRhdGEoXG4gIHNjb3BlOiBDb25zdHJ1Y3QsXG4gIGN1c3RvbURvbWFpbjogc3RyaW5nIHwgQ3VzdG9tRG9tYWluUHJvcHMgfCB1bmRlZmluZWRcbik6IEN1c3RvbURvbWFpbkRhdGEgfCB1bmRlZmluZWQge1xuICBpZiAoY3VzdG9tRG9tYWluID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgLy8gY3VzdG9tRG9tYWluIGlzIGEgc3RyaW5nXG4gIGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gPT09IFwic3RyaW5nXCIpIHtcbiAgICByZXR1cm4gYnVpbGREYXRhRm9yU3RyaW5nSW5wdXQoc2NvcGUsIGN1c3RvbURvbWFpbik7XG4gIH1cbiAgLy8gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUgaXMgYSBzdHJpbmdcbiAgZWxzZSBpZiAoY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUpIHtcbiAgICByZXR1cm4gY3VzdG9tRG9tYWluLmlzRXh0ZXJuYWxEb21haW5cbiAgICAgID8gYnVpbGREYXRhRm9yRXh0ZXJuYWxEb21haW5JbnB1dChzY29wZSwgY3VzdG9tRG9tYWluKVxuICAgICAgOiBidWlsZERhdGFGb3JJbnRlcm5hbERvbWFpbklucHV0KHNjb3BlLCBjdXN0b21Eb21haW4pO1xuICB9XG4gIC8vIGN1c3RvbURvbWFpbi5kb21haW5OYW1lIGlzIGEgY29uc3RydWN0XG4gIGVsc2UgaWYgKGN1c3RvbURvbWFpbi5jZGs/LmRvbWFpbk5hbWUpIHtcbiAgICByZXR1cm4gYnVpbGREYXRhRm9yQ29uc3RydWN0SW5wdXQoc2NvcGUsIGN1c3RvbURvbWFpbik7XG4gIH1cbiAgLy8gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUgbm90IGV4aXN0c1xuICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgXCJkb21haW5OYW1lXCIgaW4gc3N0LkFwaSdzIGN1c3RvbURvbWFpbiBzZXR0aW5nYCk7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkRGF0YUZvclN0cmluZ0lucHV0KFxuICBzY29wZTogQ29uc3RydWN0LFxuICBjdXN0b21Eb21haW46IHN0cmluZ1xuKTogQ3VzdG9tRG9tYWluRGF0YSB7XG4gIC8vIHZhbGlkYXRlOiBjdXN0b21Eb21haW4gaXMgYSBUT0tFTiBzdHJpbmdcbiAgLy8gaWUuIGltcG9ydGVkIFNTTSB2YWx1ZTogc3NtLlN0cmluZ1BhcmFtZXRlci52YWx1ZUZvclN0cmluZ1BhcmFtZXRlcigpXG4gIGlmIChjZGsuVG9rZW4uaXNVbnJlc29sdmVkKGN1c3RvbURvbWFpbikpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgWW91IGFsc28gbmVlZCB0byBzcGVjaWZ5IHRoZSBcImhvc3RlZFpvbmVcIiBpZiB0aGUgXCJkb21haW5OYW1lXCIgaXMgcGFzc2VkIGluIGFzIGEgcmVmZXJlbmNlLmBcbiAgICApO1xuICB9XG5cbiAgYXNzZXJ0RG9tYWluTmFtZUlzTG93ZXJDYXNlKGN1c3RvbURvbWFpbik7XG5cbiAgY29uc3QgZG9tYWluTmFtZSA9IGN1c3RvbURvbWFpbjtcbiAgY29uc3QgaG9zdGVkWm9uZURvbWFpbiA9IGRvbWFpbk5hbWUuc3BsaXQoXCIuXCIpLnNsaWNlKDEpLmpvaW4oXCIuXCIpO1xuICBjb25zdCBob3N0ZWRab25lID0gbG9va3VwSG9zdGVkWm9uZShzY29wZSwgaG9zdGVkWm9uZURvbWFpbik7XG4gIGNvbnN0IGNlcnRpZmljYXRlID0gY3JlYXRlQ2VydGlmaWNhdGUoc2NvcGUsIGRvbWFpbk5hbWUsIGhvc3RlZFpvbmUpO1xuICBjb25zdCBhcGlnRG9tYWluID0gY3JlYXRlQXBpZ0RvbWFpbihzY29wZSwgZG9tYWluTmFtZSwgY2VydGlmaWNhdGUpO1xuICBjcmVhdGVBUmVjb3JkcyhzY29wZSwgaG9zdGVkWm9uZSwgZG9tYWluTmFtZSwgYXBpZ0RvbWFpbik7XG5cbiAgcmV0dXJuIHtcbiAgICBhcGlnRG9tYWluLFxuICAgIGNlcnRpZmljYXRlLFxuICAgIGlzQXBpZ0RvbWFpbkNyZWF0ZWQ6IHRydWUsXG4gICAgaXNDZXJ0aWZpY2F0ZWRDcmVhdGVkOiB0cnVlLFxuICAgIHVybDogYnVpbGREb21haW5VcmwoZG9tYWluTmFtZSksXG4gIH07XG59XG5cbmZ1bmN0aW9uIGJ1aWxkRGF0YUZvckludGVybmFsRG9tYWluSW5wdXQoXG4gIHNjb3BlOiBDb25zdHJ1Y3QsXG4gIGN1c3RvbURvbWFpbjogQ3VzdG9tRG9tYWluUHJvcHNcbik6IEN1c3RvbURvbWFpbkRhdGEge1xuICAvLyBJZiBjdXN0b21Eb21haW4gaXMgYSBUT0tFTiBzdHJpbmcsIFwiaG9zdGVkWm9uZVwiIGhhcyB0byBiZSBwYXNzZWQgaW4uIFRoaXNcbiAgLy8gaXMgYmVjYXVzZSBcImhvc3RlZFpvbmVcIiBjYW5ub3QgYmUgcGFyc2VkIGZyb20gYSBUT0tFTiB2YWx1ZS5cbiAgaWYgKGNkay5Ub2tlbi5pc1VucmVzb2x2ZWQoY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUpKSB7XG4gICAgaWYgKCFjdXN0b21Eb21haW4uaG9zdGVkWm9uZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgWW91IGFsc28gbmVlZCB0byBzcGVjaWZ5IHRoZSBcImhvc3RlZFpvbmVcIiBpZiB0aGUgXCJkb21haW5OYW1lXCIgaXMgcGFzc2VkIGluIGFzIGEgcmVmZXJlbmNlLmBcbiAgICAgICk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGFzc2VydERvbWFpbk5hbWVJc0xvd2VyQ2FzZShjdXN0b21Eb21haW4uZG9tYWluTmFtZSBhcyBzdHJpbmcpO1xuICB9XG5cbiAgY29uc3QgZG9tYWluTmFtZSA9IGN1c3RvbURvbWFpbi5kb21haW5OYW1lIGFzIHN0cmluZztcblxuICAvLyBMb29rdXAgaG9zdGVkIHpvbmVcbiAgLy8gTm90ZTogQWxsb3cgdXNlciBwYXNzaW5nIGluIGBob3N0ZWRab25lYCBvYmplY3QuIFRoZSB1c2UgY2FzZSBpcyB3aGVuXG4gIC8vICAgICAgIHRoZXJlIGFyZSBtdWx0aXBsZSBIb3N0ZWRab25lcyB3aXRoIHRoZSBzYW1lIGRvbWFpbiwgYnV0IG9uZSBpc1xuICAvLyAgICAgICBwdWJsaWMsIGFuZCBvbmUgaXMgcHJpdmF0ZS5cbiAgbGV0IGhvc3RlZFpvbmU6IHJvdXRlNTMuSUhvc3RlZFpvbmU7XG4gIGlmIChjdXN0b21Eb21haW4uaG9zdGVkWm9uZSkge1xuICAgIGNvbnN0IGhvc3RlZFpvbmVEb21haW4gPSBjdXN0b21Eb21haW4uaG9zdGVkWm9uZTtcbiAgICBob3N0ZWRab25lID0gbG9va3VwSG9zdGVkWm9uZShzY29wZSwgaG9zdGVkWm9uZURvbWFpbik7XG4gIH0gZWxzZSBpZiAoY3VzdG9tRG9tYWluLmNkaz8uaG9zdGVkWm9uZSkge1xuICAgIGhvc3RlZFpvbmUgPSBjdXN0b21Eb21haW4uY2RrLmhvc3RlZFpvbmU7XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgaG9zdGVkWm9uZURvbWFpbiA9IGRvbWFpbk5hbWUuc3BsaXQoXCIuXCIpLnNsaWNlKDEpLmpvaW4oXCIuXCIpO1xuICAgIGhvc3RlZFpvbmUgPSBsb29rdXBIb3N0ZWRab25lKHNjb3BlLCBob3N0ZWRab25lRG9tYWluKTtcbiAgfVxuXG4gIC8vIENyZWF0ZSBjZXJ0aWZpY2F0ZVxuICAvLyBOb3RlOiBBbGxvdyB1c2VyIHBhc3NpbmcgaW4gYGNlcnRpZmljYXRlYCBvYmplY3QuIFRoZSB1c2UgY2FzZSBpcyBmb3JcbiAgLy8gICAgICAgdXNlciB0byBjcmVhdGUgd2lsZGNhcmQgY2VydGlmaWNhdGUgb3IgdXNpbmcgYW4gaW1wb3J0ZWQgY2VydGlmaWNhdGUuXG4gIGxldCBjZXJ0aWZpY2F0ZTogYWNtLklDZXJ0aWZpY2F0ZTtcbiAgbGV0IGlzQ2VydGlmaWNhdGVkQ3JlYXRlZDogYm9vbGVhbjtcbiAgaWYgKGN1c3RvbURvbWFpbi5jZGs/LmNlcnRpZmljYXRlKSB7XG4gICAgY2VydGlmaWNhdGUgPSBjdXN0b21Eb21haW4uY2RrLmNlcnRpZmljYXRlO1xuICAgIGlzQ2VydGlmaWNhdGVkQ3JlYXRlZCA9IGZhbHNlO1xuICB9IGVsc2Uge1xuICAgIGNlcnRpZmljYXRlID0gY3JlYXRlQ2VydGlmaWNhdGUoc2NvcGUsIGRvbWFpbk5hbWUsIGhvc3RlZFpvbmUpO1xuICAgIGlzQ2VydGlmaWNhdGVkQ3JlYXRlZCA9IHRydWU7XG4gIH1cblxuICBjb25zdCBhcGlnRG9tYWluID0gY3JlYXRlQXBpZ0RvbWFpbihzY29wZSwgZG9tYWluTmFtZSwgY2VydGlmaWNhdGUpO1xuICBjb25zdCBtYXBwaW5nS2V5ID0gY3VzdG9tRG9tYWluLnBhdGg7XG4gIGNyZWF0ZUFSZWNvcmRzKHNjb3BlLCBob3N0ZWRab25lLCBkb21haW5OYW1lLCBhcGlnRG9tYWluKTtcblxuICByZXR1cm4ge1xuICAgIGFwaWdEb21haW4sXG4gICAgbWFwcGluZ0tleSxcbiAgICBjZXJ0aWZpY2F0ZSxcbiAgICBpc0FwaWdEb21haW5DcmVhdGVkOiB0cnVlLFxuICAgIGlzQ2VydGlmaWNhdGVkQ3JlYXRlZCxcbiAgICB1cmw6IGJ1aWxkRG9tYWluVXJsKGRvbWFpbk5hbWUsIG1hcHBpbmdLZXkpLFxuICB9O1xufVxuXG5mdW5jdGlvbiBidWlsZERhdGFGb3JFeHRlcm5hbERvbWFpbklucHV0KFxuICBzY29wZTogQ29uc3RydWN0LFxuICBjdXN0b21Eb21haW46IEN1c3RvbURvbWFpblByb3BzXG4pOiBDdXN0b21Eb21haW5EYXRhIHtcbiAgLy8gaWYgaXQgaXMgZXh0ZXJuYWwsIHRoZW4gYSBjZXJ0aWZpY2F0ZSBpcyByZXF1aXJlZFxuICBpZiAoIWN1c3RvbURvbWFpbi5jZGs/LmNlcnRpZmljYXRlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYEEgdmFsaWQgY2VydGlmaWNhdGUgaXMgcmVxdWlyZWQgd2hlbiBcImlzRXh0ZXJuYWxEb21haW5cIiBpcyBzZXQgdG8gXCJ0cnVlXCIuYFxuICAgICk7XG4gIH1cbiAgLy8gaWYgaXQgaXMgZXh0ZXJuYWwsIHRoZW4gdGhlIGhvc3RlZFpvbmUgaXMgbm90IHJlcXVpcmVkXG4gIGlmIChjdXN0b21Eb21haW4uaG9zdGVkWm9uZSB8fCBjdXN0b21Eb21haW4uY2RrPy5ob3N0ZWRab25lKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYEhvc3RlZCB6b25lcyBjYW4gb25seSBiZSBjb25maWd1cmVkIGZvciBkb21haW5zIGhvc3RlZCBvbiBBbWF6b24gUm91dGUgNTMuIERvIG5vdCBzZXQgdGhlIFwiaG9zdGVkWm9uZVwiIHdoZW4gXCJpc0V4dGVybmFsRG9tYWluXCIgaXMgZW5hYmxlZC5gXG4gICAgKTtcbiAgfVxuXG4gIGNvbnN0IGRvbWFpbk5hbWUgPSBjdXN0b21Eb21haW4uZG9tYWluTmFtZSBhcyBzdHJpbmc7XG4gIGFzc2VydERvbWFpbk5hbWVJc0xvd2VyQ2FzZShkb21haW5OYW1lKTtcbiAgY29uc3QgY2VydGlmaWNhdGUgPSBjdXN0b21Eb21haW4uY2RrLmNlcnRpZmljYXRlO1xuICBjb25zdCBhcGlnRG9tYWluID0gY3JlYXRlQXBpZ0RvbWFpbihzY29wZSwgZG9tYWluTmFtZSwgY2VydGlmaWNhdGUpO1xuICBjb25zdCBtYXBwaW5nS2V5ID0gY3VzdG9tRG9tYWluLnBhdGg7XG5cbiAgcmV0dXJuIHtcbiAgICBhcGlnRG9tYWluLFxuICAgIG1hcHBpbmdLZXksXG4gICAgY2VydGlmaWNhdGUsXG4gICAgaXNBcGlnRG9tYWluQ3JlYXRlZDogdHJ1ZSxcbiAgICBpc0NlcnRpZmljYXRlZENyZWF0ZWQ6IGZhbHNlLFxuICAgIHVybDogYnVpbGREb21haW5VcmwoZG9tYWluTmFtZSwgbWFwcGluZ0tleSksXG4gIH07XG59XG5cbmZ1bmN0aW9uIGJ1aWxkRGF0YUZvckNvbnN0cnVjdElucHV0KFxuICBzY29wZTogQ29uc3RydWN0LFxuICBjdXN0b21Eb21haW46IEN1c3RvbURvbWFpblByb3BzXG4pOiBDdXN0b21Eb21haW5EYXRhIHtcbiAgLy8gIEFsbG93IHVzZXIgcGFzc2luZyBpbiBgYXBpZ0RvbWFpbmAgb2JqZWN0LiBUaGUgdXNlIGNhc2UgaXMgYSB1c2VyIGNyZWF0ZXNcbiAgLy8gIG11bHRpcGxlIEFQSSBlbmRwb2ludHMsIGFuZCBpcyBtYXBwaW5nIHRoZW0gdW5kZXIgdGhlIHNhbWUgY3VzdG9tIGRvbWFpbi5cbiAgLy8gIGBzc3QuQXBpYCBuZWVkcyB0byBleHBvc2UgdGhlIGBhcGlnRG9tYWluYCBjb25zdHJ1Y3QgY3JlYXRlZCBpbiB0aGUgZmlyc3RcbiAgLy8gIEFwaSwgYW5kIGxldHMgdXNlciBwYXNzIGl0IGluIHdoZW4gY3JlYXRpbmcgdGhlIHNlY29uZCBBcGkuXG5cbiAgaWYgKGN1c3RvbURvbWFpbi5ob3N0ZWRab25lIHx8IGN1c3RvbURvbWFpbi5jZGs/Lmhvc3RlZFpvbmUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJob3N0ZWRab25lXCIgd2hlbiB0aGUgXCJkb21haW5OYW1lXCIgaXMgYSBjb25zdHJ1Y3RgXG4gICAgKTtcbiAgfVxuICBpZiAoY3VzdG9tRG9tYWluLmNkaz8uY2VydGlmaWNhdGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJjZXJ0aWZpY2F0ZVwiIHdoZW4gdGhlIFwiZG9tYWluTmFtZVwiIGlzIGEgY29uc3RydWN0YFxuICAgICk7XG4gIH1cblxuICBjb25zdCBhcGlnRG9tYWluID0gY3VzdG9tRG9tYWluLmNkaz8uZG9tYWluTmFtZSE7XG4gIGNvbnN0IGRvbWFpbk5hbWUgPSBhcGlnRG9tYWluLm5hbWU7XG4gIGNvbnN0IG1hcHBpbmdLZXkgPSBjdXN0b21Eb21haW4ucGF0aDtcblxuICByZXR1cm4ge1xuICAgIGFwaWdEb21haW4sXG4gICAgbWFwcGluZ0tleSxcbiAgICBjZXJ0aWZpY2F0ZTogdW5kZWZpbmVkLFxuICAgIGlzQXBpZ0RvbWFpbkNyZWF0ZWQ6IGZhbHNlLFxuICAgIGlzQ2VydGlmaWNhdGVkQ3JlYXRlZDogZmFsc2UsXG4gICAgdXJsOiBidWlsZERvbWFpblVybChkb21haW5OYW1lLCBtYXBwaW5nS2V5KSxcbiAgfTtcbn1cblxuZnVuY3Rpb24gbG9va3VwSG9zdGVkWm9uZShzY29wZTogQ29uc3RydWN0LCBob3N0ZWRab25lRG9tYWluOiBzdHJpbmcpIHtcbiAgcmV0dXJuIHJvdXRlNTMuSG9zdGVkWm9uZS5mcm9tTG9va3VwKHNjb3BlLCBcIkhvc3RlZFpvbmVcIiwge1xuICAgIGRvbWFpbk5hbWU6IGhvc3RlZFpvbmVEb21haW4sXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVDZXJ0aWZpY2F0ZShcbiAgc2NvcGU6IENvbnN0cnVjdCxcbiAgZG9tYWluTmFtZTogc3RyaW5nLFxuICBob3N0ZWRab25lOiByb3V0ZTUzLklIb3N0ZWRab25lXG4pIHtcbiAgcmV0dXJuIG5ldyBhY20uQ2VydGlmaWNhdGUoc2NvcGUsIFwiQ2VydGlmaWNhdGVcIiwge1xuICAgIGRvbWFpbk5hbWUsXG4gICAgdmFsaWRhdGlvbjogYWNtLkNlcnRpZmljYXRlVmFsaWRhdGlvbi5mcm9tRG5zKGhvc3RlZFpvbmUpLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlQXBpZ0RvbWFpbihcbiAgc2NvcGU6IENvbnN0cnVjdCxcbiAgZG9tYWluTmFtZTogc3RyaW5nLFxuICBjZXJ0aWZpY2F0ZTogYWNtLklDZXJ0aWZpY2F0ZVxuKSB7XG4gIHJldHVybiBuZXcgYXBpZy5Eb21haW5OYW1lKHNjb3BlLCBcIkRvbWFpbk5hbWVcIiwge1xuICAgIGRvbWFpbk5hbWUsXG4gICAgY2VydGlmaWNhdGUsXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVBUmVjb3JkcyhcbiAgc2NvcGU6IENvbnN0cnVjdCxcbiAgaG9zdGVkWm9uZTogcm91dGU1My5JSG9zdGVkWm9uZSxcbiAgZG9tYWluTmFtZTogc3RyaW5nLFxuICBhcGlnRG9tYWluOiBhcGlnLklEb21haW5OYW1lXG4pIHtcbiAgLy8gY3JlYXRlIEROUyByZWNvcmRcbiAgY29uc3QgcmVjb3JkUHJvcHMgPSB7XG4gICAgcmVjb3JkTmFtZTogZG9tYWluTmFtZSxcbiAgICB6b25lOiBob3N0ZWRab25lLFxuICAgIHRhcmdldDogcm91dGU1My5SZWNvcmRUYXJnZXQuZnJvbUFsaWFzKFxuICAgICAgbmV3IHJvdXRlNTNUYXJnZXRzLkFwaUdhdGV3YXl2MkRvbWFpblByb3BlcnRpZXMoXG4gICAgICAgIGFwaWdEb21haW4ucmVnaW9uYWxEb21haW5OYW1lLFxuICAgICAgICBhcGlnRG9tYWluLnJlZ2lvbmFsSG9zdGVkWm9uZUlkXG4gICAgICApXG4gICAgKSxcbiAgfTtcbiAgY29uc3QgcmVjb3JkcyA9IFtcbiAgICBuZXcgcm91dGU1My5BUmVjb3JkKHNjb3BlLCBcIkFsaWFzUmVjb3JkXCIsIHJlY29yZFByb3BzKSxcbiAgICBuZXcgcm91dGU1My5BYWFhUmVjb3JkKHNjb3BlLCBcIkFsaWFzUmVjb3JkQUFBQVwiLCByZWNvcmRQcm9wcyksXG4gIF07XG4gIC8vIG5vdGU6IElmIGRvbWFpbk5hbWUgaXMgYSBUT0tFTiBzdHJpbmcgaWUuICR7VE9LRU4uLn0sIHRoZSByb3V0ZTUzLkFSZWNvcmRcbiAgLy8gICAgICAgY29uc3RydWN0IHdpbGwgYXBwZW5kIFwiLiR7aG9zdGVkWm9uZU5hbWV9XCIgdG8gdGhlIGVuZCBvZiB0aGUgZG9tYWluLlxuICAvLyAgICAgICBUaGlzIGlzIGJlY2F1c2UgdGhlIGNvbnN0cnVjdCB0cmllcyB0byBjaGVjayBpZiB0aGUgcmVjb3JkIG5hbWVcbiAgLy8gICAgICAgZW5kcyB3aXRoIHRoZSBkb21haW4gbmFtZS4gSWYgbm90LCBpdCB3aWxsIGFwcGVuZCB0aGUgZG9tYWluIG5hbWUuXG4gIC8vICAgICAgIFNvLCB3ZSBuZWVkIHJlbW92ZSB0aGlzIGJlaGF2aW9yLlxuICBpZiAoY2RrLlRva2VuLmlzVW5yZXNvbHZlZChkb21haW5OYW1lKSkge1xuICAgIHJlY29yZHMuZm9yRWFjaCgocmVjb3JkKSA9PiB7XG4gICAgICBjb25zdCBjZm5SZWNvcmQgPSByZWNvcmQubm9kZS5kZWZhdWx0Q2hpbGQgYXMgcm91dGU1My5DZm5SZWNvcmRTZXQ7XG4gICAgICBjZm5SZWNvcmQubmFtZSA9IGRvbWFpbk5hbWU7XG4gICAgfSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gYnVpbGREb21haW5VcmwoZG9tYWluTmFtZTogc3RyaW5nLCBtYXBwaW5nS2V5Pzogc3RyaW5nKSB7XG4gIC8vIE5vdGU6IElmIG1hcHBpbmcga2V5IGlzIHNldCwgdGhlIFVSTCBuZWVkcyBhIHRyYWlsaW5nIHNsYXNoLiBXaXRob3V0IHRoZVxuICAvLyAgICAgICB0cmFpbGluZyBzbGFzaCwgdGhlIEFQSSBmYWlscyB3aXRoIHRoZSBlcnJvclxuICAvLyAgICAgICB7XCJtZXNzYWdlXCI6XCJOb3QgRm91bmRcIn1cbiAgcmV0dXJuIG1hcHBpbmdLZXkgPyBgJHtkb21haW5OYW1lfS8ke21hcHBpbmdLZXl9L2AgOiBkb21haW5OYW1lO1xufVxuXG5mdW5jdGlvbiBhc3NlcnREb21haW5OYW1lSXNMb3dlckNhc2UoZG9tYWluTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gIGlmIChkb21haW5OYW1lICE9PSBkb21haW5OYW1lLnRvTG93ZXJDYXNlKCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBkb21haW4gbmFtZSBuZWVkcyB0byBiZSBpbiBsb3dlcmNhc2VgKTtcbiAgfVxufVxuIl19