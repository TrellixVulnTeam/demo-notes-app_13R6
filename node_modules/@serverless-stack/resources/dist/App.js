"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.App = void 0;
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const cdk = __importStar(require("aws-cdk-lib"));
const s3 = __importStar(require("aws-cdk-lib/aws-s3"));
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const core_1 = require("@serverless-stack/core");
const Stack_1 = require("./Stack");
const Construct_1 = require("./Construct");
const FunctionalStack_1 = require("./FunctionalStack");
function exitWithMessage(message) {
    console.error(message);
    process.exit(1);
}
/**
 * The App construct extends cdk.App and is used internally by SST to:
 * - Automatically prefix stack names with the stage and app name
 * - Deploy the entire app using the same AWS profile and region
 *
 * It is made available as the `app` in the `stacks/index.js` of your SST app.
 *
 * ```js
 * export default function main(app) {
 *   new MySampleStack(app, "sample");
 * }
 * ```
 *
 * Since it is initialized internally, the props that are passed to App cannot be changed.
 *
 * @example
 */
class App extends cdk.App {
    /**
     * @internal
     */
    constructor(deployProps = {}, props = {}) {
        super(props);
        /**
         * Whether or not the app is running locally under `sst start`
         */
        this.local = false;
        /**
         * A list of Lambda functions in the app
         */
        this.lambdaHandlers = [];
        this.siteEnvironments = [];
        this.appPath = process.cwd();
        this.stage = deployProps.stage || "dev";
        this.name = deployProps.name || "my-app";
        this.region =
            deployProps.region || process.env.CDK_DEFAULT_REGION || "us-east-1";
        this.account = process.env.CDK_DEFAULT_ACCOUNT || "my-account";
        this.esbuildConfig = deployProps.esbuildConfig;
        this.buildDir = deployProps.buildDir || ".build";
        this.skipBuild = deployProps.skipBuild || false;
        this.defaultFunctionProps = [];
        this.synthCallback = deployProps.synthCallback;
        core_1.State.init(this.appPath);
        if (deployProps.debugEndpoint) {
            this.local = true;
            core_1.State.Function.reset(this.appPath);
            this.debugEndpoint = deployProps.debugEndpoint;
            this.debugBucketArn = deployProps.debugBucketArn;
            this.debugBucketName = deployProps.debugBucketName;
            this.debugStartedAt = deployProps.debugStartedAt;
            this.debugIncreaseTimeout = deployProps.debugIncreaseTimeout;
            if (deployProps.debugBridge) {
                this.debugBridge = deployProps.debugBridge;
            }
        }
    }
    /** @internal */
    get defaultRemovalPolicy() {
        return this._defaultRemovalPolicy;
    }
    /**
     * Use this method to prefix resource names in your stacks to make sure they don't thrash when deployed to different stages in the same AWS account. This method will prefix a given resource name with the stage and app name. Using the format `${stage}-${name}-${logicalName}`.
     * @example
     * ```js
     * console.log(app.logicalPrefixedName("myTopic"));
     *
     * // dev-my-app-myTopic
     * ```
     */
    logicalPrefixedName(logicalName) {
        const namePrefix = this.name === "" ? "" : `${this.name}-`;
        return `${this.stage}-${namePrefix}${logicalName}`;
    }
    /**
     * The default removal policy that'll be applied to all the resources in the app. This can be useful to set ephemeral (dev or feature branch) environments to remove all the resources on deletion.
     * :::danger
     * Make sure to not set the default removal policy to `DESTROY` for production environments.
     * :::
     * @example
     * ```js
     * app.setDefaultRemovalPolicy(app.local ? "destroy" : "retain")
     * ```
     */
    setDefaultRemovalPolicy(policy) {
        this._defaultRemovalPolicy = policy;
    }
    /**
     * The default function props to be applied to all the Lambda functions in the app. These default values will be overridden if a Function sets its own props.
     * This needs to be called before a stack with any functions have been added to the app.
     *
     * @example
     * ```js
     * app.setDefaultFunctionProps({
     *   runtime: "nodejs12.x",
     *   timeout: 30
     * })
     * ```
     */
    setDefaultFunctionProps(props) {
        if (this.lambdaHandlers.length > 0)
            throw new Error("Cannot call 'setDefaultFunctionProps' after a stack with functions has been created. Please use 'addDefaultFunctionEnv' or 'addDefaultFunctionPermissions' to add more default properties. Read more about this change here: https://docs.serverless-stack.com/constructs/App#upgrading-to-v0420");
        this.defaultFunctionProps.push(props);
    }
    /**
     * Adds additional default Permissions to be applied to all Lambda functions in the app.
     *
     * @example
     * ```js
     * app.addDefaultFunctionPermissions(["s3"])
     * ```
     */
    addDefaultFunctionPermissions(permissions) {
        this.defaultFunctionProps.push({
            permissions,
        });
    }
    /**
     * Adds additional default environment variables to be applied to all Lambda functions in the app.
     *
     * @example
     * ```js
     * app.addDefaultFunctionPermissions({
     *   "MY_ENV_VAR": "my-value"
     * })
     * ```
     */
    addDefaultFunctionEnv(environment) {
        this.defaultFunctionProps.push({
            environment,
        });
    }
    /**
     * Adds additional default layers to be applied to all Lambda functions in the stack.
     */
    addDefaultFunctionLayers(layers) {
        this.defaultFunctionProps.push({
            layers,
        });
    }
    synth(options = {}) {
        this.buildConstructsMetadata();
        for (const child of this.node.children) {
            if ((0, Construct_1.isStackConstruct)(child)) {
                // Tag stacks
                cdk.Tags.of(child).add("sst:app", this.name);
                cdk.Tags.of(child).add("sst:stage", this.stage);
                // Set removal policy
                if (this._defaultRemovalPolicy)
                    this.applyRemovalPolicy(child, this._defaultRemovalPolicy);
                // Stack names need to be parameterized with the stage name
                if (!child.stackName.startsWith(`${this.stage}-`) &&
                    !child.stackName.endsWith(`-${this.stage}`) &&
                    child.stackName.indexOf(`-${this.stage}-`) === -1) {
                    throw new Error(`Stack "${child.stackName}" is not parameterized with the stage name. The stack name needs to either start with "$stage-", end in "-$stage", or contain the stage name "-$stage-".`);
                }
            }
        }
        const cloudAssembly = super.synth(options);
        // Run callback after synth has finished
        if (this.synthCallback) {
            this.synthCallback(this.lambdaHandlers, this.siteEnvironments);
        }
        return cloudAssembly;
    }
    isJestTest() {
        // Check the env var set inside test/setup-tests.js
        return process.env.JEST_RESOURCES_TESTS === "enabled";
    }
    registerLambdaHandler(handler) {
        this.lambdaHandlers.push(handler);
    }
    registerSiteEnvironment(environment) {
        this.siteEnvironments.push(environment);
    }
    getInputFilesFromEsbuildMetafile(file) {
        let metaJson;
        try {
            metaJson = fs.readJsonSync(file);
        }
        catch (e) {
            exitWithMessage("There was a problem reading the esbuild metafile.");
        }
        return Object.keys(metaJson.inputs).map((input) => path.resolve(input));
    }
    buildConstructsMetadata() {
        const constructs = this.buildConstructsMetadata_collectConstructs(this);
        const byStack = {};
        const local = [];
        for (const c of constructs) {
            const stack = Stack_1.Stack.of(c);
            const list = byStack[stack.node.id] || [];
            const metadata = c.getConstructMetadata();
            const item = Object.assign({ id: c.node.id, addr: c.node.addr, stack: Stack_1.Stack.of(c).stackName }, metadata);
            local.push(item);
            list.push(Object.assign(Object.assign({}, item), { local: undefined }));
            byStack[stack.node.id] = list;
        }
        // Register constructs
        for (const child of this.node.children) {
            if (child instanceof Stack_1.Stack) {
                const stackName = child.node.id;
                child.addConstructsMetadata(byStack[stackName] || []);
            }
        }
        fs.writeJSONSync(core_1.State.resolve(this.appPath, "constructs.json"), local);
    }
    buildConstructsMetadata_collectConstructs(construct) {
        return [
            (0, Construct_1.isSSTConstruct)(construct) ? construct : undefined,
            ...construct.node.children.flatMap((c) => this.buildConstructsMetadata_collectConstructs(c)),
        ].filter((c) => Boolean(c));
    }
    applyRemovalPolicy(current, policy) {
        if (current instanceof cdk.CfnResource) {
            current.applyRemovalPolicy(cdk.RemovalPolicy[policy.toUpperCase()]);
        }
        // Had to copy this in to enable deleting objects in bucket
        // https://github.com/aws/aws-cdk/blob/master/packages/%40aws-cdk/aws-s3/lib/bucket.ts#L1910
        if (current instanceof s3.Bucket &&
            !current.node.tryFindChild("AutoDeleteObjectsCustomResource")) {
            const AUTO_DELETE_OBJECTS_RESOURCE_TYPE = "Custom::S3AutoDeleteObjects";
            const provider = cdk.CustomResourceProvider.getOrCreateProvider(current, AUTO_DELETE_OBJECTS_RESOURCE_TYPE, {
                codeDirectory: path.join(require.resolve("aws-cdk-lib/aws-s3"), "../lib/auto-delete-objects-handler"),
                runtime: cdk.CustomResourceProviderRuntime.NODEJS_12_X,
                description: `Lambda function for auto-deleting objects in ${current.bucketName} S3 bucket.`,
            });
            // Use a bucket policy to allow the custom resource to delete
            // objects in the bucket
            current.addToResourcePolicy(new iam.PolicyStatement({
                actions: [
                    // list objects
                    "s3:GetBucket*",
                    "s3:List*",
                    // and then delete them
                    "s3:DeleteObject*",
                ],
                resources: [current.bucketArn, current.arnForObjects("*")],
                principals: [new iam.ArnPrincipal(provider.roleArn)],
            }));
            const customResource = new cdk.CustomResource(current, "AutoDeleteObjectsCustomResource", {
                resourceType: AUTO_DELETE_OBJECTS_RESOURCE_TYPE,
                serviceToken: provider.serviceToken,
                properties: {
                    BucketName: current.bucketName,
                },
            });
            // Ensure bucket policy is deleted AFTER the custom resource otherwise
            // we don't have permissions to list and delete in the bucket.
            // (add a `if` to make TS happy)
            if (current.policy) {
                customResource.node.addDependency(current.policy);
            }
        }
        current.node.children.forEach((resource) => this.applyRemovalPolicy(resource, policy));
    }
    // Functional Stack
    // This is a magical global to avoid having to pass app everywhere.
    // We only every have one instance of app
    stack(fn, props) {
        return (0, FunctionalStack_1.stack)(this, fn, props);
    }
}
exports.App = App;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0FwcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUE2QjtBQUM3Qiw2Q0FBK0I7QUFDL0IsaURBQW1DO0FBRW5DLHVEQUF5QztBQUN6Qyx5REFBMkM7QUFHM0MsaURBQStDO0FBQy9DLG1DQUFnQztBQUNoQywyQ0FLcUI7QUFLckIsdURBQTJEO0FBRTNELFNBQVMsZUFBZSxDQUFDLE9BQWU7SUFDdEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN2QixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2xCLENBQUM7QUFvREQ7Ozs7Ozs7Ozs7Ozs7Ozs7R0FnQkc7QUFDSCxNQUFhLEdBQUksU0FBUSxHQUFHLENBQUMsR0FBRztJQWlGOUI7O09BRUc7SUFDSCxZQUFZLGNBQThCLEVBQUUsRUFBRSxRQUFrQixFQUFFO1FBQ2hFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQXBGZjs7V0FFRztRQUNhLFVBQUssR0FBWSxLQUFLLENBQUM7UUF5RHZDOztXQUVHO1FBQ2MsbUJBQWMsR0FBMkIsRUFBRSxDQUFDO1FBQzVDLHFCQUFnQixHQUFxQyxFQUFFLENBQUM7UUFxQnZFLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBRTdCLElBQUksQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUM7UUFDeEMsSUFBSSxDQUFDLElBQUksR0FBRyxXQUFXLENBQUMsSUFBSSxJQUFJLFFBQVEsQ0FBQztRQUN6QyxJQUFJLENBQUMsTUFBTTtZQUNULFdBQVcsQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsSUFBSSxXQUFXLENBQUM7UUFDdEUsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxD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QUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUMxRCxVQUFVLEVBQUUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3JELENBQUMsQ0FDSCxDQUFDO1lBRUYsTUFBTSxjQUFjLEdBQUcsSUFBSSxHQUFHLENBQUMsY0FBYyxDQUMzQyxPQUFPLEVBQ1AsaUNBQWlDLEVBQ2pDO2dCQUNFLFlBQVksRUFBRSxpQ0FBaUM7Z0JBQy9DLFlBQVksRUFBRSxRQUFRLENBQUMsWUFBWTtnQkFDbkMsVUFBVSxFQUFFO29CQUNWLFVBQVUsRUFBRSxPQUFPLENBQUMsVUFBVTtpQkFDL0I7YUFDRixDQUNGLENBQUM7WUFFRixzRUFBc0U7WUFDdEUsOERBQThEO1lBQzlELGdDQUFnQztZQUNoQyxJQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUU7Z0JBQ2xCLGNBQWMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQzthQUNuRDtTQUNGO1FBQ0QsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FDekMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FDMUMsQ0FBQztJQUNKLENBQUM7SUFFRCxtQkFBbUI7SUFDbkIsbUVBQW1FO0lBQ25FLHlDQUF5QztJQUV6QyxLQUFLLENBQ0gsRUFBSyxFQUNMLEtBQW9DO1FBRXBDLE9BQU8sSUFBQSx1QkFBSyxFQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDaEMsQ0FBQztDQUNGO0FBdllELGtCQXVZQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmcy1leHRyYVwiO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0IHsgSUNvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBzMyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXMzXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCB7IElMYXllclZlcnNpb24gfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYVwiO1xuaW1wb3J0ICogYXMgY3hhcGkgZnJvbSBcImF3cy1jZGstbGliL2N4LWFwaVwiO1xuaW1wb3J0IHsgU3RhdGUgfSBmcm9tIFwiQHNlcnZlcmxlc3Mtc3RhY2svY29yZVwiO1xuaW1wb3J0IHsgU3RhY2sgfSBmcm9tIFwiLi9TdGFja1wiO1xuaW1wb3J0IHtcbiAgU1NUQ29uc3RydWN0LFxuICBTU1RDb25zdHJ1Y3RNZXRhZGF0YSxcbiAgaXNTU1RDb25zdHJ1Y3QsXG4gIGlzU3RhY2tDb25zdHJ1Y3QsXG59IGZyb20gXCIuL0NvbnN0cnVjdFwiO1xuaW1wb3J0IHsgRnVuY3Rpb25Qcm9wcywgRnVuY3Rpb25IYW5kbGVyUHJvcHMgfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgQmFzZVNpdGVFbnZpcm9ubWVudE91dHB1dHNJbmZvIH0gZnJvbSBcIi4vQmFzZVNpdGVcIjtcbmltcG9ydCB7IFBlcm1pc3Npb25zIH0gZnJvbSBcIi4vdXRpbC9wZXJtaXNzaW9uXCI7XG5pbXBvcnQgeyBTdGFja1Byb3BzIH0gZnJvbSBcIi5cIjtcbmltcG9ydCB7IEZ1bmN0aW9uYWxTdGFjaywgc3RhY2sgfSBmcm9tIFwiLi9GdW5jdGlvbmFsU3RhY2tcIjtcblxuZnVuY3Rpb24gZXhpdFdpdGhNZXNzYWdlKG1lc3NhZ2U6IHN0cmluZykge1xuICBjb25zb2xlLmVycm9yKG1lc3NhZ2UpO1xuICBwcm9jZXNzLmV4aXQoMSk7XG59XG5cbi8qKlxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQXBwRGVwbG95UHJvcHMge1xuICAvKipcbiAgICogVGhlIGFwcCBuYW1lLCB1c2VkIHRvIHByZWZpeCBzdGFja3MuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gRGVmYXVsdHMgdG8gZW1wdHkgc3RyaW5nXG4gICAqL1xuICByZWFkb25seSBuYW1lPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgc3RhZ2UgdG8gZGVwbG95IHRoaXMgYXBwIHRvLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIERlZmF1bHRzIHRvIGRldlxuICAgKi9cbiAgcmVhZG9ubHkgc3RhZ2U/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSByZWdpb24gdG8gZGVwbG95IHRoaXMgYXBwIHRvLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIERlZmF1bHRzIHRvIHVzLWVhc3QtMVxuICAgKi9cbiAgcmVhZG9ubHkgcmVnaW9uPzogc3RyaW5nO1xuXG4gIHJlYWRvbmx5IGJ1aWxkRGlyPzogc3RyaW5nO1xuICByZWFkb25seSBza2lwQnVpbGQ/OiBib29sZWFuO1xuICByZWFkb25seSBlc2J1aWxkQ29uZmlnPzogc3RyaW5nO1xuICByZWFkb25seSBkZWJ1Z0VuZHBvaW50Pzogc3RyaW5nO1xuICByZWFkb25seSBkZWJ1Z0J1Y2tldEFybj86IHN0cmluZztcbiAgcmVhZG9ubHkgZGVidWdCdWNrZXROYW1lPzogc3RyaW5nO1xuICByZWFkb25seSBkZWJ1Z1N0YXJ0ZWRBdD86IG51bWJlcjtcbiAgcmVhZG9ubHkgZGVidWdCcmlkZ2U/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGRlYnVnSW5jcmVhc2VUaW1lb3V0PzogYm9vbGVhbjtcblxuICAvKipcbiAgICogVGhlIGNhbGxiYWNrIGFmdGVyIHN5bnRoIGNvbXBsZXRlcywgdXNlZCBieSBgc3N0IHN0YXJ0YC5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBEZWZhdWx0cyB0byB1bmRlZmluZWRcbiAgICovXG4gIHJlYWRvbmx5IHN5bnRoQ2FsbGJhY2s/OiAoXG4gICAgbGFtYmRhSGFuZGxlcnM6IEZ1bmN0aW9uSGFuZGxlclByb3BzW10sXG4gICAgc2l0ZUVudmlyb25tZW50czogQmFzZVNpdGVFbnZpcm9ubWVudE91dHB1dHNJbmZvW11cbiAgKSA9PiB2b2lkO1xufVxuXG50eXBlIEFwcFJlbW92YWxQb2xpY3kgPSBMb3dlcmNhc2U8a2V5b2YgdHlwZW9mIGNkay5SZW1vdmFsUG9saWN5PjtcblxuZXhwb3J0IHR5cGUgQXBwUHJvcHMgPSBjZGsuQXBwUHJvcHM7XG5cbi8qKlxuICogVGhlIEFwcCBjb25zdHJ1Y3QgZXh0ZW5kcyBjZGsuQXBwIGFuZCBpcyB1c2VkIGludGVybmFsbHkgYnkgU1NUIHRvOlxuICogLSBBdXRvbWF0aWNhbGx5IHByZWZpeCBzdGFjayBuYW1lcyB3aXRoIHRoZSBzdGFnZSBhbmQgYXBwIG5hbWVcbiAqIC0gRGVwbG95IHRoZSBlbnRpcmUgYXBwIHVzaW5nIHRoZSBzYW1lIEFXUyBwcm9maWxlIGFuZCByZWdpb25cbiAqXG4gKiBJdCBpcyBtYWRlIGF2YWlsYWJsZSBhcyB0aGUgYGFwcGAgaW4gdGhlIGBzdGFja3MvaW5kZXguanNgIG9mIHlvdXIgU1NUIGFwcC5cbiAqXG4gKiBgYGBqc1xuICogZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gbWFpbihhcHApIHtcbiAqICAgbmV3IE15U2FtcGxlU3RhY2soYXBwLCBcInNhbXBsZVwiKTtcbiAqIH1cbiAqIGBgYFxuICpcbiAqIFNpbmNlIGl0IGlzIGluaXRpYWxpemVkIGludGVybmFsbHksIHRoZSBwcm9wcyB0aGF0IGFyZSBwYXNzZWQgdG8gQXBwIGNhbm5vdCBiZSBjaGFuZ2VkLlxuICpcbiAqIEBleGFtcGxlXG4gKi9cbmV4cG9ydCBjbGFzcyBBcHAgZXh0ZW5kcyBjZGsuQXBwIHtcbiAgLyoqXG4gICAqIFdoZXRoZXIgb3Igbm90IHRoZSBhcHAgaXMgcnVubmluZyBsb2NhbGx5IHVuZGVyIGBzc3Qgc3RhcnRgXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgbG9jYWw6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAvKipcbiAgICogVGhlIG5hbWUgb2YgeW91ciBhcHAsIGNvbWVzIGZyb20gdGhlIGBuYW1lYCBpbiB5b3VyIGBzc3QuanNvbmBcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBuYW1lOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgc3RhZ2UgdGhlIGFwcCBpcyBiZWluZyBkZXBsb3llZCB0by4gSWYgdGhpcyBpcyBub3Qgc3BlY2lmaWVkIGFzIHRoZSAtLXN0YWdlIG9wdGlvbiwgaXQnbGwgZGVmYXVsdCB0byB0aGUgc3RhZ2UgY29uZmlndXJlZCBkdXJpbmcgdGhlIGluaXRpYWwgcnVuIG9mIHRoZSBTU1QgQ0xJLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHN0YWdlOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgcmVnaW9uIHRoZSBhcHAgaXMgYmVpbmcgZGVwbG95ZWQgdG8uIElmIHRoaXMgaXMgbm90IHNwZWNpZmllZCBhcyB0aGUgLS1yZWdpb24gb3B0aW9uIGluIHRoZSBTU1QgQ0xJLCBpdCdsbCBkZWZhdWx0IHRvIHRoZSByZWdpb24gaW4geW91ciBzc3QuanNvbi5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSByZWdpb246IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBBV1MgYWNjb3VudCB0aGUgYXBwIGlzIGJlaW5nIGRlcGxveWVkIHRvLiBUaGlzIGNvbWVzIGZyb20gdGhlIElBTSBjcmVkZW50aWFscyBiZWluZyB1c2VkIHRvIHJ1biB0aGUgU1NUIENMSS5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBhY2NvdW50OiBzdHJpbmc7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIHJlYWRvbmx5IGJ1aWxkRGlyOiBzdHJpbmc7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIHJlYWRvbmx5IGVzYnVpbGRDb25maWc/OiBzdHJpbmc7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIHJlYWRvbmx5IGRlYnVnQnJpZGdlPzogc3RyaW5nO1xuICAvKiogQGludGVybmFsICovXG4gIHB1YmxpYyByZWFkb25seSBkZWJ1Z0VuZHBvaW50Pzogc3RyaW5nO1xuICAvKiogQGludGVybmFsICovXG4gIHB1YmxpYyByZWFkb25seSBkZWJ1Z0J1Y2tldEFybj86IHN0cmluZztcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgcmVhZG9ubHkgZGVidWdCdWNrZXROYW1lPzogc3RyaW5nO1xuICAvKiogQGludGVybmFsICovXG4gIHB1YmxpYyByZWFkb25seSBkZWJ1Z1N0YXJ0ZWRBdD86IG51bWJlcjtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgcmVhZG9ubHkgZGVidWdJbmNyZWFzZVRpbWVvdXQ/OiBib29sZWFuO1xuICAvKiogQGludGVybmFsICovXG4gIHB1YmxpYyByZWFkb25seSBhcHBQYXRoOiBzdHJpbmc7XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgZGVmYXVsdEZ1bmN0aW9uUHJvcHM6IChcbiAgICB8IEZ1bmN0aW9uUHJvcHNcbiAgICB8ICgoc3RhY2s6IGNkay5TdGFjaykgPT4gRnVuY3Rpb25Qcm9wcylcbiAgKVtdO1xuICBwcml2YXRlIF9kZWZhdWx0UmVtb3ZhbFBvbGljeT86IEFwcFJlbW92YWxQb2xpY3k7XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgZ2V0IGRlZmF1bHRSZW1vdmFsUG9saWN5KCkge1xuICAgIHJldHVybiB0aGlzLl9kZWZhdWx0UmVtb3ZhbFBvbGljeTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgY2FsbGJhY2sgYWZ0ZXIgc3ludGggY29tcGxldGVzLlxuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBzeW50aENhbGxiYWNrPzogKFxuICAgIGxhbWJkYUhhbmRsZXJzOiBGdW5jdGlvbkhhbmRsZXJQcm9wc1tdLFxuICAgIHNpdGVFbnZpcm9ubWVudHM6IEJhc2VTaXRlRW52aXJvbm1lbnRPdXRwdXRzSW5mb1tdXG4gICkgPT4gdm9pZDtcblxuICAvKipcbiAgICogQSBsaXN0IG9mIExhbWJkYSBmdW5jdGlvbnMgaW4gdGhlIGFwcFxuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBsYW1iZGFIYW5kbGVyczogRnVuY3Rpb25IYW5kbGVyUHJvcHNbXSA9IFtdO1xuICBwcml2YXRlIHJlYWRvbmx5IHNpdGVFbnZpcm9ubWVudHM6IEJhc2VTaXRlRW52aXJvbm1lbnRPdXRwdXRzSW5mb1tdID0gW107XG5cbiAgLyoqXG4gICAqIFNraXAgYnVpbGRpbmcgRnVuY3Rpb24gY29kZVxuICAgKiBOb3RlIHRoYXQgb24gYHNzdCByZW1vdmVgLCB3ZSBkbyBub3Qgd2FudCB0byBidW5kbGUgdGhlIExhbWJkYSBmdW5jdGlvbnMuXG4gICAqICAgICAgQ0RLIGRpc2FibGVzIGJ1bmRsaW5nIChpZS4gemlwcGluZykgZm9yIGBjZGsgZGVzdHJveWAgY29tbWFuZC5cbiAgICogICAgICBCdXQgU1NUIHJ1bnMgYGNkayBzeW50aGAgZmlyc3QgdGhlbiBtYW51YWxseSByZW1vdmUgZWFjaCBzdGFjay4gSGVuY2VcbiAgICogICAgICB3ZSBjYW5ub3QgcmVseSBvbiBDREsgdG8gZGlzYWJsZSBidW5kbGluZywgYW5kIHdlIGRpc2FibGUgaXQgbWFudWFsbHkuXG4gICAqICAgICAgVGhpcyBhbGxvd3MgdXMgdG8gZGlzYWJsZSBCT1RIIGJ1aWxkaW5nIGFuZCBidW5kbGluZywgd2hlcmUgYXMgQ0RLXG4gICAqICAgICAgd291bGQgb25seSBkaXNhYmxlIHRoZSBsYXR0ZXIuIEZvciBleGFtcGxlLCBgY2RrIGRlc3Ryb3lgIHN0aWxsIHRyeXNcbiAgICogICAgICB0byBpbnN0YWxsIFB5dGhvbiBkZXBlbmRlbmNpZXMgaW4gRG9ja2VyLlxuICAgKlxuICAgKiBAaW50ZXJuYWxcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBza2lwQnVpbGQ6IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgY29uc3RydWN0b3IoZGVwbG95UHJvcHM6IEFwcERlcGxveVByb3BzID0ge30sIHByb3BzOiBBcHBQcm9wcyA9IHt9KSB7XG4gICAgc3VwZXIocHJvcHMpO1xuICAgIHRoaXMuYXBwUGF0aCA9IHByb2Nlc3MuY3dkKCk7XG5cbiAgICB0aGlzLnN0YWdlID0gZGVwbG95UHJvcHMuc3RhZ2UgfHwgXCJkZXZcIjtcbiAgICB0aGlzLm5hbWUgPSBkZXBsb3lQcm9wcy5uYW1lIHx8IFwibXktYXBwXCI7XG4gICAgdGhpcy5yZWdpb24gPVxuICAgICAgZGVwbG95UHJvcHMucmVnaW9uIHx8IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX1JFR0lPTiB8fCBcInVzLWVhc3QtMVwiO1xuICAgIHRoaXMuYWNjb3VudCA9IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX0FDQ09VTlQgfHwgXCJteS1hY2NvdW50XCI7XG4gICAgdGhpcy5lc2J1aWxkQ29uZmlnID0gZGVwbG95UHJvcHMuZXNidWlsZENvbmZpZztcbiAgICB0aGlzLmJ1aWxkRGlyID0gZGVwbG95UHJvcHMuYnVpbGREaXIgfHwgXCIuYnVpbGRcIjtcbiAgICB0aGlzLnNraXBCdWlsZCA9IGRlcGxveVByb3BzLnNraXBCdWlsZCB8fCBmYWxzZTtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzID0gW107XG4gICAgdGhpcy5zeW50aENhbGxiYWNrID0gZGVwbG95UHJvcHMuc3ludGhDYWxsYmFjaztcblxuICAgIFN0YXRlLmluaXQodGhpcy5hcHBQYXRoKTtcbiAgICBpZiAoZGVwbG95UHJvcHMuZGVidWdFbmRwb2ludCkge1xuICAgICAgdGhpcy5sb2NhbCA9IHRydWU7XG4gICAgICBTdGF0ZS5GdW5jdGlvbi5yZXNldCh0aGlzLmFwcFBhdGgpO1xuICAgICAgdGhpcy5kZWJ1Z0VuZHBvaW50ID0gZGVwbG95UHJvcHMuZGVidWdFbmRwb2ludDtcbiAgICAgIHRoaXMuZGVidWdCdWNrZXRBcm4gPSBkZXBsb3lQcm9wcy5kZWJ1Z0J1Y2tldEFybjtcbiAgICAgIHRoaXMuZGVidWdCdWNrZXROYW1lID0gZGVwbG95UHJvcHMuZGVidWdCdWNrZXROYW1lO1xuICAgICAgdGhpcy5kZWJ1Z1N0YXJ0ZWRBdCA9IGRlcGxveVByb3BzLmRlYnVnU3RhcnRlZEF0O1xuICAgICAgdGhpcy5kZWJ1Z0luY3JlYXNlVGltZW91dCA9IGRlcGxveVByb3BzLmRlYnVnSW5jcmVhc2VUaW1lb3V0O1xuICAgICAgaWYgKGRlcGxveVByb3BzLmRlYnVnQnJpZGdlKSB7XG4gICAgICAgIHRoaXMuZGVidWdCcmlkZ2UgPSBkZXBsb3lQcm9wcy5kZWJ1Z0JyaWRnZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVXNlIHRoaXMgbWV0aG9kIHRvIHByZWZpeCByZXNvdXJjZSBuYW1lcyBpbiB5b3VyIHN0YWNrcyB0byBtYWtlIHN1cmUgdGhleSBkb24ndCB0aHJhc2ggd2hlbiBkZXBsb3llZCB0byBkaWZmZXJlbnQgc3RhZ2VzIGluIHRoZSBzYW1lIEFXUyBhY2NvdW50LiBUaGlzIG1ldGhvZCB3aWxsIHByZWZpeCBhIGdpdmVuIHJlc291cmNlIG5hbWUgd2l0aCB0aGUgc3RhZ2UgYW5kIGFwcCBuYW1lLiBVc2luZyB0aGUgZm9ybWF0IGAke3N0YWdlfS0ke25hbWV9LSR7bG9naWNhbE5hbWV9YC5cbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogY29uc29sZS5sb2coYXBwLmxvZ2ljYWxQcmVmaXhlZE5hbWUoXCJteVRvcGljXCIpKTtcbiAgICpcbiAgICogLy8gZGV2LW15LWFwcC1teVRvcGljXG4gICAqIGBgYFxuICAgKi9cbiAgcHVibGljIGxvZ2ljYWxQcmVmaXhlZE5hbWUobG9naWNhbE5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgbmFtZVByZWZpeCA9IHRoaXMubmFtZSA9PT0gXCJcIiA/IFwiXCIgOiBgJHt0aGlzLm5hbWV9LWA7XG4gICAgcmV0dXJuIGAke3RoaXMuc3RhZ2V9LSR7bmFtZVByZWZpeH0ke2xvZ2ljYWxOYW1lfWA7XG4gIH1cblxuICAvKipcbiAgICogVGhlIGRlZmF1bHQgcmVtb3ZhbCBwb2xpY3kgdGhhdCdsbCBiZSBhcHBsaWVkIHRvIGFsbCB0aGUgcmVzb3VyY2VzIGluIHRoZSBhcHAuIFRoaXMgY2FuIGJlIHVzZWZ1bCB0byBzZXQgZXBoZW1lcmFsIChkZXYgb3IgZmVhdHVyZSBicmFuY2gpIGVudmlyb25tZW50cyB0byByZW1vdmUgYWxsIHRoZSByZXNvdXJjZXMgb24gZGVsZXRpb24uXG4gICAqIDo6OmRhbmdlclxuICAgKiBNYWtlIHN1cmUgdG8gbm90IHNldCB0aGUgZGVmYXVsdCByZW1vdmFsIHBvbGljeSB0byBgREVTVFJPWWAgZm9yIHByb2R1Y3Rpb24gZW52aXJvbm1lbnRzLlxuICAgKiA6OjpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogYXBwLnNldERlZmF1bHRSZW1vdmFsUG9saWN5KGFwcC5sb2NhbCA/IFwiZGVzdHJveVwiIDogXCJyZXRhaW5cIilcbiAgICogYGBgXG4gICAqL1xuICBwdWJsaWMgc2V0RGVmYXVsdFJlbW92YWxQb2xpY3kocG9saWN5OiBBcHBSZW1vdmFsUG9saWN5KSB7XG4gICAgdGhpcy5fZGVmYXVsdFJlbW92YWxQb2xpY3kgPSBwb2xpY3k7XG4gIH1cblxuICAvKipcbiAgICogVGhlIGRlZmF1bHQgZnVuY3Rpb24gcHJvcHMgdG8gYmUgYXBwbGllZCB0byBhbGwgdGhlIExhbWJkYSBmdW5jdGlvbnMgaW4gdGhlIGFwcC4gVGhlc2UgZGVmYXVsdCB2YWx1ZXMgd2lsbCBiZSBvdmVycmlkZGVuIGlmIGEgRnVuY3Rpb24gc2V0cyBpdHMgb3duIHByb3BzLlxuICAgKiBUaGlzIG5lZWRzIHRvIGJlIGNhbGxlZCBiZWZvcmUgYSBzdGFjayB3aXRoIGFueSBmdW5jdGlvbnMgaGF2ZSBiZWVuIGFkZGVkIHRvIHRoZSBhcHAuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIGFwcC5zZXREZWZhdWx0RnVuY3Rpb25Qcm9wcyh7XG4gICAqICAgcnVudGltZTogXCJub2RlanMxMi54XCIsXG4gICAqICAgdGltZW91dDogMzBcbiAgICogfSlcbiAgICogYGBgXG4gICAqL1xuICBwdWJsaWMgc2V0RGVmYXVsdEZ1bmN0aW9uUHJvcHMoXG4gICAgcHJvcHM6IEZ1bmN0aW9uUHJvcHMgfCAoKHN0YWNrOiBjZGsuU3RhY2spID0+IEZ1bmN0aW9uUHJvcHMpXG4gICk6IHZvaWQge1xuICAgIGlmICh0aGlzLmxhbWJkYUhhbmRsZXJzLmxlbmd0aCA+IDApXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIFwiQ2Fubm90IGNhbGwgJ3NldERlZmF1bHRGdW5jdGlvblByb3BzJyBhZnRlciBhIHN0YWNrIHdpdGggZnVuY3Rpb25zIGhhcyBiZWVuIGNyZWF0ZWQuIFBsZWFzZSB1c2UgJ2FkZERlZmF1bHRGdW5jdGlvbkVudicgb3IgJ2FkZERlZmF1bHRGdW5jdGlvblBlcm1pc3Npb25zJyB0byBhZGQgbW9yZSBkZWZhdWx0IHByb3BlcnRpZXMuIFJlYWQgbW9yZSBhYm91dCB0aGlzIGNoYW5nZSBoZXJlOiBodHRwczovL2RvY3Muc2VydmVybGVzcy1zdGFjay5jb20vY29uc3RydWN0cy9BcHAjdXBncmFkaW5nLXRvLXYwNDIwXCJcbiAgICAgICk7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcy5wdXNoKHByb3BzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGFkZGl0aW9uYWwgZGVmYXVsdCBQZXJtaXNzaW9ucyB0byBiZSBhcHBsaWVkIHRvIGFsbCBMYW1iZGEgZnVuY3Rpb25zIGluIHRoZSBhcHAuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIGFwcC5hZGREZWZhdWx0RnVuY3Rpb25QZXJtaXNzaW9ucyhbXCJzM1wiXSlcbiAgICogYGBgXG4gICAqL1xuICBwdWJsaWMgYWRkRGVmYXVsdEZ1bmN0aW9uUGVybWlzc2lvbnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKSB7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcy5wdXNoKHtcbiAgICAgIHBlcm1pc3Npb25zLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYWRkaXRpb25hbCBkZWZhdWx0IGVudmlyb25tZW50IHZhcmlhYmxlcyB0byBiZSBhcHBsaWVkIHRvIGFsbCBMYW1iZGEgZnVuY3Rpb25zIGluIHRoZSBhcHAuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIGFwcC5hZGREZWZhdWx0RnVuY3Rpb25QZXJtaXNzaW9ucyh7XG4gICAqICAgXCJNWV9FTlZfVkFSXCI6IFwibXktdmFsdWVcIlxuICAgKiB9KVxuICAgKiBgYGBcbiAgICovXG4gIHB1YmxpYyBhZGREZWZhdWx0RnVuY3Rpb25FbnYoZW52aXJvbm1lbnQ6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4pIHtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLnB1c2goe1xuICAgICAgZW52aXJvbm1lbnQsXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhZGRpdGlvbmFsIGRlZmF1bHQgbGF5ZXJzIHRvIGJlIGFwcGxpZWQgdG8gYWxsIExhbWJkYSBmdW5jdGlvbnMgaW4gdGhlIHN0YWNrLlxuICAgKi9cbiAgcHVibGljIGFkZERlZmF1bHRGdW5jdGlvbkxheWVycyhsYXllcnM6IElMYXllclZlcnNpb25bXSkge1xuICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMucHVzaCh7XG4gICAgICBsYXllcnMsXG4gICAgfSk7XG4gIH1cblxuICBzeW50aChvcHRpb25zOiBjZGsuU3RhZ2VTeW50aGVzaXNPcHRpb25zID0ge30pOiBjeGFwaS5DbG91ZEFzc2VtYmx5IHtcbiAgICB0aGlzLmJ1aWxkQ29uc3RydWN0c01ldGFkYXRhKCk7XG5cbiAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRoaXMubm9kZS5jaGlsZHJlbikge1xuICAgICAgaWYgKGlzU3RhY2tDb25zdHJ1Y3QoY2hpbGQpKSB7XG4gICAgICAgIC8vIFRhZyBzdGFja3NcbiAgICAgICAgY2RrLlRhZ3Mub2YoY2hpbGQpLmFkZChcInNzdDphcHBcIiwgdGhpcy5uYW1lKTtcbiAgICAgICAgY2RrLlRhZ3Mub2YoY2hpbGQpLmFkZChcInNzdDpzdGFnZVwiLCB0aGlzLnN0YWdlKTtcblxuICAgICAgICAvLyBTZXQgcmVtb3ZhbCBwb2xpY3lcbiAgICAgICAgaWYgKHRoaXMuX2RlZmF1bHRSZW1vdmFsUG9saWN5KVxuICAgICAgICAgIHRoaXMuYXBwbHlSZW1vdmFsUG9saWN5KGNoaWxkLCB0aGlzLl9kZWZhdWx0UmVtb3ZhbFBvbGljeSk7XG5cbiAgICAgICAgLy8gU3RhY2sgbmFtZXMgbmVlZCB0byBiZSBwYXJhbWV0ZXJpemVkIHdpdGggdGhlIHN0YWdlIG5hbWVcbiAgICAgICAgaWYgKFxuICAgICAgICAgICFjaGlsZC5zdGFja05hbWUuc3RhcnRzV2l0aChgJHt0aGlzLnN0YWdlfS1gKSAmJlxuICAgICAgICAgICFjaGlsZC5zdGFja05hbWUuZW5kc1dpdGgoYC0ke3RoaXMuc3RhZ2V9YCkgJiZcbiAgICAgICAgICBjaGlsZC5zdGFja05hbWUuaW5kZXhPZihgLSR7dGhpcy5zdGFnZX0tYCkgPT09IC0xXG4gICAgICAgICkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBTdGFjayBcIiR7Y2hpbGQuc3RhY2tOYW1lfVwiIGlzIG5vdCBwYXJhbWV0ZXJpemVkIHdpdGggdGhlIHN0YWdlIG5hbWUuIFRoZSBzdGFjayBuYW1lIG5lZWRzIHRvIGVpdGhlciBzdGFydCB3aXRoIFwiJHN0YWdlLVwiLCBlbmQgaW4gXCItJHN0YWdlXCIsIG9yIGNvbnRhaW4gdGhlIHN0YWdlIG5hbWUgXCItJHN0YWdlLVwiLmBcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgY2xvdWRBc3NlbWJseSA9IHN1cGVyLnN5bnRoKG9wdGlvbnMpO1xuXG4gICAgLy8gUnVuIGNhbGxiYWNrIGFmdGVyIHN5bnRoIGhhcyBmaW5pc2hlZFxuICAgIGlmICh0aGlzLnN5bnRoQ2FsbGJhY2spIHtcbiAgICAgIHRoaXMuc3ludGhDYWxsYmFjayh0aGlzLmxhbWJkYUhhbmRsZXJzLCB0aGlzLnNpdGVFbnZpcm9ubWVudHMpO1xuICAgIH1cblxuICAgIHJldHVybiBjbG91ZEFzc2VtYmx5O1xuICB9XG5cbiAgaXNKZXN0VGVzdCgpOiBib29sZWFuIHtcbiAgICAvLyBDaGVjayB0aGUgZW52IHZhciBzZXQgaW5zaWRlIHRlc3Qvc2V0dXAtdGVzdHMuanNcbiAgICByZXR1cm4gcHJvY2Vzcy5lbnYuSkVTVF9SRVNPVVJDRVNfVEVTVFMgPT09IFwiZW5hYmxlZFwiO1xuICB9XG5cbiAgcmVnaXN0ZXJMYW1iZGFIYW5kbGVyKGhhbmRsZXI6IEZ1bmN0aW9uSGFuZGxlclByb3BzKTogdm9pZCB7XG4gICAgdGhpcy5sYW1iZGFIYW5kbGVycy5wdXNoKGhhbmRsZXIpO1xuICB9XG5cbiAgcmVnaXN0ZXJTaXRlRW52aXJvbm1lbnQoZW52aXJvbm1lbnQ6IEJhc2VTaXRlRW52aXJvbm1lbnRPdXRwdXRzSW5mbyk6IHZvaWQge1xuICAgIHRoaXMuc2l0ZUVudmlyb25tZW50cy5wdXNoKGVudmlyb25tZW50KTtcbiAgfVxuXG4gIGdldElucHV0RmlsZXNGcm9tRXNidWlsZE1ldGFmaWxlKGZpbGU6IHN0cmluZyk6IEFycmF5PHN0cmluZz4ge1xuICAgIGxldCBtZXRhSnNvbjtcblxuICAgIHRyeSB7XG4gICAgICBtZXRhSnNvbiA9IGZzLnJlYWRKc29uU3luYyhmaWxlKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBleGl0V2l0aE1lc3NhZ2UoXCJUaGVyZSB3YXMgYSBwcm9ibGVtIHJlYWRpbmcgdGhlIGVzYnVpbGQgbWV0YWZpbGUuXCIpO1xuICAgIH1cblxuICAgIHJldHVybiBPYmplY3Qua2V5cyhtZXRhSnNvbi5pbnB1dHMpLm1hcCgoaW5wdXQpID0+IHBhdGgucmVzb2x2ZShpbnB1dCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZENvbnN0cnVjdHNNZXRhZGF0YSgpOiB2b2lkIHtcbiAgICBjb25zdCBjb25zdHJ1Y3RzID0gdGhpcy5idWlsZENvbnN0cnVjdHNNZXRhZGF0YV9jb2xsZWN0Q29uc3RydWN0cyh0aGlzKTtcbiAgICB0eXBlIENvbnN0cnVjdCA9IFNTVENvbnN0cnVjdE1ldGFkYXRhICYge1xuICAgICAgYWRkcjogc3RyaW5nO1xuICAgICAgaWQ6IHN0cmluZztcbiAgICAgIHN0YWNrOiBzdHJpbmc7XG4gICAgfTtcbiAgICBjb25zdCBieVN0YWNrOiBSZWNvcmQ8c3RyaW5nLCBDb25zdHJ1Y3RbXT4gPSB7fTtcbiAgICBjb25zdCBsb2NhbDogQ29uc3RydWN0W10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IGMgb2YgY29uc3RydWN0cykge1xuICAgICAgY29uc3Qgc3RhY2sgPSBTdGFjay5vZihjKTtcbiAgICAgIGNvbnN0IGxpc3QgPSBieVN0YWNrW3N0YWNrLm5vZGUuaWRdIHx8IFtdO1xuICAgICAgY29uc3QgbWV0YWRhdGEgPSBjLmdldENvbnN0cnVjdE1ldGFkYXRhKCk7XG4gICAgICBjb25zdCBpdGVtOiBDb25zdHJ1Y3QgPSB7XG4gICAgICAgIGlkOiBjLm5vZGUuaWQsXG4gICAgICAgIGFkZHI6IGMubm9kZS5hZGRyLFxuICAgICAgICBzdGFjazogU3RhY2sub2YoYykuc3RhY2tOYW1lLFxuICAgICAgICAuLi5tZXRhZGF0YSxcbiAgICAgIH07XG4gICAgICBsb2NhbC5wdXNoKGl0ZW0pO1xuICAgICAgbGlzdC5wdXNoKHtcbiAgICAgICAgLi4uaXRlbSxcbiAgICAgICAgbG9jYWw6IHVuZGVmaW5lZCxcbiAgICAgIH0pO1xuICAgICAgYnlTdGFja1tzdGFjay5ub2RlLmlkXSA9IGxpc3Q7XG4gICAgfVxuXG4gICAgLy8gUmVnaXN0ZXIgY29uc3RydWN0c1xuICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdGhpcy5ub2RlLmNoaWxkcmVuKSB7XG4gICAgICBpZiAoY2hpbGQgaW5zdGFuY2VvZiBTdGFjaykge1xuICAgICAgICBjb25zdCBzdGFja05hbWUgPSAoY2hpbGQgYXMgU3RhY2spLm5vZGUuaWQ7XG4gICAgICAgIChjaGlsZCBhcyBTdGFjaykuYWRkQ29uc3RydWN0c01ldGFkYXRhKGJ5U3RhY2tbc3RhY2tOYW1lXSB8fCBbXSk7XG4gICAgICB9XG4gICAgfVxuICAgIGZzLndyaXRlSlNPTlN5bmMoU3RhdGUucmVzb2x2ZSh0aGlzLmFwcFBhdGgsIFwiY29uc3RydWN0cy5qc29uXCIpLCBsb2NhbCk7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkQ29uc3RydWN0c01ldGFkYXRhX2NvbGxlY3RDb25zdHJ1Y3RzKFxuICAgIGNvbnN0cnVjdDogSUNvbnN0cnVjdFxuICApOiAoU1NUQ29uc3RydWN0ICYgSUNvbnN0cnVjdClbXSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIGlzU1NUQ29uc3RydWN0KGNvbnN0cnVjdCkgPyBjb25zdHJ1Y3QgOiB1bmRlZmluZWQsXG4gICAgICAuLi5jb25zdHJ1Y3Qubm9kZS5jaGlsZHJlbi5mbGF0TWFwKChjKSA9PlxuICAgICAgICB0aGlzLmJ1aWxkQ29uc3RydWN0c01ldGFkYXRhX2NvbGxlY3RDb25zdHJ1Y3RzKGMpXG4gICAgICApLFxuICAgIF0uZmlsdGVyKChjKTogYyBpcyBTU1RDb25zdHJ1Y3QgJiBJQ29uc3RydWN0ID0+IEJvb2xlYW4oYykpO1xuICB9XG5cbiAgcHJpdmF0ZSBhcHBseVJlbW92YWxQb2xpY3koY3VycmVudDogSUNvbnN0cnVjdCwgcG9saWN5OiBBcHBSZW1vdmFsUG9saWN5KSB7XG4gICAgaWYgKGN1cnJlbnQgaW5zdGFuY2VvZiBjZGsuQ2ZuUmVzb3VyY2UpIHtcbiAgICAgIGN1cnJlbnQuYXBwbHlSZW1vdmFsUG9saWN5KFxuICAgICAgICBjZGsuUmVtb3ZhbFBvbGljeVtcbiAgICAgICAgICBwb2xpY3kudG9VcHBlckNhc2UoKSBhcyBrZXlvZiB0eXBlb2YgY2RrLlJlbW92YWxQb2xpY3lcbiAgICAgICAgXVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBIYWQgdG8gY29weSB0aGlzIGluIHRvIGVuYWJsZSBkZWxldGluZyBvYmplY3RzIGluIGJ1Y2tldFxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hd3MvYXdzLWNkay9ibG9iL21hc3Rlci9wYWNrYWdlcy8lNDBhd3MtY2RrL2F3cy1zMy9saWIvYnVja2V0LnRzI0wxOTEwXG4gICAgaWYgKFxuICAgICAgY3VycmVudCBpbnN0YW5jZW9mIHMzLkJ1Y2tldCAmJlxuICAgICAgIWN1cnJlbnQubm9kZS50cnlGaW5kQ2hpbGQoXCJBdXRvRGVsZXRlT2JqZWN0c0N1c3RvbVJlc291cmNlXCIpXG4gICAgKSB7XG4gICAgICBjb25zdCBBVVRPX0RFTEVURV9PQkpFQ1RTX1JFU09VUkNFX1RZUEUgPSBcIkN1c3RvbTo6UzNBdXRvRGVsZXRlT2JqZWN0c1wiO1xuICAgICAgY29uc3QgcHJvdmlkZXIgPSBjZGsuQ3VzdG9tUmVzb3VyY2VQcm92aWRlci5nZXRPckNyZWF0ZVByb3ZpZGVyKFxuICAgICAgICBjdXJyZW50LFxuICAgICAgICBBVVRPX0RFTEVURV9PQkpFQ1RTX1JFU09VUkNFX1RZUEUsXG4gICAgICAgIHtcbiAgICAgICAgICBjb2RlRGlyZWN0b3J5OiBwYXRoLmpvaW4oXG4gICAgICAgICAgICByZXF1aXJlLnJlc29sdmUoXCJhd3MtY2RrLWxpYi9hd3MtczNcIiksXG4gICAgICAgICAgICBcIi4uL2xpYi9hdXRvLWRlbGV0ZS1vYmplY3RzLWhhbmRsZXJcIlxuICAgICAgICAgICksXG4gICAgICAgICAgcnVudGltZTogY2RrLkN1c3RvbVJlc291cmNlUHJvdmlkZXJSdW50aW1lLk5PREVKU18xMl9YLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBgTGFtYmRhIGZ1bmN0aW9uIGZvciBhdXRvLWRlbGV0aW5nIG9iamVjdHMgaW4gJHtjdXJyZW50LmJ1Y2tldE5hbWV9IFMzIGJ1Y2tldC5gLFxuICAgICAgICB9XG4gICAgICApO1xuXG4gICAgICAvLyBVc2UgYSBidWNrZXQgcG9saWN5IHRvIGFsbG93IHRoZSBjdXN0b20gcmVzb3VyY2UgdG8gZGVsZXRlXG4gICAgICAvLyBvYmplY3RzIGluIHRoZSBidWNrZXRcbiAgICAgIGN1cnJlbnQuYWRkVG9SZXNvdXJjZVBvbGljeShcbiAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgIC8vIGxpc3Qgb2JqZWN0c1xuICAgICAgICAgICAgXCJzMzpHZXRCdWNrZXQqXCIsXG4gICAgICAgICAgICBcInMzOkxpc3QqXCIsXG4gICAgICAgICAgICAvLyBhbmQgdGhlbiBkZWxldGUgdGhlbVxuICAgICAgICAgICAgXCJzMzpEZWxldGVPYmplY3QqXCIsXG4gICAgICAgICAgXSxcbiAgICAgICAgICByZXNvdXJjZXM6IFtjdXJyZW50LmJ1Y2tldEFybiwgY3VycmVudC5hcm5Gb3JPYmplY3RzKFwiKlwiKV0sXG4gICAgICAgICAgcHJpbmNpcGFsczogW25ldyBpYW0uQXJuUHJpbmNpcGFsKHByb3ZpZGVyLnJvbGVBcm4pXSxcbiAgICAgICAgfSlcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGN1c3RvbVJlc291cmNlID0gbmV3IGNkay5DdXN0b21SZXNvdXJjZShcbiAgICAgICAgY3VycmVudCxcbiAgICAgICAgXCJBdXRvRGVsZXRlT2JqZWN0c0N1c3RvbVJlc291cmNlXCIsXG4gICAgICAgIHtcbiAgICAgICAgICByZXNvdXJjZVR5cGU6IEFVVE9fREVMRVRFX09CSkVDVFNfUkVTT1VSQ0VfVFlQRSxcbiAgICAgICAgICBzZXJ2aWNlVG9rZW46IHByb3ZpZGVyLnNlcnZpY2VUb2tlbixcbiAgICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgICBCdWNrZXROYW1lOiBjdXJyZW50LmJ1Y2tldE5hbWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfVxuICAgICAgKTtcblxuICAgICAgLy8gRW5zdXJlIGJ1Y2tldCBwb2xpY3kgaXMgZGVsZXRlZCBBRlRFUiB0aGUgY3VzdG9tIHJlc291cmNlIG90aGVyd2lzZVxuICAgICAgLy8gd2UgZG9uJ3QgaGF2ZSBwZXJtaXNzaW9ucyB0byBsaXN0IGFuZCBkZWxldGUgaW4gdGhlIGJ1Y2tldC5cbiAgICAgIC8vIChhZGQgYSBgaWZgIHRvIG1ha2UgVFMgaGFwcHkpXG4gICAgICBpZiAoY3VycmVudC5wb2xpY3kpIHtcbiAgICAgICAgY3VzdG9tUmVzb3VyY2Uubm9kZS5hZGREZXBlbmRlbmN5KGN1cnJlbnQucG9saWN5KTtcbiAgICAgIH1cbiAgICB9XG4gICAgY3VycmVudC5ub2RlLmNoaWxkcmVuLmZvckVhY2goKHJlc291cmNlKSA9PlxuICAgICAgdGhpcy5hcHBseVJlbW92YWxQb2xpY3kocmVzb3VyY2UsIHBvbGljeSlcbiAgICApO1xuICB9XG5cbiAgLy8gRnVuY3Rpb25hbCBTdGFja1xuICAvLyBUaGlzIGlzIGEgbWFnaWNhbCBnbG9iYWwgdG8gYXZvaWQgaGF2aW5nIHRvIHBhc3MgYXBwIGV2ZXJ5d2hlcmUuXG4gIC8vIFdlIG9ubHkgZXZlcnkgaGF2ZSBvbmUgaW5zdGFuY2Ugb2YgYXBwXG5cbiAgc3RhY2s8VCBleHRlbmRzIEZ1bmN0aW9uYWxTdGFjazxhbnk+PihcbiAgICBmbjogVCxcbiAgICBwcm9wcz86IFN0YWNrUHJvcHMgJiB7IGlkPzogc3RyaW5nIH1cbiAgKTogUmV0dXJuVHlwZTxUPiBleHRlbmRzIFByb21pc2U8YW55PiA/IFByb21pc2U8dm9pZD4gOiBBcHAge1xuICAgIHJldHVybiBzdGFjayh0aGlzLCBmbiwgcHJvcHMpO1xuICB9XG59XG4iXX0=