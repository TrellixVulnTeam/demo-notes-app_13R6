"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.updateVersionLogicalId = exports.createVersion = exports.createFunction = exports.getOrCreateBucket = void 0;
const path = __importStar(require("path"));
const crypto = __importStar(require("crypto"));
const cdk = __importStar(require("aws-cdk-lib"));
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
function getOrCreateBucket(scope) {
    // Do not recreate if exist
    const providerId = "EdgeLambdaBucketProvider";
    const resId = "EdgeLambdaBucket";
    const stack = cdk.Stack.of(scope);
    const existingResource = stack.node.tryFindChild(resId);
    if (existingResource) {
        return existingResource;
    }
    // Create provider
    const provider = new lambda.Function(stack, providerId, {
        code: lambda.Code.fromAsset(path.join(__dirname, "custom-resource")),
        handler: "s3-bucket.handler",
        runtime: lambda.Runtime.NODEJS_12_X,
        timeout: cdk.Duration.minutes(15),
        memorySize: 1024,
        initialPolicy: [
            new iam.PolicyStatement({
                effect: iam.Effect.ALLOW,
                actions: ["s3:*"],
                resources: ["*"],
            }),
        ],
    });
    // Create custom resource
    const resource = new cdk.CustomResource(stack, resId, {
        serviceToken: provider.functionArn,
        resourceType: "Custom::SSTEdgeLambdaBucket",
        properties: {
            BucketNamePrefix: `${stack.stackName}-${resId}`,
        },
    });
    return resource;
}
exports.getOrCreateBucket = getOrCreateBucket;
function createFunction(scope, name, role, bucketName, functionParams) {
    // Do not recreate if exist
    const providerId = "EdgeLambdaProvider";
    const resId = `${name}EdgeLambda`;
    const stack = cdk.Stack.of(scope);
    let provider = stack.node.tryFindChild(providerId);
    // Create provider if not already created
    if (!provider) {
        provider = new lambda.Function(stack, providerId, {
            code: lambda.Code.fromAsset(path.join(__dirname, "custom-resource")),
            handler: "edge-lambda.handler",
            runtime: lambda.Runtime.NODEJS_12_X,
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
            initialPolicy: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ["lambda:*", "s3:*"],
                    resources: ["*"],
                }),
            ],
        });
        if (provider.role) {
            role.grantPassRole(provider.role);
        }
    }
    // Create custom resource
    const resource = new cdk.CustomResource(scope, resId, {
        serviceToken: provider.functionArn,
        resourceType: "Custom::SSTEdgeLambda",
        properties: {
            FunctionNamePrefix: `${cdk.Stack.of(scope).stackName}-${resId}`,
            FunctionBucket: bucketName,
            FunctionParams: functionParams,
        },
    });
    return resource;
}
exports.createFunction = createFunction;
function createVersion(scope, name, functionArn) {
    // Do not recreate if exist
    const providerId = "EdgeLambdaVersionProvider";
    const resId = `${name}EdgeLambdaVersion`;
    const stack = cdk.Stack.of(scope);
    let provider = stack.node.tryFindChild(providerId);
    // Create provider if not already created
    if (!provider) {
        provider = new lambda.Function(stack, providerId, {
            code: lambda.Code.fromAsset(path.join(__dirname, "custom-resource")),
            handler: "edge-lambda-version.handler",
            runtime: lambda.Runtime.NODEJS_12_X,
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
            initialPolicy: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ["lambda:*"],
                    resources: ["*"],
                }),
            ],
        });
    }
    // Create custom resource
    return new cdk.CustomResource(scope, resId, {
        serviceToken: provider.functionArn,
        resourceType: "Custom::SSTEdgeLambdaVersion",
        properties: {
            FunctionArn: functionArn,
        },
    });
}
exports.createVersion = createVersion;
function updateVersionLogicalId(functionCR, versionCR) {
    // Override the version's logical ID with a lazy string which includes the
    // hash of the function itself, so a new version resource is created when
    // the function configuration changes.
    const cfn = versionCR.node.defaultChild;
    const originalLogicalId = cdk.Stack.of(versionCR).resolve(cfn.logicalId);
    cfn.overrideLogicalId(cdk.Lazy.uncachedString({
        produce: () => {
            const hash = calculateHash(functionCR);
            const logicalId = trimFromStart(originalLogicalId, 255 - 32);
            return `${logicalId}${hash}`;
        },
    }));
}
exports.updateVersionLogicalId = updateVersionLogicalId;
function trimFromStart(s, maxLength) {
    const desiredLength = Math.min(maxLength, s.length);
    const newStart = s.length - desiredLength;
    return s.substring(newStart);
}
function calculateHash(resource) {
    // render the cloudformation resource from this function
    // config is of the shape:
    // {
    //  Resources: {
    //    LogicalId: {
    //      Type: 'Function',
    //      Properties: { ... }
    // }}}
    const cfnResource = resource.node.defaultChild;
    const config = cdk.Stack.of(resource).resolve(cfnResource._toCloudFormation());
    const resources = config.Resources;
    const resourceKeys = Object.keys(resources);
    if (resourceKeys.length !== 1) {
        throw new Error(`Expected one rendered CloudFormation resource but found ${resourceKeys.length}`);
    }
    const logicalId = resourceKeys[0];
    const properties = resources[logicalId].Properties.FunctionParams;
    const hash = crypto.createHash("md5");
    hash.update(JSON.stringify(properties));
    return hash.digest("hex");
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvc3MtcmVnaW9uLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9uZXh0anMtc2l0ZS9jcm9zcy1yZWdpb24taGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQTZCO0FBQzdCLCtDQUFpQztBQUVqQyxpREFBbUM7QUFDbkMseURBQTJDO0FBQzNDLCtEQUFpRDtBQUVqRCxTQUFnQixpQkFBaUIsQ0FBQyxLQUFnQjtJQUNoRCwyQkFBMkI7SUFDM0IsTUFBTSxVQUFVLEdBQUcsMEJBQTBCLENBQUM7SUFDOUMsTUFBTSxLQUFLLEdBQUcsa0JBQWtCLENBQUM7SUFDakMsTUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbEMsTUFBTSxnQkFBZ0IsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQXVCLENBQUM7SUFDOUUsSUFBSSxnQkFBZ0IsRUFBRTtRQUNwQixPQUFPLGdCQUFnQixDQUFDO0tBQ3pCO0lBRUQsa0JBQWtCO0lBQ2xCLE1BQU0sUUFBUSxHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFO1FBQ3RELElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3BFLE9BQU8sRUFBRSxtQkFBbUI7UUFDNUIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVztRQUNuQyxPQUFPLEVBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQ2pDLFVBQVUsRUFBRSxJQUFJO1FBQ2hCLGFBQWEsRUFBRTtZQUNiLElBQUksR0FBRyxDQUFDLGVBQWUsQ0FBQztnQkFDdEIsTUFBTSxF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LENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FDMUMsV0FBbUIsQ0FBQyxpQkFBaUIsRUFBRSxDQUN6QyxDQUFDO0lBQ0YsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQztJQUNuQyxNQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzVDLElBQUksWUFBWSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDN0IsTUFBTSxJQUFJLEtBQUssQ0FDYiwyREFBMkQsWUFBWSxDQUFDLE1BQU0sRUFBRSxDQUNqRixDQUFDO0tBQ0g7SUFDRCxNQUFNLFNBQVMsR0FBRyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbEMsTUFBTSxVQUFVLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUM7SUFFbEUsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN0QyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztJQUN4QyxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDNUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIGNyeXB0byBmcm9tIFwiY3J5cHRvXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtaWFtXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGFcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldE9yQ3JlYXRlQnVja2V0KHNjb3BlOiBDb25zdHJ1Y3QpOiBjZGsuQ3VzdG9tUmVzb3VyY2Uge1xuICAvLyBEbyBub3QgcmVjcmVhdGUgaWYgZXhpc3RcbiAgY29uc3QgcHJvdmlkZXJJZCA9IFwiRWRnZUxhbWJkYUJ1Y2tldFByb3ZpZGVyXCI7XG4gIGNvbnN0IHJlc0lkID0gXCJFZGdlTGFtYmRhQnVja2V0XCI7XG4gIGNvbnN0IHN0YWNrID0gY2RrLlN0YWNrLm9mKHNjb3BlKTtcbiAgY29uc3QgZXhpc3RpbmdSZXNvdXJjZSA9IHN0YWNrLm5vZGUudHJ5RmluZENoaWxkKHJlc0lkKSBhcyBjZGsuQ3VzdG9tUmVzb3VyY2U7XG4gIGlmIChleGlzdGluZ1Jlc291cmNlKSB7XG4gICAgcmV0dXJuIGV4aXN0aW5nUmVzb3VyY2U7XG4gIH1cblxuICAvLyBDcmVhdGUgcHJvdmlkZXJcbiAgY29uc3QgcHJvdmlkZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHN0YWNrLCBwcm92aWRlcklkLCB7XG4gICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsIFwiY3VzdG9tLXJlc291cmNlXCIpKSxcbiAgICBoYW5kbGVyOiBcInMzLWJ1Y2tldC5oYW5kbGVyXCIsXG4gICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzEyX1gsXG4gICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgIG1lbW9yeVNpemU6IDEwMjQsXG4gICAgaW5pdGlhbFBvbGljeTogW1xuICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgIGFjdGlvbnM6IFtcInMzOipcIl0sXG4gICAgICAgIHJlc291cmNlczogW1wiKlwiXSxcbiAgICAgIH0pLFxuICAgIF0sXG4gIH0pO1xuXG4gIC8vIENyZWF0ZSBjdXN0b20gcmVzb3VyY2VcbiAgY29uc3QgcmVzb3VyY2UgPSBuZXcgY2RrLkN1c3RvbVJlc291cmNlKHN0YWNrLCByZXNJZCwge1xuICAgIHNlcnZpY2VUb2tlbjogcHJvdmlkZXIuZnVuY3Rpb25Bcm4sXG4gICAgcmVzb3VyY2VUeXBlOiBcIkN1c3RvbTo6U1NURWRnZUxhbWJkYUJ1Y2tldFwiLFxuICAgIHByb3BlcnRpZXM6IHtcbiAgICAgIEJ1Y2tldE5hbWVQcmVmaXg6IGAke3N0YWNrLnN0YWNrTmFtZX0tJHtyZXNJZH1gLFxuICAgIH0sXG4gIH0pO1xuXG4gIHJldHVybiByZXNvdXJjZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUZ1bmN0aW9uKFxuICBzY29wZTogQ29uc3RydWN0LFxuICBuYW1lOiBzdHJpbmcsXG4gIHJvbGU6IGlhbS5Sb2xlLFxuICBidWNrZXROYW1lOiBzdHJpbmcsXG4gIGZ1bmN0aW9uUGFyYW1zOiBhbnlcbik6IGNkay5DdXN0b21SZXNvdXJjZSB7XG4gIC8vIERvIG5vdCByZWNyZWF0ZSBpZiBleGlzdFxuICBjb25zdCBwcm92aWRlcklkID0gXCJFZGdlTGFtYmRhUHJvdmlkZXJcIjtcbiAgY29uc3QgcmVzSWQgPSBgJHtuYW1lfUVkZ2VMYW1iZGFgO1xuICBjb25zdCBzdGFjayA9IGNkay5TdGFjay5vZihzY29wZSk7XG4gIGxldCBwcm92aWRlciA9IHN0YWNrLm5vZGUudHJ5RmluZENoaWxkKHByb3ZpZGVySWQpIGFzIGxhbWJkYS5GdW5jdGlvbjtcblxuICAvLyBDcmVhdGUgcHJvdmlkZXIgaWYgbm90IGFscmVhZHkgY3JlYXRlZFxuICBpZiAoIXByb3ZpZGVyKSB7XG4gICAgcHJvdmlkZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHN0YWNrLCBwcm92aWRlcklkLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgXCJjdXN0b20tcmVzb3VyY2VcIikpLFxuICAgICAgaGFuZGxlcjogXCJlZGdlLWxhbWJkYS5oYW5kbGVyXCIsXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWCxcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDE1KSxcbiAgICAgIG1lbW9yeVNpemU6IDEwMjQsXG4gICAgICBpbml0aWFsUG9saWN5OiBbXG4gICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgYWN0aW9uczogW1wibGFtYmRhOipcIiwgXCJzMzoqXCJdLFxuICAgICAgICAgIHJlc291cmNlczogW1wiKlwiXSxcbiAgICAgICAgfSksXG4gICAgICBdLFxuICAgIH0pO1xuICAgIGlmIChwcm92aWRlci5yb2xlKSB7XG4gICAgICByb2xlLmdyYW50UGFzc1JvbGUocHJvdmlkZXIucm9sZSk7XG4gICAgfVxuICB9XG5cbiAgLy8gQ3JlYXRlIGN1c3RvbSByZXNvdXJjZVxuICBjb25zdCByZXNvdXJjZSA9IG5ldyBjZGsuQ3VzdG9tUmVzb3VyY2Uoc2NvcGUsIHJlc0lkLCB7XG4gICAgc2VydmljZVRva2VuOiBwcm92aWRlci5mdW5jdGlvbkFybixcbiAgICByZXNvdXJjZVR5cGU6IFwiQ3VzdG9tOjpTU1RFZGdlTGFtYmRhXCIsXG4gICAgcHJvcGVydGllczoge1xuICAgICAgRnVuY3Rpb25OYW1lUHJlZml4OiBgJHtjZGsuU3RhY2sub2Yoc2NvcGUpLnN0YWNrTmFtZX0tJHtyZXNJZH1gLFxuICAgICAgRnVuY3Rpb25CdWNrZXQ6IGJ1Y2tldE5hbWUsXG4gICAgICBGdW5jdGlvblBhcmFtczogZnVuY3Rpb25QYXJhbXMsXG4gICAgfSxcbiAgfSk7XG5cbiAgcmV0dXJuIHJlc291cmNlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlVmVyc2lvbihcbiAgc2NvcGU6IENvbnN0cnVjdCxcbiAgbmFtZTogc3RyaW5nLFxuICBmdW5jdGlvbkFybjogc3RyaW5nXG4pOiBjZGsuQ3VzdG9tUmVzb3VyY2Uge1xuICAvLyBEbyBub3QgcmVjcmVhdGUgaWYgZXhpc3RcbiAgY29uc3QgcHJvdmlkZXJJZCA9IFwiRWRnZUxhbWJkYVZlcnNpb25Qcm92aWRlclwiO1xuICBjb25zdCByZXNJZCA9IGAke25hbWV9RWRnZUxhbWJkYVZlcnNpb25gO1xuICBjb25zdCBzdGFjayA9IGNkay5TdGFjay5vZihzY29wZSk7XG4gIGxldCBwcm92aWRlciA9IHN0YWNrLm5vZGUudHJ5RmluZENoaWxkKHByb3ZpZGVySWQpIGFzIGxhbWJkYS5GdW5jdGlvbjtcblxuICAvLyBDcmVhdGUgcHJvdmlkZXIgaWYgbm90IGFscmVhZHkgY3JlYXRlZFxuICBpZiAoIXByb3ZpZGVyKSB7XG4gICAgcHJvdmlkZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHN0YWNrLCBwcm92aWRlcklkLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgXCJjdXN0b20tcmVzb3VyY2VcIikpLFxuICAgICAgaGFuZGxlcjogXCJlZGdlLWxhbWJkYS12ZXJzaW9uLmhhbmRsZXJcIixcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xMl9YLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICAgIGluaXRpYWxQb2xpY3k6IFtcbiAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgICBhY3Rpb25zOiBbXCJsYW1iZGE6KlwiXSxcbiAgICAgICAgICByZXNvdXJjZXM6IFtcIipcIl0sXG4gICAgICAgIH0pLFxuICAgICAgXSxcbiAgICB9KTtcbiAgfVxuXG4gIC8vIENyZWF0ZSBjdXN0b20gcmVzb3VyY2VcbiAgcmV0dXJuIG5ldyBjZGsuQ3VzdG9tUmVzb3VyY2Uoc2NvcGUsIHJlc0lkLCB7XG4gICAgc2VydmljZVRva2VuOiBwcm92aWRlci5mdW5jdGlvbkFybixcbiAgICByZXNvdXJjZVR5cGU6IFwiQ3VzdG9tOjpTU1RFZGdlTGFtYmRhVmVyc2lvblwiLFxuICAgIHByb3BlcnRpZXM6IHtcbiAgICAgIEZ1bmN0aW9uQXJuOiBmdW5jdGlvbkFybixcbiAgICB9LFxuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZVZlcnNpb25Mb2dpY2FsSWQoXG4gIGZ1bmN0aW9uQ1I6IGNkay5DdXN0b21SZXNvdXJjZSxcbiAgdmVyc2lvbkNSOiBjZGsuQ3VzdG9tUmVzb3VyY2Vcbikge1xuICAvLyBPdmVycmlkZSB0aGUgdmVyc2lvbidzIGxvZ2ljYWwgSUQgd2l0aCBhIGxhenkgc3RyaW5nIHdoaWNoIGluY2x1ZGVzIHRoZVxuICAvLyBoYXNoIG9mIHRoZSBmdW5jdGlvbiBpdHNlbGYsIHNvIGEgbmV3IHZlcnNpb24gcmVzb3VyY2UgaXMgY3JlYXRlZCB3aGVuXG4gIC8vIHRoZSBmdW5jdGlvbiBjb25maWd1cmF0aW9uIGNoYW5nZXMuXG4gIGNvbnN0IGNmbiA9IHZlcnNpb25DUi5ub2RlLmRlZmF1bHRDaGlsZCBhcyBjZGsuQ2ZuUmVzb3VyY2U7XG4gIGNvbnN0IG9yaWdpbmFsTG9naWNhbElkID0gY2RrLlN0YWNrLm9mKHZlcnNpb25DUikucmVzb2x2ZShcbiAgICBjZm4ubG9naWNhbElkXG4gICkgYXMgc3RyaW5nO1xuICBjZm4ub3ZlcnJpZGVMb2dpY2FsSWQoXG4gICAgY2RrLkxhenkudW5jYWNoZWRTdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICBjb25zdCBoYXNoID0gY2FsY3VsYXRlSGFzaChmdW5jdGlvbkNSKTtcbiAgICAgICAgY29uc3QgbG9naWNhbElkID0gdHJpbUZyb21TdGFydChvcmlnaW5hbExvZ2ljYWxJZCwgMjU1IC0gMzIpO1xuICAgICAgICByZXR1cm4gYCR7bG9naWNhbElkfSR7aGFzaH1gO1xuICAgICAgfSxcbiAgICB9KVxuICApO1xufVxuXG5mdW5jdGlvbiB0cmltRnJvbVN0YXJ0KHM6IHN0cmluZywgbWF4TGVuZ3RoOiBudW1iZXIpIHtcbiAgY29uc3QgZGVzaXJlZExlbmd0aCA9IE1hdGgubWluKG1heExlbmd0aCwgcy5sZW5ndGgpO1xuICBjb25zdCBuZXdTdGFydCA9IHMubGVuZ3RoIC0gZGVzaXJlZExlbmd0aDtcbiAgcmV0dXJuIHMuc3Vic3RyaW5nKG5ld1N0YXJ0KTtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlSGFzaChyZXNvdXJjZTogY2RrLkN1c3RvbVJlc291cmNlKTogc3RyaW5nIHtcbiAgLy8gcmVuZGVyIHRoZSBjbG91ZGZvcm1hdGlvbiByZXNvdXJjZSBmcm9tIHRoaXMgZnVuY3Rpb25cbiAgLy8gY29uZmlnIGlzIG9mIHRoZSBzaGFwZTpcbiAgLy8ge1xuICAvLyAgUmVzb3VyY2VzOiB7XG4gIC8vICAgIExvZ2ljYWxJZDoge1xuICAvLyAgICAgIFR5cGU6ICdGdW5jdGlvbicsXG4gIC8vICAgICAgUHJvcGVydGllczogeyAuLi4gfVxuICAvLyB9fX1cbiAgY29uc3QgY2ZuUmVzb3VyY2UgPSByZXNvdXJjZS5ub2RlLmRlZmF1bHRDaGlsZCBhcyBjZGsuQ2ZuUmVzb3VyY2U7XG4gIGNvbnN0IGNvbmZpZyA9IGNkay5TdGFjay5vZihyZXNvdXJjZSkucmVzb2x2ZShcbiAgICAoY2ZuUmVzb3VyY2UgYXMgYW55KS5fdG9DbG91ZEZvcm1hdGlvbigpXG4gICk7XG4gIGNvbnN0IHJlc291cmNlcyA9IGNvbmZpZy5SZXNvdXJjZXM7XG4gIGNvbnN0IHJlc291cmNlS2V5cyA9IE9iamVjdC5rZXlzKHJlc291cmNlcyk7XG4gIGlmIChyZXNvdXJjZUtleXMubGVuZ3RoICE9PSAxKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYEV4cGVjdGVkIG9uZSByZW5kZXJlZCBDbG91ZEZvcm1hdGlvbiByZXNvdXJjZSBidXQgZm91bmQgJHtyZXNvdXJjZUtleXMubGVuZ3RofWBcbiAgICApO1xuICB9XG4gIGNvbnN0IGxvZ2ljYWxJZCA9IHJlc291cmNlS2V5c1swXTtcbiAgY29uc3QgcHJvcGVydGllcyA9IHJlc291cmNlc1tsb2dpY2FsSWRdLlByb3BlcnRpZXMuRnVuY3Rpb25QYXJhbXM7XG5cbiAgY29uc3QgaGFzaCA9IGNyeXB0by5jcmVhdGVIYXNoKFwibWQ1XCIpO1xuICBoYXNoLnVwZGF0ZShKU09OLnN0cmluZ2lmeShwcm9wZXJ0aWVzKSk7XG4gIHJldHVybiBoYXNoLmRpZ2VzdChcImhleFwiKTtcbn1cbiJdfQ==