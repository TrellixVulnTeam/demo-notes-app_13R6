"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
const AWS = __importStar(require("aws-sdk"));
AWS.config.logger = console;
const util_1 = require("./util");
const cfnResponse = __importStar(require("./cfn-response"));
const s3 = new AWS.S3({ region: "us-east-1" });
const lambda = new AWS.Lambda({ region: "us-east-1" });
function handler(cfnRequest) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)("onEventHandler", cfnRequest);
        // Get bucket name
        const functionName = cfnRequest.RequestType === "Create"
            ? generateFunctionName(cfnRequest.ResourceProperties.FunctionNamePrefix)
            : cfnRequest.PhysicalResourceId.split(":").pop();
        // Process request
        let PhysicalResourceId;
        let Data;
        const bucket = cfnRequest.ResourceProperties.FunctionBucket;
        const params = cfnRequest.ResourceProperties.FunctionParams;
        switch (cfnRequest.RequestType) {
            case "Create": {
                yield copyAsset(bucket, params);
                const ret = yield createFunction(functionName, params);
                PhysicalResourceId = ret.FunctionArn;
                Data = {
                    FunctionArn: ret.FunctionArn,
                };
                break;
            }
            case "Update": {
                const oldParams = cfnRequest.OldResourceProperties.FunctionParams;
                if (isConfigurationChanged(params, oldParams)) {
                    yield updateFunctionConfiguration(functionName, params);
                }
                if (isCodeChanged(params, oldParams)) {
                    yield copyAsset(bucket, params);
                    yield updateFunctionCode(functionName, params);
                }
                PhysicalResourceId = cfnRequest.PhysicalResourceId;
                Data = {
                    FunctionArn: cfnRequest.PhysicalResourceId,
                };
                break;
            }
            case "Delete": {
                yield deleteFunction(functionName);
                break;
            }
            default:
                throw new Error("Unsupported request type");
        }
        // Build response
        return cfnResponse.submitResponse("SUCCESS", Object.assign(Object.assign({}, cfnRequest), { PhysicalResourceId,
            Data }));
    });
}
function generateFunctionName(prefix) {
    const MAX_NAME_LENGTH = 64;
    const length = 20;
    const characters = "abcdefghijklmnopqrstuvwxyz";
    const charactersLength = characters.length;
    let result = `${prefix
        .toLowerCase()
        .slice(0, MAX_NAME_LENGTH - length - 1)}-`;
    for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
}
function copyAsset(bucket, params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`copyAsset() called with params`, bucket, params);
        // Copy
        (0, util_1.log)(`copy`);
        const resp = yield s3
            .copyObject({
            Bucket: bucket,
            CopySource: `/${params.Code.S3Bucket}/${params.Code.S3Key}`,
            Key: params.Code.S3Key,
        })
            .promise();
        (0, util_1.log)(`response`, resp);
        // Update params
        params.Code.S3Bucket = bucket;
    });
}
function createFunction(functionName, params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`createFunction() called with params`, params);
        const resp = yield lambda
            .createFunction(Object.assign(Object.assign({}, params), { FunctionName: functionName }))
            .promise();
        (0, util_1.log)(`response`, resp);
        return { FunctionArn: resp.FunctionArn };
    });
}
function updateFunctionConfiguration(functionName, params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`updateFunctionConfiguration() called with params`, params);
        const resp = yield lambda
            .updateFunctionConfiguration(Object.assign(Object.assign({}, params), { Code: undefined }))
            .promise();
        (0, util_1.log)(`response`, resp);
    });
}
function updateFunctionCode(functionName, params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`updateFunctionCode() called with params`, params);
        const resp = yield lambda
            .updateFunctionCode(Object.assign({ FunctionName: functionName, Publish: false }, params.Code))
            .promise();
        (0, util_1.log)(`response`, resp);
    });
}
function deleteFunction(functionName) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`deleteFunction() called with functionName`, functionName);
        const resp = yield lambda
            .deleteFunction({
            FunctionName: functionName,
        })
            .promise();
        (0, util_1.log)(`response`, resp);
    });
}
function isConfigurationChanged(params, oldParams) {
    return (Object.keys(params).length !== Object.keys(params).length ||
        ["Description", "Handler", "Runtime", "MemorySize", "Timeout", "Role"].some((p) => params[p] !== oldParams[p]));
}
function isCodeChanged(params, oldParams) {
    return (params.Code.S3Bucket !== oldParams.Code.S3Bucket ||
        params.Code.S3Key !== oldParams.Code.S3Key);
}
module.exports = {
    handler: cfnResponse.safeHandler(handler),
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRnZS1sYW1iZGEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbmV4dGpzLXNpdGUvY3VzdG9tLXJlc291cmNlL2VkZ2UtbGFtYmRhLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDZDQUErQjtBQUMvQixHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUM7QUFFNUIsaUNBQTZCO0FBQzdCLDREQUE4QztBQUM5QyxNQUFNLEVBQUUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztBQUMvQyxNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztBQU12RCxTQUFlLE9BQU8sQ0FDcEIsVUFBdUQ7O1FBRXZELElBQUEsVUFBRyxFQUFDLGdCQUFnQixFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBRWxDLGtCQUFrQjtRQUNsQixNQUFNLFlBQVksR0FDaEIsVUFBVSxDQUFDLFdBQVcsS0FBSyxRQUFRO1lBQ2pDLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsa0JBQWtCLENBQUM7WUFDeEUsQ0FBQyxDQUFFLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFhLENBQUM7UUFFakUsa0JBQWtCO1FBQ2xCLElBQUksa0JBQWtCLENBQUM7UUFDdkIsSUFBSSxJQUFJLENBQUM7UUFDVCxNQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsa0JBQWtCLENBQUMsY0FBYyxDQUFDO1FBQzVELE1BQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxjQUFjLENBQUM7UUFDNUQsUUFBUSxVQUFVLENBQUMsV0FBVyxFQUFFO1lBQzlC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Zy5sb2dnZXIgPSBjb25zb2xlO1xuXG5pbXBvcnQgeyBsb2cgfSBmcm9tIFwiLi91dGlsXCI7XG5pbXBvcnQgKiBhcyBjZm5SZXNwb25zZSBmcm9tIFwiLi9jZm4tcmVzcG9uc2VcIjtcbmNvbnN0IHMzID0gbmV3IEFXUy5TMyh7IHJlZ2lvbjogXCJ1cy1lYXN0LTFcIiB9KTtcbmNvbnN0IGxhbWJkYSA9IG5ldyBBV1MuTGFtYmRhKHsgcmVnaW9uOiBcInVzLWVhc3QtMVwiIH0pO1xuXG5leHBvcnQgPSB7XG4gIGhhbmRsZXI6IGNmblJlc3BvbnNlLnNhZmVIYW5kbGVyKGhhbmRsZXIpLFxufTtcblxuYXN5bmMgZnVuY3Rpb24gaGFuZGxlcihcbiAgY2ZuUmVxdWVzdDogQVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudFxuKSB7XG4gIGxvZyhcIm9uRXZlbnRIYW5kbGVyXCIsIGNmblJlcXVlc3QpO1xuXG4gIC8vIEdldCBidWNrZXQgbmFtZVxuICBjb25zdCBmdW5jdGlvbk5hbWUgPVxuICAgIGNmblJlcXVlc3QuUmVxdWVzdFR5cGUgPT09IFwiQ3JlYXRlXCJcbiAgICAgID8gZ2VuZXJhdGVGdW5jdGlvbk5hbWUoY2ZuUmVxdWVzdC5SZXNvdXJjZVByb3BlcnRpZXMuRnVuY3Rpb25OYW1lUHJlZml4KVxuICAgICAgOiAoY2ZuUmVxdWVzdC5QaHlzaWNhbFJlc291cmNlSWQuc3BsaXQoXCI6XCIpLnBvcCgpIGFzIHN0cmluZyk7XG5cbiAgLy8gUHJvY2VzcyByZXF1ZXN0XG4gIGxldCBQaHlzaWNhbFJlc291cmNlSWQ7XG4gIGxldCBEYXRhO1xuICBjb25zdCBidWNrZXQgPSBjZm5SZXF1ZXN0LlJlc291cmNlUHJvcGVydGllcy5GdW5jdGlvbkJ1Y2tldDtcbiAgY29uc3QgcGFyYW1zID0gY2ZuUmVxdWVzdC5SZXNvdXJjZVByb3BlcnRpZXMuRnVuY3Rpb25QYXJhbXM7XG4gIHN3aXRjaCAoY2ZuUmVxdWVzdC5SZXF1ZXN0VHlwZSkge1xuICAgIGNhc2UgXCJDcmVhdGVcIjoge1xuICAgICAgYXdhaXQgY29weUFzc2V0KGJ1Y2tldCwgcGFyYW1zKTtcbiAgICAgIGNvbnN0IHJldCA9IGF3YWl0IGNyZWF0ZUZ1bmN0aW9uKGZ1bmN0aW9uTmFtZSwgcGFyYW1zKTtcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZCA9IHJldC5GdW5jdGlvbkFybjtcbiAgICAgIERhdGEgPSB7XG4gICAgICAgIEZ1bmN0aW9uQXJuOiByZXQuRnVuY3Rpb25Bcm4sXG4gICAgICB9O1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGNhc2UgXCJVcGRhdGVcIjoge1xuICAgICAgY29uc3Qgb2xkUGFyYW1zID0gY2ZuUmVxdWVzdC5PbGRSZXNvdXJjZVByb3BlcnRpZXMuRnVuY3Rpb25QYXJhbXM7XG4gICAgICBpZiAoaXNDb25maWd1cmF0aW9uQ2hhbmdlZChwYXJhbXMsIG9sZFBhcmFtcykpIHtcbiAgICAgICAgYXdhaXQgdXBkYXRlRnVuY3Rpb25Db25maWd1cmF0aW9uKGZ1bmN0aW9uTmFtZSwgcGFyYW1zKTtcbiAgICAgIH1cbiAgICAgIGlmIChpc0NvZGVDaGFuZ2VkKHBhcmFtcywgb2xkUGFyYW1zKSkge1xuICAgICAgICBhd2FpdCBjb3B5QXNzZXQoYnVja2V0LCBwYXJhbXMpO1xuICAgICAgICBhd2FpdCB1cGRhdGVGdW5jdGlvbkNvZGUoZnVuY3Rpb25OYW1lLCBwYXJhbXMpO1xuICAgICAgfVxuICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkID0gY2ZuUmVxdWVzdC5QaHlzaWNhbFJlc291cmNlSWQ7XG4gICAgICBEYXRhID0ge1xuICAgICAgICBGdW5jdGlvbkFybjogY2ZuUmVxdWVzdC5QaHlzaWNhbFJlc291cmNlSWQsXG4gICAgICB9O1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGNhc2UgXCJEZWxldGVcIjoge1xuICAgICAgYXdhaXQgZGVsZXRlRnVuY3Rpb24oZnVuY3Rpb25OYW1lKTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVW5zdXBwb3J0ZWQgcmVxdWVzdCB0eXBlXCIpO1xuICB9XG5cbiAgLy8gQnVpbGQgcmVzcG9uc2VcbiAgcmV0dXJuIGNmblJlc3BvbnNlLnN1Ym1pdFJlc3BvbnNlKFwiU1VDQ0VTU1wiLCB7XG4gICAgLi4uY2ZuUmVxdWVzdCxcbiAgICBQaHlzaWNhbFJlc291cmNlSWQsXG4gICAgRGF0YSxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlRnVuY3Rpb25OYW1lKHByZWZpeDogc3RyaW5nKSB7XG4gIGNvbnN0IE1BWF9OQU1FX0xFTkdUSCA9IDY0O1xuICBjb25zdCBsZW5ndGggPSAyMDtcbiAgY29uc3QgY2hhcmFjdGVycyA9IFwiYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXpcIjtcbiAgY29uc3QgY2hhcmFjdGVyc0xlbmd0aCA9IGNoYXJhY3RlcnMubGVuZ3RoO1xuICBsZXQgcmVzdWx0ID0gYCR7cHJlZml4XG4gICAgLnRvTG93ZXJDYXNlKClcbiAgICAuc2xpY2UoMCwgTUFYX05BTUVfTEVOR1RIIC0gbGVuZ3RoIC0gMSl9LWA7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICByZXN1bHQgKz0gY2hhcmFjdGVycy5jaGFyQXQoTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogY2hhcmFjdGVyc0xlbmd0aCkpO1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvcHlBc3NldChidWNrZXQ6IHN0cmluZywgcGFyYW1zOiBhbnkpIHtcbiAgbG9nKGBjb3B5QXNzZXQoKSBjYWxsZWQgd2l0aCBwYXJhbXNgLCBidWNrZXQsIHBhcmFtcyk7XG5cbiAgLy8gQ29weVxuICBsb2coYGNvcHlgKTtcbiAgY29uc3QgcmVzcCA9IGF3YWl0IHMzXG4gICAgLmNvcHlPYmplY3Qoe1xuICAgICAgQnVja2V0OiBidWNrZXQsXG4gICAgICBDb3B5U291cmNlOiBgLyR7cGFyYW1zLkNvZGUuUzNCdWNrZXR9LyR7cGFyYW1zLkNvZGUuUzNLZXl9YCxcbiAgICAgIEtleTogcGFyYW1zLkNvZGUuUzNLZXksXG4gICAgfSlcbiAgICAucHJvbWlzZSgpO1xuICBsb2coYHJlc3BvbnNlYCwgcmVzcCk7XG5cbiAgLy8gVXBkYXRlIHBhcmFtc1xuICBwYXJhbXMuQ29kZS5TM0J1Y2tldCA9IGJ1Y2tldDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlRnVuY3Rpb24oZnVuY3Rpb25OYW1lOiBzdHJpbmcsIHBhcmFtczogYW55KSB7XG4gIGxvZyhgY3JlYXRlRnVuY3Rpb24oKSBjYWxsZWQgd2l0aCBwYXJhbXNgLCBwYXJhbXMpO1xuXG4gIGNvbnN0IHJlc3AgPSBhd2FpdCBsYW1iZGFcbiAgICAuY3JlYXRlRnVuY3Rpb24oe1xuICAgICAgLi4ucGFyYW1zLFxuICAgICAgRnVuY3Rpb25OYW1lOiBmdW5jdGlvbk5hbWUsXG4gICAgfSlcbiAgICAucHJvbWlzZSgpO1xuXG4gIGxvZyhgcmVzcG9uc2VgLCByZXNwKTtcblxuICByZXR1cm4geyBGdW5jdGlvbkFybjogcmVzcC5GdW5jdGlvbkFybiB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVGdW5jdGlvbkNvbmZpZ3VyYXRpb24oZnVuY3Rpb25OYW1lOiBzdHJpbmcsIHBhcmFtczogYW55KSB7XG4gIGxvZyhgdXBkYXRlRnVuY3Rpb25Db25maWd1cmF0aW9uKCkgY2FsbGVkIHdpdGggcGFyYW1zYCwgcGFyYW1zKTtcblxuICBjb25zdCByZXNwID0gYXdhaXQgbGFtYmRhXG4gICAgLnVwZGF0ZUZ1bmN0aW9uQ29uZmlndXJhdGlvbih7XG4gICAgICAuLi5wYXJhbXMsXG4gICAgICBDb2RlOiB1bmRlZmluZWQsXG4gICAgfSlcbiAgICAucHJvbWlzZSgpO1xuICBsb2coYHJlc3BvbnNlYCwgcmVzcCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUZ1bmN0aW9uQ29kZShmdW5jdGlvbk5hbWU6IHN0cmluZywgcGFyYW1zOiBhbnkpIHtcbiAgbG9nKGB1cGRhdGVGdW5jdGlvbkNvZGUoKSBjYWxsZWQgd2l0aCBwYXJhbXNgLCBwYXJhbXMpO1xuXG4gIGNvbnN0IHJlc3AgPSBhd2FpdCBsYW1iZGFcbiAgICAudXBkYXRlRnVuY3Rpb25Db2RlKHtcbiAgICAgIEZ1bmN0aW9uTmFtZTogZnVuY3Rpb25OYW1lLFxuICAgICAgUHVibGlzaDogZmFsc2UsXG4gICAgICAuLi5wYXJhbXMuQ29kZSxcbiAgICB9KVxuICAgIC5wcm9taXNlKCk7XG4gIGxvZyhgcmVzcG9uc2VgLCByZXNwKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZGVsZXRlRnVuY3Rpb24oZnVuY3Rpb25OYW1lOiBzdHJpbmcpIHtcbiAgbG9nKGBkZWxldGVGdW5jdGlvbigpIGNhbGxlZCB3aXRoIGZ1bmN0aW9uTmFtZWAsIGZ1bmN0aW9uTmFtZSk7XG5cbiAgY29uc3QgcmVzcCA9IGF3YWl0IGxhbWJkYVxuICAgIC5kZWxldGVGdW5jdGlvbih7XG4gICAgICBGdW5jdGlvbk5hbWU6IGZ1bmN0aW9uTmFtZSxcbiAgICB9KVxuICAgIC5wcm9taXNlKCk7XG5cbiAgbG9nKGByZXNwb25zZWAsIHJlc3ApO1xufVxuXG5mdW5jdGlvbiBpc0NvbmZpZ3VyYXRpb25DaGFuZ2VkKHBhcmFtczogYW55LCBvbGRQYXJhbXM6IGFueSkge1xuICByZXR1cm4gKFxuICAgIE9iamVjdC5rZXlzKHBhcmFtcykubGVuZ3RoICE9PSBPYmplY3Qua2V5cyhwYXJhbXMpLmxlbmd0aCB8fFxuICAgIFtcIkRlc2NyaXB0aW9uXCIsIFwiSGFuZGxlclwiLCBcIlJ1bnRpbWVcIiwgXCJNZW1vcnlTaXplXCIsIFwiVGltZW91dFwiLCBcIlJvbGVcIl0uc29tZShcbiAgICAgIChwKSA9PiBwYXJhbXNbcF0gIT09IG9sZFBhcmFtc1twXVxuICAgIClcbiAgKTtcbn1cblxuZnVuY3Rpb24gaXNDb2RlQ2hhbmdlZChwYXJhbXM6IGFueSwgb2xkUGFyYW1zOiBhbnkpIHtcbiAgcmV0dXJuIChcbiAgICBwYXJhbXMuQ29kZS5TM0J1Y2tldCAhPT0gb2xkUGFyYW1zLkNvZGUuUzNCdWNrZXQgfHxcbiAgICBwYXJhbXMuQ29kZS5TM0tleSAhPT0gb2xkUGFyYW1zLkNvZGUuUzNLZXlcbiAgKTtcbn1cbiJdfQ==