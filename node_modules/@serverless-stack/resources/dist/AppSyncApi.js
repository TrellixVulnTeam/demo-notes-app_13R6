"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AppSyncApi = void 0;
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const graphql_1 = require("graphql");
const merge_1 = require("@graphql-tools/merge");
const load_files_1 = require("@graphql-tools/load-files");
const constructs_1 = require("constructs");
const appsync = __importStar(require("@aws-cdk/aws-appsync-alpha"));
const appSyncApiDomain = __importStar(require("./util/appSyncApiDomain"));
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
/**
 *
 * The `AppSyncApi` construct is a higher level CDK construct that makes it easy to create an AppSync GraphQL API. It provides a simple way to define the data sources and the resolvers in your API. And allows you to configure the specific Lambda functions if necessary. See the [examples](#examples) for more details.
 *
 * @example
 * ### Using the minimal config
 *
 * ```js
 * import { AppSyncApi } from "@serverless-stack/resources";
 *
 * new AppSyncApi(stack, "GraphqlApi", {
 *   schema: "graphql/schema.graphql",
 *   dataSources: {
 *     notesDS: "src/notes.main",
 *   },
 *   resolvers: {
 *     "Query    listNotes": "notesDS",
 *     "Query    getNoteById": "notesDS",
 *     "Mutation createNote": "notesDS",
 *     "Mutation updateNote": "notesDS",
 *     "Mutation deleteNote": "notesDS",
 *   },
 * });
 * ```
 *
 * Note that, the resolver key can have extra spaces in between, they are just ignored.
 */
class AppSyncApi extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.props = props || {};
        this.cdk = {};
        this.functionsByDsKey = {};
        this.dataSourcesByDsKey = {};
        this.resolversByResKey = {};
        this.dsKeysByResKey = {};
        this.permissionsAttachedForAllFunctions = [];
        this.createGraphApi();
        // Configure data sources
        if (props === null || props === void 0 ? void 0 : props.dataSources) {
            for (const key of Object.keys(props.dataSources)) {
                this.addDataSource(this, key, props.dataSources[key]);
            }
        }
        // Configure resolvers
        if (props === null || props === void 0 ? void 0 : props.resolvers) {
            for (const key of Object.keys(props.resolvers)) {
                this.addResolver(this, key, props.resolvers[key]);
            }
        }
    }
    /**
     * The Id of the internally created AppSync GraphQL API.
     */
    get apiId() {
        return this.cdk.graphqlApi.apiId;
    }
    /**
     * The ARN of the internally created AppSync GraphQL API.
     */
    get apiArn() {
        return this.cdk.graphqlApi.arn;
    }
    /**
     * The name of the internally created AppSync GraphQL API.
     */
    get apiName() {
        return this.cdk.graphqlApi.name;
    }
    /**
     * The AWS generated URL of the Api.
     */
    get url() {
        return this.cdk.graphqlApi.graphqlUrl;
    }
    /**
     * If custom domain is enabled, this is the custom domain URL of the Api.
     */
    get customDomainUrl() {
        return this._customDomainUrl;
    }
    /**
     * Add data sources after the construct has been created
     *
     * @example
     * ```js
     * api.addDataSources(stack, {
     *   billingDS: "src/billing.main",
     * });
     * ```
     */
    addDataSources(scope, dataSources) {
        Object.keys(dataSources).forEach((key) => {
            // add data source
            const fn = this.addDataSource(scope, key, dataSources[key]);
            // attached existing permissions
            if (fn) {
                this.permissionsAttachedForAllFunctions.forEach((permissions) => fn.attachPermissions(permissions));
            }
        });
    }
    /**
     * Add resolvers the construct has been created
     *
     * @example
     * ```js
     * api.addResolvers(stack, {
     *   "Mutation charge": "billingDS",
     * });
     * ```
     */
    addResolvers(scope, resolvers) {
        Object.keys(resolvers).forEach((key) => {
            // add resolver
            const fn = this.addResolver(scope, key, resolvers[key]);
            // attached existing permissions
            if (fn) {
                this.permissionsAttachedForAllFunctions.forEach((permissions) => fn.attachPermissions(permissions));
            }
        });
    }
    /**
     * Get the instance of the internally created Function, for a given resolver.
     *
     * @example
     * ```js
     * const func = api.getFunction("Mutation charge");
     * ```
     */
    getFunction(key) {
        let fn = this.functionsByDsKey[key];
        if (!fn) {
            const resKey = this.normalizeResolverKey(key);
            const dsKey = this.dsKeysByResKey[resKey];
            fn = this.functionsByDsKey[dsKey];
        }
        return fn;
    }
    /**
     * Get a datasource by name
     * @example
     * ```js
     * api.getDataSource("billingDS");
     * ```
     */
    getDataSource(key) {
        let ds = this.dataSourcesByDsKey[key];
        if (!ds) {
            const resKey = this.normalizeResolverKey(key);
            const dsKey = this.dsKeysByResKey[resKey];
            ds = this.dataSourcesByDsKey[dsKey];
        }
        return ds;
    }
    /**
     * Get a resolver
     *
     * @example
     * ```js
     * api.getResolver("Mutation charge");
     * ```
     */
    getResolver(key) {
        const resKey = this.normalizeResolverKey(key);
        return this.resolversByResKey[resKey];
    }
    /**
     * Attaches the given list of permissions to all function datasources
     *
     * @example
     *
     * ```js
     * api.attachPermissions(["s3"]);
     * ```
     */
    attachPermissions(permissions) {
        Object.values(this.functionsByDsKey).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllFunctions.push(permissions);
    }
    /**
     * Attaches the given list of permissions to a specific function datasource. This allows that function to access other AWS resources.
     *
     * @example
     * api.attachPermissionsToRoute("Mutation charge", ["s3"]);
     * ```
     */
    attachPermissionsToDataSource(key, permissions) {
        const fn = this.getFunction(key);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Function does not exist for key "${key}".`);
        }
        fn.attachPermissions(permissions);
    }
    getConstructMetadata() {
        return {
            type: "AppSync",
            data: {
                url: this.cdk.graphqlApi.graphqlUrl,
                appSyncApiId: this.cdk.graphqlApi.apiId,
                appSyncApiKey: this.cdk.graphqlApi.apiKey,
                customDomainUrl: this._customDomainUrl,
                dataSources: Object.entries(this.dataSourcesByDsKey).map(([key]) => ({
                    name: key,
                    fn: (0, Construct_1.getFunctionRef)(this.functionsByDsKey[key]),
                })),
            },
        };
    }
    createGraphApi() {
        const { schema, customDomain, cdk } = this.props;
        const id = this.node.id;
        const app = this.node.root;
        if ((0, Construct_1.isCDKConstruct)(cdk === null || cdk === void 0 ? void 0 : cdk.graphqlApi)) {
            if (customDomain !== undefined) {
                throw new Error(`Cannot configure the "customDomain" when "graphqlApi" is a construct`);
            }
            this.cdk.graphqlApi = cdk === null || cdk === void 0 ? void 0 : cdk.graphqlApi;
        }
        else {
            const graphqlApiProps = ((cdk === null || cdk === void 0 ? void 0 : cdk.graphqlApi) ||
                {});
            // build schema
            let mainSchema;
            if (typeof schema === "string") {
                mainSchema = appsync.Schema.fromAsset(schema);
            }
            else if (Array.isArray(schema)) {
                if (schema.length > 0) {
                    // merge schema files
                    const mergedSchema = (0, merge_1.mergeTypeDefs)((0, load_files_1.loadFilesSync)(schema));
                    const filePath = path.join(app.buildDir, `appsyncapi-${id}-${this.node.addr}.graphql`);
                    fs.writeFileSync(filePath, (0, graphql_1.print)(mergedSchema));
                    mainSchema = appsync.Schema.fromAsset(filePath);
                }
            }
            // build domain
            const domainData = appSyncApiDomain.buildCustomDomainData(this, customDomain);
            this._customDomainUrl =
                domainData && `https://${domainData.domainName}/graphql`;
            this.cdk.graphqlApi = new appsync.GraphqlApi(this, "Api", Object.assign({ name: app.logicalPrefixedName(id), xrayEnabled: true, schema: mainSchema, domainName: domainData }, graphqlApiProps));
            this.cdk.certificate = domainData === null || domainData === void 0 ? void 0 : domainData.certificate;
            // note: As of CDK 2.20.0, the "AWS::AppSync::DomainNameApiAssociation" resource
            //       is not dependent on the "AWS::AppSync::DomainName" resource. This leads
            //       CloudFormation deploy error if DomainNameApiAssociation is created before
            //       DomainName is created.
            //       https://github.com/aws/aws-cdk/issues/18395#issuecomment-1099455502
            //       To workaround this issue, we need to add a dependency manually.
            if (domainData) {
                this._cfnDomainName = this.cdk.graphqlApi.node.children.find((child) => child.cfnResourceType ===
                    "AWS::AppSync::DomainName");
                const cfnDomainNameApiAssociation = this.cdk.graphqlApi.node.children.find((child) => child
                    .cfnResourceType === "AWS::AppSync::DomainNameApiAssociation");
                if (this._cfnDomainName && cfnDomainNameApiAssociation) {
                    cfnDomainNameApiAssociation.node.addDependency(this._cfnDomainName);
                }
            }
        }
    }
    addDataSource(scope, dsKey, dsValue) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k;
        let dataSource;
        let lambda;
        // Lambda function
        if (Function_1.Function.isInlineDefinition(dsValue)) {
            lambda = Function_1.Function.fromDefinition(scope, `Lambda_${dsKey}`, dsValue, (_a = this.props.defaults) === null || _a === void 0 ? void 0 : _a.function, `Cannot define defaults.function when a Function is passed in to the "${dsKey} data source`);
            dataSource = this.cdk.graphqlApi.addLambdaDataSource(dsKey, lambda);
        }
        // DynamoDb ds
        else if (dsValue.type === "dynamodb") {
            dataSource = this.cdk.graphqlApi.addDynamoDbDataSource(dsKey, dsValue.table
                ? dsValue.table.cdk.table
                : (_c = (_b = dsValue.cdk) === null || _b === void 0 ? void 0 : _b.dataSource) === null || _c === void 0 ? void 0 : _c.table, {
                name: dsValue.name,
                description: dsValue.description,
            });
        }
        // Rds ds
        else if (dsValue.type === "rds") {
            dataSource = this.cdk.graphqlApi.addRdsDataSource(dsKey, dsValue.rds
                ? dsValue.rds.cdk.cluster
                : (_e = (_d = dsValue.cdk) === null || _d === void 0 ? void 0 : _d.dataSource) === null || _e === void 0 ? void 0 : _e.serverlessCluster, dsValue.rds
                ? dsValue.rds.cdk.cluster.secret
                : (_g = (_f = dsValue.cdk) === null || _f === void 0 ? void 0 : _f.dataSource) === null || _g === void 0 ? void 0 : _g.secretStore, dsValue.rds
                ? dsValue.databaseName || dsValue.rds.defaultDatabaseName
                : (_j = (_h = dsValue.cdk) === null || _h === void 0 ? void 0 : _h.dataSource) === null || _j === void 0 ? void 0 : _j.databaseName, {
                name: dsValue.name,
                description: dsValue.description,
            });
        }
        // Http ds
        else if (dsValue.type === "http") {
            dataSource = this.cdk.graphqlApi.addHttpDataSource(dsKey, dsValue.endpoint, {
                name: dsValue.name,
                description: dsValue.description,
            });
        }
        // Http ds
        else if (dsValue.type === "none") {
            dataSource = this.cdk.graphqlApi.addNoneDataSource(dsKey, {
                name: dsValue.name,
                description: dsValue.description,
            });
        }
        // Lambda ds
        else {
            lambda = Function_1.Function.fromDefinition(scope, `Lambda_${dsKey}`, dsValue.function, (_k = this.props.defaults) === null || _k === void 0 ? void 0 : _k.function, `Cannot define defaults.function when a Function is passed in to the "${dsKey} data source`);
            dataSource = this.cdk.graphqlApi.addLambdaDataSource(dsKey, lambda, {
                name: dsValue.name,
                description: dsValue.description,
            });
        }
        this.dataSourcesByDsKey[dsKey] = dataSource;
        if (lambda) {
            this.functionsByDsKey[dsKey] = lambda;
        }
        return lambda;
    }
    addResolver(scope, resKey, resValue) {
        var _a, _b, _c, _d;
        // Normalize resKey
        resKey = this.normalizeResolverKey(resKey);
        // Get type and field
        const resolverKeyParts = resKey.split(" ");
        if (resolverKeyParts.length !== 2) {
            throw new Error(`Invalid resolver ${resKey}`);
        }
        const [typeName, fieldName] = resolverKeyParts;
        if (fieldName.length === 0) {
            throw new Error(`Invalid field defined for "${resKey}"`);
        }
        ///////////////////
        // Create data source if not created before
        ///////////////////
        let lambda;
        let dataSource;
        let dataSourceKey;
        let resolverProps;
        // DataSource key
        if (typeof resValue === "string" &&
            Object.keys(this.dataSourcesByDsKey).includes(resValue)) {
            dataSourceKey = resValue;
            dataSource = this.dataSourcesByDsKey[resValue];
            resolverProps = {};
        }
        // DataSource key not exist (string does not have a dot, assume it is referencing a data store)
        else if (typeof resValue === "string" && resValue.indexOf(".") === -1) {
            throw new Error(`Failed to create resolver "${resKey}". Data source "${resValue}" does not exist.`);
        }
        // Lambda resolver
        else if (this.isLambdaResolverProps(resValue)) {
            resValue = resValue;
            lambda = Function_1.Function.fromDefinition(scope, `Lambda_${typeName}_${fieldName}`, resValue.function, (_a = this.props.defaults) === null || _a === void 0 ? void 0 : _a.function, `Cannot define defaults.function when a Function is passed in to the "${resKey} resolver`);
            dataSourceKey = this.buildDataSourceKey(typeName, fieldName);
            dataSource = this.cdk.graphqlApi.addLambdaDataSource(dataSourceKey, lambda);
            resolverProps = Object.assign({ requestMappingTemplate: this.buildMappingTemplate(resValue.requestMapping), responseMappingTemplate: this.buildMappingTemplate(resValue.responseMapping) }, (_b = resValue.cdk) === null || _b === void 0 ? void 0 : _b.resolver);
        }
        // DataSource resolver
        else if (this.isDataSourceResolverProps(resValue)) {
            resValue = resValue;
            dataSourceKey = resValue.dataSource;
            dataSource = this.dataSourcesByDsKey[dataSourceKey];
            resolverProps = Object.assign({ requestMappingTemplate: this.buildMappingTemplate(resValue.requestMapping), responseMappingTemplate: this.buildMappingTemplate(resValue.responseMapping) }, (_c = resValue.cdk) === null || _c === void 0 ? void 0 : _c.resolver);
        }
        // Lambda function
        else {
            resValue = resValue;
            lambda = Function_1.Function.fromDefinition(scope, `Lambda_${typeName}_${fieldName}`, resValue, (_d = this.props.defaults) === null || _d === void 0 ? void 0 : _d.function, `Cannot define defaults.function when a Function is passed in to the "${resKey} resolver`);
            dataSourceKey = this.buildDataSourceKey(typeName, fieldName);
            dataSource = this.cdk.graphqlApi.addLambdaDataSource(dataSourceKey, lambda);
            resolverProps = {};
        }
        // Store new data source created
        if (lambda) {
            this.dataSourcesByDsKey[dataSourceKey] = dataSource;
            this.functionsByDsKey[dataSourceKey] = lambda;
        }
        this.dsKeysByResKey[resKey] = dataSourceKey;
        ///////////////////
        // Create resolver
        ///////////////////
        const resolver = this.cdk.graphqlApi.createResolver(Object.assign({ dataSource,
            typeName,
            fieldName }, resolverProps));
        this.resolversByResKey[resKey] = resolver;
        return lambda;
    }
    isLambdaResolverProps(object) {
        return object.function !== undefined;
    }
    isDataSourceResolverProps(object) {
        return object.dataSource !== undefined;
    }
    normalizeResolverKey(resolverKey) {
        // remove extra spaces in the key
        return resolverKey.split(/\s+/).join(" ");
    }
    buildMappingTemplate(mapping) {
        if (!mapping) {
            return undefined;
        }
        if (mapping.file) {
            return appsync.MappingTemplate.fromFile(mapping.file);
        }
        return appsync.MappingTemplate.fromString(mapping.inline);
    }
    buildDataSourceKey(typeName, fieldName) {
        return `LambdaDS_${typeName}_${fieldName}`;
    }
}
exports.AppSyncApi = AppSyncApi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBwU3luY0FwaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9BcHBTeW5jQXBpLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQTZCO0FBQzdCLDZDQUErQjtBQUMvQixxQ0FBZ0M7QUFDaEMsZ0RBQXFEO0FBQ3JELDBEQUEwRDtBQUUxRCwyQ0FBdUM7QUFHdkMsb0VBQXNEO0FBUXRELDBFQUE0RDtBQUM1RCwyQ0FBMkU7QUFDM0UseUNBS29CO0FBb1dwQixxQkFBcUI7QUFDckIsWUFBWTtBQUNaLHFCQUFxQjtBQUVyQjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0EwQkc7QUFDSCxNQUFhLFVBQVcsU0FBUSxzQkFBUztJQXNCdkMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUF1QjtRQUMvRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsR0FBRyxHQUFHLEVBQVMsQ0FBQztRQUNyQixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsa0NBQWtDLEdBQUcsRUFBRSxDQUFDO1FBRTdDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUV0Qix5QkFBeUI7UUFDekIsSUFBSSxLQUFLLGFBQUwsS0FBSyx1QkFBTCxLQUFLLENBQUUsV0FBVyxFQUFFO1lBQ3RCLEtBQUssTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEVBQUU7Z0JBQ2hELElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxLQUFLLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7YUFDdkQ7U0FDRjtRQUVELHNCQUFzQjtRQUN0QixJQUFJLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxTQUFTLEVBQUU7WUFDcEIsS0FBSyxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsRUFBRTtnQkFDOUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQzthQUNuRDtTQUNGO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBVyxLQUFLO1FBQ2QsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUM7SUFDbkMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBVyxNQUFNO1FBQ2YsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUM7SUFDakMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBVyxPQUFPO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDO0lBQ2xDLENBQUM7SUFFRDs7T0FFRztJQUNILElBQVcsR0FBRztRQUNaLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDO0lBQ3hDLENBQUM7SUFFRDs7T0FFRztJQUNILElBQVcsZUFBZTtRQUN4QixPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztJQUMvQixDQUFDO0lBRUQ7Ozs7Ozs7OztPQVNHO0lBQ0ksY0FBYyxDQUNuQixLQUFnQixFQUNoQixXQVFDO1FBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFXLEVBQUUsRUFBRTtZQUMvQyxrQkFBa0I7WUFDbEIsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBRTVELGdDQUFnQztZQUNoQyxJQUFJLEVBQUUsRUFBRTtnQkFDTixJQUFJLENBQUMsa0NBQWtDLENBQUMsT0FBTyxDQUFDLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FDOUQsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUNsQyxDQUFDO2FBQ0g7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7Ozs7Ozs7O09BU0c7SUFDSSxZQUFZLENBQ2pCLEtBQWdCLEVBQ2hCLFNBRUM7UUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQVcsRUFBRSxFQUFFO1lBQzdDLGVBQWU7WUFDZixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFFeEQsZ0NBQWdDO1lBQ2hDLElBQUksRUFBRSxFQUFFO2dCQUNOLElBQUksQ0FBQyxrQ0FBa0MsQ0FBQyxPQUFPLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUM5RCxFQUFFLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQ2xDLENBQUM7YUFDSDtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7Ozs7O09BT0c7SUFDSSxXQUFXLENBQUMsR0FBVztRQUM1QixJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFcEMsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNQLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM5QyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzFDLEVBQUUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDbkM7UUFDRCxPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7SUFFRDs7Ozs7O09BTUc7SUFDSSxhQUFhLENBQUMsR0FBVztRQUM5QixJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFdEMsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNQLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM5QyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzFDLEVBQUUsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDckM7UUFDRCxPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0ksV0FBVyxDQUFDLEdBQVc7UUFDNUIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzlDLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFRDs7Ozs7Ozs7T0FRRztJQUNJLGlCQUFpQixDQUFDLFdBQXdCO1FBQy9DLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FDbEQsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUNsQyxDQUFDO1FBQ0YsSUFBSSxDQUFDLGtDQUFrQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRUQ7Ozs7OztPQU1HO0lBQ0ksNkJBQTZCLENBQ2xDLEdBQVcsRUFDWCxXQUF3QjtRQUV4QixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDUCxNQUFNLElBQUksS0FBSyxDQUNiLGtFQUFrRSxHQUFHLElBQUksQ0FDMUUsQ0FBQztTQUNIO1FBRUQsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFFTSxvQkFBb0I7UUFDekIsT0FBTztZQUNMLElBQUksRUFBRSxTQUFrQjtZQUN4QixJQUFJLEVBQUU7Z0JBQ0osR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLFVBQVU7Z0JBQ25DLFlBQVksRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxLQUFLO2dCQUN2QyxhQUFhLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsTUFBTTtnQkFDekMsZUFBZSxFQUFFLElBQUksQ0FBQyxnQkFBZ0I7Z0JBQ3RDLFdBQVcsRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7b0JBQ25FLElBQUksRUFBRSxHQUFHO29CQUNULEVBQUUsRUFBRSxJQUFBLDBCQUFjLEVBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUMvQyxDQUFDLENBQUM7YUFDSjtTQUNGLENBQUM7SUFDSixDQUFDO0lBRU8sY0FBYztRQUNwQixNQUFNLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ2pELE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1FBQ3hCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBRWxDLElBQUksSUFBQSwwQkFBYyxFQUFDLEdBQUcsYUFBSCxHQUFHLHVCQUFILEdBQUcsQ0FBRSxVQUFVLENBQUMsRUFBRTtZQUNuQyxJQUFJLFlBQVksS0FBSyxTQUFTLEVBQUU7Z0JBQzlCLE1BQU0sSUFBSSxLQUFLLENBQ2Isc0VBQXNFLENBQ3ZFLENBQUM7YUFDSDtZQUNELElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLEdBQUcsYUFBSCxHQUFHLHVCQUFILEdBQUcsQ0FBRSxVQUFnQyxDQUFDO1NBQzdEO2FBQU07WUFDTCxNQUFNLGVBQWUsR0FBRyxDQUFDLENBQUEsR0FBRyxhQUFILEdBQUcsdUJBQUgsR0FBRyxDQUFFLFVBQVU7Z0JBQ3RDLEVBQUUsQ0FBOEIsQ0FBQztZQUVuQyxlQUFlO1lBQ2YsSUFBSSxVQUFzQyxDQUFDO1lBQzNDLElBQUksT0FBTyxNQUFNLEtBQUssUUFBUSxFQUFFO2dCQUM5QixVQUFVLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDL0M7aUJBQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO2dCQUNoQyxJQUFJLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO29CQUNyQixxQkFBcUI7b0JBQ3JCLE1BQU0sWUFBWSxHQUFHLElBQUEscUJBQWEsRUFBQyxJQUFBLDBCQUFhLEVBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztvQkFDMUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FDeEIsR0FBRyxDQUFDLFFBQVEsRUFDWixjQUFjLEVBQUUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksVUFBVSxDQUM3QyxDQUFDO29CQUNGLEVBQUUsQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLElBQUEsZUFBSyxFQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7b0JBQ2hELFVBQVUsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztpQkFDakQ7YUFDRjtZQUVELGVBQWU7WUFDZixNQUFNLFVBQVUsR0FBRyxnQkFBZ0IsQ0FBQyxxQkFBcUIsQ0FDdkQsSUFBSSxFQUNKLFlBQVksQ0FDYixDQUFDO1lBQ0YsSUFBSSxDQUFDLGdCQUFnQjtnQkFDbkIsVUFBVSxJQUFJLFdBQVcsVUFBVSxDQUFDLFVBQVUsVUFBVSxDQUFDO1lBRTNELElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLElBQUksT0FBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsS0FBSyxrQkFDdEQsSUFBSSxFQUFFLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLENBQUMsRUFDakMsV0FBVyxFQUFFLElBQUksRUFDakIsTUFBTSxFQUFFLFVBQVUsRUFDbEIsVUFBVSxFQUFFLFVBQVUsSUFDbkIsZUFBZSxFQUNsQixDQUFDO1lBQ0gsSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEdBQUcsVUFBVSxhQUFWLFVBQVUsdUJBQVYsVUFBVSxDQUFFLFdBQVcsQ0FBQztZQUUvQyxnRkFBZ0Y7WUFDaEYsZ0ZBQWdGO1lBQ2hGLGtGQUFrRjtZQUNsRiwrQkFBK0I7WUFDL0IsNEVBQTRFO1lBQzVFLHdFQUF3RTtZQUN4RSxJQUFJLFVBQVUsRUFBRTtnQkFDZCxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUMxRCxDQUFDLEtBQUssRUFBRSxFQUFFLENBQ1AsS0FBa0MsQ0FBQyxlQUFlO29CQUNuRCwwQkFBMEIsQ0FDRCxDQUFDO2dCQUM5QixNQUFNLDJCQUEyQixHQUMvQixJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FDcEMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUNQLEtBQWdEO3FCQUM5QyxlQUFlLEtBQUssd0NBQXdDLENBQ2xFLENBQUM7Z0JBQ0osSUFBSSxJQUFJLENBQUMsY0FBYyxJQUFJLDJCQUEyQixFQUFFO29CQUN0RCwyQkFBMkIsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztpQkFDckU7YUFDRjtTQUNGO0lBQ0gsQ0FBQztJQUVPLGFBQWEsQ0FDbkIsS0FBZ0IsRUFDaEIsS0FBYSxFQUNiLE9BTWlDOztRQUVqQyxJQUFJLFVBQVUsQ0FBQztRQUNmLElBQUksTUFBTSxDQUFDO1FBRVgsa0JBQWtCO1FBQ2xCLElBQUksbUJBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUNsQyxNQUFNLEdBQUcsbUJBQUUsQ0FBQyxjQUFjLENBQ3hCLEtBQUssRUFDTCxVQUFVLEtBQUssRUFBRSxFQUNqQixPQUFPLEVBQ1AsTUFBQSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsMENBQUUsUUFBUSxFQUM3Qix3RUFBd0UsS0FBSyxjQUFjLENBQzVGLENBQUM7WUFDRixVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQ3JFO1FBQ0QsY0FBYzthQUNULElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxVQUFVLEVBQUU7WUFDcEMsVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLHFCQUFxQixDQUNwRCxLQUFLLEVBQ0wsT0FBTyxDQUFDLEtBQUs7Z0JBQ1gsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUs7Z0JBQ3pCLENBQUMsQ0FBQyxNQUFBLE1BQUEsT0FBTyxDQUFDLEdBQUcsMENBQUUsVUFBVSwwQ0FBRSxLQUFNLEVBQ25DO2dCQUNFLElBQUksRUFBRSxPQUFPLENBQUMsSUFBSTtnQkFDbEIsV0FBVyxFQUFFLE9BQU8sQ0FBQyxXQUFXO2FBQ2pDLENBQ0YsQ0FBQztTQUNIO1FBQ0QsU0FBUzthQUNKLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxLQUFLLEVBQUU7WUFDL0IsVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUMvQyxLQUFLLEVBQ0wsT0FBTyxDQUFDLEdBQUc7Z0JBQ1QsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU87Z0JBQ3pCLENBQUMsQ0FBQyxNQUFBLE1BQUEsT0FBTyxDQUFDLEdBQUcsMENBQUUsVUFBVSwwQ0FBRSxpQkFBa0IsRUFDL0MsT0FBTyxDQUFDLEdBQUc7Z0JBQ1QsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFPO2dCQUNqQyxDQUFDLENBQUMsTUFBQSxNQUFBLE9BQU8sQ0FBQyxHQUFHLDBDQUFFLFVBQVUsMENBQUUsV0FBWSxFQUN6QyxPQUFPLENBQUMsR0FBRztnQkFDVCxDQUFDLENBQUMsT0FBTyxDQUFDLFlBQVksSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQjtnQkFDekQsQ0FBQyxDQUFDLE1BQUEsTUFBQSxPQUFPLENBQUMsR0FBRywwQ0FBRSxVQUFVLDBDQUFFLFlBQVksRUFDekM7Z0JBQ0UsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO2dCQUNsQixXQUFXLEVBQUUsT0FBTyxDQUFDLFdBQVc7YUFDakMsQ0FDRixDQUFDO1NBQ0g7UUFDRCxVQUFVO2FBQ0wsSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRTtZQUNoQyxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQ2hELEtBQUssRUFDTCxPQUFPLENBQUMsUUFBUSxFQUNoQjtnQkFDRSxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUk7Z0JBQ2xCLFdBQVcsRUFBRSxPQUFPLENBQUMsV0FBVzthQUNqQyxDQUNGLENBQUM7U0FDSDtRQUNELFVBQVU7YUFDTCxJQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssTUFBTSxFQUFFO1lBQ2hDLFVBQVUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUU7Z0JBQ3hELElBQUksRUFBRSxPQUFPLENBQUMsSUFBSTtnQkFDbEIsV0FBVyxFQUFFLE9BQU8sQ0FBQyxXQUFXO2FBQ2pDLENBQUMsQ0FBQztTQUNKO1FBQ0QsWUFBWTthQUNQO1lBQ0gsTUFBTSxHQUFHLG1CQUFFLENBQUMsY0FBYyxDQUN4QixLQUFLLEVBQ0wsVUFBVSxLQUFLLEVBQUUsRUFDakIsT0FBTyxDQUFDLFFBQVEsRUFDaEIsTUFBQSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsMENBQUUsUUFBUSxFQUM3Qix3RUFBd0UsS0FBSyxjQUFjLENBQzVGLENBQUM7WUFDRixVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRTtnQkFDbEUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO2dCQUNsQixXQUFXLEVBQUUsT0FBTyxDQUFDLFdBQVc7YUFDakMsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLEdBQUcsVUFBVSxDQUFDO1FBQzVDLElBQUksTUFBTSxFQUFFO1lBQ1YsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxHQUFHLE1BQU0sQ0FBQztTQUN2QztRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFTyxXQUFXLENBQ2pCLEtBQWdCLEVBQ2hCLE1BQWMsRUFDZCxRQUE0RDs7UUFFNUQsbUJBQW1CO1FBQ25CLE1BQU0sR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFM0MscUJBQXFCO1FBQ3JCLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMzQyxJQUFJLGdCQUFnQixDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDakMsTUFBTSxJQUFJLEtBQUssQ0FBQyxvQkFBb0IsTUFBTSxFQUFFLENBQUMsQ0FBQztTQUMvQztRQUNELE1BQU0sQ0FBQyxRQUFRLEVBQUUsU0FBUyxDQUFDLEdBQUcsZ0JBQWdCLENBQUM7UUFDL0MsSUFBSSxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUMxQixNQUFNLElBQUksS0FBSyxDQUFDLDhCQUE4QixNQUFNLEdBQUcsQ0FBQyxDQUFDO1NBQzFEO1FBRUQsbUJBQW1CO1FBQ25CLDJDQUEyQztRQUMzQyxtQkFBbUI7UUFDbkIsSUFBSSxNQUFNLENBQUM7UUFDWCxJQUFJLFVBQVUsQ0FBQztRQUNmLElBQUksYUFBYSxDQUFDO1FBQ2xCLElBQUksYUFBYSxDQUFDO1FBRWxCLGlCQUFpQjtRQUNqQixJQUNFLE9BQU8sUUFBUSxLQUFLLFFBQVE7WUFDNUIsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQ3ZEO1lBQ0EsYUFBYSxHQUFHLFFBQVEsQ0FBQztZQUN6QixVQUFVLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQy9DLGFBQWEsR0FBRyxFQUFFLENBQUM7U0FDcEI7UUFDRCwrRkFBK0Y7YUFDMUYsSUFBSSxPQUFPLFFBQVEsS0FBSyxRQUFRLElBQUksUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtZQUNyRSxNQUFNLElBQUksS0FBSyxDQUNiLDhCQUE4QixNQUFNLG1CQUFtQixRQUFRLG1CQUFtQixDQUNuRixDQUFDO1NBQ0g7UUFDRCxrQkFBa0I7YUFDYixJQUFJLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxRQUFtQyxDQUFDLEVBQUU7WUFDeEUsUUFBUSxHQUFHLFFBQW1DLENBQUM7WUFDL0MsTUFBTSxHQUFHLG1CQUFFLENBQUMsY0FBYyxDQUN4QixLQUFLLEVBQ0wsVUFBVSxRQUFRLElBQUksU0FBUyxFQUFFLEVBQ2pDLFFBQVEsQ0FBQyxRQUE4QixFQUN2QyxNQUFBLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSwwQ0FBRSxRQUFRLEVBQzdCLHdFQUF3RSxNQUFNLFdBQVcsQ0FDMUYsQ0FBQztZQUNGLGFBQWEsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQzdELFVBQVUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxtQkFBbUIsQ0FDbEQsYUFBYSxFQUNiLE1BQU0sQ0FDUCxDQUFDO1lBQ0YsYUFBYSxtQkFDWCxzQkFBc0IsRUFBRSxJQUFJLENBQUMsb0JBQW9CLENBQy9DLFFBQVEsQ0FBQyxjQUFjLENBQ3hCLEVBQ0QsdUJBQXVCLEVBQUUsSUFBSSxDQUFDLG9CQUFvQixDQUNoRCxRQUFRLENBQUMsZUFBZSxDQUN6QixJQUNFLE1BQUEsUUFBUSxDQUFDLEdBQUcsMENBQUUsUUFBUSxDQUMxQixDQUFDO1NBQ0g7UUFDRCxzQkFBc0I7YUFDakIsSUFDSCxJQUFJLENBQUMseUJBQXlCLENBQUMsUUFBbUMsQ0FBQyxFQUNuRTtZQUNBLFFBQVEsR0FBRyxRQUFtQyxDQUFDO1lBQy9DLGFBQWEsR0FBRyxRQUFRLENBQUMsVUFBb0IsQ0FBQztZQUM5QyxVQUFVLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQ3BELGFBQWEsbUJBQ1gsc0JBQXNCLEVBQUUsSUFBSSxDQUFDLG9CQUFvQixDQUMvQyxRQUFRLENBQUMsY0FBYyxDQUN4QixFQUNELHVCQUF1QixFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FDaEQsUUFBUSxDQUFDLGVBQWUsQ0FDekIsSUFDRSxNQUFBLFFBQVEsQ0FBQyxHQUFHLDBDQUFFLFFBQVEsQ0FDMUIsQ0FBQztTQUNIO1FBQ0Qsa0JBQWtCO2FBQ2I7WUFDSCxRQUFRLEdBQUcsUUFBb0MsQ0FBQztZQUNoRCxNQUFNLEdBQUcsbUJBQUUsQ0FBQyxjQUFjLENBQ3hCLEtBQUssRUFDTCxVQUFVLFFBQVEsSUFBSSxTQUFTLEVBQUUsRUFDakMsUUFBUSxFQUNSLE1BQUEsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLDBDQUFFLFFBQVEsRUFDN0Isd0VBQXdFLE1BQU0sV0FBVyxDQUMxRixDQUFDO1lBQ0YsYUFBYSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDN0QsVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLG1CQUFtQixDQUNsRCxhQUFhLEVBQ2IsTUFBTSxDQUNQLENBQUM7WUFDRixhQUFhLEdBQUcsRUFBRSxDQUFDO1NBQ3BCO1FBRUQsZ0NBQWdDO1FBQ2hDLElBQUksTUFBTSxFQUFFO1lBQ1YsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGFBQWEsQ0FBQyxHQUFHLFVBQVUsQ0FBQztZQUNwRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLEdBQUcsTUFBTSxDQUFDO1NBQy9DO1FBQ0QsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsR0FBRyxhQUFhLENBQUM7UUFFNUMsbUJBQW1CO1FBQ25CLGtCQUFrQjtRQUNsQixtQkFBbUI7UUFDbkIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsY0FBYyxpQkFDakQsVUFBVTtZQUNWLFFBQVE7WUFDUixTQUFTLElBQ04sYUFBYSxFQUNoQixDQUFDO1FBQ0gsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxHQUFHLFFBQVEsQ0FBQztRQUUxQyxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRU8scUJBQXFCLENBQUMsTUFBK0I7UUFDM0QsT0FBTyxNQUFNLENBQUMsUUFBUSxLQUFLLFNBQVMsQ0FBQztJQUN2QyxDQUFDO0lBRU8seUJBQXlCLENBQUMsTUFBK0I7UUFDL0QsT0FBTyxNQUFNLENBQUMsVUFBVSxLQUFLLFNBQVMsQ0FBQztJQUN6QyxDQUFDO0lBRU8sb0JBQW9CLENBQUMsV0FBbUI7UUFDOUMsaUNBQWlDO1FBQ2pDLE9BQU8sV0FBVyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVPLG9CQUFvQixDQUFDLE9BQXlCO1FBQ3BELElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDWixPQUFPLFNBQVMsQ0FBQztTQUNsQjtRQUVELElBQUssT0FBK0IsQ0FBQyxJQUFJLEVBQUU7WUFDekMsT0FBTyxPQUFPLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FDcEMsT0FBK0IsQ0FBQyxJQUFJLENBQ3RDLENBQUM7U0FDSDtRQUVELE9BQU8sT0FBTyxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQ3RDLE9BQWlDLENBQUMsTUFBTSxDQUMxQyxDQUFDO0lBQ0osQ0FBQztJQUVPLGtCQUFrQixDQUFDLFFBQWdCLEVBQUUsU0FBaUI7UUFDNUQsT0FBTyxZQUFZLFFBQVEsSUFBSSxTQUFTLEVBQUUsQ0FBQztJQUM3QyxDQUFDO0NBQ0Y7QUFsa0JELGdDQWtrQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcbmltcG9ydCB7IHByaW50IH0gZnJvbSBcImdyYXBocWxcIjtcbmltcG9ydCB7IG1lcmdlVHlwZURlZnMgfSBmcm9tIFwiQGdyYXBocWwtdG9vbHMvbWVyZ2VcIjtcbmltcG9ydCB7IGxvYWRGaWxlc1N5bmMgfSBmcm9tIFwiQGdyYXBocWwtdG9vbHMvbG9hZC1maWxlc1wiO1xuXG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgcmRzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtcmRzXCI7XG5pbXBvcnQgKiBhcyBjZm5BcHBzeW5jIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtYXBwc3luY1wiO1xuaW1wb3J0ICogYXMgYXBwc3luYyBmcm9tIFwiQGF3cy1jZGsvYXdzLWFwcHN5bmMtYWxwaGFcIjtcbmltcG9ydCAqIGFzIGR5bmFtb2RiIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZHluYW1vZGJcIjtcbmltcG9ydCAqIGFzIGFjbSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWNlcnRpZmljYXRlbWFuYWdlclwiO1xuaW1wb3J0ICogYXMgc2VjcmV0c21hbmFnZXIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zZWNyZXRzbWFuYWdlclwiO1xuXG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9BcHBcIjtcbmltcG9ydCB7IFRhYmxlIH0gZnJvbSBcIi4vVGFibGVcIjtcbmltcG9ydCB7IFJEUyB9IGZyb20gXCIuL1JEU1wiO1xuaW1wb3J0ICogYXMgYXBwU3luY0FwaURvbWFpbiBmcm9tIFwiLi91dGlsL2FwcFN5bmNBcGlEb21haW5cIjtcbmltcG9ydCB7IGdldEZ1bmN0aW9uUmVmLCBTU1RDb25zdHJ1Y3QsIGlzQ0RLQ29uc3RydWN0IH0gZnJvbSBcIi4vQ29uc3RydWN0XCI7XG5pbXBvcnQge1xuICBGdW5jdGlvbiBhcyBGbixcbiAgRnVuY3Rpb25Qcm9wcyxcbiAgRnVuY3Rpb25JbmxpbmVEZWZpbml0aW9uLFxuICBGdW5jdGlvbkRlZmluaXRpb24sXG59IGZyb20gXCIuL0Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucyB9IGZyb20gXCIuL3V0aWwvcGVybWlzc2lvblwiO1xuaW1wb3J0IHsgZG9tYWluIH0gZnJvbSBcInByb2Nlc3NcIjtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBBcHBTeW5jQXBpRG9tYWluUHJvcHNcbiAgZXh0ZW5kcyBhcHBTeW5jQXBpRG9tYWluLkN1c3RvbURvbWFpblByb3BzIHt9XG5cbmludGVyZmFjZSBBcHBTeW5jQXBpQmFzZURhdGFTb3VyY2VQcm9wcyB7XG4gIC8qKlxuICAgKiBOYW1lIG9mIHRoZSBkYXRhIHNvdXJjZVxuICAgKi9cbiAgbmFtZT86IHN0cmluZztcbiAgLyoqXG4gICAqIERlc2NyaXB0aW9uIG9mIHRoZSBkYXRhIHNvdXJjZVxuICAgKi9cbiAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG59XG5cbi8qKlxuICogVXNlZCB0byBkZWZpbmUgYSBsYW1iZGEgZGF0YSBzb3VyY2VcbiAqXG4gKiBAZXhhbXBsZVxuICogYGBganNcbiAqIG5ldyBBcHBTeW5jQXBpKHN0YWNrLCBcIkFwcFN5bmNcIiwge1xuICogICBkYXRhU291cmNlczoge1xuICogICAgIGxhbWJkYToge1xuICogICAgICAgdHlwZTogXCJmdW5jdGlvblwiLFxuICogICAgICAgZnVuY3Rpb246IFwic3JjL2Z1bmN0aW9uLmhhbmRsZXJcIlxuICogICAgIH0sXG4gKiAgIH0sXG4gKiB9KTtcbiAqIGBgYFxuICpcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBBcHBTeW5jQXBpTGFtYmRhRGF0YVNvdXJjZVByb3BzXG4gIGV4dGVuZHMgQXBwU3luY0FwaUJhc2VEYXRhU291cmNlUHJvcHMge1xuICAvKipcbiAgICogU3RyaW5nIGxpdGVyYWwgdG8gc2lnbmlmeSB0aGF0IHRoaXMgZGF0YSBzb3VyY2UgaXMgYSBmdW5jdGlvblxuICAgKi9cbiAgdHlwZT86IFwiZnVuY3Rpb25cIjtcbiAgLyoqXG4gICAqIEZ1bmN0aW9uIGRlZmluaXRpb25cbiAgICovXG4gIGZ1bmN0aW9uOiBGdW5jdGlvbkRlZmluaXRpb247XG59XG5cbi8qKlxuICogVXNlZCB0byBkZWZpbmUgYSBEeW5hbW9EQiBkYXRhIHNvdXJjZVxuICpcbiAqIEBleGFtcGxlXG4gKiBgYGBqc1xuICogbmV3IEFwcFN5bmNBcGkoc3RhY2ssIFwiQXBwU3luY1wiLCB7XG4gKiAgIGRhdGFTb3VyY2VzOiB7XG4gKiAgICAgdGFibGU6IHtcbiAqICAgICAgIHR5cGU6IFwidGFibGVcIixcbiAqICAgICAgIHRhYmxlOiBNeVRhYmxlXG4gKiAgICAgfSxcbiAqICAgfSxcbiAqIH0pO1xuICogYGBgXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQXBwU3luY0FwaUR5bmFtb0RiRGF0YVNvdXJjZVByb3BzXG4gIGV4dGVuZHMgQXBwU3luY0FwaUJhc2VEYXRhU291cmNlUHJvcHMge1xuICAvKipcbiAgICogU3RyaW5nIGxpdGVyYWwgdG8gc2lnbmlmeSB0aGF0IHRoaXMgZGF0YSBzb3VyY2UgaXMgYSBkeW5hbW9kYiB0YWJsZVxuICAgKi9cbiAgdHlwZTogXCJkeW5hbW9kYlwiO1xuICAvKipcbiAgICogVGFyZ2V0IHRhYmxlXG4gICAqL1xuICB0YWJsZT86IFRhYmxlO1xuICBjZGs/OiB7XG4gICAgZGF0YVNvdXJjZT86IHtcbiAgICAgIHRhYmxlOiBkeW5hbW9kYi5UYWJsZTtcbiAgICB9O1xuICB9O1xufVxuXG4vKipcbiAqIFVzZWQgdG8gZGVmaW5lIGEgUkRTIGRhdGEgc291cmNlXG4gKlxuICogQGV4YW1wbGVcbiAqIGBgYGpzXG4gKiBuZXcgQXBwU3luY0FwaShzdGFjaywgXCJBcHBTeW5jXCIsIHtcbiAqICAgZGF0YVNvdXJjZXM6IHtcbiAqICAgICByZHM6IHtcbiAqICAgICAgIHR5cGU6IFwicmRzXCIsXG4gKiAgICAgICByZHM6IE15UkRTQ2x1c3RlclxuICogICAgIH0sXG4gKiAgIH0sXG4gKiB9KTtcbiAqIGBgYFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEFwcFN5bmNBcGlSZHNEYXRhU291cmNlUHJvcHNcbiAgZXh0ZW5kcyBBcHBTeW5jQXBpQmFzZURhdGFTb3VyY2VQcm9wcyB7XG4gIC8qKlxuICAgKiBTdHJpbmcgbGl0ZXJhbCB0byBzaWduaWZ5IHRoYXQgdGhpcyBkYXRhIHNvdXJjZSBpcyBhbiBSRFMgZGF0YWJhc2VcbiAgICovXG4gIHR5cGU6IFwicmRzXCI7XG4gIC8qKlxuICAgKiBUYXJnZXQgUkRTIGNvbnN0cnVjdFxuICAgKi9cbiAgcmRzPzogUkRTO1xuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIGRhdGFiYXNlIHRvIGNvbm5lY3QgdG9cbiAgICovXG4gIGRhdGFiYXNlTmFtZT86IHN0cmluZztcbiAgY2RrPzoge1xuICAgIGRhdGFTb3VyY2U/OiB7XG4gICAgICBzZXJ2ZXJsZXNzQ2x1c3RlcjogcmRzLklTZXJ2ZXJsZXNzQ2x1c3RlcjtcbiAgICAgIHNlY3JldFN0b3JlOiBzZWNyZXRzbWFuYWdlci5JU2VjcmV0O1xuICAgICAgZGF0YWJhc2VOYW1lPzogc3RyaW5nO1xuICAgIH07XG4gIH07XG59XG5cbi8qKlxuICogVXNlZCB0byBkZWZpbmUgYW4gaHR0cCBkYXRhIHNvdXJjZVxuICpcbiAqIEBleGFtcGxlXG4gKiBgYGBqc1xuICogbmV3IEFwcFN5bmNBcGkoc3RhY2ssIFwiQXBwU3luY1wiLCB7XG4gKiAgIGRhdGFTb3VyY2VzOiB7XG4gKiAgICAgaHR0cDoge1xuICogICAgICAgdHlwZTogXCJodHRwXCIsXG4gKiAgICAgICBlbmRwb2ludDogXCJodHRwczovL2V4YW1wbGUuY29tXCJcbiAqICAgICB9LFxuICogICB9LFxuICogfSk7XG4gKiBgYGBcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBBcHBTeW5jQXBpSHR0cERhdGFTb3VyY2VQcm9wc1xuICBleHRlbmRzIEFwcFN5bmNBcGlCYXNlRGF0YVNvdXJjZVByb3BzIHtcbiAgLyoqXG4gICAqIFN0cmluZyBsaXRlcmFsIHRvIHNpZ25pZnkgdGhhdCB0aGlzIGRhdGEgc291cmNlIGlzIGFuIEhUVFAgZW5kcG9pbnRcbiAgICovXG4gIHR5cGU6IFwiaHR0cFwiO1xuICAvKipcbiAgICogVVJMIHRvIGZvcndhcmQgcmVxdWVzdHMgdG9cbiAgICovXG4gIGVuZHBvaW50OiBzdHJpbmc7XG4gIGNkaz86IHtcbiAgICBkYXRhU291cmNlPzoge1xuICAgICAgYXV0aG9yaXphdGlvbkNvbmZpZz86IGFwcHN5bmMuQXdzSWFtQ29uZmlnO1xuICAgIH07XG4gIH07XG59XG5cbi8qKlxuICogVXNlZCB0byBkZWZpbmUgYSBub25lIGRhdGEgc291cmNlXG4gKlxuICogQGV4YW1wbGVcbiAqIGBgYGpzXG4gKiBuZXcgQXBwU3luY0FwaShzdGFjaywgXCJBcHBTeW5jXCIsIHtcbiAqICAgZGF0YVNvdXJjZXM6IHtcbiAqICAgICBodHRwOiB7XG4gKiAgICAgICB0eXBlOiBcImh0dHBcIixcbiAqICAgICAgIGVuZHBvaW50OiBcImh0dHBzOi8vZXhhbXBsZS5jb21cIlxuICogICAgIH0sXG4gKiAgIH0sXG4gKiB9KTtcbiAqIGBgYFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEFwcFN5bmNBcGlOb25lRGF0YVNvdXJjZVByb3BzXG4gIGV4dGVuZHMgQXBwU3luY0FwaUJhc2VEYXRhU291cmNlUHJvcHMge1xuICAvKipcbiAgICogU3RyaW5nIGxpdGVyYWwgdG8gc2lnbmlmeSB0aGF0IHRoaXMgZGF0YSBzb3VyY2UgaXMgYW4gSFRUUCBlbmRwb2ludFxuICAgKi9cbiAgdHlwZTogXCJub25lXCI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTWFwcGluZ1RlbXBsYXRlRmlsZSB7XG4gIC8qKlxuICAgKiBQYXRoIHRvIHRoZSBmaWxlIGNvbnRhaW5pbmcgdGhlIFZUTCBtYXBwaW5nIHRlbXBsYXRlXG4gICAqL1xuICBmaWxlOiBzdHJpbmc7XG59XG5leHBvcnQgaW50ZXJmYWNlIE1hcHBpbmdUZW1wbGF0ZUlubGluZSB7XG4gIC8qKlxuICAgKiBJbmxpbmUgZGVmaW5pdGlvbiBvZiB0aGUgVlRMIG1hcHBpbmcgdGVtcGxhdGVcbiAgICovXG4gIGlubGluZTogc3RyaW5nO1xufVxuXG5leHBvcnQgdHlwZSBNYXBwaW5nVGVtcGxhdGUgPSBNYXBwaW5nVGVtcGxhdGVGaWxlIHwgTWFwcGluZ1RlbXBsYXRlSW5saW5lO1xuXG4vKipcbiAqIFVzZWQgdG8gZGVmaW5lIGZ1bGwgcmVzb2x2ZXIgY29uZmlnXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQXBwU3luY0FwaVJlc29sdmVyUHJvcHMge1xuICAvKipcbiAgICogVGhlIGRhdGEgc291cmNlIGZvciB0aGlzIHJlc29sdmVyLiBUaGUgZGF0YSBzb3VyY2UgbXVzdCBiZSBhbHJlYWR5IGNyZWF0ZWQuXG4gICAqL1xuICBkYXRhU291cmNlPzogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIGZ1bmN0aW9uIGRlZmluaXRpb24gdXNlZCB0byBjcmVhdGUgdGhlIGRhdGEgc291cmNlIGZvciB0aGlzIHJlc29sdmVyLlxuICAgKi9cbiAgZnVuY3Rpb24/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIC8qKlxuICAgKiBWVEwgcmVxdWVzdCBtYXBwaW5nIHRlbXBsYXRlXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqICAgcmVxdWVzdE1hcHBpbmc6IHtcbiAgICogICAgIGlubGluZTogJ3tcInZlcnNpb25cIiA6IFwiMjAxNy0wMi0yOFwiLCBcIm9wZXJhdGlvblwiIDogXCJTY2FuXCJ9JyxcbiAgICogICB9LFxuICAgKiBgYGBcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogICByZXF1ZXN0TWFwcGluZzoge1xuICAgKiAgICAgZmlsZTogXCJwYXRoL3RvL3RlbXBsYXRlLnZ0bFwiLFxuICAgKiAgIH0sXG4gICAqIGBgYFxuICAgKi9cbiAgcmVxdWVzdE1hcHBpbmc/OiBNYXBwaW5nVGVtcGxhdGU7XG4gIC8qKlxuICAgKiBWVEwgcmVzcG9uc2UgbWFwcGluZyB0ZW1wbGF0ZVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqc1xuICAgKiAgIHJlc3BvbnNlTWFwcGluZzoge1xuICAgKiAgICAgaW5saW5lOiBcIiR1dGlsLnRvSnNvbigkY3R4LnJlc3VsdC5pdGVtcylcIixcbiAgICogICB9LFxuICAgKiBgYGBcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogICByZXNwb25zZU1hcHBpbmc6IHtcbiAgICogICAgIGZpbGU6IFwicGF0aC90by90ZW1wbGF0ZS52dGxcIixcbiAgICogICB9LFxuICAgKiBgYGBcbiAgICovXG4gIHJlc3BvbnNlTWFwcGluZz86IE1hcHBpbmdUZW1wbGF0ZTtcbiAgY2RrPzoge1xuICAgIC8qKlxuICAgICAqIFRoaXMgYWxsb3dzIHlvdSB0byBvdmVycmlkZSB0aGUgZGVmYXVsdCBzZXR0aW5ncyB0aGlzIGNvbnN0cnVjdCB1c2VzIGludGVybmFsbHkgdG8gY3JlYXRlIHRoZSByZXNvbHZlci5cbiAgICAgKi9cbiAgICByZXNvbHZlcjogT21pdDxcbiAgICAgIGFwcHN5bmMuUmVzb2x2ZXJQcm9wcyxcbiAgICAgIFwiYXBpXCIgfCBcImZpZWxkTmFtZVwiIHwgXCJ0eXBlTmFtZVwiIHwgXCJkYXRhU291cmNlXCJcbiAgICA+O1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwcFN5bmNBcGlQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgR3JhcGhRTCBzY2hlbWEgZGVmaW5pdGlvbi5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogYGBganNcbiAgICogbmV3IEFwcFN5bmNBcGkoc3RhY2ssIFwiR3JhcGhxbEFwaVwiLCB7XG4gICAqICAgc2NoZW1hOiBcImdyYXBocWwvc2NoZW1hLmdyYXBocWxcIixcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgc2NoZW1hPzogc3RyaW5nIHwgc3RyaW5nW107XG4gIC8qKlxuICAgKiBTcGVjaWZ5IGEgY3VzdG9tIGRvbWFpbiB0byB1c2UgaW4gYWRkaXRpb24gdG8gdGhlIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIG9uZS4gU1NUIGN1cnJlbnRseSBzdXBwb3J0cyBkb21haW5zIHRoYXQgYXJlIGNvbmZpZ3VyZWQgdXNpbmcgW1JvdXRlIDUzXShodHRwczovL2F3cy5hbWF6b24uY29tL3JvdXRlNTMvKVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqc1xuICAgKiBuZXcgQXBwU3luY0FwaShzdGFjaywgXCJHcmFwaHFsQXBpXCIsIHtcbiAgICogICBjdXN0b21Eb21haW46IFwiYXBpLmV4YW1wbGUuY29tXCJcbiAgICogfSlcbiAgICogYGBgXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIG5ldyBBcHBTeW5jQXBpKHN0YWNrLCBcIkdyYXBocWxBcGlcIiwge1xuICAgKiAgIGN1c3RvbURvbWFpbjoge1xuICAgKiAgICAgZG9tYWluTmFtZTogXCJhcGkuZXhhbXBsZS5jb21cIixcbiAgICogICAgIGhvc3RlZFpvbmU6IFwiZG9tYWluLmNvbVwiLFxuICAgKiAgIH1cbiAgICogfSlcbiAgICogYGBgXG4gICAqL1xuICBjdXN0b21Eb21haW4/OiBzdHJpbmcgfCBBcHBTeW5jQXBpRG9tYWluUHJvcHM7XG4gIC8qKlxuICAgKiBEZWZpbmUgZGF0YXNvdXJjZXMuIENhbiBiZSBhIGZ1bmN0aW9uLCBkeW5hbW9kYiB0YWJsZSwgcmRzIGNsdXN0ZXIgb3IgaHR0cCBlbmRwb2ludFxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqc1xuICAgKiBuZXcgQXBwU3luY0FwaShzdGFjaywgXCJHcmFwaHFsQXBpXCIsIHtcbiAgICogICBkYXRhU291cmNlczoge1xuICAgKiAgICAgbm90ZXM6IFwic3JjL25vdGVzLm1haW5cIixcbiAgICogICB9LFxuICAgKiAgIHJlc29sdmVyczoge1xuICAgKiAgICAgXCJRdWVyeSAgICBsaXN0Tm90ZXNcIjogXCJub3Rlc1wiLFxuICAgKiAgIH0sXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIGRhdGFTb3VyY2VzPzogUmVjb3JkPFxuICAgIHN0cmluZyxcbiAgICB8IEZ1bmN0aW9uSW5saW5lRGVmaW5pdGlvblxuICAgIHwgQXBwU3luY0FwaUxhbWJkYURhdGFTb3VyY2VQcm9wc1xuICAgIHwgQXBwU3luY0FwaUR5bmFtb0RiRGF0YVNvdXJjZVByb3BzXG4gICAgfCBBcHBTeW5jQXBpUmRzRGF0YVNvdXJjZVByb3BzXG4gICAgfCBBcHBTeW5jQXBpSHR0cERhdGFTb3VyY2VQcm9wc1xuICAgIHwgQXBwU3luY0FwaU5vbmVEYXRhU291cmNlUHJvcHNcbiAgPjtcbiAgLyoqXG4gICAqIFRoZSByZXNvbHZlcnMgZm9yIHRoaXMgQVBJLiBUYWtlcyBhbiBvYmplY3QsIHdpdGggdGhlIGtleSBiZWluZyB0aGUgdHlwZSBuYW1lIGFuZCBmaWVsZCBuYW1lIGFzIGEgc3RyaW5nIGFuZCB0aGUgdmFsdWUgaXMgZWl0aGVyIGEgc3RyaW5nIHdpdGggdGhlIG5hbWUgb2YgZXhpc3RpbmcgZGF0YSBzb3VyY2UuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIG5ldyBBcHBTeW5jQXBpKHN0YWNrLCBcIkdyYXBocWxBcGlcIiwge1xuICAgKiAgIHJlc29sdmVyczoge1xuICAgKiAgICAgXCJRdWVyeSAgICBsaXN0Tm90ZXNcIjogXCJzcmMvbGlzdC5tYWluXCIsXG4gICAqICAgICBcIlF1ZXJ5ICAgIGdldE5vdGVCeUlkXCI6IFwic3JjL2dldC5tYWluXCIsXG4gICAqICAgICBcIk11dGF0aW9uIGNyZWF0ZU5vdGVcIjogXCJzcmMvY3JlYXRlLm1haW5cIixcbiAgICogICAgIFwiTXV0YXRpb24gdXBkYXRlTm90ZVwiOiBcInNyYy91cGRhdGUubWFpblwiLFxuICAgKiAgICAgXCJNdXRhdGlvbiBkZWxldGVOb3RlXCI6IFwic3JjL2RlbGV0ZS5tYWluXCIsXG4gICAqICAgfSxcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgcmVzb2x2ZXJzPzogUmVjb3JkPFxuICAgIHN0cmluZyxcbiAgICBzdHJpbmcgfCBGdW5jdGlvbklubGluZURlZmluaXRpb24gfCBBcHBTeW5jQXBpUmVzb2x2ZXJQcm9wc1xuICA+O1xuICBkZWZhdWx0cz86IHtcbiAgICAvKipcbiAgICAgKiBUaGUgZGVmYXVsdCBmdW5jdGlvbiBwcm9wcyB0byBiZSBhcHBsaWVkIHRvIGFsbCB0aGUgTGFtYmRhIGZ1bmN0aW9ucyBpbiB0aGUgQXBwU3luY0FwaS4gVGhlIGBlbnZpcm9ubWVudGAsIGBwZXJtaXNzaW9uc2AgYW5kIGBsYXllcnNgIHByb3BlcnRpZXMgd2lsbCBiZSBtZXJnZWQgd2l0aCBwZXIgcm91dGUgZGVmaW5pdGlvbnMgaWYgdGhleSBhcmUgZGVmaW5lZC5cbiAgICAgKlxuICAgICAqIEBleGFtcGxlXG4gICAgICogYGBganNcbiAgICAgKiBuZXcgQXBwU3luYyhzdGFjaywgXCJBcHBTeW5jXCIsIHtcbiAgICAgKiAgIGRlZmF1bHRzOiB7XG4gICAgICogICAgIGZ1bmN0aW9uOiB7XG4gICAgICogICAgICAgdGltZW91dDogMjAsXG4gICAgICogICAgICAgZW52aXJvbm1lbnQ6IHsgdGFibGVOYW1lOiB0YWJsZS50YWJsZU5hbWUgfSxcbiAgICAgKiAgICAgICBwZXJtaXNzaW9uczogW3RhYmxlXSxcbiAgICAgKiAgICAgfVxuICAgICAqICAgfSxcbiAgICAgKiB9KTtcbiAgICAgKiBgYGBcbiAgICAgKi9cbiAgICBmdW5jdGlvbj86IEZ1bmN0aW9uUHJvcHM7XG4gIH07XG4gIGNkaz86IHtcbiAgICBncmFwaHFsQXBpPzogYXBwc3luYy5JR3JhcGhxbEFwaSB8IEFwcFN5bmNBcGlDZGtHcmFwaHFsUHJvcHM7XG4gIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBwU3luY0FwaUNka0dyYXBocWxQcm9wc1xuICBleHRlbmRzIE9taXQ8YXBwc3luYy5HcmFwaHFsQXBpUHJvcHMsIFwibmFtZVwiPiB7XG4gIG5hbWU/OiBzdHJpbmc7XG59XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gQ29uc3RydWN0XG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuLyoqXG4gKlxuICogVGhlIGBBcHBTeW5jQXBpYCBjb25zdHJ1Y3QgaXMgYSBoaWdoZXIgbGV2ZWwgQ0RLIGNvbnN0cnVjdCB0aGF0IG1ha2VzIGl0IGVhc3kgdG8gY3JlYXRlIGFuIEFwcFN5bmMgR3JhcGhRTCBBUEkuIEl0IHByb3ZpZGVzIGEgc2ltcGxlIHdheSB0byBkZWZpbmUgdGhlIGRhdGEgc291cmNlcyBhbmQgdGhlIHJlc29sdmVycyBpbiB5b3VyIEFQSS4gQW5kIGFsbG93cyB5b3UgdG8gY29uZmlndXJlIHRoZSBzcGVjaWZpYyBMYW1iZGEgZnVuY3Rpb25zIGlmIG5lY2Vzc2FyeS4gU2VlIHRoZSBbZXhhbXBsZXNdKCNleGFtcGxlcykgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBAZXhhbXBsZVxuICogIyMjIFVzaW5nIHRoZSBtaW5pbWFsIGNvbmZpZ1xuICpcbiAqIGBgYGpzXG4gKiBpbXBvcnQgeyBBcHBTeW5jQXBpIH0gZnJvbSBcIkBzZXJ2ZXJsZXNzLXN0YWNrL3Jlc291cmNlc1wiO1xuICpcbiAqIG5ldyBBcHBTeW5jQXBpKHN0YWNrLCBcIkdyYXBocWxBcGlcIiwge1xuICogICBzY2hlbWE6IFwiZ3JhcGhxbC9zY2hlbWEuZ3JhcGhxbFwiLFxuICogICBkYXRhU291cmNlczoge1xuICogICAgIG5vdGVzRFM6IFwic3JjL25vdGVzLm1haW5cIixcbiAqICAgfSxcbiAqICAgcmVzb2x2ZXJzOiB7XG4gKiAgICAgXCJRdWVyeSAgICBsaXN0Tm90ZXNcIjogXCJub3Rlc0RTXCIsXG4gKiAgICAgXCJRdWVyeSAgICBnZXROb3RlQnlJZFwiOiBcIm5vdGVzRFNcIixcbiAqICAgICBcIk11dGF0aW9uIGNyZWF0ZU5vdGVcIjogXCJub3Rlc0RTXCIsXG4gKiAgICAgXCJNdXRhdGlvbiB1cGRhdGVOb3RlXCI6IFwibm90ZXNEU1wiLFxuICogICAgIFwiTXV0YXRpb24gZGVsZXRlTm90ZVwiOiBcIm5vdGVzRFNcIixcbiAqICAgfSxcbiAqIH0pO1xuICogYGBgXG4gKlxuICogTm90ZSB0aGF0LCB0aGUgcmVzb2x2ZXIga2V5IGNhbiBoYXZlIGV4dHJhIHNwYWNlcyBpbiBiZXR3ZWVuLCB0aGV5IGFyZSBqdXN0IGlnbm9yZWQuXG4gKi9cbmV4cG9ydCBjbGFzcyBBcHBTeW5jQXBpIGV4dGVuZHMgQ29uc3RydWN0IGltcGxlbWVudHMgU1NUQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IGNkazoge1xuICAgIC8qKlxuICAgICAqIFRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgYXBwc3luYyBhcGlcbiAgICAgKi9cbiAgICBncmFwaHFsQXBpOiBhcHBzeW5jLkdyYXBocWxBcGk7XG4gICAgLyoqXG4gICAgICogSWYgY3VzdG9tIGRvbWFpbiBpcyBlbmFibGVkLCB0aGlzIGlzIHRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgQ0RLIENlcnRpZmljYXRlIGluc3RhbmNlLlxuICAgICAqL1xuICAgIGNlcnRpZmljYXRlPzogYWNtLklDZXJ0aWZpY2F0ZTtcbiAgfTtcbiAgcmVhZG9ubHkgcHJvcHM6IEFwcFN5bmNBcGlQcm9wcztcbiAgcHJpdmF0ZSBfY3VzdG9tRG9tYWluVXJsPzogc3RyaW5nO1xuICBfY2ZuRG9tYWluTmFtZT86IGNmbkFwcHN5bmMuQ2ZuRG9tYWluTmFtZTtcbiAgcmVhZG9ubHkgZnVuY3Rpb25zQnlEc0tleTogeyBba2V5OiBzdHJpbmddOiBGbiB9O1xuICByZWFkb25seSBkYXRhU291cmNlc0J5RHNLZXk6IHtcbiAgICBba2V5OiBzdHJpbmddOiBhcHBzeW5jLkJhc2VEYXRhU291cmNlO1xuICB9O1xuICByZWFkb25seSBkc0tleXNCeVJlc0tleTogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcbiAgcmVhZG9ubHkgcmVzb2x2ZXJzQnlSZXNLZXk6IHsgW2tleTogc3RyaW5nXTogYXBwc3luYy5SZXNvbHZlciB9O1xuICByZWFkb25seSBwZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsRnVuY3Rpb25zOiBQZXJtaXNzaW9uc1tdO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogQXBwU3luY0FwaVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIHRoaXMucHJvcHMgPSBwcm9wcyB8fCB7fTtcbiAgICB0aGlzLmNkayA9IHt9IGFzIGFueTtcbiAgICB0aGlzLmZ1bmN0aW9uc0J5RHNLZXkgPSB7fTtcbiAgICB0aGlzLmRhdGFTb3VyY2VzQnlEc0tleSA9IHt9O1xuICAgIHRoaXMucmVzb2x2ZXJzQnlSZXNLZXkgPSB7fTtcbiAgICB0aGlzLmRzS2V5c0J5UmVzS2V5ID0ge307XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsRnVuY3Rpb25zID0gW107XG5cbiAgICB0aGlzLmNyZWF0ZUdyYXBoQXBpKCk7XG5cbiAgICAvLyBDb25maWd1cmUgZGF0YSBzb3VyY2VzXG4gICAgaWYgKHByb3BzPy5kYXRhU291cmNlcykge1xuICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMocHJvcHMuZGF0YVNvdXJjZXMpKSB7XG4gICAgICAgIHRoaXMuYWRkRGF0YVNvdXJjZSh0aGlzLCBrZXksIHByb3BzLmRhdGFTb3VyY2VzW2tleV0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENvbmZpZ3VyZSByZXNvbHZlcnNcbiAgICBpZiAocHJvcHM/LnJlc29sdmVycykge1xuICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMocHJvcHMucmVzb2x2ZXJzKSkge1xuICAgICAgICB0aGlzLmFkZFJlc29sdmVyKHRoaXMsIGtleSwgcHJvcHMucmVzb2x2ZXJzW2tleV0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgSWQgb2YgdGhlIGludGVybmFsbHkgY3JlYXRlZCBBcHBTeW5jIEdyYXBoUUwgQVBJLlxuICAgKi9cbiAgcHVibGljIGdldCBhcGlJZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmNkay5ncmFwaHFsQXBpLmFwaUlkO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBBUk4gb2YgdGhlIGludGVybmFsbHkgY3JlYXRlZCBBcHBTeW5jIEdyYXBoUUwgQVBJLlxuICAgKi9cbiAgcHVibGljIGdldCBhcGlBcm4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jZGsuZ3JhcGhxbEFwaS5hcm47XG4gIH1cblxuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIGludGVybmFsbHkgY3JlYXRlZCBBcHBTeW5jIEdyYXBoUUwgQVBJLlxuICAgKi9cbiAgcHVibGljIGdldCBhcGlOYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuY2RrLmdyYXBocWxBcGkubmFtZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgQVdTIGdlbmVyYXRlZCBVUkwgb2YgdGhlIEFwaS5cbiAgICovXG4gIHB1YmxpYyBnZXQgdXJsKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuY2RrLmdyYXBocWxBcGkuZ3JhcGhxbFVybDtcbiAgfVxuXG4gIC8qKlxuICAgKiBJZiBjdXN0b20gZG9tYWluIGlzIGVuYWJsZWQsIHRoaXMgaXMgdGhlIGN1c3RvbSBkb21haW4gVVJMIG9mIHRoZSBBcGkuXG4gICAqL1xuICBwdWJsaWMgZ2V0IGN1c3RvbURvbWFpblVybCgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLl9jdXN0b21Eb21haW5Vcmw7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGRhdGEgc291cmNlcyBhZnRlciB0aGUgY29uc3RydWN0IGhhcyBiZWVuIGNyZWF0ZWRcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogYXBpLmFkZERhdGFTb3VyY2VzKHN0YWNrLCB7XG4gICAqICAgYmlsbGluZ0RTOiBcInNyYy9iaWxsaW5nLm1haW5cIixcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgcHVibGljIGFkZERhdGFTb3VyY2VzKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgZGF0YVNvdXJjZXM6IHtcbiAgICAgIFtrZXk6IHN0cmluZ106XG4gICAgICAgIHwgRnVuY3Rpb25JbmxpbmVEZWZpbml0aW9uXG4gICAgICAgIHwgQXBwU3luY0FwaUxhbWJkYURhdGFTb3VyY2VQcm9wc1xuICAgICAgICB8IEFwcFN5bmNBcGlEeW5hbW9EYkRhdGFTb3VyY2VQcm9wc1xuICAgICAgICB8IEFwcFN5bmNBcGlSZHNEYXRhU291cmNlUHJvcHNcbiAgICAgICAgfCBBcHBTeW5jQXBpSHR0cERhdGFTb3VyY2VQcm9wc1xuICAgICAgICB8IEFwcFN5bmNBcGlOb25lRGF0YVNvdXJjZVByb3BzO1xuICAgIH1cbiAgKTogdm9pZCB7XG4gICAgT2JqZWN0LmtleXMoZGF0YVNvdXJjZXMpLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XG4gICAgICAvLyBhZGQgZGF0YSBzb3VyY2VcbiAgICAgIGNvbnN0IGZuID0gdGhpcy5hZGREYXRhU291cmNlKHNjb3BlLCBrZXksIGRhdGFTb3VyY2VzW2tleV0pO1xuXG4gICAgICAvLyBhdHRhY2hlZCBleGlzdGluZyBwZXJtaXNzaW9uc1xuICAgICAgaWYgKGZuKSB7XG4gICAgICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbEZ1bmN0aW9ucy5mb3JFYWNoKChwZXJtaXNzaW9ucykgPT5cbiAgICAgICAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucylcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgcmVzb2x2ZXJzIHRoZSBjb25zdHJ1Y3QgaGFzIGJlZW4gY3JlYXRlZFxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqc1xuICAgKiBhcGkuYWRkUmVzb2x2ZXJzKHN0YWNrLCB7XG4gICAqICAgXCJNdXRhdGlvbiBjaGFyZ2VcIjogXCJiaWxsaW5nRFNcIixcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgcHVibGljIGFkZFJlc29sdmVycyhcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHJlc29sdmVyczoge1xuICAgICAgW2tleTogc3RyaW5nXTogRnVuY3Rpb25JbmxpbmVEZWZpbml0aW9uIHwgQXBwU3luY0FwaVJlc29sdmVyUHJvcHM7XG4gICAgfVxuICApOiB2b2lkIHtcbiAgICBPYmplY3Qua2V5cyhyZXNvbHZlcnMpLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XG4gICAgICAvLyBhZGQgcmVzb2x2ZXJcbiAgICAgIGNvbnN0IGZuID0gdGhpcy5hZGRSZXNvbHZlcihzY29wZSwga2V5LCByZXNvbHZlcnNba2V5XSk7XG5cbiAgICAgIC8vIGF0dGFjaGVkIGV4aXN0aW5nIHBlcm1pc3Npb25zXG4gICAgICBpZiAoZm4pIHtcbiAgICAgICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsRnVuY3Rpb25zLmZvckVhY2goKHBlcm1pc3Npb25zKSA9PlxuICAgICAgICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgaW5zdGFuY2Ugb2YgdGhlIGludGVybmFsbHkgY3JlYXRlZCBGdW5jdGlvbiwgZm9yIGEgZ2l2ZW4gcmVzb2x2ZXIuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIGNvbnN0IGZ1bmMgPSBhcGkuZ2V0RnVuY3Rpb24oXCJNdXRhdGlvbiBjaGFyZ2VcIik7XG4gICAqIGBgYFxuICAgKi9cbiAgcHVibGljIGdldEZ1bmN0aW9uKGtleTogc3RyaW5nKTogRm4gfCB1bmRlZmluZWQge1xuICAgIGxldCBmbiA9IHRoaXMuZnVuY3Rpb25zQnlEc0tleVtrZXldO1xuXG4gICAgaWYgKCFmbikge1xuICAgICAgY29uc3QgcmVzS2V5ID0gdGhpcy5ub3JtYWxpemVSZXNvbHZlcktleShrZXkpO1xuICAgICAgY29uc3QgZHNLZXkgPSB0aGlzLmRzS2V5c0J5UmVzS2V5W3Jlc0tleV07XG4gICAgICBmbiA9IHRoaXMuZnVuY3Rpb25zQnlEc0tleVtkc0tleV07XG4gICAgfVxuICAgIHJldHVybiBmbjtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYSBkYXRhc291cmNlIGJ5IG5hbWVcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogYXBpLmdldERhdGFTb3VyY2UoXCJiaWxsaW5nRFNcIik7XG4gICAqIGBgYFxuICAgKi9cbiAgcHVibGljIGdldERhdGFTb3VyY2Uoa2V5OiBzdHJpbmcpOiBhcHBzeW5jLkJhc2VEYXRhU291cmNlIHwgdW5kZWZpbmVkIHtcbiAgICBsZXQgZHMgPSB0aGlzLmRhdGFTb3VyY2VzQnlEc0tleVtrZXldO1xuXG4gICAgaWYgKCFkcykge1xuICAgICAgY29uc3QgcmVzS2V5ID0gdGhpcy5ub3JtYWxpemVSZXNvbHZlcktleShrZXkpO1xuICAgICAgY29uc3QgZHNLZXkgPSB0aGlzLmRzS2V5c0J5UmVzS2V5W3Jlc0tleV07XG4gICAgICBkcyA9IHRoaXMuZGF0YVNvdXJjZXNCeURzS2V5W2RzS2V5XTtcbiAgICB9XG4gICAgcmV0dXJuIGRzO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhIHJlc29sdmVyXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIGFwaS5nZXRSZXNvbHZlcihcIk11dGF0aW9uIGNoYXJnZVwiKTtcbiAgICogYGBgXG4gICAqL1xuICBwdWJsaWMgZ2V0UmVzb2x2ZXIoa2V5OiBzdHJpbmcpOiBhcHBzeW5jLlJlc29sdmVyIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCByZXNLZXkgPSB0aGlzLm5vcm1hbGl6ZVJlc29sdmVyS2V5KGtleSk7XG4gICAgcmV0dXJuIHRoaXMucmVzb2x2ZXJzQnlSZXNLZXlbcmVzS2V5XTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBdHRhY2hlcyB0aGUgZ2l2ZW4gbGlzdCBvZiBwZXJtaXNzaW9ucyB0byBhbGwgZnVuY3Rpb24gZGF0YXNvdXJjZXNcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogYGBganNcbiAgICogYXBpLmF0dGFjaFBlcm1pc3Npb25zKFtcInMzXCJdKTtcbiAgICogYGBgXG4gICAqL1xuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKTogdm9pZCB7XG4gICAgT2JqZWN0LnZhbHVlcyh0aGlzLmZ1bmN0aW9uc0J5RHNLZXkpLmZvckVhY2goKGZuKSA9PlxuICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpXG4gICAgKTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxGdW5jdGlvbnMucHVzaChwZXJtaXNzaW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogQXR0YWNoZXMgdGhlIGdpdmVuIGxpc3Qgb2YgcGVybWlzc2lvbnMgdG8gYSBzcGVjaWZpYyBmdW5jdGlvbiBkYXRhc291cmNlLiBUaGlzIGFsbG93cyB0aGF0IGZ1bmN0aW9uIHRvIGFjY2VzcyBvdGhlciBBV1MgcmVzb3VyY2VzLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBhcGkuYXR0YWNoUGVybWlzc2lvbnNUb1JvdXRlKFwiTXV0YXRpb24gY2hhcmdlXCIsIFtcInMzXCJdKTtcbiAgICogYGBgXG4gICAqL1xuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNUb0RhdGFTb3VyY2UoXG4gICAga2V5OiBzdHJpbmcsXG4gICAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25zXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGZuID0gdGhpcy5nZXRGdW5jdGlvbihrZXkpO1xuICAgIGlmICghZm4pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBhdHRhY2ggcGVybWlzc2lvbnMuIEZ1bmN0aW9uIGRvZXMgbm90IGV4aXN0IGZvciBrZXkgXCIke2tleX1cIi5gXG4gICAgICApO1xuICAgIH1cblxuICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25zdHJ1Y3RNZXRhZGF0YSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogXCJBcHBTeW5jXCIgYXMgY29uc3QsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIHVybDogdGhpcy5jZGsuZ3JhcGhxbEFwaS5ncmFwaHFsVXJsLFxuICAgICAgICBhcHBTeW5jQXBpSWQ6IHRoaXMuY2RrLmdyYXBocWxBcGkuYXBpSWQsXG4gICAgICAgIGFwcFN5bmNBcGlLZXk6IHRoaXMuY2RrLmdyYXBocWxBcGkuYXBpS2V5LFxuICAgICAgICBjdXN0b21Eb21haW5Vcmw6IHRoaXMuX2N1c3RvbURvbWFpblVybCxcbiAgICAgICAgZGF0YVNvdXJjZXM6IE9iamVjdC5lbnRyaWVzKHRoaXMuZGF0YVNvdXJjZXNCeURzS2V5KS5tYXAoKFtrZXldKSA9PiAoe1xuICAgICAgICAgIG5hbWU6IGtleSxcbiAgICAgICAgICBmbjogZ2V0RnVuY3Rpb25SZWYodGhpcy5mdW5jdGlvbnNCeURzS2V5W2tleV0pLFxuICAgICAgICB9KSksXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUdyYXBoQXBpKCkge1xuICAgIGNvbnN0IHsgc2NoZW1hLCBjdXN0b21Eb21haW4sIGNkayB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBpZCA9IHRoaXMubm9kZS5pZDtcbiAgICBjb25zdCBhcHAgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG5cbiAgICBpZiAoaXNDREtDb25zdHJ1Y3QoY2RrPy5ncmFwaHFsQXBpKSkge1xuICAgICAgaWYgKGN1c3RvbURvbWFpbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJjdXN0b21Eb21haW5cIiB3aGVuIFwiZ3JhcGhxbEFwaVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgdGhpcy5jZGsuZ3JhcGhxbEFwaSA9IGNkaz8uZ3JhcGhxbEFwaSBhcyBhcHBzeW5jLkdyYXBocWxBcGk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGdyYXBocWxBcGlQcm9wcyA9IChjZGs/LmdyYXBocWxBcGkgfHxcbiAgICAgICAge30pIGFzIEFwcFN5bmNBcGlDZGtHcmFwaHFsUHJvcHM7XG5cbiAgICAgIC8vIGJ1aWxkIHNjaGVtYVxuICAgICAgbGV0IG1haW5TY2hlbWE6IGFwcHN5bmMuU2NoZW1hIHwgdW5kZWZpbmVkO1xuICAgICAgaWYgKHR5cGVvZiBzY2hlbWEgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgbWFpblNjaGVtYSA9IGFwcHN5bmMuU2NoZW1hLmZyb21Bc3NldChzY2hlbWEpO1xuICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHNjaGVtYSkpIHtcbiAgICAgICAgaWYgKHNjaGVtYS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgLy8gbWVyZ2Ugc2NoZW1hIGZpbGVzXG4gICAgICAgICAgY29uc3QgbWVyZ2VkU2NoZW1hID0gbWVyZ2VUeXBlRGVmcyhsb2FkRmlsZXNTeW5jKHNjaGVtYSkpO1xuICAgICAgICAgIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5qb2luKFxuICAgICAgICAgICAgYXBwLmJ1aWxkRGlyLFxuICAgICAgICAgICAgYGFwcHN5bmNhcGktJHtpZH0tJHt0aGlzLm5vZGUuYWRkcn0uZ3JhcGhxbGBcbiAgICAgICAgICApO1xuICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIHByaW50KG1lcmdlZFNjaGVtYSkpO1xuICAgICAgICAgIG1haW5TY2hlbWEgPSBhcHBzeW5jLlNjaGVtYS5mcm9tQXNzZXQoZmlsZVBhdGgpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIGJ1aWxkIGRvbWFpblxuICAgICAgY29uc3QgZG9tYWluRGF0YSA9IGFwcFN5bmNBcGlEb21haW4uYnVpbGRDdXN0b21Eb21haW5EYXRhKFxuICAgICAgICB0aGlzLFxuICAgICAgICBjdXN0b21Eb21haW5cbiAgICAgICk7XG4gICAgICB0aGlzLl9jdXN0b21Eb21haW5VcmwgPVxuICAgICAgICBkb21haW5EYXRhICYmIGBodHRwczovLyR7ZG9tYWluRGF0YS5kb21haW5OYW1lfS9ncmFwaHFsYDtcblxuICAgICAgdGhpcy5jZGsuZ3JhcGhxbEFwaSA9IG5ldyBhcHBzeW5jLkdyYXBocWxBcGkodGhpcywgXCJBcGlcIiwge1xuICAgICAgICBuYW1lOiBhcHAubG9naWNhbFByZWZpeGVkTmFtZShpZCksXG4gICAgICAgIHhyYXlFbmFibGVkOiB0cnVlLFxuICAgICAgICBzY2hlbWE6IG1haW5TY2hlbWEsXG4gICAgICAgIGRvbWFpbk5hbWU6IGRvbWFpbkRhdGEsXG4gICAgICAgIC4uLmdyYXBocWxBcGlQcm9wcyxcbiAgICAgIH0pO1xuICAgICAgdGhpcy5jZGsuY2VydGlmaWNhdGUgPSBkb21haW5EYXRhPy5jZXJ0aWZpY2F0ZTtcblxuICAgICAgLy8gbm90ZTogQXMgb2YgQ0RLIDIuMjAuMCwgdGhlIFwiQVdTOjpBcHBTeW5jOjpEb21haW5OYW1lQXBpQXNzb2NpYXRpb25cIiByZXNvdXJjZVxuICAgICAgLy8gICAgICAgaXMgbm90IGRlcGVuZGVudCBvbiB0aGUgXCJBV1M6OkFwcFN5bmM6OkRvbWFpbk5hbWVcIiByZXNvdXJjZS4gVGhpcyBsZWFkc1xuICAgICAgLy8gICAgICAgQ2xvdWRGb3JtYXRpb24gZGVwbG95IGVycm9yIGlmIERvbWFpbk5hbWVBcGlBc3NvY2lhdGlvbiBpcyBjcmVhdGVkIGJlZm9yZVxuICAgICAgLy8gICAgICAgRG9tYWluTmFtZSBpcyBjcmVhdGVkLlxuICAgICAgLy8gICAgICAgaHR0cHM6Ly9naXRodWIuY29tL2F3cy9hd3MtY2RrL2lzc3Vlcy8xODM5NSNpc3N1ZWNvbW1lbnQtMTA5OTQ1NTUwMlxuICAgICAgLy8gICAgICAgVG8gd29ya2Fyb3VuZCB0aGlzIGlzc3VlLCB3ZSBuZWVkIHRvIGFkZCBhIGRlcGVuZGVuY3kgbWFudWFsbHkuXG4gICAgICBpZiAoZG9tYWluRGF0YSkge1xuICAgICAgICB0aGlzLl9jZm5Eb21haW5OYW1lID0gdGhpcy5jZGsuZ3JhcGhxbEFwaS5ub2RlLmNoaWxkcmVuLmZpbmQoXG4gICAgICAgICAgKGNoaWxkKSA9PlxuICAgICAgICAgICAgKGNoaWxkIGFzIGNmbkFwcHN5bmMuQ2ZuRG9tYWluTmFtZSkuY2ZuUmVzb3VyY2VUeXBlID09PVxuICAgICAgICAgICAgXCJBV1M6OkFwcFN5bmM6OkRvbWFpbk5hbWVcIlxuICAgICAgICApIGFzIGNmbkFwcHN5bmMuQ2ZuRG9tYWluTmFtZTtcbiAgICAgICAgY29uc3QgY2ZuRG9tYWluTmFtZUFwaUFzc29jaWF0aW9uID1cbiAgICAgICAgICB0aGlzLmNkay5ncmFwaHFsQXBpLm5vZGUuY2hpbGRyZW4uZmluZChcbiAgICAgICAgICAgIChjaGlsZCkgPT5cbiAgICAgICAgICAgICAgKGNoaWxkIGFzIGNmbkFwcHN5bmMuQ2ZuRG9tYWluTmFtZUFwaUFzc29jaWF0aW9uKVxuICAgICAgICAgICAgICAgIC5jZm5SZXNvdXJjZVR5cGUgPT09IFwiQVdTOjpBcHBTeW5jOjpEb21haW5OYW1lQXBpQXNzb2NpYXRpb25cIlxuICAgICAgICAgICk7XG4gICAgICAgIGlmICh0aGlzLl9jZm5Eb21haW5OYW1lICYmIGNmbkRvbWFpbk5hbWVBcGlBc3NvY2lhdGlvbikge1xuICAgICAgICAgIGNmbkRvbWFpbk5hbWVBcGlBc3NvY2lhdGlvbi5ub2RlLmFkZERlcGVuZGVuY3kodGhpcy5fY2ZuRG9tYWluTmFtZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFkZERhdGFTb3VyY2UoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBkc0tleTogc3RyaW5nLFxuICAgIGRzVmFsdWU6XG4gICAgICB8IEZ1bmN0aW9uSW5saW5lRGVmaW5pdGlvblxuICAgICAgfCBBcHBTeW5jQXBpTGFtYmRhRGF0YVNvdXJjZVByb3BzXG4gICAgICB8IEFwcFN5bmNBcGlEeW5hbW9EYkRhdGFTb3VyY2VQcm9wc1xuICAgICAgfCBBcHBTeW5jQXBpUmRzRGF0YVNvdXJjZVByb3BzXG4gICAgICB8IEFwcFN5bmNBcGlIdHRwRGF0YVNvdXJjZVByb3BzXG4gICAgICB8IEFwcFN5bmNBcGlOb25lRGF0YVNvdXJjZVByb3BzXG4gICk6IEZuIHwgdW5kZWZpbmVkIHtcbiAgICBsZXQgZGF0YVNvdXJjZTtcbiAgICBsZXQgbGFtYmRhO1xuXG4gICAgLy8gTGFtYmRhIGZ1bmN0aW9uXG4gICAgaWYgKEZuLmlzSW5saW5lRGVmaW5pdGlvbihkc1ZhbHVlKSkge1xuICAgICAgbGFtYmRhID0gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICAgIHNjb3BlLFxuICAgICAgICBgTGFtYmRhXyR7ZHNLZXl9YCxcbiAgICAgICAgZHNWYWx1ZSxcbiAgICAgICAgdGhpcy5wcm9wcy5kZWZhdWx0cz8uZnVuY3Rpb24sXG4gICAgICAgIGBDYW5ub3QgZGVmaW5lIGRlZmF1bHRzLmZ1bmN0aW9uIHdoZW4gYSBGdW5jdGlvbiBpcyBwYXNzZWQgaW4gdG8gdGhlIFwiJHtkc0tleX0gZGF0YSBzb3VyY2VgXG4gICAgICApO1xuICAgICAgZGF0YVNvdXJjZSA9IHRoaXMuY2RrLmdyYXBocWxBcGkuYWRkTGFtYmRhRGF0YVNvdXJjZShkc0tleSwgbGFtYmRhKTtcbiAgICB9XG4gICAgLy8gRHluYW1vRGIgZHNcbiAgICBlbHNlIGlmIChkc1ZhbHVlLnR5cGUgPT09IFwiZHluYW1vZGJcIikge1xuICAgICAgZGF0YVNvdXJjZSA9IHRoaXMuY2RrLmdyYXBocWxBcGkuYWRkRHluYW1vRGJEYXRhU291cmNlKFxuICAgICAgICBkc0tleSxcbiAgICAgICAgZHNWYWx1ZS50YWJsZVxuICAgICAgICAgID8gZHNWYWx1ZS50YWJsZS5jZGsudGFibGVcbiAgICAgICAgICA6IGRzVmFsdWUuY2RrPy5kYXRhU291cmNlPy50YWJsZSEsXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lOiBkc1ZhbHVlLm5hbWUsXG4gICAgICAgICAgZGVzY3JpcHRpb246IGRzVmFsdWUuZGVzY3JpcHRpb24sXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuICAgIC8vIFJkcyBkc1xuICAgIGVsc2UgaWYgKGRzVmFsdWUudHlwZSA9PT0gXCJyZHNcIikge1xuICAgICAgZGF0YVNvdXJjZSA9IHRoaXMuY2RrLmdyYXBocWxBcGkuYWRkUmRzRGF0YVNvdXJjZShcbiAgICAgICAgZHNLZXksXG4gICAgICAgIGRzVmFsdWUucmRzXG4gICAgICAgICAgPyBkc1ZhbHVlLnJkcy5jZGsuY2x1c3RlclxuICAgICAgICAgIDogZHNWYWx1ZS5jZGs/LmRhdGFTb3VyY2U/LnNlcnZlcmxlc3NDbHVzdGVyISxcbiAgICAgICAgZHNWYWx1ZS5yZHNcbiAgICAgICAgICA/IGRzVmFsdWUucmRzLmNkay5jbHVzdGVyLnNlY3JldCFcbiAgICAgICAgICA6IGRzVmFsdWUuY2RrPy5kYXRhU291cmNlPy5zZWNyZXRTdG9yZSEsXG4gICAgICAgIGRzVmFsdWUucmRzXG4gICAgICAgICAgPyBkc1ZhbHVlLmRhdGFiYXNlTmFtZSB8fCBkc1ZhbHVlLnJkcy5kZWZhdWx0RGF0YWJhc2VOYW1lXG4gICAgICAgICAgOiBkc1ZhbHVlLmNkaz8uZGF0YVNvdXJjZT8uZGF0YWJhc2VOYW1lLFxuICAgICAgICB7XG4gICAgICAgICAgbmFtZTogZHNWYWx1ZS5uYW1lLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBkc1ZhbHVlLmRlc2NyaXB0aW9uLFxuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cbiAgICAvLyBIdHRwIGRzXG4gICAgZWxzZSBpZiAoZHNWYWx1ZS50eXBlID09PSBcImh0dHBcIikge1xuICAgICAgZGF0YVNvdXJjZSA9IHRoaXMuY2RrLmdyYXBocWxBcGkuYWRkSHR0cERhdGFTb3VyY2UoXG4gICAgICAgIGRzS2V5LFxuICAgICAgICBkc1ZhbHVlLmVuZHBvaW50LFxuICAgICAgICB7XG4gICAgICAgICAgbmFtZTogZHNWYWx1ZS5uYW1lLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBkc1ZhbHVlLmRlc2NyaXB0aW9uLFxuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cbiAgICAvLyBIdHRwIGRzXG4gICAgZWxzZSBpZiAoZHNWYWx1ZS50eXBlID09PSBcIm5vbmVcIikge1xuICAgICAgZGF0YVNvdXJjZSA9IHRoaXMuY2RrLmdyYXBocWxBcGkuYWRkTm9uZURhdGFTb3VyY2UoZHNLZXksIHtcbiAgICAgICAgbmFtZTogZHNWYWx1ZS5uYW1lLFxuICAgICAgICBkZXNjcmlwdGlvbjogZHNWYWx1ZS5kZXNjcmlwdGlvbixcbiAgICAgIH0pO1xuICAgIH1cbiAgICAvLyBMYW1iZGEgZHNcbiAgICBlbHNlIHtcbiAgICAgIGxhbWJkYSA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgICBzY29wZSxcbiAgICAgICAgYExhbWJkYV8ke2RzS2V5fWAsXG4gICAgICAgIGRzVmFsdWUuZnVuY3Rpb24sXG4gICAgICAgIHRoaXMucHJvcHMuZGVmYXVsdHM/LmZ1bmN0aW9uLFxuICAgICAgICBgQ2Fubm90IGRlZmluZSBkZWZhdWx0cy5mdW5jdGlvbiB3aGVuIGEgRnVuY3Rpb24gaXMgcGFzc2VkIGluIHRvIHRoZSBcIiR7ZHNLZXl9IGRhdGEgc291cmNlYFxuICAgICAgKTtcbiAgICAgIGRhdGFTb3VyY2UgPSB0aGlzLmNkay5ncmFwaHFsQXBpLmFkZExhbWJkYURhdGFTb3VyY2UoZHNLZXksIGxhbWJkYSwge1xuICAgICAgICBuYW1lOiBkc1ZhbHVlLm5hbWUsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBkc1ZhbHVlLmRlc2NyaXB0aW9uLFxuICAgICAgfSk7XG4gICAgfVxuICAgIHRoaXMuZGF0YVNvdXJjZXNCeURzS2V5W2RzS2V5XSA9IGRhdGFTb3VyY2U7XG4gICAgaWYgKGxhbWJkYSkge1xuICAgICAgdGhpcy5mdW5jdGlvbnNCeURzS2V5W2RzS2V5XSA9IGxhbWJkYTtcbiAgICB9XG5cbiAgICByZXR1cm4gbGFtYmRhO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRSZXNvbHZlcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHJlc0tleTogc3RyaW5nLFxuICAgIHJlc1ZhbHVlOiBGdW5jdGlvbklubGluZURlZmluaXRpb24gfCBBcHBTeW5jQXBpUmVzb2x2ZXJQcm9wc1xuICApOiBGbiB8IHVuZGVmaW5lZCB7XG4gICAgLy8gTm9ybWFsaXplIHJlc0tleVxuICAgIHJlc0tleSA9IHRoaXMubm9ybWFsaXplUmVzb2x2ZXJLZXkocmVzS2V5KTtcblxuICAgIC8vIEdldCB0eXBlIGFuZCBmaWVsZFxuICAgIGNvbnN0IHJlc29sdmVyS2V5UGFydHMgPSByZXNLZXkuc3BsaXQoXCIgXCIpO1xuICAgIGlmIChyZXNvbHZlcktleVBhcnRzLmxlbmd0aCAhPT0gMikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHJlc29sdmVyICR7cmVzS2V5fWApO1xuICAgIH1cbiAgICBjb25zdCBbdHlwZU5hbWUsIGZpZWxkTmFtZV0gPSByZXNvbHZlcktleVBhcnRzO1xuICAgIGlmIChmaWVsZE5hbWUubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgZmllbGQgZGVmaW5lZCBmb3IgXCIke3Jlc0tleX1cImApO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgZGF0YSBzb3VyY2UgaWYgbm90IGNyZWF0ZWQgYmVmb3JlXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGxldCBsYW1iZGE7XG4gICAgbGV0IGRhdGFTb3VyY2U7XG4gICAgbGV0IGRhdGFTb3VyY2VLZXk7XG4gICAgbGV0IHJlc29sdmVyUHJvcHM7XG5cbiAgICAvLyBEYXRhU291cmNlIGtleVxuICAgIGlmIChcbiAgICAgIHR5cGVvZiByZXNWYWx1ZSA9PT0gXCJzdHJpbmdcIiAmJlxuICAgICAgT2JqZWN0LmtleXModGhpcy5kYXRhU291cmNlc0J5RHNLZXkpLmluY2x1ZGVzKHJlc1ZhbHVlKVxuICAgICkge1xuICAgICAgZGF0YVNvdXJjZUtleSA9IHJlc1ZhbHVlO1xuICAgICAgZGF0YVNvdXJjZSA9IHRoaXMuZGF0YVNvdXJjZXNCeURzS2V5W3Jlc1ZhbHVlXTtcbiAgICAgIHJlc29sdmVyUHJvcHMgPSB7fTtcbiAgICB9XG4gICAgLy8gRGF0YVNvdXJjZSBrZXkgbm90IGV4aXN0IChzdHJpbmcgZG9lcyBub3QgaGF2ZSBhIGRvdCwgYXNzdW1lIGl0IGlzIHJlZmVyZW5jaW5nIGEgZGF0YSBzdG9yZSlcbiAgICBlbHNlIGlmICh0eXBlb2YgcmVzVmFsdWUgPT09IFwic3RyaW5nXCIgJiYgcmVzVmFsdWUuaW5kZXhPZihcIi5cIikgPT09IC0xKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gY3JlYXRlIHJlc29sdmVyIFwiJHtyZXNLZXl9XCIuIERhdGEgc291cmNlIFwiJHtyZXNWYWx1ZX1cIiBkb2VzIG5vdCBleGlzdC5gXG4gICAgICApO1xuICAgIH1cbiAgICAvLyBMYW1iZGEgcmVzb2x2ZXJcbiAgICBlbHNlIGlmICh0aGlzLmlzTGFtYmRhUmVzb2x2ZXJQcm9wcyhyZXNWYWx1ZSBhcyBBcHBTeW5jQXBpUmVzb2x2ZXJQcm9wcykpIHtcbiAgICAgIHJlc1ZhbHVlID0gcmVzVmFsdWUgYXMgQXBwU3luY0FwaVJlc29sdmVyUHJvcHM7XG4gICAgICBsYW1iZGEgPSBGbi5mcm9tRGVmaW5pdGlvbihcbiAgICAgICAgc2NvcGUsXG4gICAgICAgIGBMYW1iZGFfJHt0eXBlTmFtZX1fJHtmaWVsZE5hbWV9YCxcbiAgICAgICAgcmVzVmFsdWUuZnVuY3Rpb24gYXMgRnVuY3Rpb25EZWZpbml0aW9uLFxuICAgICAgICB0aGlzLnByb3BzLmRlZmF1bHRzPy5mdW5jdGlvbixcbiAgICAgICAgYENhbm5vdCBkZWZpbmUgZGVmYXVsdHMuZnVuY3Rpb24gd2hlbiBhIEZ1bmN0aW9uIGlzIHBhc3NlZCBpbiB0byB0aGUgXCIke3Jlc0tleX0gcmVzb2x2ZXJgXG4gICAgICApO1xuICAgICAgZGF0YVNvdXJjZUtleSA9IHRoaXMuYnVpbGREYXRhU291cmNlS2V5KHR5cGVOYW1lLCBmaWVsZE5hbWUpO1xuICAgICAgZGF0YVNvdXJjZSA9IHRoaXMuY2RrLmdyYXBocWxBcGkuYWRkTGFtYmRhRGF0YVNvdXJjZShcbiAgICAgICAgZGF0YVNvdXJjZUtleSxcbiAgICAgICAgbGFtYmRhXG4gICAgICApO1xuICAgICAgcmVzb2x2ZXJQcm9wcyA9IHtcbiAgICAgICAgcmVxdWVzdE1hcHBpbmdUZW1wbGF0ZTogdGhpcy5idWlsZE1hcHBpbmdUZW1wbGF0ZShcbiAgICAgICAgICByZXNWYWx1ZS5yZXF1ZXN0TWFwcGluZ1xuICAgICAgICApLFxuICAgICAgICByZXNwb25zZU1hcHBpbmdUZW1wbGF0ZTogdGhpcy5idWlsZE1hcHBpbmdUZW1wbGF0ZShcbiAgICAgICAgICByZXNWYWx1ZS5yZXNwb25zZU1hcHBpbmdcbiAgICAgICAgKSxcbiAgICAgICAgLi4ucmVzVmFsdWUuY2RrPy5yZXNvbHZlcixcbiAgICAgIH07XG4gICAgfVxuICAgIC8vIERhdGFTb3VyY2UgcmVzb2x2ZXJcbiAgICBlbHNlIGlmIChcbiAgICAgIHRoaXMuaXNEYXRhU291cmNlUmVzb2x2ZXJQcm9wcyhyZXNWYWx1ZSBhcyBBcHBTeW5jQXBpUmVzb2x2ZXJQcm9wcylcbiAgICApIHtcbiAgICAgIHJlc1ZhbHVlID0gcmVzVmFsdWUgYXMgQXBwU3luY0FwaVJlc29sdmVyUHJvcHM7XG4gICAgICBkYXRhU291cmNlS2V5ID0gcmVzVmFsdWUuZGF0YVNvdXJjZSBhcyBzdHJpbmc7XG4gICAgICBkYXRhU291cmNlID0gdGhpcy5kYXRhU291cmNlc0J5RHNLZXlbZGF0YVNvdXJjZUtleV07XG4gICAgICByZXNvbHZlclByb3BzID0ge1xuICAgICAgICByZXF1ZXN0TWFwcGluZ1RlbXBsYXRlOiB0aGlzLmJ1aWxkTWFwcGluZ1RlbXBsYXRlKFxuICAgICAgICAgIHJlc1ZhbHVlLnJlcXVlc3RNYXBwaW5nXG4gICAgICAgICksXG4gICAgICAgIHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlOiB0aGlzLmJ1aWxkTWFwcGluZ1RlbXBsYXRlKFxuICAgICAgICAgIHJlc1ZhbHVlLnJlc3BvbnNlTWFwcGluZ1xuICAgICAgICApLFxuICAgICAgICAuLi5yZXNWYWx1ZS5jZGs/LnJlc29sdmVyLFxuICAgICAgfTtcbiAgICB9XG4gICAgLy8gTGFtYmRhIGZ1bmN0aW9uXG4gICAgZWxzZSB7XG4gICAgICByZXNWYWx1ZSA9IHJlc1ZhbHVlIGFzIEZ1bmN0aW9uSW5saW5lRGVmaW5pdGlvbjtcbiAgICAgIGxhbWJkYSA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgICBzY29wZSxcbiAgICAgICAgYExhbWJkYV8ke3R5cGVOYW1lfV8ke2ZpZWxkTmFtZX1gLFxuICAgICAgICByZXNWYWx1ZSxcbiAgICAgICAgdGhpcy5wcm9wcy5kZWZhdWx0cz8uZnVuY3Rpb24sXG4gICAgICAgIGBDYW5ub3QgZGVmaW5lIGRlZmF1bHRzLmZ1bmN0aW9uIHdoZW4gYSBGdW5jdGlvbiBpcyBwYXNzZWQgaW4gdG8gdGhlIFwiJHtyZXNLZXl9IHJlc29sdmVyYFxuICAgICAgKTtcbiAgICAgIGRhdGFTb3VyY2VLZXkgPSB0aGlzLmJ1aWxkRGF0YVNvdXJjZUtleSh0eXBlTmFtZSwgZmllbGROYW1lKTtcbiAgICAgIGRhdGFTb3VyY2UgPSB0aGlzLmNkay5ncmFwaHFsQXBpLmFkZExhbWJkYURhdGFTb3VyY2UoXG4gICAgICAgIGRhdGFTb3VyY2VLZXksXG4gICAgICAgIGxhbWJkYVxuICAgICAgKTtcbiAgICAgIHJlc29sdmVyUHJvcHMgPSB7fTtcbiAgICB9XG5cbiAgICAvLyBTdG9yZSBuZXcgZGF0YSBzb3VyY2UgY3JlYXRlZFxuICAgIGlmIChsYW1iZGEpIHtcbiAgICAgIHRoaXMuZGF0YVNvdXJjZXNCeURzS2V5W2RhdGFTb3VyY2VLZXldID0gZGF0YVNvdXJjZTtcbiAgICAgIHRoaXMuZnVuY3Rpb25zQnlEc0tleVtkYXRhU291cmNlS2V5XSA9IGxhbWJkYTtcbiAgICB9XG4gICAgdGhpcy5kc0tleXNCeVJlc0tleVtyZXNLZXldID0gZGF0YVNvdXJjZUtleTtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgcmVzb2x2ZXJcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgY29uc3QgcmVzb2x2ZXIgPSB0aGlzLmNkay5ncmFwaHFsQXBpLmNyZWF0ZVJlc29sdmVyKHtcbiAgICAgIGRhdGFTb3VyY2UsXG4gICAgICB0eXBlTmFtZSxcbiAgICAgIGZpZWxkTmFtZSxcbiAgICAgIC4uLnJlc29sdmVyUHJvcHMsXG4gICAgfSk7XG4gICAgdGhpcy5yZXNvbHZlcnNCeVJlc0tleVtyZXNLZXldID0gcmVzb2x2ZXI7XG5cbiAgICByZXR1cm4gbGFtYmRhO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0xhbWJkYVJlc29sdmVyUHJvcHMob2JqZWN0OiBBcHBTeW5jQXBpUmVzb2x2ZXJQcm9wcyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBvYmplY3QuZnVuY3Rpb24gIT09IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHByaXZhdGUgaXNEYXRhU291cmNlUmVzb2x2ZXJQcm9wcyhvYmplY3Q6IEFwcFN5bmNBcGlSZXNvbHZlclByb3BzKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIG9iamVjdC5kYXRhU291cmNlICE9PSB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIG5vcm1hbGl6ZVJlc29sdmVyS2V5KHJlc29sdmVyS2V5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIC8vIHJlbW92ZSBleHRyYSBzcGFjZXMgaW4gdGhlIGtleVxuICAgIHJldHVybiByZXNvbHZlcktleS5zcGxpdCgvXFxzKy8pLmpvaW4oXCIgXCIpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZE1hcHBpbmdUZW1wbGF0ZShtYXBwaW5nPzogTWFwcGluZ1RlbXBsYXRlKSB7XG4gICAgaWYgKCFtYXBwaW5nKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGlmICgobWFwcGluZyBhcyBNYXBwaW5nVGVtcGxhdGVGaWxlKS5maWxlKSB7XG4gICAgICByZXR1cm4gYXBwc3luYy5NYXBwaW5nVGVtcGxhdGUuZnJvbUZpbGUoXG4gICAgICAgIChtYXBwaW5nIGFzIE1hcHBpbmdUZW1wbGF0ZUZpbGUpLmZpbGVcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFwcHN5bmMuTWFwcGluZ1RlbXBsYXRlLmZyb21TdHJpbmcoXG4gICAgICAobWFwcGluZyBhcyBNYXBwaW5nVGVtcGxhdGVJbmxpbmUpLmlubGluZVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkRGF0YVNvdXJjZUtleSh0eXBlTmFtZTogc3RyaW5nLCBmaWVsZE5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBMYW1iZGFEU18ke3R5cGVOYW1lfV8ke2ZpZWxkTmFtZX1gO1xuICB9XG59XG4iXX0=