"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Table = void 0;
const constructs_1 = require("constructs");
const dynamodb = __importStar(require("aws-cdk-lib/aws-dynamodb"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const lambdaEventSources = __importStar(require("aws-cdk-lib/aws-lambda-event-sources"));
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
/**
 * The `Table` construct is a higher level CDK construct that makes it easy to create a [DynamoDB](https://aws.amazon.com/dynamodb/) table. It uses the following defaults:
 *
 * - Defaults to using the [On-Demand capacity](https://aws.amazon.com/dynamodb/pricing/on-demand/) to make it perfectly serverless.
 * - Enables [Point-in-Time Recovery](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/PointInTimeRecovery.html) to make sure that you don't lose your data.
 * - Provides a nicer interface for defining indexes.
 */
class Table extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.props = props;
        const { fields, globalIndexes, localIndexes, kinesisStream } = this.props;
        this.cdk = {};
        this.functions = {};
        this.fields = fields;
        this.permissionsAttachedForAllConsumers = [];
        // Input Validation
        this.validateFieldsAndIndexes(id, props);
        // Create Table
        this.createTable();
        // Create Secondary Indexes
        if (globalIndexes)
            this.addGlobalIndexes(globalIndexes);
        if (localIndexes)
            this.addLocalIndexes(localIndexes);
        // Create Consumers
        if (props.consumers) {
            for (const consumerName in props.consumers) {
                this.addConsumer(this, consumerName, props.consumers[consumerName]);
            }
        }
        // Create Kinesis Stream
        this.buildKinesisStreamSpec(kinesisStream);
    }
    /**
     * The ARN of the internally created DynamoDB Table.
     */
    get tableArn() {
        return this.cdk.table.tableArn;
    }
    /**
     * The name of the internally created DynamoDB Table.
     */
    get tableName() {
        return this.cdk.table.tableName;
    }
    /**
     * Add additional global secondary indexes where the `key` is the name of the global secondary index
     *
     * @example
     * ```js
     * table.addGlobalIndexes({
     *   gsi1: {
     *     partitionKey: "pk",
     *     sortKey: "sk",
     *   }
     * })
     * ```
     */
    addGlobalIndexes(secondaryIndexes) {
        var _a, _b, _c;
        if (!this.fields)
            throw new Error(`Cannot add secondary indexes to "${this.node.id}" Table without defining "fields"`);
        for (const [indexName, { partitionKey, sortKey, projection, cdk },] of Object.entries(secondaryIndexes)) {
            // Validate index does not contain "indexName", "partitionKey" and "sortKey"
            if ((_a = cdk === null || cdk === void 0 ? void 0 : cdk.index) === null || _a === void 0 ? void 0 : _a.indexName) {
                throw new Error(`Cannot configure the "cdk.index.indexName" in the "${indexName}" index of the "${this.node.id}" Table`);
            }
            if ((_b = cdk === null || cdk === void 0 ? void 0 : cdk.index) === null || _b === void 0 ? void 0 : _b.partitionKey) {
                throw new Error(`Cannot configure the "cdk.index.partitionKey" in the "${indexName}" index of the "${this.node.id}" Table`);
            }
            if ((_c = cdk === null || cdk === void 0 ? void 0 : cdk.index) === null || _c === void 0 ? void 0 : _c.sortKey) {
                throw new Error(`Cannot configure the "cdk.index.sortKey" in the "${indexName}" index of the "${this.node.id}" Table`);
            }
            this.cdk.table.addGlobalSecondaryIndex(Object.assign(Object.assign({ indexName, partitionKey: this.buildAttribute(this.fields, partitionKey), sortKey: sortKey
                    ? this.buildAttribute(this.fields, sortKey)
                    : undefined }, (() => {
                if (!projection) {
                    return undefined;
                }
                else if (Array.isArray(projection)) {
                    return {
                        projectionType: dynamodb.ProjectionType.INCLUDE,
                        nonKeyAttributes: projection,
                    };
                }
                return {
                    projectionType: dynamodb.ProjectionType[projection.toUpperCase()],
                };
            })()), cdk === null || cdk === void 0 ? void 0 : cdk.index));
        }
    }
    /**
     * Add additional local secondary indexes where the `key` is the name of the local secondary index
     *
     * @example
     * ```js
     * table.addLocalIndexes({
     *   lsi1: {
     *     sortKey: "sk",
     *   }
     * })
     * ```
     */
    addLocalIndexes(secondaryIndexes) {
        var _a, _b;
        if (!this.fields)
            throw new Error(`Cannot add local secondary indexes to "${this.node.id}" Table without defining "fields"`);
        for (const [indexName, { sortKey, projection, cdk }] of Object.entries(secondaryIndexes)) {
            // Validate index does not contain "indexName", "partitionKey" and "sortKey"
            if ((_a = cdk === null || cdk === void 0 ? void 0 : cdk.index) === null || _a === void 0 ? void 0 : _a.indexName) {
                throw new Error(`Cannot configure the "cdk.index.indexName" in the "${indexName}" index of the "${this.node.id}" Table`);
            }
            if ((_b = cdk === null || cdk === void 0 ? void 0 : cdk.index) === null || _b === void 0 ? void 0 : _b.sortKey) {
                throw new Error(`Cannot configure the "cdk.index.sortKey" in the "${indexName}" index of the "${this.node.id}" Table`);
            }
            this.cdk.table.addLocalSecondaryIndex(Object.assign(Object.assign({ indexName, sortKey: this.buildAttribute(this.fields, sortKey) }, (() => {
                if (!projection) {
                    return undefined;
                }
                else if (Array.isArray(projection)) {
                    return {
                        projectionType: dynamodb.ProjectionType.INCLUDE,
                        nonKeyAttributes: projection,
                    };
                }
                return {
                    projectionType: dynamodb.ProjectionType[projection.toUpperCase()],
                };
            })()), cdk === null || cdk === void 0 ? void 0 : cdk.index));
        }
    }
    /**
     * Define additional consumers for table events
     *
     * @example
     * ```js
     * table.addConsumers(stack, {
     *   consumer1: "src/consumer1.main",
     *   consumer2: "src/consumer2.main",
     * });
     * ```
     */
    addConsumers(scope, consumers) {
        Object.keys(consumers).forEach((consumerName) => {
            this.addConsumer(scope, consumerName, consumers[consumerName]);
        });
    }
    /**
     * Grant permissions to all consumers of this table.
     *
     * @example
     * ```js
     * table.attachPermissions(["s3"]);
     * ```
     */
    attachPermissions(permissions) {
        Object.values(this.functions).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllConsumers.push(permissions);
    }
    /**
     * Grant permissions to a specific consumer of this table.
     *
     * @example
     * ```js
     * table.attachPermissionsToConsumer("consumer1", ["s3"]);
     * ```
     */
    attachPermissionsToConsumer(consumerName, permissions) {
        if (!this.functions[consumerName]) {
            throw new Error(`The "${consumerName}" consumer was not found in the "${this.node.id}" Table.`);
        }
        this.functions[consumerName].attachPermissions(permissions);
    }
    /**
     * Get the instance of the internally created Function, for a given consumer.
     *
     * ```js
     *  const table = new Table(stack, "Table", {
     *    consumers: {
     *      consumer1: "./src/function.handler",
     *    }
     *  })
     * table.getFunction("consumer1");
     * ```
     */
    getFunction(consumerName) {
        return this.functions[consumerName];
    }
    getConstructMetadata() {
        return {
            type: "Table",
            data: {
                tableName: this.cdk.table.tableName,
                consumers: Object.entries(this.functions).map(([name, fun]) => ({
                    name,
                    fn: (0, Construct_1.getFunctionRef)(fun),
                })),
            },
        };
    }
    createTable() {
        const { fields, primaryIndex, stream, cdk } = this.props;
        const app = this.node.root;
        const id = this.node.id;
        if ((0, Construct_1.isCDKConstruct)(cdk === null || cdk === void 0 ? void 0 : cdk.table)) {
            // Validate "fields" is not configured
            if (fields !== undefined) {
                throw new Error(`Cannot configure the "fields" when "cdk.table" is a construct in the "${id}" Table`);
            }
            // Validate "stream" is not configured
            if (stream !== undefined) {
                throw new Error(`Cannot configure the "stream" when "cdk.table" is a construct in the "${id}" Table`);
            }
            this.dynamodbTableType = "IMPORTED";
            this.cdk.table = cdk === null || cdk === void 0 ? void 0 : cdk.table;
        }
        else {
            let dynamodbTableProps = ((cdk === null || cdk === void 0 ? void 0 : cdk.table) || {});
            // Validate "fields" is configured
            if (fields === undefined) {
                throw new Error(`Missing "fields" in the "${id}" Table`);
            }
            // Validate dynamodbTableProps does not contain "partitionKey", "sortKey" and "stream"
            if (dynamodbTableProps.partitionKey) {
                throw new Error(`Cannot configure the "cdk.table.partitionKey" in the "${id}" Table`);
            }
            if (dynamodbTableProps.sortKey) {
                throw new Error(`Cannot configure the "cdk.table.sortKey" in the "${id}" Table`);
            }
            if (dynamodbTableProps.stream) {
                throw new Error(`Cannot configure the "cdk.table.stream" in the "${id}" Table`);
            }
            if (fields && primaryIndex) {
                dynamodbTableProps = Object.assign(Object.assign({}, dynamodbTableProps), { partitionKey: this.buildAttribute(fields, primaryIndex.partitionKey), sortKey: primaryIndex.sortKey
                        ? this.buildAttribute(fields, primaryIndex.sortKey)
                        : undefined });
            }
            this.dynamodbTableType = "CREATED";
            this.cdk.table = new dynamodb.Table(this, "Table", Object.assign({ tableName: app.logicalPrefixedName(id), pointInTimeRecovery: true, billingMode: dynamodb.BillingMode.PAY_PER_REQUEST, stream: this.buildStreamConfig(stream) }, dynamodbTableProps));
        }
    }
    addConsumer(scope, consumerName, consumer) {
        var _a, _b;
        // validate stream enabled
        // note: if table is imported, do not check because we want to allow ppl to
        //       import without specifying the "tableStreamArn". And let them add
        //       consumers to it.
        if (!this.cdk.table.tableStreamArn) {
            const errorMsgs = [
                `Please enable the "stream" option to add consumers to the "${this.node.id}" Table.`,
            ];
            if (this.dynamodbTableType === "IMPORTED") {
                errorMsgs.push(`To import a table with stream enabled, use the "Table.fromTableAttributes()" method, and set the "tableStreamArn" in the attributes.`);
            }
            throw new Error(errorMsgs.join(" "));
        }
        // parse consumer
        let consumerFunction, eventSourceProps;
        if (consumer.function) {
            consumer = consumer;
            consumerFunction = consumer.function;
            eventSourceProps = (_a = consumer.cdk) === null || _a === void 0 ? void 0 : _a.eventSource;
        }
        else {
            consumerFunction = consumer;
        }
        eventSourceProps = Object.assign({ startingPosition: lambda.StartingPosition.LATEST }, (eventSourceProps || {}));
        // create function
        const fn = Function_1.Function.fromDefinition(scope, `Consumer_${this.node.id}_${consumerName}`, consumerFunction, (_b = this.props.defaults) === null || _b === void 0 ? void 0 : _b.function, `The "defaults.function" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the consumers using FunctionProps, so the Table construct can apply the "defaults.function" to them.`);
        this.functions[consumerName] = fn;
        // create event source
        const eventSource = new lambdaEventSources.DynamoEventSource(this.cdk.table, eventSourceProps);
        fn.addEventSource(eventSource);
        // attach permissions
        this.permissionsAttachedForAllConsumers.forEach((permissions) => {
            fn.attachPermissions(permissions);
        });
        return fn;
    }
    buildAttribute(fields, name) {
        // Ensure the key is specified in "fields"
        if (!fields[name]) {
            throw new Error(`Please define "${name}" in "fields" to create the index in the "${this.node.id}" Table.`);
        }
        return {
            name,
            type: dynamodb.AttributeType[fields[name].toUpperCase()],
        };
    }
    buildStreamConfig(stream) {
        if (stream === true) {
            return dynamodb.StreamViewType.NEW_AND_OLD_IMAGES;
        }
        else if (stream === false || stream === undefined) {
            return undefined;
        }
        return dynamodb.StreamViewType[stream.toUpperCase()];
    }
    buildKinesisStreamSpec(kinesisStream) {
        if (!kinesisStream) {
            return;
        }
        const cfTable = this.cdk.table.node.defaultChild;
        cfTable.addPropertyOverride("KinesisStreamSpecification.StreamArn", kinesisStream.streamArn);
    }
    validateFieldsAndIndexes(id, props) {
        const { fields, primaryIndex } = props;
        // Validate "fields"
        if (fields && Object.keys(fields).length === 0) {
            throw new Error(`No fields defined for the "${id}" Table`);
        }
        // Validate "primaryIndex"
        if (primaryIndex && !primaryIndex.partitionKey) {
            throw new Error(`Missing "partitionKey" in primary index for the "${id}" Table`);
        }
        // Validate "fields" and "primaryIndex" co-exists
        if (fields) {
            if (!primaryIndex) {
                throw new Error(`Missing "primaryIndex" in "${id}" Table`);
            }
        }
        else {
            if (primaryIndex) {
                throw new Error(`Cannot configure the "primaryIndex" without setting the "fields" in "${id}" Table`);
            }
        }
    }
}
exports.Table = Table;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvVGFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBdUM7QUFDdkMsbUVBQXFEO0FBQ3JELCtEQUFpRDtBQUNqRCx5RkFBMkU7QUFFM0UsMkNBQTJFO0FBQzNFLHlDQUtvQjtBQW1PcEIscUJBQXFCO0FBQ3JCLFlBQVk7QUFDWixxQkFBcUI7QUFFckI7Ozs7OztHQU1HO0FBQ0gsTUFBYSxLQUFNLFNBQVEsc0JBQVM7SUFjbEMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFpQjtRQUN6RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLE1BQU0sRUFBRSxNQUFNLEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQzFFLElBQUksQ0FBQyxHQUFHLEdBQUcsRUFBUyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxrQ0FBa0MsR0FBRyxFQUFFLENBQUM7UUFFN0MsbUJBQW1CO1FBQ25CLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFekMsZUFBZTtRQUNmLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUVuQiwyQkFBMkI7UUFDM0IsSUFBSSxhQUFhO1lBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3hELElBQUksWUFBWTtZQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFckQsbUJBQW1CO1FBQ25CLElBQUksS0FBSyxDQUFDLFNBQVMsRUFB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O1FBRUQsaURBQWlEO1FBQ2pELElBQUksTUFBTSxFQUFFO1lBQ1YsSUFBSSxDQUFDLFlBQVksRUFBRTtnQkFDakIsTUFBTSxJQUFJLEtBQUssQ0FBQyw4QkFBOEIsRUFBRSxTQUFTLENBQUMsQ0FBQzthQUM1RDtTQUNGO2FBQU07WUFDTCxJQUFJLFlBQVksRUFBRTtnQkFDaEIsTUFBTSxJQUFJLEtBQUssQ0FDYix3RUFBd0UsRUFBRSxTQUFTLENBQ3BGLENBQUM7YUFDSDtTQUNGO0lBQ0gsQ0FBQztDQUNGO0FBdmRELHNCQXVkQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBkeW5hbW9kYiBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWR5bmFtb2RiXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGFcIjtcbmltcG9ydCAqIGFzIGxhbWJkYUV2ZW50U291cmNlcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYS1ldmVudC1zb3VyY2VzXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9BcHBcIjtcbmltcG9ydCB7IGdldEZ1bmN0aW9uUmVmLCBTU1RDb25zdHJ1Y3QsIGlzQ0RLQ29uc3RydWN0IH0gZnJvbSBcIi4vQ29uc3RydWN0XCI7XG5pbXBvcnQge1xuICBGdW5jdGlvbiBhcyBGbixcbiAgRnVuY3Rpb25Qcm9wcyxcbiAgRnVuY3Rpb25JbmxpbmVEZWZpbml0aW9uLFxuICBGdW5jdGlvbkRlZmluaXRpb24sXG59IGZyb20gXCIuL0Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBLaW5lc2lzU3RyZWFtIH0gZnJvbSBcIi4vS2luZXNpc1N0cmVhbVwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBUYWJsZUNvbnN1bWVyUHJvcHMge1xuICAvKipcbiAgICogVXNlZCB0byBjcmVhdGUgdGhlIGNvbnN1bWVyIGZ1bmN0aW9uIGZvciB0aGUgdGFibGUuXG4gICAqL1xuICBmdW5jdGlvbjogRnVuY3Rpb25EZWZpbml0aW9uO1xuICBjZGs/OiB7XG4gICAgLyoqXG4gICAgICogT3ZlcnJpZGUgdGhlIHNldHRpbmdzIG9mIHRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgZXZlbnQgc291cmNlXG4gICAgICovXG4gICAgZXZlbnRTb3VyY2U/OiBsYW1iZGFFdmVudFNvdXJjZXMuRHluYW1vRXZlbnRTb3VyY2VQcm9wcztcbiAgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUYWJsZUxvY2FsSW5kZXhQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgZmllbGQgdGhhdCdzIHRvIGJlIHVzZWQgYXMgdGhlIHNvcnQga2V5IGZvciB0aGUgaW5kZXguXG4gICAqL1xuICBzb3J0S2V5OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgc2V0IG9mIGF0dHJpYnV0ZXMgdGhhdCBhcmUgcHJvamVjdGVkIGludG8gdGhlIHNlY29uZGFyeSBpbmRleC5cbiAgICogQGRlZmF1bHQgXCJhbGxcIlxuICAgKi9cbiAgcHJvamVjdGlvbj86XG4gICAgfCBMb3dlcmNhc2U8a2V5b2YgUGljazx0eXBlb2YgZHluYW1vZGIuUHJvamVjdGlvblR5cGUsIFwiQUxMXCIgfCBcIktFWVNfT05MWVwiPj5cbiAgICB8IHN0cmluZ1tdO1xuICBjZGs/OiB7XG4gICAgLyoqXG4gICAgICogT3ZlcnJpZGUgdGhlIHNldHRpbmdzIG9mIHRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgbG9jYWwgc2Vjb25kYXJ5IGluZGV4ZXNcbiAgICAgKi9cbiAgICBpbmRleD86IE9taXQ8ZHluYW1vZGIuTG9jYWxTZWNvbmRhcnlJbmRleFByb3BzLCBcImluZGV4TmFtZVwiIHwgXCJzb3J0S2V5XCI+O1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRhYmxlR2xvYmFsSW5kZXhQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgZmllbGQgdGhhdCdzIHRvIGJlIHVzZWQgYXMgYSBwYXJ0aXRpb24ga2V5IGZvciB0aGUgaW5kZXguXG4gICAqL1xuICBwYXJ0aXRpb25LZXk6IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBmaWVsZCB0aGF0J3MgdG8gYmUgdXNlZCBhcyB0aGUgc29ydCBrZXkgZm9yIHRoZSBpbmRleC5cbiAgICovXG4gIHNvcnRLZXk/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgc2V0IG9mIGF0dHJpYnV0ZXMgdGhhdCBhcmUgcHJvamVjdGVkIGludG8gdGhlIHNlY29uZGFyeSBpbmRleC5cbiAgICogQGRlZmF1bHQgXCJhbGxcIlxuICAgKi9cbiAgcHJvamVjdGlvbj86XG4gICAgfCBMb3dlcmNhc2U8a2V5b2YgUGljazx0eXBlb2YgZHluYW1vZGIuUHJvamVjdGlvblR5cGUsIFwiQUxMXCIgfCBcIktFWVNfT05MWVwiPj5cbiAgICB8IHN0cmluZ1tdO1xuICBjZGs/OiB7XG4gICAgLyoqXG4gICAgICogT3ZlcnJpZGUgdGhlIHNldHRpbmdzIG9mIHRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgZ2xvYmFsIHNlY29uZGFyeSBpbmRleFxuICAgICAqL1xuICAgIGluZGV4PzogT21pdDxcbiAgICAgIGR5bmFtb2RiLkdsb2JhbFNlY29uZGFyeUluZGV4UHJvcHMsXG4gICAgICBcImluZGV4TmFtZVwiIHwgXCJwYXJ0aXRpb25LZXlcIiB8IFwic29ydEtleVwiXG4gICAgPjtcbiAgfTtcbn1cblxudHlwZSBUYWJsZUZpZWxkVHlwZSA9IExvd2VyY2FzZTxrZXlvZiB0eXBlb2YgZHluYW1vZGIuQXR0cmlidXRlVHlwZT47XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGFibGVQcm9wcyB7XG4gIC8qKlxuICAgKiBBbiBvYmplY3QgZGVmaW5pbmcgdGhlIGZpZWxkcyBvZiB0aGUgdGFibGUuIEtleSBpcyB0aGUgbmFtZSBvZiB0aGUgZmllbGQgYW5kIHRoZSB2YWx1ZSBpcyB0aGUgdHlwZS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogbmV3IFRhYmxlKHN0YWNrLCBcIlRhYmxlXCIsIHtcbiAgICogICBmaWVsZHM6IHtcbiAgICogICAgIHBrOiBcInN0cmluZ1wiLFxuICAgKiAgICAgc2s6IFwic3RyaW5nXCIsXG4gICAqICAgfVxuICAgKiB9KVxuICAgKiBgYGBcbiAgICovXG4gIGZpZWxkcz86IFJlY29yZDxzdHJpbmcsIFRhYmxlRmllbGRUeXBlPjtcbiAgcHJpbWFyeUluZGV4Pzoge1xuICAgIC8qKlxuICAgICAqIERlZmluZSB0aGUgUGFydGl0aW9uIEtleSBmb3IgdGhlIHRhYmxlJ3MgcHJpbWFyeSBpbmRleFxuICAgICAqXG4gICAgICogQGV4YW1wbGVcbiAgICAgKlxuICAgICAqIGBgYGpzXG4gICAgICogbmV3IFRhYmxlKHN0YWNrLCBcIlRhYmxlXCIsIHtcbiAgICAgKiAgIGZpZWxkczoge1xuICAgICAqICAgICBwazogXCJzdHJpbmdcIixcbiAgICAgKiAgIH0sXG4gICAgICogICBwcmltYXJ5SW5kZXg6IHsgcGFydGl0aW9uS2V5OiBcInBrXCIgfSxcbiAgICAgKiB9KTtcbiAgICAgKiBgYGBcbiAgICAgKi9cbiAgICBwYXJ0aXRpb25LZXk6IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBEZWZpbmUgdGhlIFNvcnQgS2V5IGZvciB0aGUgdGFibGUncyBwcmltYXJ5IGluZGV4XG4gICAgICpcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqXG4gICAgICogYGBganNcbiAgICAgKiBuZXcgVGFibGUoc3RhY2ssIFwiVGFibGVcIiwge1xuICAgICAqICAgZmllbGRzOiB7XG4gICAgICogICAgIHBrOiBcInN0cmluZ1wiLFxuICAgICAqICAgICBzazogXCJzdHJpbmdcIixcbiAgICAgKiAgIH0sXG4gICAgICogICBwcmltYXJ5SW5kZXg6IHsgcGFydGl0aW9uS2V5OiBcInBrXCIsIHNvcnRLZXk6IFwic2tcIiB9LFxuICAgICAqIH0pO1xuICAgICAqIGBgYFxuICAgICAqL1xuICAgIHNvcnRLZXk/OiBzdHJpbmc7XG4gIH07XG4gIC8qKlxuICAgKiBDb25maWd1cmUgdGhlIHRhYmxlJ3MgZ2xvYmFsIHNlY29uZGFyeSBpbmRleGVzXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIGBgYGpzXG4gICAqIG5ldyBUYWJsZShzdGFjaywgXCJUYWJsZVwiLCB7XG4gICAqICAgZmllbGRzOiB7XG4gICAqICAgICBwazogXCJzdHJpbmdcIixcbiAgICogICAgIHNrOiBcInN0cmluZ1wiLFxuICAgKiAgICAgZ3NpMXBrOiBcInN0cmluZ1wiLFxuICAgKiAgICAgZ3NpMXNrOiBcInN0cmluZ1wiLFxuICAgKiAgIH0sXG4gICAqICAgZ2xvYmFsSW5kZXhlczoge1xuICAgKiAgICAgXCJHU0kxXCI6IHsgcGFydGl0aW9uS2V5OiBcImdzaTFwa1wiLCBzb3J0S2V5OiBcImdzaTFza1wiIH0sXG4gICAqICAgfSxcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgZ2xvYmFsSW5kZXhlcz86IFJlY29yZDxzdHJpbmcsIFRhYmxlR2xvYmFsSW5kZXhQcm9wcz47XG4gIC8qKlxuICAgKiBDb25maWd1cmUgdGhlIHRhYmxlJ3MgbG9jYWwgc2Vjb25kYXJ5IGluZGV4ZXNcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogYGBganNcbiAgICogbmV3IFRhYmxlKHN0YWNrLCBcIlRhYmxlXCIsIHtcbiAgICogICBmaWVsZHM6IHtcbiAgICogICAgIHBrOiBcInN0cmluZ1wiLFxuICAgKiAgICAgc2s6IFwic3RyaW5nXCIsXG4gICAqICAgICBsc2kxc2s6IFwic3RyaW5nXCIsXG4gICAqICAgfSxcbiAgICogICBnbG9iYWxJbmRleGVzOiB7XG4gICAqICAgICBcImxzaTFcIjogeyBzb3J0S2V5OiBcImxzaTFza1wiIH0sXG4gICAqICAgfSxcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgbG9jYWxJbmRleGVzPzogUmVjb3JkPHN0cmluZywgVGFibGVMb2NhbEluZGV4UHJvcHM+O1xuICAvKipcbiAgICogQ29uZmlndXJlIHRoZSBLaW5lc2lzU3RyZWFtIHRvIGNhcHR1cmUgaXRlbS1sZXZlbCBjaGFuZ2VzIGZvciB0aGUgdGFibGUuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIGBgYGpzXG4gICAqIGNvbnN0IHN0cmVhbSA9IG5ldyBLaW5lc2lzU3RyZWFtKHN0YWNrLCBcIlN0cmVhbVwiKTtcbiAgICpcbiAgICogbmV3IFRhYmxlKHN0YWNrLCBcIlRhYmxlXCIsIHtcbiAgICogICBraW5lc2lzU3RyZWFtOiBzdHJlYW0sXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIGtpbmVzaXNTdHJlYW0/OiBLaW5lc2lzU3RyZWFtO1xuICAvKipcbiAgICogQ29uZmlndXJlIHRoZSBpbmZvcm1hdGlvbiB0aGF0IHdpbGwgYmUgd3JpdHRlbiB0byB0aGUgU3RyZWFtLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqcyB7OH1cbiAgICogbmV3IFRhYmxlKHN0YWNrLCBcIlRhYmxlXCIsIHtcbiAgICogICBzdHJlYW06IFwibmV3X2ltYWdlXCIsXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIHN0cmVhbT86IGJvb2xlYW4gfCBMb3dlcmNhc2U8a2V5b2YgdHlwZW9mIGR5bmFtb2RiLlN0cmVhbVZpZXdUeXBlPjtcbiAgZGVmYXVsdHM/OiB7XG4gICAgLyoqXG4gICAgICogVGhlIGRlZmF1bHQgZnVuY3Rpb24gcHJvcHMgdG8gYmUgYXBwbGllZCB0byBhbGwgdGhlIGNvbnN1bWVycyBpbiB0aGUgVGFibGUuIFRoZSBgZW52aXJvbm1lbnRgLCBgcGVybWlzc2lvbnNgIGFuZCBgbGF5ZXJzYCBwcm9wZXJ0aWVzIHdpbGwgYmUgbWVyZ2VkIHdpdGggcGVyIHJvdXRlIGRlZmluaXRpb25zIGlmIHRoZXkgYXJlIGRlZmluZWQuXG4gICAgICpcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqXG4gICAgICogYGBganNcbiAgICAgKiBuZXcgVGFibGUoc3RhY2ssIFwiVGFibGVcIiwge1xuICAgICAqICAgZGVmYXVsdHM6IHtcbiAgICAgKiAgICAgZnVuY3Rpb246IHtcbiAgICAgKiAgICAgICB0aW1lb3V0OiAyMCxcbiAgICAgKiAgICAgICBlbnZpcm9ubWVudDogeyB0b3BpY05hbWU6IHRvcGljLnRvcGljTmFtZSB9LFxuICAgICAqICAgICAgIHBlcm1pc3Npb25zOiBbdG9waWNdLFxuICAgICAqICAgICB9XG4gICAgICogICB9LFxuICAgICAqIH0pO1xuICAgICAqIGBgYFxuICAgICAqL1xuICAgIGZ1bmN0aW9uPzogRnVuY3Rpb25Qcm9wcztcbiAgfTtcbiAgLyoqXG4gICAqIENvbmZpZ3VyZSBEeW5hbW9EQiBzdHJlYW1zIGFuZCBjb25zdW1lcnNcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogYGBganNcbiAgICogY29uc3QgdGFibGUgPSBuZXcgVGFibGUoc3RhY2ssIFwiVGFibGVcIiwge1xuICAgKiAgIGNvbnN1bWVyczoge1xuICAgKiAgICAgY29uc3VtZXIxOiBcInNyYy9jb25zdW1lcjEubWFpblwiLFxuICAgKiAgICAgY29uc3VtZXIyOiBcInNyYy9jb25zdW1lcjIubWFpblwiLFxuICAgKiAgIH0sXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIGNvbnN1bWVycz86IFJlY29yZDxzdHJpbmcsIEZ1bmN0aW9uSW5saW5lRGVmaW5pdGlvbiB8IFRhYmxlQ29uc3VtZXJQcm9wcz47XG4gIGNkaz86IHtcbiAgICAvKipcbiAgICAgKiBPdmVycmlkZSB0aGUgc2V0dGluZ3Mgb2YgdGhlIGludGVybmFsbHkgY3JlYXRlZCBjZGsgdGFibGVcbiAgICAgKi9cbiAgICB0YWJsZT86XG4gICAgICB8IGR5bmFtb2RiLklUYWJsZVxuICAgICAgfCBPbWl0PGR5bmFtb2RiLlRhYmxlUHJvcHMsIFwicGFydGl0aW9uS2V5XCIgfCBcInNvcnRLZXlcIj47XG4gIH07XG59XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gQ29uc3RydWN0XG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuLyoqXG4gKiBUaGUgYFRhYmxlYCBjb25zdHJ1Y3QgaXMgYSBoaWdoZXIgbGV2ZWwgQ0RLIGNvbnN0cnVjdCB0aGF0IG1ha2VzIGl0IGVhc3kgdG8gY3JlYXRlIGEgW0R5bmFtb0RCXShodHRwczovL2F3cy5hbWF6b24uY29tL2R5bmFtb2RiLykgdGFibGUuIEl0IHVzZXMgdGhlIGZvbGxvd2luZyBkZWZhdWx0czpcbiAqXG4gKiAtIERlZmF1bHRzIHRvIHVzaW5nIHRoZSBbT24tRGVtYW5kIGNhcGFjaXR5XShodHRwczovL2F3cy5hbWF6b24uY29tL2R5bmFtb2RiL3ByaWNpbmcvb24tZGVtYW5kLykgdG8gbWFrZSBpdCBwZXJmZWN0bHkgc2VydmVybGVzcy5cbiAqIC0gRW5hYmxlcyBbUG9pbnQtaW4tVGltZSBSZWNvdmVyeV0oaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2FtYXpvbmR5bmFtb2RiL2xhdGVzdC9kZXZlbG9wZXJndWlkZS9Qb2ludEluVGltZVJlY292ZXJ5Lmh0bWwpIHRvIG1ha2Ugc3VyZSB0aGF0IHlvdSBkb24ndCBsb3NlIHlvdXIgZGF0YS5cbiAqIC0gUHJvdmlkZXMgYSBuaWNlciBpbnRlcmZhY2UgZm9yIGRlZmluaW5nIGluZGV4ZXMuXG4gKi9cbmV4cG9ydCBjbGFzcyBUYWJsZSBleHRlbmRzIENvbnN0cnVjdCBpbXBsZW1lbnRzIFNTVENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBjZGs6IHtcbiAgICAvKipcbiAgICAgKiBUaGUgaW50ZXJuYWxseSBjcmVhdGVkIENESyBgVGFibGVgIGluc3RhbmNlLlxuICAgICAqL1xuICAgIHRhYmxlOiBkeW5hbW9kYi5JVGFibGU7XG4gIH07XG4gIHByaXZhdGUgZHluYW1vZGJUYWJsZVR5cGU/OiBcIkNSRUFURURcIiB8IFwiSU1QT1JURURcIjtcbiAgcHJpdmF0ZSBmdW5jdGlvbnM6IHsgW2NvbnN1bWVyTmFtZTogc3RyaW5nXTogRm4gfTtcbiAgcHJpdmF0ZSBwZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsQ29uc3VtZXJzOiBQZXJtaXNzaW9uc1tdO1xuICBwcml2YXRlIHByb3BzOiBUYWJsZVByb3BzO1xuICBwcml2YXRlIHN0cmVhbT86IGR5bmFtb2RiLlN0cmVhbVZpZXdUeXBlO1xuICBwcml2YXRlIGZpZWxkcz86IFJlY29yZDxzdHJpbmcsIFRhYmxlRmllbGRUeXBlPjtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogVGFibGVQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICB0aGlzLnByb3BzID0gcHJvcHM7XG4gICAgY29uc3QgeyBmaWVsZHMsIGdsb2JhbEluZGV4ZXMsIGxvY2FsSW5kZXhlcywga2luZXNpc1N0cmVhbSB9ID0gdGhpcy5wcm9wcztcbiAgICB0aGlzLmNkayA9IHt9IGFzIGFueTtcbiAgICB0aGlzLmZ1bmN0aW9ucyA9IHt9O1xuICAgIHRoaXMuZmllbGRzID0gZmllbGRzO1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbENvbnN1bWVycyA9IFtdO1xuXG4gICAgLy8gSW5wdXQgVmFsaWRhdGlvblxuICAgIHRoaXMudmFsaWRhdGVGaWVsZHNBbmRJbmRleGVzKGlkLCBwcm9wcyk7XG5cbiAgICAvLyBDcmVhdGUgVGFibGVcbiAgICB0aGlzLmNyZWF0ZVRhYmxlKCk7XG5cbiAgICAvLyBDcmVhdGUgU2Vjb25kYXJ5IEluZGV4ZXNcbiAgICBpZiAoZ2xvYmFsSW5kZXhlcykgdGhpcy5hZGRHbG9iYWxJbmRleGVzKGdsb2JhbEluZGV4ZXMpO1xuICAgIGlmIChsb2NhbEluZGV4ZXMpIHRoaXMuYWRkTG9jYWxJbmRleGVzKGxvY2FsSW5kZXhlcyk7XG5cbiAgICAvLyBDcmVhdGUgQ29uc3VtZXJzXG4gICAgaWYgKHByb3BzLmNvbnN1bWVycykge1xuICAgICAgZm9yIChjb25zdCBjb25zdW1lck5hbWUgaW4gcHJvcHMuY29uc3VtZXJzKSB7XG4gICAgICAgIHRoaXMuYWRkQ29uc3VtZXIodGhpcywgY29uc3VtZXJOYW1lLCBwcm9wcy5jb25zdW1lcnNbY29uc3VtZXJOYW1lXSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIEtpbmVzaXMgU3RyZWFtXG4gICAgdGhpcy5idWlsZEtpbmVzaXNTdHJlYW1TcGVjKGtpbmVzaXNTdHJlYW0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBBUk4gb2YgdGhlIGludGVybmFsbHkgY3JlYXRlZCBEeW5hbW9EQiBUYWJsZS5cbiAgICovXG4gIHB1YmxpYyBnZXQgdGFibGVBcm4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jZGsudGFibGUudGFibGVBcm47XG4gIH1cblxuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIGludGVybmFsbHkgY3JlYXRlZCBEeW5hbW9EQiBUYWJsZS5cbiAgICovXG4gIHB1YmxpYyBnZXQgdGFibGVOYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuY2RrLnRhYmxlLnRhYmxlTmFtZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYWRkaXRpb25hbCBnbG9iYWwgc2Vjb25kYXJ5IGluZGV4ZXMgd2hlcmUgdGhlIGBrZXlgIGlzIHRoZSBuYW1lIG9mIHRoZSBnbG9iYWwgc2Vjb25kYXJ5IGluZGV4XG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIHRhYmxlLmFkZEdsb2JhbEluZGV4ZXMoe1xuICAgKiAgIGdzaTE6IHtcbiAgICogICAgIHBhcnRpdGlvbktleTogXCJwa1wiLFxuICAgKiAgICAgc29ydEtleTogXCJza1wiLFxuICAgKiAgIH1cbiAgICogfSlcbiAgICogYGBgXG4gICAqL1xuICBwdWJsaWMgYWRkR2xvYmFsSW5kZXhlcyhcbiAgICBzZWNvbmRhcnlJbmRleGVzOiBOb25OdWxsYWJsZTxUYWJsZVByb3BzW1wiZ2xvYmFsSW5kZXhlc1wiXT5cbiAgKSB7XG4gICAgaWYgKCF0aGlzLmZpZWxkcylcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYENhbm5vdCBhZGQgc2Vjb25kYXJ5IGluZGV4ZXMgdG8gXCIke3RoaXMubm9kZS5pZH1cIiBUYWJsZSB3aXRob3V0IGRlZmluaW5nIFwiZmllbGRzXCJgXG4gICAgICApO1xuICAgIGZvciAoY29uc3QgW1xuICAgICAgaW5kZXhOYW1lLFxuICAgICAgeyBwYXJ0aXRpb25LZXksIHNvcnRLZXksIHByb2plY3Rpb24sIGNkayB9LFxuICAgIF0gb2YgT2JqZWN0LmVudHJpZXMoc2Vjb25kYXJ5SW5kZXhlcykpIHtcbiAgICAgIC8vIFZhbGlkYXRlIGluZGV4IGRvZXMgbm90IGNvbnRhaW4gXCJpbmRleE5hbWVcIiwgXCJwYXJ0aXRpb25LZXlcIiBhbmQgXCJzb3J0S2V5XCJcbiAgICAgIGlmICgoY2RrPy5pbmRleCBhcyBkeW5hbW9kYi5HbG9iYWxTZWNvbmRhcnlJbmRleFByb3BzKT8uaW5kZXhOYW1lKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJjZGsuaW5kZXguaW5kZXhOYW1lXCIgaW4gdGhlIFwiJHtpbmRleE5hbWV9XCIgaW5kZXggb2YgdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgVGFibGVgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoKGNkaz8uaW5kZXggYXMgZHluYW1vZGIuR2xvYmFsU2Vjb25kYXJ5SW5kZXhQcm9wcyk/LnBhcnRpdGlvbktleSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiY2RrLmluZGV4LnBhcnRpdGlvbktleVwiIGluIHRoZSBcIiR7aW5kZXhOYW1lfVwiIGluZGV4IG9mIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIFRhYmxlYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKChjZGs/LmluZGV4IGFzIGR5bmFtb2RiLkdsb2JhbFNlY29uZGFyeUluZGV4UHJvcHMpPy5zb3J0S2V5KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJjZGsuaW5kZXguc29ydEtleVwiIGluIHRoZSBcIiR7aW5kZXhOYW1lfVwiIGluZGV4IG9mIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIFRhYmxlYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAodGhpcy5jZGsudGFibGUgYXMgZHluYW1vZGIuVGFibGUpLmFkZEdsb2JhbFNlY29uZGFyeUluZGV4KHtcbiAgICAgICAgaW5kZXhOYW1lLFxuICAgICAgICBwYXJ0aXRpb25LZXk6IHRoaXMuYnVpbGRBdHRyaWJ1dGUodGhpcy5maWVsZHMsIHBhcnRpdGlvbktleSksXG4gICAgICAgIHNvcnRLZXk6IHNvcnRLZXlcbiAgICAgICAgICA/IHRoaXMuYnVpbGRBdHRyaWJ1dGUodGhpcy5maWVsZHMsIHNvcnRLZXkpXG4gICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIC4uLigoKSA9PiB7XG4gICAgICAgICAgaWYgKCFwcm9qZWN0aW9uKSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShwcm9qZWN0aW9uKSkge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgcHJvamVjdGlvblR5cGU6IGR5bmFtb2RiLlByb2plY3Rpb25UeXBlLklOQ0xVREUsXG4gICAgICAgICAgICAgIG5vbktleUF0dHJpYnV0ZXM6IHByb2plY3Rpb24sXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgcHJvamVjdGlvblR5cGU6XG4gICAgICAgICAgICAgIGR5bmFtb2RiLlByb2plY3Rpb25UeXBlW1xuICAgICAgICAgICAgICAgIHByb2plY3Rpb24udG9VcHBlckNhc2UoKSBhcyBrZXlvZiB0eXBlb2YgZHluYW1vZGIuUHJvamVjdGlvblR5cGVcbiAgICAgICAgICAgICAgXSxcbiAgICAgICAgICB9O1xuICAgICAgICB9KSgpLFxuICAgICAgICAuLi5jZGs/LmluZGV4LFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhZGRpdGlvbmFsIGxvY2FsIHNlY29uZGFyeSBpbmRleGVzIHdoZXJlIHRoZSBga2V5YCBpcyB0aGUgbmFtZSBvZiB0aGUgbG9jYWwgc2Vjb25kYXJ5IGluZGV4XG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIHRhYmxlLmFkZExvY2FsSW5kZXhlcyh7XG4gICAqICAgbHNpMToge1xuICAgKiAgICAgc29ydEtleTogXCJza1wiLFxuICAgKiAgIH1cbiAgICogfSlcbiAgICogYGBgXG4gICAqL1xuICBwdWJsaWMgYWRkTG9jYWxJbmRleGVzKFxuICAgIHNlY29uZGFyeUluZGV4ZXM6IE5vbk51bGxhYmxlPFRhYmxlUHJvcHNbXCJsb2NhbEluZGV4ZXNcIl0+XG4gICkge1xuICAgIGlmICghdGhpcy5maWVsZHMpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDYW5ub3QgYWRkIGxvY2FsIHNlY29uZGFyeSBpbmRleGVzIHRvIFwiJHt0aGlzLm5vZGUuaWR9XCIgVGFibGUgd2l0aG91dCBkZWZpbmluZyBcImZpZWxkc1wiYFxuICAgICAgKTtcbiAgICBmb3IgKGNvbnN0IFtpbmRleE5hbWUsIHsgc29ydEtleSwgcHJvamVjdGlvbiwgY2RrIH1dIG9mIE9iamVjdC5lbnRyaWVzKFxuICAgICAgc2Vjb25kYXJ5SW5kZXhlcyFcbiAgICApKSB7XG4gICAgICAvLyBWYWxpZGF0ZSBpbmRleCBkb2VzIG5vdCBjb250YWluIFwiaW5kZXhOYW1lXCIsIFwicGFydGl0aW9uS2V5XCIgYW5kIFwic29ydEtleVwiXG4gICAgICBpZiAoKGNkaz8uaW5kZXggYXMgZHluYW1vZGIuTG9jYWxTZWNvbmRhcnlJbmRleFByb3BzKT8uaW5kZXhOYW1lKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJjZGsuaW5kZXguaW5kZXhOYW1lXCIgaW4gdGhlIFwiJHtpbmRleE5hbWV9XCIgaW5kZXggb2YgdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgVGFibGVgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoKGNkaz8uaW5kZXggYXMgZHluYW1vZGIuTG9jYWxTZWNvbmRhcnlJbmRleFByb3BzKT8uc29ydEtleSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiY2RrLmluZGV4LnNvcnRLZXlcIiBpbiB0aGUgXCIke2luZGV4TmFtZX1cIiBpbmRleCBvZiB0aGUgXCIke3RoaXMubm9kZS5pZH1cIiBUYWJsZWBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgKHRoaXMuY2RrLnRhYmxlIGFzIGR5bmFtb2RiLlRhYmxlKS5hZGRMb2NhbFNlY29uZGFyeUluZGV4KHtcbiAgICAgICAgaW5kZXhOYW1lLFxuICAgICAgICBzb3J0S2V5OiB0aGlzLmJ1aWxkQXR0cmlidXRlKHRoaXMuZmllbGRzLCBzb3J0S2V5KSxcbiAgICAgICAgLi4uKCgpID0+IHtcbiAgICAgICAgICBpZiAoIXByb2plY3Rpb24pIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHByb2plY3Rpb24pKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBwcm9qZWN0aW9uVHlwZTogZHluYW1vZGIuUHJvamVjdGlvblR5cGUuSU5DTFVERSxcbiAgICAgICAgICAgICAgbm9uS2V5QXR0cmlidXRlczogcHJvamVjdGlvbixcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBwcm9qZWN0aW9uVHlwZTpcbiAgICAgICAgICAgICAgZHluYW1vZGIuUHJvamVjdGlvblR5cGVbXG4gICAgICAgICAgICAgICAgcHJvamVjdGlvbi50b1VwcGVyQ2FzZSgpIGFzIGtleW9mIHR5cGVvZiBkeW5hbW9kYi5Qcm9qZWN0aW9uVHlwZVxuICAgICAgICAgICAgICBdLFxuICAgICAgICAgIH07XG4gICAgICAgIH0pKCksXG4gICAgICAgIC4uLmNkaz8uaW5kZXgsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRGVmaW5lIGFkZGl0aW9uYWwgY29uc3VtZXJzIGZvciB0YWJsZSBldmVudHNcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogdGFibGUuYWRkQ29uc3VtZXJzKHN0YWNrLCB7XG4gICAqICAgY29uc3VtZXIxOiBcInNyYy9jb25zdW1lcjEubWFpblwiLFxuICAgKiAgIGNvbnN1bWVyMjogXCJzcmMvY29uc3VtZXIyLm1haW5cIixcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgcHVibGljIGFkZENvbnN1bWVycyhcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGNvbnN1bWVyczoge1xuICAgICAgW2NvbnN1bWVyTmFtZTogc3RyaW5nXTogRnVuY3Rpb25JbmxpbmVEZWZpbml0aW9uIHwgVGFibGVDb25zdW1lclByb3BzO1xuICAgIH1cbiAgKTogdm9pZCB7XG4gICAgT2JqZWN0LmtleXMoY29uc3VtZXJzKS5mb3JFYWNoKChjb25zdW1lck5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgdGhpcy5hZGRDb25zdW1lcihzY29wZSwgY29uc3VtZXJOYW1lLCBjb25zdW1lcnNbY29uc3VtZXJOYW1lXSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogR3JhbnQgcGVybWlzc2lvbnMgdG8gYWxsIGNvbnN1bWVycyBvZiB0aGlzIHRhYmxlLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqc1xuICAgKiB0YWJsZS5hdHRhY2hQZXJtaXNzaW9ucyhbXCJzM1wiXSk7XG4gICAqIGBgYFxuICAgKi9cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIE9iamVjdC52YWx1ZXModGhpcy5mdW5jdGlvbnMpLmZvckVhY2goKGZuKSA9PlxuICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpXG4gICAgKTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxDb25zdW1lcnMucHVzaChwZXJtaXNzaW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogR3JhbnQgcGVybWlzc2lvbnMgdG8gYSBzcGVjaWZpYyBjb25zdW1lciBvZiB0aGlzIHRhYmxlLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqc1xuICAgKiB0YWJsZS5hdHRhY2hQZXJtaXNzaW9uc1RvQ29uc3VtZXIoXCJjb25zdW1lcjFcIiwgW1wiczNcIl0pO1xuICAgKiBgYGBcbiAgICovXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9uc1RvQ29uc3VtZXIoXG4gICAgY29uc3VtZXJOYW1lOiBzdHJpbmcsXG4gICAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25zXG4gICk6IHZvaWQge1xuICAgIGlmICghdGhpcy5mdW5jdGlvbnNbY29uc3VtZXJOYW1lXSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgVGhlIFwiJHtjb25zdW1lck5hbWV9XCIgY29uc3VtZXIgd2FzIG5vdCBmb3VuZCBpbiB0aGUgXCIke3RoaXMubm9kZS5pZH1cIiBUYWJsZS5gXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuZnVuY3Rpb25zW2NvbnN1bWVyTmFtZV0uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgaW5zdGFuY2Ugb2YgdGhlIGludGVybmFsbHkgY3JlYXRlZCBGdW5jdGlvbiwgZm9yIGEgZ2l2ZW4gY29uc3VtZXIuXG4gICAqXG4gICAqIGBgYGpzXG4gICAqICBjb25zdCB0YWJsZSA9IG5ldyBUYWJsZShzdGFjaywgXCJUYWJsZVwiLCB7XG4gICAqICAgIGNvbnN1bWVyczoge1xuICAgKiAgICAgIGNvbnN1bWVyMTogXCIuL3NyYy9mdW5jdGlvbi5oYW5kbGVyXCIsXG4gICAqICAgIH1cbiAgICogIH0pXG4gICAqIHRhYmxlLmdldEZ1bmN0aW9uKFwiY29uc3VtZXIxXCIpO1xuICAgKiBgYGBcbiAgICovXG4gIHB1YmxpYyBnZXRGdW5jdGlvbihjb25zdW1lck5hbWU6IHN0cmluZyk6IEZuIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5mdW5jdGlvbnNbY29uc3VtZXJOYW1lXTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25zdHJ1Y3RNZXRhZGF0YSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogXCJUYWJsZVwiIGFzIGNvbnN0LFxuICAgICAgZGF0YToge1xuICAgICAgICB0YWJsZU5hbWU6IHRoaXMuY2RrLnRhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgY29uc3VtZXJzOiBPYmplY3QuZW50cmllcyh0aGlzLmZ1bmN0aW9ucykubWFwKChbbmFtZSwgZnVuXSkgPT4gKHtcbiAgICAgICAgICBuYW1lLFxuICAgICAgICAgIGZuOiBnZXRGdW5jdGlvblJlZihmdW4pLFxuICAgICAgICB9KSksXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVRhYmxlKCkge1xuICAgIGNvbnN0IHsgZmllbGRzLCBwcmltYXJ5SW5kZXgsIHN0cmVhbSwgY2RrIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IGFwcCA9IHRoaXMubm9kZS5yb290IGFzIEFwcDtcbiAgICBjb25zdCBpZCA9IHRoaXMubm9kZS5pZDtcblxuICAgIGlmIChpc0NES0NvbnN0cnVjdChjZGs/LnRhYmxlKSkge1xuICAgICAgLy8gVmFsaWRhdGUgXCJmaWVsZHNcIiBpcyBub3QgY29uZmlndXJlZFxuICAgICAgaWYgKGZpZWxkcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJmaWVsZHNcIiB3aGVuIFwiY2RrLnRhYmxlXCIgaXMgYSBjb25zdHJ1Y3QgaW4gdGhlIFwiJHtpZH1cIiBUYWJsZWBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGUgXCJzdHJlYW1cIiBpcyBub3QgY29uZmlndXJlZFxuICAgICAgaWYgKHN0cmVhbSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJzdHJlYW1cIiB3aGVuIFwiY2RrLnRhYmxlXCIgaXMgYSBjb25zdHJ1Y3QgaW4gdGhlIFwiJHtpZH1cIiBUYWJsZWBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5keW5hbW9kYlRhYmxlVHlwZSA9IFwiSU1QT1JURURcIjtcbiAgICAgIHRoaXMuY2RrLnRhYmxlID0gY2RrPy50YWJsZSBhcyBkeW5hbW9kYi5UYWJsZTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IGR5bmFtb2RiVGFibGVQcm9wcyA9IChjZGs/LnRhYmxlIHx8IHt9KSBhcyBkeW5hbW9kYi5UYWJsZVByb3BzO1xuXG4gICAgICAvLyBWYWxpZGF0ZSBcImZpZWxkc1wiIGlzIGNvbmZpZ3VyZWRcbiAgICAgIGlmIChmaWVsZHMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgXCJmaWVsZHNcIiBpbiB0aGUgXCIke2lkfVwiIFRhYmxlYCk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZhbGlkYXRlIGR5bmFtb2RiVGFibGVQcm9wcyBkb2VzIG5vdCBjb250YWluIFwicGFydGl0aW9uS2V5XCIsIFwic29ydEtleVwiIGFuZCBcInN0cmVhbVwiXG4gICAgICBpZiAoZHluYW1vZGJUYWJsZVByb3BzLnBhcnRpdGlvbktleSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiY2RrLnRhYmxlLnBhcnRpdGlvbktleVwiIGluIHRoZSBcIiR7aWR9XCIgVGFibGVgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoZHluYW1vZGJUYWJsZVByb3BzLnNvcnRLZXkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImNkay50YWJsZS5zb3J0S2V5XCIgaW4gdGhlIFwiJHtpZH1cIiBUYWJsZWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChkeW5hbW9kYlRhYmxlUHJvcHMuc3RyZWFtKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJjZGsudGFibGUuc3RyZWFtXCIgaW4gdGhlIFwiJHtpZH1cIiBUYWJsZWBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGZpZWxkcyAmJiBwcmltYXJ5SW5kZXgpIHtcbiAgICAgICAgZHluYW1vZGJUYWJsZVByb3BzID0ge1xuICAgICAgICAgIC4uLmR5bmFtb2RiVGFibGVQcm9wcyxcbiAgICAgICAgICBwYXJ0aXRpb25LZXk6IHRoaXMuYnVpbGRBdHRyaWJ1dGUoZmllbGRzLCBwcmltYXJ5SW5kZXgucGFydGl0aW9uS2V5KSxcbiAgICAgICAgICBzb3J0S2V5OiBwcmltYXJ5SW5kZXguc29ydEtleVxuICAgICAgICAgICAgPyB0aGlzLmJ1aWxkQXR0cmlidXRlKGZpZWxkcywgcHJpbWFyeUluZGV4LnNvcnRLZXkpXG4gICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5keW5hbW9kYlRhYmxlVHlwZSA9IFwiQ1JFQVRFRFwiO1xuICAgICAgdGhpcy5jZGsudGFibGUgPSBuZXcgZHluYW1vZGIuVGFibGUodGhpcywgXCJUYWJsZVwiLCB7XG4gICAgICAgIHRhYmxlTmFtZTogYXBwLmxvZ2ljYWxQcmVmaXhlZE5hbWUoaWQpLFxuICAgICAgICBwb2ludEluVGltZVJlY292ZXJ5OiB0cnVlLFxuICAgICAgICBiaWxsaW5nTW9kZTogZHluYW1vZGIuQmlsbGluZ01vZGUuUEFZX1BFUl9SRVFVRVNULFxuICAgICAgICBzdHJlYW06IHRoaXMuYnVpbGRTdHJlYW1Db25maWcoc3RyZWFtKSxcbiAgICAgICAgLi4uKGR5bmFtb2RiVGFibGVQcm9wcyBhcyBkeW5hbW9kYi5UYWJsZVByb3BzKSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkQ29uc3VtZXIoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBjb25zdW1lck5hbWU6IHN0cmluZyxcbiAgICBjb25zdW1lcjogRnVuY3Rpb25JbmxpbmVEZWZpbml0aW9uIHwgVGFibGVDb25zdW1lclByb3BzXG4gICk6IEZuIHtcbiAgICAvLyB2YWxpZGF0ZSBzdHJlYW0gZW5hYmxlZFxuICAgIC8vIG5vdGU6IGlmIHRhYmxlIGlzIGltcG9ydGVkLCBkbyBub3QgY2hlY2sgYmVjYXVzZSB3ZSB3YW50IHRvIGFsbG93IHBwbCB0b1xuICAgIC8vICAgICAgIGltcG9ydCB3aXRob3V0IHNwZWNpZnlpbmcgdGhlIFwidGFibGVTdHJlYW1Bcm5cIi4gQW5kIGxldCB0aGVtIGFkZFxuICAgIC8vICAgICAgIGNvbnN1bWVycyB0byBpdC5cbiAgICBpZiAoIXRoaXMuY2RrLnRhYmxlLnRhYmxlU3RyZWFtQXJuKSB7XG4gICAgICBjb25zdCBlcnJvck1zZ3MgPSBbXG4gICAgICAgIGBQbGVhc2UgZW5hYmxlIHRoZSBcInN0cmVhbVwiIG9wdGlvbiB0byBhZGQgY29uc3VtZXJzIHRvIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIFRhYmxlLmAsXG4gICAgICBdO1xuICAgICAgaWYgKHRoaXMuZHluYW1vZGJUYWJsZVR5cGUgPT09IFwiSU1QT1JURURcIikge1xuICAgICAgICBlcnJvck1zZ3MucHVzaChcbiAgICAgICAgICBgVG8gaW1wb3J0IGEgdGFibGUgd2l0aCBzdHJlYW0gZW5hYmxlZCwgdXNlIHRoZSBcIlRhYmxlLmZyb21UYWJsZUF0dHJpYnV0ZXMoKVwiIG1ldGhvZCwgYW5kIHNldCB0aGUgXCJ0YWJsZVN0cmVhbUFyblwiIGluIHRoZSBhdHRyaWJ1dGVzLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1zZ3Muam9pbihcIiBcIikpO1xuICAgIH1cblxuICAgIC8vIHBhcnNlIGNvbnN1bWVyXG4gICAgbGV0IGNvbnN1bWVyRnVuY3Rpb24sIGV2ZW50U291cmNlUHJvcHM7XG4gICAgaWYgKChjb25zdW1lciBhcyBUYWJsZUNvbnN1bWVyUHJvcHMpLmZ1bmN0aW9uKSB7XG4gICAgICBjb25zdW1lciA9IGNvbnN1bWVyIGFzIFRhYmxlQ29uc3VtZXJQcm9wcztcbiAgICAgIGNvbnN1bWVyRnVuY3Rpb24gPSBjb25zdW1lci5mdW5jdGlvbjtcbiAgICAgIGV2ZW50U291cmNlUHJvcHMgPSBjb25zdW1lci5jZGs/LmV2ZW50U291cmNlO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdW1lckZ1bmN0aW9uID0gY29uc3VtZXIgYXMgRnVuY3Rpb25JbmxpbmVEZWZpbml0aW9uO1xuICAgIH1cbiAgICBldmVudFNvdXJjZVByb3BzID0ge1xuICAgICAgc3RhcnRpbmdQb3NpdGlvbjogbGFtYmRhLlN0YXJ0aW5nUG9zaXRpb24uTEFURVNULFxuICAgICAgLi4uKGV2ZW50U291cmNlUHJvcHMgfHwge30pLFxuICAgIH07XG5cbiAgICAvLyBjcmVhdGUgZnVuY3Rpb25cbiAgICBjb25zdCBmbiA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICBgQ29uc3VtZXJfJHt0aGlzLm5vZGUuaWR9XyR7Y29uc3VtZXJOYW1lfWAsXG4gICAgICBjb25zdW1lckZ1bmN0aW9uLFxuICAgICAgdGhpcy5wcm9wcy5kZWZhdWx0cz8uZnVuY3Rpb24sXG4gICAgICBgVGhlIFwiZGVmYXVsdHMuZnVuY3Rpb25cIiBjYW5ub3QgYmUgYXBwbGllZCBpZiBhbiBpbnN0YW5jZSBvZiBhIEZ1bmN0aW9uIGNvbnN0cnVjdCBpcyBwYXNzZWQgaW4uIE1ha2Ugc3VyZSB0byBkZWZpbmUgYWxsIHRoZSBjb25zdW1lcnMgdXNpbmcgRnVuY3Rpb25Qcm9wcywgc28gdGhlIFRhYmxlIGNvbnN0cnVjdCBjYW4gYXBwbHkgdGhlIFwiZGVmYXVsdHMuZnVuY3Rpb25cIiB0byB0aGVtLmBcbiAgICApO1xuICAgIHRoaXMuZnVuY3Rpb25zW2NvbnN1bWVyTmFtZV0gPSBmbjtcblxuICAgIC8vIGNyZWF0ZSBldmVudCBzb3VyY2VcbiAgICBjb25zdCBldmVudFNvdXJjZSA9IG5ldyBsYW1iZGFFdmVudFNvdXJjZXMuRHluYW1vRXZlbnRTb3VyY2UoXG4gICAgICB0aGlzLmNkay50YWJsZSxcbiAgICAgIGV2ZW50U291cmNlUHJvcHNcbiAgICApO1xuICAgIGZuLmFkZEV2ZW50U291cmNlKGV2ZW50U291cmNlKTtcblxuICAgIC8vIGF0dGFjaCBwZXJtaXNzaW9uc1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbENvbnN1bWVycy5mb3JFYWNoKChwZXJtaXNzaW9ucykgPT4ge1xuICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGZuO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZEF0dHJpYnV0ZShcbiAgICBmaWVsZHM6IHsgW2tleTogc3RyaW5nXTogVGFibGVGaWVsZFR5cGUgfSxcbiAgICBuYW1lOiBzdHJpbmdcbiAgKTogZHluYW1vZGIuQXR0cmlidXRlIHtcbiAgICAvLyBFbnN1cmUgdGhlIGtleSBpcyBzcGVjaWZpZWQgaW4gXCJmaWVsZHNcIlxuICAgIGlmICghZmllbGRzW25hbWVdKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFBsZWFzZSBkZWZpbmUgXCIke25hbWV9XCIgaW4gXCJmaWVsZHNcIiB0byBjcmVhdGUgdGhlIGluZGV4IGluIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIFRhYmxlLmApO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZVtcbiAgICAgICAgZmllbGRzW25hbWVdLnRvVXBwZXJDYXNlKCkgYXMga2V5b2YgdHlwZW9mIGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGVcbiAgICAgIF0sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRTdHJlYW1Db25maWcoXG4gICAgc3RyZWFtPzogYm9vbGVhbiB8IExvd2VyY2FzZTxrZXlvZiB0eXBlb2YgZHluYW1vZGIuU3RyZWFtVmlld1R5cGU+XG4gICk6IGR5bmFtb2RiLlN0cmVhbVZpZXdUeXBlIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoc3RyZWFtID09PSB0cnVlKSB7XG4gICAgICByZXR1cm4gZHluYW1vZGIuU3RyZWFtVmlld1R5cGUuTkVXX0FORF9PTERfSU1BR0VTO1xuICAgIH0gZWxzZSBpZiAoc3RyZWFtID09PSBmYWxzZSB8fCBzdHJlYW0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICByZXR1cm4gZHluYW1vZGIuU3RyZWFtVmlld1R5cGVbXG4gICAgICBzdHJlYW0hLnRvVXBwZXJDYXNlKCkgYXMga2V5b2YgdHlwZW9mIGR5bmFtb2RiLlN0cmVhbVZpZXdUeXBlXG4gICAgXTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRLaW5lc2lzU3RyZWFtU3BlYyhraW5lc2lzU3RyZWFtPzogS2luZXNpc1N0cmVhbSk6IHZvaWQge1xuICAgIGlmICgha2luZXNpc1N0cmVhbSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGNmVGFibGUgPSB0aGlzLmNkay50YWJsZS5ub2RlLmRlZmF1bHRDaGlsZCBhcyBkeW5hbW9kYi5DZm5UYWJsZTtcbiAgICBjZlRhYmxlLmFkZFByb3BlcnR5T3ZlcnJpZGUoXG4gICAgICBcIktpbmVzaXNTdHJlYW1TcGVjaWZpY2F0aW9uLlN0cmVhbUFyblwiLFxuICAgICAga2luZXNpc1N0cmVhbS5zdHJlYW1Bcm5cbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZUZpZWxkc0FuZEluZGV4ZXMoaWQ6IHN0cmluZywgcHJvcHM6IFRhYmxlUHJvcHMpOiB2b2lkIHtcbiAgICBjb25zdCB7IGZpZWxkcywgcHJpbWFyeUluZGV4IH0gPSBwcm9wcztcblxuICAgIC8vIFZhbGlkYXRlIFwiZmllbGRzXCJcbiAgICBpZiAoZmllbGRzICYmIE9iamVjdC5rZXlzKGZpZWxkcykubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIGZpZWxkcyBkZWZpbmVkIGZvciB0aGUgXCIke2lkfVwiIFRhYmxlYCk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgXCJwcmltYXJ5SW5kZXhcIlxuICAgIGlmIChwcmltYXJ5SW5kZXggJiYgIXByaW1hcnlJbmRleC5wYXJ0aXRpb25LZXkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYE1pc3NpbmcgXCJwYXJ0aXRpb25LZXlcIiBpbiBwcmltYXJ5IGluZGV4IGZvciB0aGUgXCIke2lkfVwiIFRhYmxlYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBcImZpZWxkc1wiIGFuZCBcInByaW1hcnlJbmRleFwiIGNvLWV4aXN0c1xuICAgIGlmIChmaWVsZHMpIHtcbiAgICAgIGlmICghcHJpbWFyeUluZGV4KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBcInByaW1hcnlJbmRleFwiIGluIFwiJHtpZH1cIiBUYWJsZWApO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAocHJpbWFyeUluZGV4KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJwcmltYXJ5SW5kZXhcIiB3aXRob3V0IHNldHRpbmcgdGhlIFwiZmllbGRzXCIgaW4gXCIke2lkfVwiIFRhYmxlYFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19