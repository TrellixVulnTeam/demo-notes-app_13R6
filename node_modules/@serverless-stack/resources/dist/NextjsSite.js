"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.NextjsSite = void 0;
const chalk_1 = __importDefault(require("chalk"));
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const cross_spawn_1 = __importDefault(require("cross-spawn"));
const constructs_1 = require("constructs");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const s3 = __importStar(require("aws-cdk-lib/aws-s3"));
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const sqs = __importStar(require("aws-cdk-lib/aws-sqs"));
const logs = __importStar(require("aws-cdk-lib/aws-logs"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const route53 = __importStar(require("aws-cdk-lib/aws-route53"));
const s3Assets = __importStar(require("aws-cdk-lib/aws-s3-assets"));
const cloudfront = __importStar(require("aws-cdk-lib/aws-cloudfront"));
const acm = __importStar(require("aws-cdk-lib/aws-certificatemanager"));
const lambda_layer_awscli_1 = require("aws-cdk-lib/lambda-layer-awscli");
const origins = __importStar(require("aws-cdk-lib/aws-cloudfront-origins"));
const route53Targets = __importStar(require("aws-cdk-lib/aws-route53-targets"));
const route53Patterns = __importStar(require("aws-cdk-lib/aws-route53-patterns"));
const lambdaEventSources = __importStar(require("aws-cdk-lib/aws-lambda-event-sources"));
const Stack_1 = require("./Stack");
const BaseSite_1 = require("./BaseSite");
const permission_1 = require("./util/permission");
const builder_1 = require("./util/builder");
const crossRegionHelper = __importStar(require("./nextjs-site/cross-region-helper"));
/////////////////////
// Construct
/////////////////////
/**
 * The `NextjsSite` construct is a higher level CDK construct that makes it easy to create a Next.js app. It provides a simple way to build and deploy the site to an S3 bucket; setup a CloudFront CDN for fast content delivery; and configure a custom domain for the website URL.
 *
 * It also allows you to [automatically set the environment variables](#configuring-environment-variables) in your Next.js app directly from the outputs in your SST app.
 *
 * ## Next.js Features
 * The `NextjsSite` construct uses the [`@sls-next/lambda-at-edge`](https://github.com/serverless-nextjs/serverless-next.js/tree/master/packages/libs/lambda-at-edge) package from the [`serverless-next.js`](https://github.com/serverless-nextjs/serverless-next.js) project to build and package your Next.js app so that it can be deployed to Lambda@Edge and CloudFront.
 *
 * :::note
 * To use the `NextjsSite` construct, you have to install `@sls-next/lambda-at-edge` as a dependency in your `package.json`.
 *
 * ```bash
 * npm install --save @sls-next/lambda-at-edge
 * ```
 * :::
 *
 * Most of the Next.js 11 features are supported, including:
 *
 * - [Static Site Generation (SSG)](https://nextjs.org/docs/basic-features/data-fetching#getstaticprops-static-generation): Static pages are served out through the CloudFront CDN.
 * - [Server Side Rendering (SSR)](https://nextjs.org/docs/basic-features/data-fetching#getserversideprops-server-side-rendering): Server side rendering is performed at CloudFront edge locations using Lambda@Edge.
 * - [API Routes](https://nextjs.org/docs/api-routes/introduction): API requests are served from CloudFront edge locations using Lambda@Edge.
 * - [Incremental Static Regeneration (ISR)](https://nextjs.org/docs/basic-features/data-fetching#incremental-static-regeneration): Regeneration is performed using Lambda functions, and the generated pages will be served out through the CloudFront CDN.
 * - [Image Optimization](https://nextjs.org/docs/basic-features/image-optimization): Images are resized and optimized at CloudFront edge locations using Lambda@Edge.
 *
 * Next.js 12 features like middleware and AVIF image are not yet supported. You can [read more about the features supported by `serverless-next.js`](https://github.com/serverless-nextjs/serverless-next.js#features). And you can [follow the progress on Next.js 12 support here](https://github.com/serverless-nextjs/serverless-next.js/issues/2016).
 *
 * @example
 * ### Creating a Next.js app
 *
 * Deploys a Next.js app in the `path/to/site` directory.
 *
 * ```js
 * new NextjsSite(stack, "NextSite", {
 *   path: "path/to/site",
 * });
 * ```
 */
class NextjsSite extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        // Local development or skip build => stub asset
        this.isPlaceholder =
            (root.local || root.skipBuild) && !props.disablePlaceholder;
        const buildDir = root.buildDir;
        const fileSizeLimit = root.isJestTest()
            ? // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                // @ts-ignore: "jestFileSizeLimitOverride" not exposed in props
                props.jestFileSizeLimitOverride || 200
            : 200;
        this.props = props;
        this.cdk = {};
        this.awsCliLayer = new lambda_layer_awscli_1.AwsCliLayer(this, "AwsCliLayer");
        this.registerSiteEnvironment();
        // Build app
        if (this.isPlaceholder) {
            this.buildOutDir = null;
            this.assets = this.zipAppStubAssets();
            this.routesManifest = null;
        }
        else {
            this.buildOutDir = root.isJestTest()
                ? // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                    // @ts-ignore: "jestBuildOutputPath" not exposed in props
                    props.jestBuildOutputPath || this.buildApp()
                : this.buildApp();
            this.assets = this.zipAppAssets(fileSizeLimit, buildDir);
            this.routesManifest = this.readRoutesManifest();
        }
        // Create Bucket
        this.cdk.bucket = this.createS3Bucket();
        // Handle Incremental Static Regeneration
        this.cdk.regenerationQueue = this.createRegenerationQueue();
        this.regenerationFunction = this.createRegenerationFunction();
        // Create Lambda@Edge functions (always created in us-east-1)
        this.edgeLambdaRole = this.createEdgeFunctionRole();
        this.mainFunctionVersion = this.createEdgeFunction("Main", "default-lambda");
        this.apiFunctionVersion = this.createEdgeFunction("Api", "api-lambda");
        this.imageFunctionVersion = this.createEdgeFunction("Image", "image-lambda");
        // Create Custom Domain
        this.validateCustomDomainSettings();
        this.cdk.hostedZone = this.lookupHostedZone();
        this.cdk.certificate = this.createCertificate();
        // Create S3 Deployment
        const s3deployCR = this.createS3Deployment();
        // Create CloudFront
        this.cdk.distribution = this.createCloudFrontDistribution();
        this.cdk.distribution.node.addDependency(s3deployCR);
        // Invalidate CloudFront
        const invalidationCR = this.createCloudFrontInvalidation();
        invalidationCR.node.addDependency(this.cdk.distribution);
        // Connect Custom Domain to CloudFront Distribution
        this.createRoute53Records();
    }
    /**
     * The CloudFront URL of the website.
     */
    get url() {
        return `https://${this.cdk.distribution.distributionDomainName}`;
    }
    /**
     * If the custom domain is enabled, this is the URL of the website with the custom domain.
     */
    get customDomainUrl() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        if (typeof customDomain === "string") {
            return `https://${customDomain}`;
        }
        else {
            return `https://${customDomain.domainName}`;
        }
    }
    /**
     * The ARN of the internally created S3 Bucket.
     */
    get bucketArn() {
        return this.cdk.bucket.bucketArn;
    }
    /**
     * The name of the internally created S3 Bucket.
     */
    get bucketName() {
        return this.cdk.bucket.bucketName;
    }
    /**
     * The ID of the internally created CloudFront Distribution.
     */
    get distributionId() {
        return this.cdk.distribution.distributionId;
    }
    /**
     * The domain name of the internally created CloudFront Distribution.
     */
    get distributionDomain() {
        return this.cdk.distribution.distributionDomainName;
    }
    /**
     * Attaches the given list of permissions to allow the Next.js API routes and Server Side rendering `getServerSideProps` to access other AWS resources.
     * @example
     * ### Attaching permissions
     *
     * ```js {5}
     * const site = new NextjsSite(stack, "Site", {
     *   path: "path/to/site",
     * });
     *
     * site.attachPermissions(["sns"]);
     * ```
     */
    attachPermissions(permissions) {
        (0, permission_1.attachPermissionsToRole)(this.edgeLambdaRole, permissions);
    }
    getConstructMetadata() {
        return {
            type: "NextSite",
            data: {
                distributionId: this.cdk.distribution.distributionId,
                customDomainUrl: this.customDomainUrl,
            },
        };
    }
    zipAppAssets(fileSizeLimit, buildDir) {
        // validate buildOutput exists
        const siteOutputPath = path.resolve(path.join(this.buildOutDir, "assets"));
        if (!fs.existsSync(siteOutputPath)) {
            throw new Error(`No build output found at "${siteOutputPath}" for the "${this.node.id}" NextjsSite.`);
        }
        // create zip files
        const script = path.join(__dirname, "../assets/BaseSite/archiver.js");
        const zipPath = path.resolve(path.join(buildDir, `NextjsSite-${this.node.id}-${this.node.addr}`));
        // clear zip path to ensure no partX.zip remain from previous build
        fs.removeSync(zipPath);
        const result = cross_spawn_1.default.sync("node", [script, siteOutputPath, zipPath, `${fileSizeLimit}`], {
            stdio: "inherit",
        });
        if (result.status !== 0) {
            console.error(`There was a problem generating the "${this.node.id}" NextjsSite package.`);
            process.exit(1);
        }
        // create assets
        const assets = [];
        for (let partId = 0;; partId++) {
            const zipFilePath = path.join(zipPath, `part${partId}.zip`);
            if (!fs.existsSync(zipFilePath)) {
                break;
            }
            assets.push(new s3Assets.Asset(this, `Asset${partId}`, {
                path: zipFilePath,
            }));
        }
        return assets;
    }
    zipAppStubAssets() {
        return [
            new s3Assets.Asset(this, "Asset", {
                path: path.resolve(__dirname, "../assets/NextjsSite/site-stub"),
            }),
        ];
    }
    createEdgeFunction(name, handlerPath) {
        // Use real code if:
        // - Next.js app was build; AND
        // - the Lambda code directory is not empty
        const hasRealCode = typeof this.buildOutDir === "string" &&
            fs.pathExistsSync(path.join(this.buildOutDir, handlerPath, "index.js"));
        // Create function asset
        const assetPath = hasRealCode && this.buildOutDir
            ? path.join(this.buildOutDir, handlerPath)
            : path.join(__dirname, "../assets/NextjsSite/edge-lambda-stub");
        const asset = new s3Assets.Asset(this, `${name}FunctionAsset`, {
            path: assetPath,
        });
        // Create function based on region
        const root = this.node.root;
        return root.region === "us-east-1"
            ? this.createEdgeFunctionInUE1(name, assetPath, asset, hasRealCode)
            : this.createEdgeFunctionInNonUE1(name, assetPath, asset, hasRealCode);
    }
    createEdgeFunctionInUE1(name, assetPath, asset, hasRealCode) {
        var _a, _b;
        const { defaults } = this.props;
        // Create function
        const fn = new lambda.Function(this, `${name}Function`, {
            description: `${name} handler for Next.js`,
            handler: "index-wrapper.handler",
            currentVersionOptions: {
                removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
            },
            logRetention: logs.RetentionDays.THREE_DAYS,
            code: lambda.Code.fromAsset(assetPath),
            runtime: lambda.Runtime.NODEJS_12_X,
            memorySize: ((_a = defaults === null || defaults === void 0 ? void 0 : defaults.function) === null || _a === void 0 ? void 0 : _a.memorySize) || 512,
            timeout: aws_cdk_lib_1.Duration.seconds(((_b = defaults === null || defaults === void 0 ? void 0 : defaults.function) === null || _b === void 0 ? void 0 : _b.timeout) || 10),
            role: this.edgeLambdaRole,
        });
        // Create alias
        fn.currentVersion.addAlias("live");
        // Deploy after the code is updated
        if (hasRealCode) {
            const updaterCR = this.createLambdaCodeReplacer(name, asset);
            fn.node.addDependency(updaterCR);
        }
        return fn.currentVersion;
    }
    createEdgeFunctionInNonUE1(name, assetPath, asset, hasRealCode) {
        var _a, _b;
        const { defaults } = this.props;
        // If app region is NOT us-east-1, create a Function in us-east-1
        // using a Custom Resource
        // Create a S3 bucket in us-east-1 to store Lambda code. Create
        // 1 bucket for all Edge functions.
        const bucketCR = crossRegionHelper.getOrCreateBucket(this);
        const bucketName = bucketCR.getAttString("BucketName");
        // Create a Lambda function in us-east-1
        const functionCR = crossRegionHelper.createFunction(this, name, this.edgeLambdaRole, bucketName, {
            Description: `handler for Next.js`,
            Handler: "index-wrapper.handler",
            Code: {
                S3Bucket: asset.s3BucketName,
                S3Key: asset.s3ObjectKey,
            },
            Runtime: lambda.Runtime.NODEJS_12_X.name,
            MemorySize: ((_a = defaults === null || defaults === void 0 ? void 0 : defaults.function) === null || _a === void 0 ? void 0 : _a.memorySize) || 512,
            Timeout: aws_cdk_lib_1.Duration.seconds(((_b = defaults === null || defaults === void 0 ? void 0 : defaults.function) === null || _b === void 0 ? void 0 : _b.timeout) || 10).toSeconds(),
            Role: this.edgeLambdaRole.roleArn,
        });
        const functionArn = functionCR.getAttString("FunctionArn");
        // Create a Lambda function version in us-east-1
        const versionCR = crossRegionHelper.createVersion(this, name, functionArn);
        const versionId = versionCR.getAttString("Version");
        crossRegionHelper.updateVersionLogicalId(functionCR, versionCR);
        // Deploy after the code is updated
        if (hasRealCode) {
            const updaterCR = this.createLambdaCodeReplacer(name, asset);
            functionCR.node.addDependency(updaterCR);
        }
        return lambda.Version.fromVersionArn(this, `${name}FunctionVersion`, `${functionArn}:${versionId}`);
    }
    createEdgeFunctionRole() {
        var _a;
        const { defaults } = this.props;
        // Create function role
        const role = new iam.Role(this, `EdgeLambdaRole`, {
            assumedBy: new iam.CompositePrincipal(new iam.ServicePrincipal("lambda.amazonaws.com"), new iam.ServicePrincipal("edgelambda.amazonaws.com")),
            managedPolicies: [
                iam.ManagedPolicy.fromManagedPolicyArn(this, "EdgeLambdaPolicy", "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"),
            ],
        });
        // Attach permission
        this.cdk.bucket.grantReadWrite(role);
        this.cdk.regenerationQueue.grantSendMessages(role);
        this.regenerationFunction.grantInvoke(role);
        if ((_a = defaults === null || defaults === void 0 ? void 0 : defaults.function) === null || _a === void 0 ? void 0 : _a.permissions) {
            (0, permission_1.attachPermissionsToRole)(role, defaults.function.permissions);
        }
        return role;
    }
    createRegenerationQueue() {
        const { cdk } = this.props;
        return new sqs.Queue(this, "RegenerationQueue", Object.assign(Object.assign({}, cdk === null || cdk === void 0 ? void 0 : cdk.regenerationQueue), { 
            // We call the queue the same name as the bucket so that we can easily
            // reference it from within the lambda@edge, given we can't use env vars
            // in a lambda@edge
            queueName: `${this.cdk.bucket.bucketName}.fifo`, fifo: true, removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY }));
    }
    createRegenerationFunction() {
        var _a, _b;
        // Use real code if:
        // - Next.js app was build; AND
        // - the Lambda code directory is not empty
        let code;
        let updaterCR;
        if (this.buildOutDir &&
            fs.pathExistsSync(path.join(this.buildOutDir, "regeneration-lambda", "index.js"))) {
            const asset = new s3Assets.Asset(this, `RegenerationFunctionAsset`, {
                path: path.join(this.buildOutDir, "regeneration-lambda"),
            });
            code = lambda.Code.fromAsset(path.join(this.buildOutDir, "regeneration-lambda"));
            updaterCR = this.createLambdaCodeReplacer("Regeneration", asset);
        }
        else {
            code = lambda.Code.fromInline("  ");
        }
        // Create function
        const { defaults } = this.props;
        const fn = new lambda.Function(this, "RegenerationFunction", {
            handler: "index-wrapper.handler",
            runtime: lambda.Runtime.NODEJS_12_X,
            memorySize: ((_a = defaults === null || defaults === void 0 ? void 0 : defaults.function) === null || _a === void 0 ? void 0 : _a.memorySize) || 1024,
            timeout: aws_cdk_lib_1.Duration.seconds(((_b = defaults === null || defaults === void 0 ? void 0 : defaults.function) === null || _b === void 0 ? void 0 : _b.timeout) || 30),
            code,
        });
        fn.addEventSource(new lambdaEventSources.SqsEventSource(this.cdk.regenerationQueue));
        // Grant permissions
        this.cdk.bucket.grantReadWrite(fn);
        // Deploy after the code is updated
        if (updaterCR) {
            fn.node.addDependency(updaterCR);
        }
        return fn;
    }
    createLambdaCodeReplacer(name, asset) {
        // Note: Source code for the Lambda functions have "{{ ENV_KEY }}" in them.
        //       They need to be replaced with real values before the Lambda
        //       functions get deployed.
        var _a;
        const providerId = "LambdaCodeReplacerProvider";
        const resId = `${name}LambdaCodeReplacer`;
        const stack = Stack_1.Stack.of(this);
        let provider = stack.node.tryFindChild(providerId);
        // Create provider if not already created
        if (!provider) {
            provider = new lambda.Function(stack, providerId, {
                code: lambda.Code.fromAsset(path.join(__dirname, "../assets/NextjsSite/custom-resource")),
                layers: [this.awsCliLayer],
                runtime: lambda.Runtime.PYTHON_3_7,
                handler: "lambda-code-updater.handler",
                timeout: aws_cdk_lib_1.Duration.minutes(15),
                memorySize: 1024,
            });
        }
        // Allow provider to perform search/replace on the asset
        (_a = provider.role) === null || _a === void 0 ? void 0 : _a.addToPrincipalPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ["s3:*"],
            resources: [`arn:aws:s3:::${asset.s3BucketName}/${asset.s3ObjectKey}`],
        }));
        // Create custom resource
        const resource = new aws_cdk_lib_1.CustomResource(this, resId, {
            serviceToken: provider.functionArn,
            resourceType: "Custom::SSTLambdaCodeUpdater",
            properties: {
                Source: {
                    BucketName: asset.s3BucketName,
                    ObjectKey: asset.s3ObjectKey,
                },
                ReplaceValues: this.getLambdaContentReplaceValues(),
            },
        });
        return resource;
    }
    buildApp() {
        const { path: sitePath } = this.props;
        // validate site path exists
        if (!fs.existsSync(sitePath)) {
            throw new Error(`No path found at "${path.resolve(sitePath)}" for the "${this.node.id}" NextjsSite.`);
        }
        // Build command
        // Note: probably could pass JSON string also, but this felt safer.
        const root = this.node.root;
        const pathHash = (0, builder_1.getHandlerHash)(sitePath);
        const buildOutput = path.join(root.buildDir, pathHash);
        const configBuffer = Buffer.from(JSON.stringify({
            cwd: path.resolve(sitePath),
            args: ["build"],
        }));
        // Run build
        console.log(chalk_1.default.grey(`Building Next.js site ${sitePath}`));
        const result = cross_spawn_1.default.sync("node", [
            path.join(__dirname, "../assets/NextjsSite/build/build.js"),
            "--path",
            path.resolve(sitePath),
            "--output",
            path.resolve(buildOutput),
            "--config",
            configBuffer.toString("base64"),
        ], {
            cwd: sitePath,
            stdio: "inherit",
            env: Object.assign(Object.assign({}, process.env), (0, BaseSite_1.getBuildCmdEnvironment)(this.props.environment)),
        });
        if (result.status !== 0) {
            console.error(`There was a problem building the "${this.node.id}" NextjsSite.`);
            process.exit(1);
        }
        return buildOutput;
    }
    createS3Bucket() {
        const { cdk } = this.props;
        return new s3.Bucket(this, "S3Bucket", Object.assign({ publicReadAccess: true, autoDeleteObjects: true, removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY }, cdk === null || cdk === void 0 ? void 0 : cdk.bucket));
    }
    createS3Deployment() {
        // Create a Lambda function that will be doing the uploading
        const uploader = new lambda.Function(this, "S3Uploader", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "s3-upload.handler",
            timeout: aws_cdk_lib_1.Duration.minutes(15),
            memorySize: 1024,
        });
        this.cdk.bucket.grantReadWrite(uploader);
        this.assets.forEach((asset) => asset.grantRead(uploader));
        // Create the custom resource function
        const handler = new lambda.Function(this, "S3Handler", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "s3-handler.handler",
            timeout: aws_cdk_lib_1.Duration.minutes(15),
            memorySize: 1024,
            environment: {
                UPLOADER_FUNCTION_NAME: uploader.functionName,
            },
        });
        this.cdk.bucket.grantReadWrite(handler);
        uploader.grantInvoke(handler);
        // Create custom resource
        const fileOptions = [
            {
                exclude: "*",
                include: "public/*",
                cacheControl: "public,max-age=31536000,must-revalidate",
            },
            {
                exclude: "*",
                include: "static/*",
                cacheControl: "public,max-age=31536000,must-revalidate",
            },
            {
                exclude: "*",
                include: "static-pages/*",
                cacheControl: "public,max-age=0,s-maxage=2678400,must-revalidate",
            },
            {
                exclude: "*",
                include: "_next/data/*",
                cacheControl: "public,max-age=0,s-maxage=2678400,must-revalidate",
            },
            {
                exclude: "*",
                include: "_next/static/*",
                cacheControl: "public,max-age=31536000,immutable",
            },
        ];
        return new aws_cdk_lib_1.CustomResource(this, "S3Deployment", {
            serviceToken: handler.functionArn,
            resourceType: "Custom::SSTBucketDeployment",
            properties: {
                Sources: this.assets.map((asset) => ({
                    BucketName: asset.s3BucketName,
                    ObjectKey: asset.s3ObjectKey,
                })),
                DestinationBucketName: this.cdk.bucket.bucketName,
                FileOptions: (fileOptions || []).map(({ exclude, include, cacheControl }) => {
                    return [
                        "--exclude",
                        exclude,
                        "--include",
                        include,
                        "--cache-control",
                        cacheControl,
                    ];
                }),
                ReplaceValues: this.getS3ContentReplaceValues(),
            },
        });
    }
    /////////////////////
    // CloudFront Distribution
    /////////////////////
    createCloudFrontDistribution() {
        var _a, _b, _c, _d, _e, _f, _g;
        const { cdk, customDomain } = this.props;
        const cfDistributionProps = (cdk === null || cdk === void 0 ? void 0 : cdk.distribution) || {};
        // Validate input
        if (cfDistributionProps.certificate) {
            throw new Error(`Do not configure the "cfDistribution.certificate". Use the "customDomain" to configure the NextjsSite domain certificate.`);
        }
        if (cfDistributionProps.domainNames) {
            throw new Error(`Do not configure the "cfDistribution.domainNames". Use the "customDomain" to configure the NextjsSite domain.`);
        }
        // Build domainNames
        const domainNames = [];
        if (!customDomain) {
            // no domain
        }
        else if (typeof customDomain === "string") {
            domainNames.push(customDomain);
        }
        else {
            domainNames.push(customDomain.domainName);
        }
        // Build behavior
        const origin = new origins.S3Origin(this.cdk.bucket);
        const viewerProtocolPolicy = cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS;
        if (this.isPlaceholder) {
            return new cloudfront.Distribution(this, "Distribution", {
                defaultRootObject: "index.html",
                errorResponses: (0, BaseSite_1.buildErrorResponsesForRedirectToIndex)("index.html"),
                domainNames,
                certificate: this.cdk.certificate,
                defaultBehavior: {
                    origin,
                    viewerProtocolPolicy,
                },
            });
        }
        // Build Edge functions
        const edgeLambdas = [
            {
                includeBody: true,
                eventType: cloudfront.LambdaEdgeEventType.ORIGIN_REQUEST,
                functionVersion: this.mainFunctionVersion,
            },
            {
                eventType: cloudfront.LambdaEdgeEventType.ORIGIN_RESPONSE,
                functionVersion: this.mainFunctionVersion,
            },
        ];
        // Build cache policy
        const staticCachePolicy = (_b = (_a = cdk === null || cdk === void 0 ? void 0 : cdk.cachePolicies) === null || _a === void 0 ? void 0 : _a.staticCachePolicy) !== null && _b !== void 0 ? _b : this.createCloudFrontStaticCachePolicy();
        const imageCachePolicy = (_d = (_c = cdk === null || cdk === void 0 ? void 0 : cdk.cachePolicies) === null || _c === void 0 ? void 0 : _c.imageCachePolicy) !== null && _d !== void 0 ? _d : this.createCloudFrontImageCachePolicy();
        const lambdaCachePolicy = (_f = (_e = cdk === null || cdk === void 0 ? void 0 : cdk.cachePolicies) === null || _e === void 0 ? void 0 : _e.lambdaCachePolicy) !== null && _f !== void 0 ? _f : this.createCloudFrontLambdaCachePolicy();
        // Create Distribution
        return new cloudfront.Distribution(this, "Distribution", Object.assign(Object.assign({ 
            // these values can be overwritten by cfDistributionProps
            defaultRootObject: "" }, cfDistributionProps), { 
            // these values can NOT be overwritten by cfDistributionProps
            domainNames, certificate: this.cdk.certificate, defaultBehavior: Object.assign(Object.assign({ viewerProtocolPolicy,
                origin, allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS, cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS, compress: true, cachePolicy: lambdaCachePolicy }, (cfDistributionProps.defaultBehavior || {})), { 
                // concatenate edgeLambdas
                edgeLambdas: [
                    ...edgeLambdas,
                    ...(((_g = cfDistributionProps.defaultBehavior) === null || _g === void 0 ? void 0 : _g.edgeLambdas) || []),
                ] }), additionalBehaviors: Object.assign({ [this.pathPattern("_next/image*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_ALL,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: imageCachePolicy,
                    originRequestPolicy: new cloudfront.OriginRequestPolicy(this, "ImageOriginRequest", {
                        queryStringBehavior: cloudfront.OriginRequestQueryStringBehavior.all(),
                    }),
                    edgeLambdas: [
                        {
                            eventType: cloudfront.LambdaEdgeEventType.ORIGIN_REQUEST,
                            functionVersion: this.imageFunctionVersion,
                        },
                    ],
                }, [this.pathPattern("_next/data/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: lambdaCachePolicy,
                    edgeLambdas,
                }, [this.pathPattern("_next/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: staticCachePolicy,
                }, [this.pathPattern("static/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: staticCachePolicy,
                }, [this.pathPattern("api/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_ALL,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: lambdaCachePolicy,
                    edgeLambdas: [
                        {
                            includeBody: true,
                            eventType: cloudfront.LambdaEdgeEventType.ORIGIN_REQUEST,
                            functionVersion: this.apiFunctionVersion,
                        },
                    ],
                } }, (cfDistributionProps.additionalBehaviors || {})) }));
    }
    createCloudFrontStaticCachePolicy() {
        return new cloudfront.CachePolicy(this, "StaticsCache", NextjsSite.staticCachePolicyProps);
    }
    createCloudFrontImageCachePolicy() {
        return new cloudfront.CachePolicy(this, "ImageCache", NextjsSite.imageCachePolicyProps);
    }
    createCloudFrontLambdaCachePolicy() {
        return new cloudfront.CachePolicy(this, "LambdaCache", NextjsSite.lambdaCachePolicyProps);
    }
    createCloudFrontInvalidation() {
        // Create a Lambda function that will be doing the invalidation
        const invalidator = new lambda.Function(this, "CloudFrontInvalidator", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "cf-invalidate.handler",
            timeout: aws_cdk_lib_1.Duration.minutes(15),
            memorySize: 1024,
        });
        // Grant permissions to invalidate CF Distribution
        invalidator.addToRolePolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                "cloudfront:GetInvalidation",
                "cloudfront:CreateInvalidation",
            ],
            resources: ["*"],
        }));
        // need the BuildId field so this CR gets updated on each deploy
        let buildId;
        if (this.isPlaceholder) {
            buildId = "live";
        }
        else {
            const buildIdFile = path.resolve(this.buildOutDir, "assets", "BUILD_ID");
            buildId = fs.readFileSync(buildIdFile).toString();
        }
        // Create custom resource
        const waitForInvalidation = this.props.waitForInvalidation === false ? false : true;
        return new aws_cdk_lib_1.CustomResource(this, "CloudFrontInvalidation", {
            serviceToken: invalidator.functionArn,
            resourceType: "Custom::SSTCloudFrontInvalidation",
            properties: {
                BuildId: buildId,
                DistributionId: this.cdk.distribution.distributionId,
                DistributionPaths: ["/*"],
                WaitForInvalidation: waitForInvalidation,
            },
        });
    }
    /////////////////////
    // Custom Domain
    /////////////////////
    validateCustomDomainSettings() {
        var _a;
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        if (typeof customDomain === "string") {
            return;
        }
        if (customDomain.isExternalDomain === true) {
            if (!((_a = customDomain.cdk) === null || _a === void 0 ? void 0 : _a.certificate)) {
                throw new Error(`A valid certificate is required when "isExternalDomain" is set to "true".`);
            }
            if (customDomain.domainAlias) {
                throw new Error(`Domain alias is only supported for domains hosted on Amazon Route 53. Do not set the "customDomain.domainAlias" when "isExternalDomain" is enabled.`);
            }
            if (customDomain.hostedZone) {
                throw new Error(`Hosted zones can only be configured for domains hosted on Amazon Route 53. Do not set the "customDomain.hostedZone" when "isExternalDomain" is enabled.`);
            }
        }
    }
    lookupHostedZone() {
        var _a;
        const { customDomain } = this.props;
        // Skip if customDomain is not configured
        if (!customDomain) {
            return;
        }
        let hostedZone;
        if (typeof customDomain === "string") {
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain,
            });
        }
        else if ((_a = customDomain.cdk) === null || _a === void 0 ? void 0 : _a.hostedZone) {
            hostedZone = customDomain.cdk.hostedZone;
        }
        else if (typeof customDomain.hostedZone === "string") {
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain.hostedZone,
            });
        }
        else if (typeof customDomain.domainName === "string") {
            // Skip if domain is not a Route53 domain
            if (customDomain.isExternalDomain === true) {
                return;
            }
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain.domainName,
            });
        }
        else {
            hostedZone = customDomain.hostedZone;
        }
        return hostedZone;
    }
    createCertificate() {
        var _a, _b;
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        let acmCertificate;
        // HostedZone is set for Route 53 domains
        if (this.cdk.hostedZone) {
            if (typeof customDomain === "string") {
                acmCertificate = new acm.DnsValidatedCertificate(this, "Certificate", {
                    domainName: customDomain,
                    hostedZone: this.cdk.hostedZone,
                    region: "us-east-1",
                });
            }
            else if ((_a = customDomain.cdk) === null || _a === void 0 ? void 0 : _a.certificate) {
                acmCertificate = customDomain.cdk.certificate;
            }
            else {
                acmCertificate = new acm.DnsValidatedCertificate(this, "Certificate", {
                    domainName: customDomain.domainName,
                    hostedZone: this.cdk.hostedZone,
                    region: "us-east-1",
                });
            }
        }
        // HostedZone is NOT set for non-Route 53 domains
        else {
            if (typeof customDomain !== "string") {
                acmCertificate = (_b = customDomain.cdk) === null || _b === void 0 ? void 0 : _b.certificate;
            }
        }
        return acmCertificate;
    }
    createRoute53Records() {
        const { customDomain } = this.props;
        if (!customDomain || !this.cdk.hostedZone) {
            return;
        }
        let recordName;
        let domainAlias;
        if (typeof customDomain === "string") {
            recordName = customDomain;
        }
        else {
            recordName = customDomain.domainName;
            domainAlias = customDomain.domainAlias;
        }
        // Create DNS record
        const recordProps = {
            recordName,
            zone: this.cdk.hostedZone,
            target: route53.RecordTarget.fromAlias(new route53Targets.CloudFrontTarget(this.cdk.distribution)),
        };
        new route53.ARecord(this, "AliasRecord", recordProps);
        new route53.AaaaRecord(this, "AliasRecordAAAA", recordProps);
        // Create Alias redirect record
        if (domainAlias) {
            new route53Patterns.HttpsRedirect(this, "Redirect", {
                zone: this.cdk.hostedZone,
                recordNames: [domainAlias],
                targetDomain: recordName,
            });
        }
    }
    /////////////////////
    // Helper Functions
    /////////////////////
    pathPattern(pattern) {
        const { basePath } = this.routesManifest || {};
        return basePath && basePath.length > 0
            ? `${basePath.slice(1)}/${pattern}`
            : pattern;
    }
    readRoutesManifest() {
        return fs.readJSONSync(path.join(this.buildOutDir, "default-lambda/routes-manifest.json"));
    }
    getS3ContentReplaceValues() {
        const replaceValues = [];
        Object.entries(this.props.environment || {})
            .filter(([, value]) => aws_cdk_lib_1.Token.isUnresolved(value))
            .forEach(([key, value]) => {
            const token = `{{ ${key} }}`;
            replaceValues.push({
                files: "**/*.html",
                search: token,
                replace: value,
            }, {
                files: "**/*.js",
                search: token,
                replace: value,
            }, {
                files: "**/*.json",
                search: token,
                replace: value,
            });
        });
        return replaceValues;
    }
    getLambdaContentReplaceValues() {
        const replaceValues = [];
        // The Next.js app can have environment variables like
        // `process.env.API_URL` in the JS code. `process.env.API_URL` might or
        // might not get resolved on `next build` if it is used in
        // server-side functions, ie. getServerSideProps().
        // Because Lambda@Edge does not support environment variables, we will
        // use the trick of replacing "{{ _SST_NEXTJS_SITE_ENVIRONMENT_ }}" with
        // a JSON encoded string of all environment key-value pairs. This string
        // will then get decoded at run time.
        const lambdaEnvs = {};
        Object.entries(this.props.environment || {}).forEach(([key, value]) => {
            const token = `{{ ${key} }}`;
            replaceValues.push({
                files: "**/*.html",
                search: token,
                replace: value,
            }, {
                files: "**/*.js",
                search: token,
                replace: value,
            }, {
                files: "**/*.json",
                search: token,
                replace: value,
            });
            lambdaEnvs[key] = value;
        });
        replaceValues.push({
            files: "**/*.js",
            search: '"{{ _SST_NEXTJS_SITE_ENVIRONMENT_ }}"',
            replace: JSON.stringify(lambdaEnvs),
        });
        return replaceValues;
    }
    registerSiteEnvironment() {
        const environmentOutputs = {};
        for (const [key, value] of Object.entries(this.props.environment || {})) {
            const outputId = `SstSiteEnv_${key}`;
            const output = new aws_cdk_lib_1.CfnOutput(this, outputId, { value });
            environmentOutputs[key] = Stack_1.Stack.of(this).getLogicalId(output);
        }
        const root = this.node.root;
        root.registerSiteEnvironment({
            id: this.node.id,
            path: this.props.path,
            stack: Stack_1.Stack.of(this).node.id,
            environmentOutputs,
        });
    }
}
exports.NextjsSite = NextjsSite;
/**
 * The default CloudFront cache policy properties for static pages.
 */
NextjsSite.staticCachePolicyProps = {
    queryStringBehavior: cloudfront.CacheQueryStringBehavior.none(),
    headerBehavior: cloudfront.CacheHeaderBehavior.none(),
    cookieBehavior: cloudfront.CacheCookieBehavior.none(),
    defaultTtl: aws_cdk_lib_1.Duration.days(30),
    maxTtl: aws_cdk_lib_1.Duration.days(30),
    minTtl: aws_cdk_lib_1.Duration.days(30),
    enableAcceptEncodingBrotli: true,
    enableAcceptEncodingGzip: true,
    comment: "SST NextjsSite Static Default Cache Policy",
};
/**
 * The default CloudFront cache policy properties for images.
 */
NextjsSite.imageCachePolicyProps = {
    queryStringBehavior: cloudfront.CacheQueryStringBehavior.all(),
    headerBehavior: cloudfront.CacheHeaderBehavior.allowList("Accept"),
    cookieBehavior: cloudfront.CacheCookieBehavior.none(),
    defaultTtl: aws_cdk_lib_1.Duration.days(1),
    maxTtl: aws_cdk_lib_1.Duration.days(365),
    minTtl: aws_cdk_lib_1.Duration.days(0),
    enableAcceptEncodingBrotli: true,
    enableAcceptEncodingGzip: true,
    comment: "SST NextjsSite Image Default Cache Policy",
};
/**
 * The default CloudFront cache policy properties for Lambda@Edge.
 */
NextjsSite.lambdaCachePolicyProps = {
    queryStringBehavior: cloudfront.CacheQueryStringBehavior.all(),
    headerBehavior: cloudfront.CacheHeaderBehavior.none(),
    cookieBehavior: cloudfront.CacheCookieBehavior.all(),
    defaultTtl: aws_cdk_lib_1.Duration.seconds(0),
    maxTtl: aws_cdk_lib_1.Duration.days(365),
    minTtl: aws_cdk_lib_1.Duration.seconds(0),
    enableAcceptEncodingBrotli: true,
    enableAcceptEncodingGzip: true,
    comment: "SST NextjsSite Lambda Default Cache Policy",
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmV4dGpzU2l0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9OZXh0anNTaXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsa0RBQTBCO0FBQzFCLDJDQUE2QjtBQUM3Qiw2Q0FBK0I7QUFDL0IsOERBQWdDO0FBRWhDLDJDQUF1QztBQUN2Qyw2Q0FNcUI7QUFDckIsdURBQXlDO0FBQ3pDLHlEQUEyQztBQUMzQyx5REFBMkM7QUFDM0MsMkRBQTZDO0FBQzdDLCtEQUFpRDtBQUNqRCxpRUFBbUQ7QUFDbkQsb0VBQXNEO0FBQ3RELHVFQUF5RDtBQUN6RCx3RUFBMEQ7QUFDMUQseUVBQThEO0FBQzlELDRFQUE4RDtBQUM5RCxnRkFBa0U7QUFDbEUsa0ZBQW9FO0FBQ3BFLHlGQUEyRTtBQUkzRSxtQ0FBZ0M7QUFFaEMseUNBT29CO0FBQ3BCLGtEQUF5RTtBQUN6RSw0Q0FBZ0Q7QUFDaEQscUZBQXVFO0FBaUd2RSxxQkFBcUI7QUFDckIsWUFBWTtBQUNaLHFCQUFxQjtBQUVyQjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBb0NHO0FBQ0gsTUFBYSxVQUFXLFNBQVEsc0JBQVM7SUFnRnZDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBc0I7UUFDOUQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUNwQyxnREFBZ0Q7UUFDaEQsSUFBSSxDQUFDLGFBQWE7WUFDaEIsQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQztRQUM5RCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQy9CLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxVQUFVLEVB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LE1BQU0sRUFBRSxzQkFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDeEIsMEJBQTBCLEVBQUUsSUFBSTtJQUNoQyx3QkFBd0IsRUFBRSxJQUFJO0lBQzlCLE9BQU8sRUFBRSwyQ0FBMkM7Q0FDckQsQ0FBQztBQUVGOztHQUVHO0FBQ1csaUNBQXNCLEdBQWdDO0lBQ2xFLG1CQUFtQixFQUFFLFVBQVUsQ0FBQyx3QkFBd0IsQ0FBQyxHQUFHLEVBQUU7SUFDOUQsY0FBYyxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUU7SUFDckQsY0FBYyxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLEVBQUU7SUFDcEQsVUFBVSxFQUFFLHNCQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUMvQixNQUFNLEVBQUUsc0JBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO0lBQzFCLE1BQU0sRUFBRSxzQkFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDM0IsMEJBQTBCLEVBQUUsSUFBSTtJQUNoQyx3QkFBd0IsRUFBRSxJQUFJO0lBQzlCLE9BQU8sRUFBRSw0Q0FBNEM7Q0FDdEQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaGFsayBmcm9tIFwiY2hhbGtcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmcy1leHRyYVwiO1xuaW1wb3J0IHNwYXduIGZyb20gXCJjcm9zcy1zcGF3blwiO1xuXG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHtcbiAgVG9rZW4sXG4gIER1cmF0aW9uLFxuICBDZm5PdXRwdXQsXG4gIFJlbW92YWxQb2xpY3ksXG4gIEN1c3RvbVJlc291cmNlLFxufSBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCAqIGFzIHMzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtczNcIjtcbmltcG9ydCAqIGFzIGlhbSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xuaW1wb3J0ICogYXMgc3FzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtc3FzXCI7XG5pbXBvcnQgKiBhcyBsb2dzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbG9nc1wiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgKiBhcyByb3V0ZTUzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtcm91dGU1M1wiO1xuaW1wb3J0ICogYXMgczNBc3NldHMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zMy1hc3NldHNcIjtcbmltcG9ydCAqIGFzIGNsb3VkZnJvbnQgZnJvbSBcImF3cy1jZGstbGliL2F3cy1jbG91ZGZyb250XCI7XG5pbXBvcnQgKiBhcyBhY20gZnJvbSBcImF3cy1jZGstbGliL2F3cy1jZXJ0aWZpY2F0ZW1hbmFnZXJcIjtcbmltcG9ydCB7IEF3c0NsaUxheWVyIH0gZnJvbSBcImF3cy1jZGstbGliL2xhbWJkYS1sYXllci1hd3NjbGlcIjtcbmltcG9ydCAqIGFzIG9yaWdpbnMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1jbG91ZGZyb250LW9yaWdpbnNcIjtcbmltcG9ydCAqIGFzIHJvdXRlNTNUYXJnZXRzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtcm91dGU1My10YXJnZXRzXCI7XG5pbXBvcnQgKiBhcyByb3V0ZTUzUGF0dGVybnMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1yb3V0ZTUzLXBhdHRlcm5zXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGFFdmVudFNvdXJjZXMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGEtZXZlbnQtc291cmNlc1wiO1xuaW1wb3J0IHR5cGUgeyBSb3V0ZXNNYW5pZmVzdCB9IGZyb20gXCJAc2xzLW5leHQvbGFtYmRhLWF0LWVkZ2VcIjtcblxuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vQXBwXCI7XG5pbXBvcnQgeyBTdGFjayB9IGZyb20gXCIuL1N0YWNrXCI7XG5pbXBvcnQgeyBTU1RDb25zdHJ1Y3QgfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7XG4gIEJhc2VTaXRlRG9tYWluUHJvcHMsXG4gIEJhc2VTaXRlUmVwbGFjZVByb3BzLFxuICBCYXNlU2l0ZUNka0Rpc3RyaWJ1dGlvblByb3BzLFxuICBCYXNlU2l0ZUVudmlyb25tZW50T3V0cHV0c0luZm8sXG4gIGdldEJ1aWxkQ21kRW52aXJvbm1lbnQsXG4gIGJ1aWxkRXJyb3JSZXNwb25zZXNGb3JSZWRpcmVjdFRvSW5kZXgsXG59IGZyb20gXCIuL0Jhc2VTaXRlXCI7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucywgYXR0YWNoUGVybWlzc2lvbnNUb1JvbGUgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcbmltcG9ydCB7IGdldEhhbmRsZXJIYXNoIH0gZnJvbSBcIi4vdXRpbC9idWlsZGVyXCI7XG5pbXBvcnQgKiBhcyBjcm9zc1JlZ2lvbkhlbHBlciBmcm9tIFwiLi9uZXh0anMtc2l0ZS9jcm9zcy1yZWdpb24taGVscGVyXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTmV4dGpzRG9tYWluUHJvcHMgZXh0ZW5kcyBCYXNlU2l0ZURvbWFpblByb3BzIHt9XG5leHBvcnQgaW50ZXJmYWNlIE5leHRqc0Nka0Rpc3RyaWJ1dGlvblByb3BzXG4gIGV4dGVuZHMgQmFzZVNpdGVDZGtEaXN0cmlidXRpb25Qcm9wcyB7fVxuZXhwb3J0IGludGVyZmFjZSBOZXh0anNTaXRlUHJvcHMge1xuICBjZGs/OiB7XG4gICAgLyoqXG4gICAgICogUGFzcyBpbiBidWNrZXQgaW5mb3JtYXRpb24gdG8gb3ZlcnJpZGUgdGhlIGRlZmF1bHQgc2V0dGluZ3MgdGhpcyBjb25zdHJ1Y3QgdXNlcyB0byBjcmVhdGUgdGhlIENESyBCdWNrZXQgaW50ZXJuYWxseS5cbiAgICAgKi9cbiAgICBidWNrZXQ/OiBzMy5CdWNrZXRQcm9wcztcbiAgICAvKipcbiAgICAgKiBQYXNzIGluIGEgdmFsdWUgdG8gb3ZlcnJpZGUgdGhlIGRlZmF1bHQgc2V0dGluZ3MgdGhpcyBjb25zdHJ1Y3QgdXNlcyB0byBjcmVhdGUgdGhlIENESyBgRGlzdHJpYnV0aW9uYCBpbnRlcm5hbGx5LlxuICAgICAqL1xuICAgIGRpc3RyaWJ1dGlvbj86IE5leHRqc0Nka0Rpc3RyaWJ1dGlvblByb3BzO1xuICAgIC8qKlxuICAgICAqIE92ZXJyaWRlIHRoZSBkZWZhdWx0IENsb3VkRnJvbnQgY2FjaGUgcG9saWNpZXMgY3JlYXRlZCBpbnRlcm5hbGx5LlxuICAgICAqL1xuICAgIGNhY2hlUG9saWNpZXM/OiB7XG4gICAgICBzdGF0aWNDYWNoZVBvbGljeT86IGNsb3VkZnJvbnQuSUNhY2hlUG9saWN5O1xuICAgICAgaW1hZ2VDYWNoZVBvbGljeT86IGNsb3VkZnJvbnQuSUNhY2hlUG9saWN5O1xuICAgICAgbGFtYmRhQ2FjaGVQb2xpY3k/OiBjbG91ZGZyb250LklDYWNoZVBvbGljeTtcbiAgICB9O1xuICAgIC8qKlxuICAgICAqIE92ZXJyaWRlIHRoZSBkZWZhdWx0IHNldHRpbmdzIHRoaXMgY29uc3RydWN0IHVzZXMgdG8gY3JlYXRlIHRoZSBDREsgYFF1ZXVlYCBpbnRlcm5hbGx5LlxuICAgICAqL1xuICAgIHJlZ2VuZXJhdGlvblF1ZXVlPzogc3FzLlF1ZXVlUHJvcHM7XG4gIH07XG4gIC8qKlxuICAgKiBQYXRoIHRvIHRoZSBkaXJlY3Rvcnkgd2hlcmUgdGhlIHdlYnNpdGUgc291cmNlIGlzIGxvY2F0ZWQuXG4gICAqL1xuICBwYXRoOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgY3VzdG9tRG9tYWluIGZvciB0aGlzIHdlYnNpdGUuIFNTVCBzdXBwb3J0cyBkb21haW5zIHRoYXQgYXJlIGhvc3RlZCBlaXRoZXIgb24gW1JvdXRlIDUzXShodHRwczovL2F3cy5hbWF6b24uY29tL3JvdXRlNTMvKSBvciBleHRlcm5hbGx5LlxuICAgKlxuICAgKiBOb3RlIHRoYXQgeW91IGNhbiBhbHNvIG1pZ3JhdGUgZXh0ZXJuYWxseSBob3N0ZWQgZG9tYWlucyB0byBSb3V0ZSA1MyBieSBbZm9sbG93aW5nIHRoaXMgZ3VpZGVdKGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9Sb3V0ZTUzL2xhdGVzdC9EZXZlbG9wZXJHdWlkZS9NaWdyYXRpbmdETlMuaHRtbCkuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzIHszfVxuICAgKiBuZXcgTmV4dGpzU2l0ZShzdGFjaywgXCJTaXRlXCIsIHtcbiAgICogICBwYXRoOiBcInBhdGgvdG8vc2l0ZVwiLFxuICAgKiAgIGN1c3RvbURvbWFpbjogXCJkb21haW4uY29tXCIsXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICpcbiAgICogYGBganMgezMtNn1cbiAgICogbmV3IE5leHRqc1NpdGUoc3RhY2ssIFwiU2l0ZVwiLCB7XG4gICAqICAgcGF0aDogXCJwYXRoL3RvL3NpdGVcIixcbiAgICogICBjdXN0b21Eb21haW46IHtcbiAgICogICAgIGRvbWFpbk5hbWU6IFwiZG9tYWluLmNvbVwiLFxuICAgKiAgICAgZG9tYWluQWxpYXM6IFwid3d3LmRvbWFpbi5jb21cIixcbiAgICogICAgIGhvc3RlZFpvbmU6IFwiZG9tYWluLmNvbVwiXG4gICAqICAgfSxcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgY3VzdG9tRG9tYWluPzogc3RyaW5nIHwgTmV4dGpzRG9tYWluUHJvcHM7XG4gIC8qKlxuICAgKiBBbiBvYmplY3Qgd2l0aCB0aGUga2V5IGJlaW5nIHRoZSBlbnZpcm9ubWVudCB2YXJpYWJsZSBuYW1lLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqcyB7My02fVxuICAgKiBuZXcgTmV4dGpzU2l0ZShzdGFjaywgXCJOZXh0U2l0ZVwiLCB7XG4gICAqICAgcGF0aDogXCJwYXRoL3RvL3NpdGVcIixcbiAgICogICBlbnZpcm9ubWVudDoge1xuICAgKiAgICAgQVBJX1VSTDogYXBpLnVybCxcbiAgICogICAgIFVTRVJfUE9PTF9DTElFTlQ6IGF1dGguY29nbml0b1VzZXJQb29sQ2xpZW50LnVzZXJQb29sQ2xpZW50SWQsXG4gICAqICAgfSxcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgZW52aXJvbm1lbnQ/OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9O1xuICBkZWZhdWx0cz86IHtcbiAgICBmdW5jdGlvbj86IHtcbiAgICAgIHRpbWVvdXQ/OiBudW1iZXI7XG4gICAgICBtZW1vcnlTaXplPzogbnVtYmVyO1xuICAgICAgcGVybWlzc2lvbnM/OiBQZXJtaXNzaW9ucztcbiAgICB9O1xuICB9O1xuICAvKipcbiAgICogV2hlbiBydW5uaW5nIGBzc3Qgc3RhcnRgLCBhIHBsYWNlaG9sZGVyIHNpdGUgaXMgZGVwbG95ZWQuIFRoaXMgaXMgdG8gZW5zdXJlIHRoYXQgdGhlIHNpdGUgY29udGVudCByZW1haW5zIHVuY2hhbmdlZCwgYW5kIHN1YnNlcXVlbnQgYHNzdCBzdGFydGAgY2FuIHN0YXJ0IHVwIHF1aWNrbHkuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzIHszfVxuICAgKiBuZXcgTmV4dGpzU2l0ZShzdGFjaywgXCJOZXh0U2l0ZVwiLCB7XG4gICAqICAgcGF0aDogXCJwYXRoL3RvL3NpdGVcIixcbiAgICogICBkaXNhYmxlUGxhY2Vob2xkZXI6IHRydWUsXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIGRpc2FibGVQbGFjZWhvbGRlcj86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBXaGlsZSBkZXBsb3lpbmcsIFNTVCB3YWl0cyBmb3IgdGhlIENsb3VkRnJvbnQgY2FjaGUgaW52YWxpZGF0aW9uIHByb2Nlc3MgdG8gZmluaXNoLiBUaGlzIGVuc3VyZXMgdGhhdCB0aGUgbmV3IGNvbnRlbnQgd2lsbCBiZSBzZXJ2ZWQgb25jZSB0aGUgZGVwbG95IGNvbW1hbmQgZmluaXNoZXMuIEhvd2V2ZXIsIHRoaXMgcHJvY2VzcyBjYW4gc29tZXRpbWVzIHRha2UgbW9yZSB0aGFuIDUgbWlucy4gRm9yIG5vbi1wcm9kIGVudmlyb25tZW50cyBpdCBtaWdodCBtYWtlIHNlbnNlIHRvIHBhc3MgaW4gYGZhbHNlYC4gVGhhdCdsbCBza2lwIHdhaXRpbmcgZm9yIHRoZSBjYWNoZSB0byBpbnZhbGlkYXRlIGFuZCBzcGVlZCB1cCB0aGUgZGVwbG95IHByb2Nlc3MuXG4gICAqL1xuICB3YWl0Rm9ySW52YWxpZGF0aW9uPzogYm9vbGVhbjtcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBDb25zdHJ1Y3Rcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4vKipcbiAqIFRoZSBgTmV4dGpzU2l0ZWAgY29uc3RydWN0IGlzIGEgaGlnaGVyIGxldmVsIENESyBjb25zdHJ1Y3QgdGhhdCBtYWtlcyBpdCBlYXN5IHRvIGNyZWF0ZSBhIE5leHQuanMgYXBwLiBJdCBwcm92aWRlcyBhIHNpbXBsZSB3YXkgdG8gYnVpbGQgYW5kIGRlcGxveSB0aGUgc2l0ZSB0byBhbiBTMyBidWNrZXQ7IHNldHVwIGEgQ2xvdWRGcm9udCBDRE4gZm9yIGZhc3QgY29udGVudCBkZWxpdmVyeTsgYW5kIGNvbmZpZ3VyZSBhIGN1c3RvbSBkb21haW4gZm9yIHRoZSB3ZWJzaXRlIFVSTC5cbiAqXG4gKiBJdCBhbHNvIGFsbG93cyB5b3UgdG8gW2F1dG9tYXRpY2FsbHkgc2V0IHRoZSBlbnZpcm9ubWVudCB2YXJpYWJsZXNdKCNjb25maWd1cmluZy1lbnZpcm9ubWVudC12YXJpYWJsZXMpIGluIHlvdXIgTmV4dC5qcyBhcHAgZGlyZWN0bHkgZnJvbSB0aGUgb3V0cHV0cyBpbiB5b3VyIFNTVCBhcHAuXG4gKlxuICogIyMgTmV4dC5qcyBGZWF0dXJlc1xuICogVGhlIGBOZXh0anNTaXRlYCBjb25zdHJ1Y3QgdXNlcyB0aGUgW2BAc2xzLW5leHQvbGFtYmRhLWF0LWVkZ2VgXShodHRwczovL2dpdGh1Yi5jb20vc2VydmVybGVzcy1uZXh0anMvc2VydmVybGVzcy1uZXh0LmpzL3RyZWUvbWFzdGVyL3BhY2thZ2VzL2xpYnMvbGFtYmRhLWF0LWVkZ2UpIHBhY2thZ2UgZnJvbSB0aGUgW2BzZXJ2ZXJsZXNzLW5leHQuanNgXShodHRwczovL2dpdGh1Yi5jb20vc2VydmVybGVzcy1uZXh0anMvc2VydmVybGVzcy1uZXh0LmpzKSBwcm9qZWN0IHRvIGJ1aWxkIGFuZCBwYWNrYWdlIHlvdXIgTmV4dC5qcyBhcHAgc28gdGhhdCBpdCBjYW4gYmUgZGVwbG95ZWQgdG8gTGFtYmRhQEVkZ2UgYW5kIENsb3VkRnJvbnQuXG4gKlxuICogOjo6bm90ZVxuICogVG8gdXNlIHRoZSBgTmV4dGpzU2l0ZWAgY29uc3RydWN0LCB5b3UgaGF2ZSB0byBpbnN0YWxsIGBAc2xzLW5leHQvbGFtYmRhLWF0LWVkZ2VgIGFzIGEgZGVwZW5kZW5jeSBpbiB5b3VyIGBwYWNrYWdlLmpzb25gLlxuICpcbiAqIGBgYGJhc2hcbiAqIG5wbSBpbnN0YWxsIC0tc2F2ZSBAc2xzLW5leHQvbGFtYmRhLWF0LWVkZ2VcbiAqIGBgYFxuICogOjo6XG4gKlxuICogTW9zdCBvZiB0aGUgTmV4dC5qcyAxMSBmZWF0dXJlcyBhcmUgc3VwcG9ydGVkLCBpbmNsdWRpbmc6XG4gKlxuICogLSBbU3RhdGljIFNpdGUgR2VuZXJhdGlvbiAoU1NHKV0oaHR0cHM6Ly9uZXh0anMub3JnL2RvY3MvYmFzaWMtZmVhdHVyZXMvZGF0YS1mZXRjaGluZyNnZXRzdGF0aWNwcm9wcy1zdGF0aWMtZ2VuZXJhdGlvbik6IFN0YXRpYyBwYWdlcyBhcmUgc2VydmVkIG91dCB0aHJvdWdoIHRoZSBDbG91ZEZyb250IENETi5cbiAqIC0gW1NlcnZlciBTaWRlIFJlbmRlcmluZyAoU1NSKV0oaHR0cHM6Ly9uZXh0anMub3JnL2RvY3MvYmFzaWMtZmVhdHVyZXMvZGF0YS1mZXRjaGluZyNnZXRzZXJ2ZXJzaWRlcHJvcHMtc2VydmVyLXNpZGUtcmVuZGVyaW5nKTogU2VydmVyIHNpZGUgcmVuZGVyaW5nIGlzIHBlcmZvcm1lZCBhdCBDbG91ZEZyb250IGVkZ2UgbG9jYXRpb25zIHVzaW5nIExhbWJkYUBFZGdlLlxuICogLSBbQVBJIFJvdXRlc10oaHR0cHM6Ly9uZXh0anMub3JnL2RvY3MvYXBpLXJvdXRlcy9pbnRyb2R1Y3Rpb24pOiBBUEkgcmVxdWVzdHMgYXJlIHNlcnZlZCBmcm9tIENsb3VkRnJvbnQgZWRnZSBsb2NhdGlvbnMgdXNpbmcgTGFtYmRhQEVkZ2UuXG4gKiAtIFtJbmNyZW1lbnRhbCBTdGF0aWMgUmVnZW5lcmF0aW9uIChJU1IpXShodHRwczovL25leHRqcy5vcmcvZG9jcy9iYXNpYy1mZWF0dXJlcy9kYXRhLWZldGNoaW5nI2luY3JlbWVudGFsLXN0YXRpYy1yZWdlbmVyYXRpb24pOiBSZWdlbmVyYXRpb24gaXMgcGVyZm9ybWVkIHVzaW5nIExhbWJkYSBmdW5jdGlvbnMsIGFuZCB0aGUgZ2VuZXJhdGVkIHBhZ2VzIHdpbGwgYmUgc2VydmVkIG91dCB0aHJvdWdoIHRoZSBDbG91ZEZyb250IENETi5cbiAqIC0gW0ltYWdlIE9wdGltaXphdGlvbl0oaHR0cHM6Ly9uZXh0anMub3JnL2RvY3MvYmFzaWMtZmVhdHVyZXMvaW1hZ2Utb3B0aW1pemF0aW9uKTogSW1hZ2VzIGFyZSByZXNpemVkIGFuZCBvcHRpbWl6ZWQgYXQgQ2xvdWRGcm9udCBlZGdlIGxvY2F0aW9ucyB1c2luZyBMYW1iZGFARWRnZS5cbiAqXG4gKiBOZXh0LmpzIDEyIGZlYXR1cmVzIGxpa2UgbWlkZGxld2FyZSBhbmQgQVZJRiBpbWFnZSBhcmUgbm90IHlldCBzdXBwb3J0ZWQuIFlvdSBjYW4gW3JlYWQgbW9yZSBhYm91dCB0aGUgZmVhdHVyZXMgc3VwcG9ydGVkIGJ5IGBzZXJ2ZXJsZXNzLW5leHQuanNgXShodHRwczovL2dpdGh1Yi5jb20vc2VydmVybGVzcy1uZXh0anMvc2VydmVybGVzcy1uZXh0LmpzI2ZlYXR1cmVzKS4gQW5kIHlvdSBjYW4gW2ZvbGxvdyB0aGUgcHJvZ3Jlc3Mgb24gTmV4dC5qcyAxMiBzdXBwb3J0IGhlcmVdKGh0dHBzOi8vZ2l0aHViLmNvbS9zZXJ2ZXJsZXNzLW5leHRqcy9zZXJ2ZXJsZXNzLW5leHQuanMvaXNzdWVzLzIwMTYpLlxuICpcbiAqIEBleGFtcGxlXG4gKiAjIyMgQ3JlYXRpbmcgYSBOZXh0LmpzIGFwcFxuICpcbiAqIERlcGxveXMgYSBOZXh0LmpzIGFwcCBpbiB0aGUgYHBhdGgvdG8vc2l0ZWAgZGlyZWN0b3J5LlxuICpcbiAqIGBgYGpzXG4gKiBuZXcgTmV4dGpzU2l0ZShzdGFjaywgXCJOZXh0U2l0ZVwiLCB7XG4gKiAgIHBhdGg6IFwicGF0aC90by9zaXRlXCIsXG4gKiB9KTtcbiAqIGBgYFxuICovXG5leHBvcnQgY2xhc3MgTmV4dGpzU2l0ZSBleHRlbmRzIENvbnN0cnVjdCBpbXBsZW1lbnRzIFNTVENvbnN0cnVjdCB7XG4gIC8qKlxuICAgKiBUaGUgZGVmYXVsdCBDbG91ZEZyb250IGNhY2hlIHBvbGljeSBwcm9wZXJ0aWVzIGZvciBzdGF0aWMgcGFnZXMuXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIHN0YXRpY0NhY2hlUG9saWN5UHJvcHM6IGNsb3VkZnJvbnQuQ2FjaGVQb2xpY3lQcm9wcyA9IHtcbiAgICBxdWVyeVN0cmluZ0JlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlUXVlcnlTdHJpbmdCZWhhdmlvci5ub25lKCksXG4gICAgaGVhZGVyQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVIZWFkZXJCZWhhdmlvci5ub25lKCksXG4gICAgY29va2llQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVDb29raWVCZWhhdmlvci5ub25lKCksXG4gICAgZGVmYXVsdFR0bDogRHVyYXRpb24uZGF5cygzMCksXG4gICAgbWF4VHRsOiBEdXJhdGlvbi5kYXlzKDMwKSxcbiAgICBtaW5UdGw6IER1cmF0aW9uLmRheXMoMzApLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nQnJvdGxpOiB0cnVlLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nR3ppcDogdHJ1ZSxcbiAgICBjb21tZW50OiBcIlNTVCBOZXh0anNTaXRlIFN0YXRpYyBEZWZhdWx0IENhY2hlIFBvbGljeVwiLFxuICB9O1xuXG4gIC8qKlxuICAgKiBUaGUgZGVmYXVsdCBDbG91ZEZyb250IGNhY2hlIHBvbGljeSBwcm9wZXJ0aWVzIGZvciBpbWFnZXMuXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGltYWdlQ2FjaGVQb2xpY3lQcm9wczogY2xvdWRmcm9udC5DYWNoZVBvbGljeVByb3BzID0ge1xuICAgIHF1ZXJ5U3RyaW5nQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVRdWVyeVN0cmluZ0JlaGF2aW9yLmFsbCgpLFxuICAgIGhlYWRlckJlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlSGVhZGVyQmVoYXZpb3IuYWxsb3dMaXN0KFwiQWNjZXB0XCIpLFxuICAgIGNvb2tpZUJlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlQ29va2llQmVoYXZpb3Iubm9uZSgpLFxuICAgIGRlZmF1bHRUdGw6IER1cmF0aW9uLmRheXMoMSksXG4gICAgbWF4VHRsOiBEdXJhdGlvbi5kYXlzKDM2NSksXG4gICAgbWluVHRsOiBEdXJhdGlvbi5kYXlzKDApLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nQnJvdGxpOiB0cnVlLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nR3ppcDogdHJ1ZSxcbiAgICBjb21tZW50OiBcIlNTVCBOZXh0anNTaXRlIEltYWdlIERlZmF1bHQgQ2FjaGUgUG9saWN5XCIsXG4gIH07XG5cbiAgLyoqXG4gICAqIFRoZSBkZWZhdWx0IENsb3VkRnJvbnQgY2FjaGUgcG9saWN5IHByb3BlcnRpZXMgZm9yIExhbWJkYUBFZGdlLlxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBsYW1iZGFDYWNoZVBvbGljeVByb3BzOiBjbG91ZGZyb250LkNhY2hlUG9saWN5UHJvcHMgPSB7XG4gICAgcXVlcnlTdHJpbmdCZWhhdmlvcjogY2xvdWRmcm9udC5DYWNoZVF1ZXJ5U3RyaW5nQmVoYXZpb3IuYWxsKCksXG4gICAgaGVhZGVyQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVIZWFkZXJCZWhhdmlvci5ub25lKCksXG4gICAgY29va2llQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVDb29raWVCZWhhdmlvci5hbGwoKSxcbiAgICBkZWZhdWx0VHRsOiBEdXJhdGlvbi5zZWNvbmRzKDApLFxuICAgIG1heFR0bDogRHVyYXRpb24uZGF5cygzNjUpLFxuICAgIG1pblR0bDogRHVyYXRpb24uc2Vjb25kcygwKSxcbiAgICBlbmFibGVBY2NlcHRFbmNvZGluZ0Jyb3RsaTogdHJ1ZSxcbiAgICBlbmFibGVBY2NlcHRFbmNvZGluZ0d6aXA6IHRydWUsXG4gICAgY29tbWVudDogXCJTU1QgTmV4dGpzU2l0ZSBMYW1iZGEgRGVmYXVsdCBDYWNoZSBQb2xpY3lcIixcbiAgfTtcblxuICBwdWJsaWMgcmVhZG9ubHkgY2RrOiB7XG4gICAgLyoqXG4gICAgICogVGhlIGludGVybmFsbHkgY3JlYXRlZCBDREsgYEJ1Y2tldGAgaW5zdGFuY2UuXG4gICAgICovXG4gICAgYnVja2V0OiBzMy5CdWNrZXQ7XG4gICAgLyoqXG4gICAgICogVGhlIGludGVybmFsbHkgY3JlYXRlZCBDREsgYFF1ZXVlYCBpbnN0YW5jZS5cbiAgICAgKi9cbiAgICByZWdlbmVyYXRpb25RdWV1ZTogc3FzLlF1ZXVlO1xuICAgIC8qKlxuICAgICAqIFRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgQ0RLIGBEaXN0cmlidXRpb25gIGluc3RhbmNlLlxuICAgICAqL1xuICAgIGRpc3RyaWJ1dGlvbjogY2xvdWRmcm9udC5EaXN0cmlidXRpb247XG4gICAgLyoqXG4gICAgICogVGhlIFJvdXRlIDUzIGhvc3RlZCB6b25lIGZvciB0aGUgY3VzdG9tIGRvbWFpbi5cbiAgICAgKi9cbiAgICBob3N0ZWRab25lPzogcm91dGU1My5JSG9zdGVkWm9uZTtcbiAgICAvKipcbiAgICAgKiBUaGUgQVdTIENlcnRpZmljYXRlIE1hbmFnZXIgY2VydGlmaWNhdGUgZm9yIHRoZSBjdXN0b20gZG9tYWluLlxuICAgICAqL1xuICAgIGNlcnRpZmljYXRlPzogYWNtLklDZXJ0aWZpY2F0ZTtcbiAgfTtcbiAgcHJpdmF0ZSBwcm9wczogTmV4dGpzU2l0ZVByb3BzO1xuICBwcml2YXRlIGlzUGxhY2Vob2xkZXI6IGJvb2xlYW47XG4gIHByaXZhdGUgYnVpbGRPdXREaXI6IHN0cmluZyB8IG51bGw7XG4gIHByaXZhdGUgYXNzZXRzOiBzM0Fzc2V0cy5Bc3NldFtdO1xuICBwcml2YXRlIGF3c0NsaUxheWVyOiBBd3NDbGlMYXllcjtcbiAgcHJpdmF0ZSByb3V0ZXNNYW5pZmVzdDogUm91dGVzTWFuaWZlc3QgfCBudWxsO1xuICBwcml2YXRlIGVkZ2VMYW1iZGFSb2xlOiBpYW0uUm9sZTtcbiAgcHJpdmF0ZSBtYWluRnVuY3Rpb25WZXJzaW9uOiBsYW1iZGEuSVZlcnNpb247XG4gIHByaXZhdGUgYXBpRnVuY3Rpb25WZXJzaW9uOiBsYW1iZGEuSVZlcnNpb247XG4gIHByaXZhdGUgaW1hZ2VGdW5jdGlvblZlcnNpb246IGxhbWJkYS5JVmVyc2lvbjtcbiAgcHJpdmF0ZSByZWdlbmVyYXRpb25GdW5jdGlvbjogbGFtYmRhLkZ1bmN0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBOZXh0anNTaXRlUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgLy8gTG9jYWwgZGV2ZWxvcG1lbnQgb3Igc2tpcCBidWlsZCA9PiBzdHViIGFzc2V0XG4gICAgdGhpcy5pc1BsYWNlaG9sZGVyID1cbiAgICAgIChyb290LmxvY2FsIHx8IHJvb3Quc2tpcEJ1aWxkKSAmJiAhcHJvcHMuZGlzYWJsZVBsYWNlaG9sZGVyO1xuICAgIGNvbnN0IGJ1aWxkRGlyID0gcm9vdC5idWlsZERpcjtcbiAgICBjb25zdCBmaWxlU2l6ZUxpbWl0ID0gcm9vdC5pc0plc3RUZXN0KClcbiAgICAgID8gLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9iYW4tdHMtY29tbWVudFxuICAgICAgICAvLyBAdHMtaWdub3JlOiBcImplc3RGaWxlU2l6ZUxpbWl0T3ZlcnJpZGVcIiBub3QgZXhwb3NlZCBpbiBwcm9wc1xuICAgICAgICBwcm9wcy5qZXN0RmlsZVNpemVMaW1pdE92ZXJyaWRlIHx8IDIwMFxuICAgICAgOiAyMDA7XG5cbiAgICB0aGlzLnByb3BzID0gcHJvcHM7XG4gICAgdGhpcy5jZGsgPSB7fSBhcyBhbnk7XG4gICAgdGhpcy5hd3NDbGlMYXllciA9IG5ldyBBd3NDbGlMYXllcih0aGlzLCBcIkF3c0NsaUxheWVyXCIpO1xuICAgIHRoaXMucmVnaXN0ZXJTaXRlRW52aXJvbm1lbnQoKTtcblxuICAgIC8vIEJ1aWxkIGFwcFxuICAgIGlmICh0aGlzLmlzUGxhY2Vob2xkZXIpIHtcbiAgICAgIHRoaXMuYnVpbGRPdXREaXIgPSBudWxsO1xuICAgICAgdGhpcy5hc3NldHMgPSB0aGlzLnppcEFwcFN0dWJBc3NldHMoKTtcbiAgICAgIHRoaXMucm91dGVzTWFuaWZlc3QgPSBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmJ1aWxkT3V0RGlyID0gcm9vdC5pc0plc3RUZXN0KClcbiAgICAgICAgPyAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10cy1jb21tZW50XG4gICAgICAgICAgLy8gQHRzLWlnbm9yZTogXCJqZXN0QnVpbGRPdXRwdXRQYXRoXCIgbm90IGV4cG9zZWQgaW4gcHJvcHNcbiAgICAgICAgICBwcm9wcy5qZXN0QnVpbGRPdXRwdXRQYXRoIHx8IHRoaXMuYnVpbGRBcHAoKVxuICAgICAgICA6IHRoaXMuYnVpbGRBcHAoKTtcbiAgICAgIHRoaXMuYXNzZXRzID0gdGhpcy56aXBBcHBBc3NldHMoZmlsZVNpemVMaW1pdCwgYnVpbGREaXIpO1xuICAgICAgdGhpcy5yb3V0ZXNNYW5pZmVzdCA9IHRoaXMucmVhZFJvdXRlc01hbmlmZXN0KCk7XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIEJ1Y2tldFxuICAgIHRoaXMuY2RrLmJ1Y2tldCA9IHRoaXMuY3JlYXRlUzNCdWNrZXQoKTtcblxuICAgIC8vIEhhbmRsZSBJbmNyZW1lbnRhbCBTdGF0aWMgUmVnZW5lcmF0aW9uXG4gICAgdGhpcy5jZGsucmVnZW5lcmF0aW9uUXVldWUgPSB0aGlzLmNyZWF0ZVJlZ2VuZXJhdGlvblF1ZXVlKCk7XG4gICAgdGhpcy5yZWdlbmVyYXRpb25GdW5jdGlvbiA9IHRoaXMuY3JlYXRlUmVnZW5lcmF0aW9uRnVuY3Rpb24oKTtcblxuICAgIC8vIENyZWF0ZSBMYW1iZGFARWRnZSBmdW5jdGlvbnMgKGFsd2F5cyBjcmVhdGVkIGluIHVzLWVhc3QtMSlcbiAgICB0aGlzLmVkZ2VMYW1iZGFSb2xlID0gdGhpcy5jcmVhdGVFZGdlRnVuY3Rpb25Sb2xlKCk7XG4gICAgdGhpcy5tYWluRnVuY3Rpb25WZXJzaW9uID0gdGhpcy5jcmVhdGVFZGdlRnVuY3Rpb24oXG4gICAgICBcIk1haW5cIixcbiAgICAgIFwiZGVmYXVsdC1sYW1iZGFcIlxuICAgICk7XG4gICAgdGhpcy5hcGlGdW5jdGlvblZlcnNpb24gPSB0aGlzLmNyZWF0ZUVkZ2VGdW5jdGlvbihcIkFwaVwiLCBcImFwaS1sYW1iZGFcIik7XG4gICAgdGhpcy5pbWFnZUZ1bmN0aW9uVmVyc2lvbiA9IHRoaXMuY3JlYXRlRWRnZUZ1bmN0aW9uKFxuICAgICAgXCJJbWFnZVwiLFxuICAgICAgXCJpbWFnZS1sYW1iZGFcIlxuICAgICk7XG5cbiAgICAvLyBDcmVhdGUgQ3VzdG9tIERvbWFpblxuICAgIHRoaXMudmFsaWRhdGVDdXN0b21Eb21haW5TZXR0aW5ncygpO1xuICAgIHRoaXMuY2RrLmhvc3RlZFpvbmUgPSB0aGlzLmxvb2t1cEhvc3RlZFpvbmUoKTtcbiAgICB0aGlzLmNkay5jZXJ0aWZpY2F0ZSA9IHRoaXMuY3JlYXRlQ2VydGlmaWNhdGUoKTtcblxuICAgIC8vIENyZWF0ZSBTMyBEZXBsb3ltZW50XG4gICAgY29uc3QgczNkZXBsb3lDUiA9IHRoaXMuY3JlYXRlUzNEZXBsb3ltZW50KCk7XG5cbiAgICAvLyBDcmVhdGUgQ2xvdWRGcm9udFxuICAgIHRoaXMuY2RrLmRpc3RyaWJ1dGlvbiA9IHRoaXMuY3JlYXRlQ2xvdWRGcm9udERpc3RyaWJ1dGlvbigpO1xuICAgIHRoaXMuY2RrLmRpc3RyaWJ1dGlvbi5ub2RlLmFkZERlcGVuZGVuY3koczNkZXBsb3lDUik7XG5cbiAgICAvLyBJbnZhbGlkYXRlIENsb3VkRnJvbnRcbiAgICBjb25zdCBpbnZhbGlkYXRpb25DUiA9IHRoaXMuY3JlYXRlQ2xvdWRGcm9udEludmFsaWRhdGlvbigpO1xuICAgIGludmFsaWRhdGlvbkNSLm5vZGUuYWRkRGVwZW5kZW5jeSh0aGlzLmNkay5kaXN0cmlidXRpb24pO1xuXG4gICAgLy8gQ29ubmVjdCBDdXN0b20gRG9tYWluIHRvIENsb3VkRnJvbnQgRGlzdHJpYnV0aW9uXG4gICAgdGhpcy5jcmVhdGVSb3V0ZTUzUmVjb3JkcygpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBDbG91ZEZyb250IFVSTCBvZiB0aGUgd2Vic2l0ZS5cbiAgICovXG4gIHB1YmxpYyBnZXQgdXJsKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBodHRwczovLyR7dGhpcy5jZGsuZGlzdHJpYnV0aW9uLmRpc3RyaWJ1dGlvbkRvbWFpbk5hbWV9YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBJZiB0aGUgY3VzdG9tIGRvbWFpbiBpcyBlbmFibGVkLCB0aGlzIGlzIHRoZSBVUkwgb2YgdGhlIHdlYnNpdGUgd2l0aCB0aGUgY3VzdG9tIGRvbWFpbi5cbiAgICovXG4gIHB1YmxpYyBnZXQgY3VzdG9tRG9tYWluVXJsKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgeyBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIGBodHRwczovLyR7Y3VzdG9tRG9tYWlufWA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBgaHR0cHM6Ly8ke2N1c3RvbURvbWFpbi5kb21haW5OYW1lfWA7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBBUk4gb2YgdGhlIGludGVybmFsbHkgY3JlYXRlZCBTMyBCdWNrZXQuXG4gICAqL1xuICBwdWJsaWMgZ2V0IGJ1Y2tldEFybigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmNkay5idWNrZXQuYnVja2V0QXJuO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgUzMgQnVja2V0LlxuICAgKi9cbiAgcHVibGljIGdldCBidWNrZXROYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuY2RrLmJ1Y2tldC5idWNrZXROYW1lO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBJRCBvZiB0aGUgaW50ZXJuYWxseSBjcmVhdGVkIENsb3VkRnJvbnQgRGlzdHJpYnV0aW9uLlxuICAgKi9cbiAgcHVibGljIGdldCBkaXN0cmlidXRpb25JZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmNkay5kaXN0cmlidXRpb24uZGlzdHJpYnV0aW9uSWQ7XG4gIH1cblxuICAvKipcbiAgICogVGhlIGRvbWFpbiBuYW1lIG9mIHRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgQ2xvdWRGcm9udCBEaXN0cmlidXRpb24uXG4gICAqL1xuICBwdWJsaWMgZ2V0IGRpc3RyaWJ1dGlvbkRvbWFpbigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmNkay5kaXN0cmlidXRpb24uZGlzdHJpYnV0aW9uRG9tYWluTmFtZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBdHRhY2hlcyB0aGUgZ2l2ZW4gbGlzdCBvZiBwZXJtaXNzaW9ucyB0byBhbGxvdyB0aGUgTmV4dC5qcyBBUEkgcm91dGVzIGFuZCBTZXJ2ZXIgU2lkZSByZW5kZXJpbmcgYGdldFNlcnZlclNpZGVQcm9wc2AgdG8gYWNjZXNzIG90aGVyIEFXUyByZXNvdXJjZXMuXG4gICAqIEBleGFtcGxlXG4gICAqICMjIyBBdHRhY2hpbmcgcGVybWlzc2lvbnNcbiAgICpcbiAgICogYGBganMgezV9XG4gICAqIGNvbnN0IHNpdGUgPSBuZXcgTmV4dGpzU2l0ZShzdGFjaywgXCJTaXRlXCIsIHtcbiAgICogICBwYXRoOiBcInBhdGgvdG8vc2l0ZVwiLFxuICAgKiB9KTtcbiAgICpcbiAgICogc2l0ZS5hdHRhY2hQZXJtaXNzaW9ucyhbXCJzbnNcIl0pO1xuICAgKiBgYGBcbiAgICovXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICBhdHRhY2hQZXJtaXNzaW9uc1RvUm9sZSh0aGlzLmVkZ2VMYW1iZGFSb2xlLCBwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q29uc3RydWN0TWV0YWRhdGEoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwiTmV4dFNpdGVcIiBhcyBjb25zdCxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgZGlzdHJpYnV0aW9uSWQ6IHRoaXMuY2RrLmRpc3RyaWJ1dGlvbi5kaXN0cmlidXRpb25JZCxcbiAgICAgICAgY3VzdG9tRG9tYWluVXJsOiB0aGlzLmN1c3RvbURvbWFpblVybCxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgemlwQXBwQXNzZXRzKFxuICAgIGZpbGVTaXplTGltaXQ6IG51bWJlcixcbiAgICBidWlsZERpcjogc3RyaW5nXG4gICk6IHMzQXNzZXRzLkFzc2V0W10ge1xuICAgIC8vIHZhbGlkYXRlIGJ1aWxkT3V0cHV0IGV4aXN0c1xuICAgIGNvbnN0IHNpdGVPdXRwdXRQYXRoID0gcGF0aC5yZXNvbHZlKHBhdGguam9pbih0aGlzLmJ1aWxkT3V0RGlyISwgXCJhc3NldHNcIikpO1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhzaXRlT3V0cHV0UGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYE5vIGJ1aWxkIG91dHB1dCBmb3VuZCBhdCBcIiR7c2l0ZU91dHB1dFBhdGh9XCIgZm9yIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIE5leHRqc1NpdGUuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBjcmVhdGUgemlwIGZpbGVzXG4gICAgY29uc3Qgc2NyaXB0ID0gcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi9hc3NldHMvQmFzZVNpdGUvYXJjaGl2ZXIuanNcIik7XG4gICAgY29uc3QgemlwUGF0aCA9IHBhdGgucmVzb2x2ZShcbiAgICAgIHBhdGguam9pbihidWlsZERpciwgYE5leHRqc1NpdGUtJHt0aGlzLm5vZGUuaWR9LSR7dGhpcy5ub2RlLmFkZHJ9YClcbiAgICApO1xuICAgIC8vIGNsZWFyIHppcCBwYXRoIHRvIGVuc3VyZSBubyBwYXJ0WC56aXAgcmVtYWluIGZyb20gcHJldmlvdXMgYnVpbGRcbiAgICBmcy5yZW1vdmVTeW5jKHppcFBhdGgpO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gc3Bhd24uc3luYyhcbiAgICAgIFwibm9kZVwiLFxuICAgICAgW3NjcmlwdCwgc2l0ZU91dHB1dFBhdGgsIHppcFBhdGgsIGAke2ZpbGVTaXplTGltaXR9YF0sXG4gICAgICB7XG4gICAgICAgIHN0ZGlvOiBcImluaGVyaXRcIixcbiAgICAgIH1cbiAgICApO1xuICAgIGlmIChyZXN1bHQuc3RhdHVzICE9PSAwKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICBgVGhlcmUgd2FzIGEgcHJvYmxlbSBnZW5lcmF0aW5nIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIE5leHRqc1NpdGUgcGFja2FnZS5gXG4gICAgICApO1xuICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH1cblxuICAgIC8vIGNyZWF0ZSBhc3NldHNcbiAgICBjb25zdCBhc3NldHMgPSBbXTtcbiAgICBmb3IgKGxldCBwYXJ0SWQgPSAwOyA7IHBhcnRJZCsrKSB7XG4gICAgICBjb25zdCB6aXBGaWxlUGF0aCA9IHBhdGguam9pbih6aXBQYXRoLCBgcGFydCR7cGFydElkfS56aXBgKTtcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyh6aXBGaWxlUGF0aCkpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIGFzc2V0cy5wdXNoKFxuICAgICAgICBuZXcgczNBc3NldHMuQXNzZXQodGhpcywgYEFzc2V0JHtwYXJ0SWR9YCwge1xuICAgICAgICAgIHBhdGg6IHppcEZpbGVQYXRoLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGFzc2V0cztcbiAgfVxuXG4gIHByaXZhdGUgemlwQXBwU3R1YkFzc2V0cygpOiBzM0Fzc2V0cy5Bc3NldFtdIHtcbiAgICByZXR1cm4gW1xuICAgICAgbmV3IHMzQXNzZXRzLkFzc2V0KHRoaXMsIFwiQXNzZXRcIiwge1xuICAgICAgICBwYXRoOiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBcIi4uL2Fzc2V0cy9OZXh0anNTaXRlL3NpdGUtc3R1YlwiKSxcbiAgICAgIH0pLFxuICAgIF07XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUVkZ2VGdW5jdGlvbihcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgaGFuZGxlclBhdGg6IHN0cmluZ1xuICApOiBsYW1iZGEuSVZlcnNpb24ge1xuICAgIC8vIFVzZSByZWFsIGNvZGUgaWY6XG4gICAgLy8gLSBOZXh0LmpzIGFwcCB3YXMgYnVpbGQ7IEFORFxuICAgIC8vIC0gdGhlIExhbWJkYSBjb2RlIGRpcmVjdG9yeSBpcyBub3QgZW1wdHlcbiAgICBjb25zdCBoYXNSZWFsQ29kZSA9XG4gICAgICB0eXBlb2YgdGhpcy5idWlsZE91dERpciA9PT0gXCJzdHJpbmdcIiAmJlxuICAgICAgZnMucGF0aEV4aXN0c1N5bmMocGF0aC5qb2luKHRoaXMuYnVpbGRPdXREaXIsIGhhbmRsZXJQYXRoLCBcImluZGV4LmpzXCIpKTtcblxuICAgIC8vIENyZWF0ZSBmdW5jdGlvbiBhc3NldFxuICAgIGNvbnN0IGFzc2V0UGF0aCA9XG4gICAgICBoYXNSZWFsQ29kZSAmJiB0aGlzLmJ1aWxkT3V0RGlyXG4gICAgICAgID8gcGF0aC5qb2luKHRoaXMuYnVpbGRPdXREaXIsIGhhbmRsZXJQYXRoKVxuICAgICAgICA6IHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL05leHRqc1NpdGUvZWRnZS1sYW1iZGEtc3R1YlwiKTtcbiAgICBjb25zdCBhc3NldCA9IG5ldyBzM0Fzc2V0cy5Bc3NldCh0aGlzLCBgJHtuYW1lfUZ1bmN0aW9uQXNzZXRgLCB7XG4gICAgICBwYXRoOiBhc3NldFBhdGgsXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgZnVuY3Rpb24gYmFzZWQgb24gcmVnaW9uXG4gICAgY29uc3Qgcm9vdCA9IHRoaXMubm9kZS5yb290IGFzIEFwcDtcbiAgICByZXR1cm4gcm9vdC5yZWdpb24gPT09IFwidXMtZWFzdC0xXCJcbiAgICAgID8gdGhpcy5jcmVhdGVFZGdlRnVuY3Rpb25JblVFMShuYW1lLCBhc3NldFBhdGgsIGFzc2V0LCBoYXNSZWFsQ29kZSlcbiAgICAgIDogdGhpcy5jcmVhdGVFZGdlRnVuY3Rpb25Jbk5vblVFMShuYW1lLCBhc3NldFBhdGgsIGFzc2V0LCBoYXNSZWFsQ29kZSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUVkZ2VGdW5jdGlvbkluVUUxKFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICBhc3NldFBhdGg6IHN0cmluZyxcbiAgICBhc3NldDogczNBc3NldHMuQXNzZXQsXG4gICAgaGFzUmVhbENvZGU6IGJvb2xlYW5cbiAgKTogbGFtYmRhLklWZXJzaW9uIHtcbiAgICBjb25zdCB7IGRlZmF1bHRzIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgLy8gQ3JlYXRlIGZ1bmN0aW9uXG4gICAgY29uc3QgZm4gPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIGAke25hbWV9RnVuY3Rpb25gLCB7XG4gICAgICBkZXNjcmlwdGlvbjogYCR7bmFtZX0gaGFuZGxlciBmb3IgTmV4dC5qc2AsXG4gICAgICBoYW5kbGVyOiBcImluZGV4LXdyYXBwZXIuaGFuZGxlclwiLFxuICAgICAgY3VycmVudFZlcnNpb25PcHRpb25zOiB7XG4gICAgICAgIHJlbW92YWxQb2xpY3k6IFJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICAgIH0sXG4gICAgICBsb2dSZXRlbnRpb246IGxvZ3MuUmV0ZW50aW9uRGF5cy5USFJFRV9EQVlTLFxuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KGFzc2V0UGF0aCksXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWCxcbiAgICAgIG1lbW9yeVNpemU6IGRlZmF1bHRzPy5mdW5jdGlvbj8ubWVtb3J5U2l6ZSB8fCA1MTIsXG4gICAgICB0aW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKGRlZmF1bHRzPy5mdW5jdGlvbj8udGltZW91dCB8fCAxMCksXG4gICAgICByb2xlOiB0aGlzLmVkZ2VMYW1iZGFSb2xlLFxuICAgIH0pO1xuXG4gICAgLy8gQ3JlYXRlIGFsaWFzXG4gICAgZm4uY3VycmVudFZlcnNpb24uYWRkQWxpYXMoXCJsaXZlXCIpO1xuXG4gICAgLy8gRGVwbG95IGFmdGVyIHRoZSBjb2RlIGlzIHVwZGF0ZWRcbiAgICBpZiAoaGFzUmVhbENvZGUpIHtcbiAgICAgIGNvbnN0IHVwZGF0ZXJDUiA9IHRoaXMuY3JlYXRlTGFtYmRhQ29kZVJlcGxhY2VyKG5hbWUsIGFzc2V0KTtcbiAgICAgIGZuLm5vZGUuYWRkRGVwZW5kZW5jeSh1cGRhdGVyQ1IpO1xuICAgIH1cblxuICAgIHJldHVybiBmbi5jdXJyZW50VmVyc2lvbjtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlRWRnZUZ1bmN0aW9uSW5Ob25VRTEoXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIGFzc2V0UGF0aDogc3RyaW5nLFxuICAgIGFzc2V0OiBzM0Fzc2V0cy5Bc3NldCxcbiAgICBoYXNSZWFsQ29kZTogYm9vbGVhblxuICApOiBsYW1iZGEuSVZlcnNpb24ge1xuICAgIGNvbnN0IHsgZGVmYXVsdHMgfSA9IHRoaXMucHJvcHM7XG5cbiAgICAvLyBJZiBhcHAgcmVnaW9uIGlzIE5PVCB1cy1lYXN0LTEsIGNyZWF0ZSBhIEZ1bmN0aW9uIGluIHVzLWVhc3QtMVxuICAgIC8vIHVzaW5nIGEgQ3VzdG9tIFJlc291cmNlXG5cbiAgICAvLyBDcmVhdGUgYSBTMyBidWNrZXQgaW4gdXMtZWFzdC0xIHRvIHN0b3JlIExhbWJkYSBjb2RlLiBDcmVhdGVcbiAgICAvLyAxIGJ1Y2tldCBmb3IgYWxsIEVkZ2UgZnVuY3Rpb25zLlxuICAgIGNvbnN0IGJ1Y2tldENSID0gY3Jvc3NSZWdpb25IZWxwZXIuZ2V0T3JDcmVhdGVCdWNrZXQodGhpcyk7XG4gICAgY29uc3QgYnVja2V0TmFtZSA9IGJ1Y2tldENSLmdldEF0dFN0cmluZyhcIkJ1Y2tldE5hbWVcIik7XG5cbiAgICAvLyBDcmVhdGUgYSBMYW1iZGEgZnVuY3Rpb24gaW4gdXMtZWFzdC0xXG4gICAgY29uc3QgZnVuY3Rpb25DUiA9IGNyb3NzUmVnaW9uSGVscGVyLmNyZWF0ZUZ1bmN0aW9uKFxuICAgICAgdGhpcyxcbiAgICAgIG5hbWUsXG4gICAgICB0aGlzLmVkZ2VMYW1iZGFSb2xlLFxuICAgICAgYnVja2V0TmFtZSxcbiAgICAgIHtcbiAgICAgICAgRGVzY3JpcHRpb246IGBoYW5kbGVyIGZvciBOZXh0LmpzYCxcbiAgICAgICAgSGFuZGxlcjogXCJpbmRleC13cmFwcGVyLmhhbmRsZXJcIixcbiAgICAgICAgQ29kZToge1xuICAgICAgICAgIFMzQnVja2V0OiBhc3NldC5zM0J1Y2tldE5hbWUsXG4gICAgICAgICAgUzNLZXk6IGFzc2V0LnMzT2JqZWN0S2V5LFxuICAgICAgICB9LFxuICAgICAgICBSdW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWC5uYW1lLFxuICAgICAgICBNZW1vcnlTaXplOiBkZWZhdWx0cz8uZnVuY3Rpb24/Lm1lbW9yeVNpemUgfHwgNTEyLFxuICAgICAgICBUaW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKFxuICAgICAgICAgIGRlZmF1bHRzPy5mdW5jdGlvbj8udGltZW91dCB8fCAxMFxuICAgICAgICApLnRvU2Vjb25kcygpLFxuICAgICAgICBSb2xlOiB0aGlzLmVkZ2VMYW1iZGFSb2xlLnJvbGVBcm4sXG4gICAgICB9XG4gICAgKTtcbiAgICBjb25zdCBmdW5jdGlvbkFybiA9IGZ1bmN0aW9uQ1IuZ2V0QXR0U3RyaW5nKFwiRnVuY3Rpb25Bcm5cIik7XG5cbiAgICAvLyBDcmVhdGUgYSBMYW1iZGEgZnVuY3Rpb24gdmVyc2lvbiBpbiB1cy1lYXN0LTFcbiAgICBjb25zdCB2ZXJzaW9uQ1IgPSBjcm9zc1JlZ2lvbkhlbHBlci5jcmVhdGVWZXJzaW9uKHRoaXMsIG5hbWUsIGZ1bmN0aW9uQXJuKTtcbiAgICBjb25zdCB2ZXJzaW9uSWQgPSB2ZXJzaW9uQ1IuZ2V0QXR0U3RyaW5nKFwiVmVyc2lvblwiKTtcbiAgICBjcm9zc1JlZ2lvbkhlbHBlci51cGRhdGVWZXJzaW9uTG9naWNhbElkKGZ1bmN0aW9uQ1IsIHZlcnNpb25DUik7XG5cbiAgICAvLyBEZXBsb3kgYWZ0ZXIgdGhlIGNvZGUgaXMgdXBkYXRlZFxuICAgIGlmIChoYXNSZWFsQ29kZSkge1xuICAgICAgY29uc3QgdXBkYXRlckNSID0gdGhpcy5jcmVhdGVMYW1iZGFDb2RlUmVwbGFjZXIobmFtZSwgYXNzZXQpO1xuICAgICAgZnVuY3Rpb25DUi5ub2RlLmFkZERlcGVuZGVuY3kodXBkYXRlckNSKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbGFtYmRhLlZlcnNpb24uZnJvbVZlcnNpb25Bcm4oXG4gICAgICB0aGlzLFxuICAgICAgYCR7bmFtZX1GdW5jdGlvblZlcnNpb25gLFxuICAgICAgYCR7ZnVuY3Rpb25Bcm59OiR7dmVyc2lvbklkfWBcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVFZGdlRnVuY3Rpb25Sb2xlKCk6IGlhbS5Sb2xlIHtcbiAgICBjb25zdCB7IGRlZmF1bHRzIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgLy8gQ3JlYXRlIGZ1bmN0aW9uIHJvbGVcbiAgICBjb25zdCByb2xlID0gbmV3IGlhbS5Sb2xlKHRoaXMsIGBFZGdlTGFtYmRhUm9sZWAsIHtcbiAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5Db21wb3NpdGVQcmluY2lwYWwoXG4gICAgICAgIG5ldyBpYW0uU2VydmljZVByaW5jaXBhbChcImxhbWJkYS5hbWF6b25hd3MuY29tXCIpLFxuICAgICAgICBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoXCJlZGdlbGFtYmRhLmFtYXpvbmF3cy5jb21cIilcbiAgICAgICksXG4gICAgICBtYW5hZ2VkUG9saWNpZXM6IFtcbiAgICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbU1hbmFnZWRQb2xpY3lBcm4oXG4gICAgICAgICAgdGhpcyxcbiAgICAgICAgICBcIkVkZ2VMYW1iZGFQb2xpY3lcIixcbiAgICAgICAgICBcImFybjphd3M6aWFtOjphd3M6cG9saWN5L3NlcnZpY2Utcm9sZS9BV1NMYW1iZGFCYXNpY0V4ZWN1dGlvblJvbGVcIlxuICAgICAgICApLFxuICAgICAgXSxcbiAgICB9KTtcblxuICAgIC8vIEF0dGFjaCBwZXJtaXNzaW9uXG4gICAgdGhpcy5jZGsuYnVja2V0LmdyYW50UmVhZFdyaXRlKHJvbGUpO1xuICAgIHRoaXMuY2RrLnJlZ2VuZXJhdGlvblF1ZXVlLmdyYW50U2VuZE1lc3NhZ2VzKHJvbGUpO1xuICAgIHRoaXMucmVnZW5lcmF0aW9uRnVuY3Rpb24uZ3JhbnRJbnZva2Uocm9sZSk7XG4gICAgaWYgKGRlZmF1bHRzPy5mdW5jdGlvbj8ucGVybWlzc2lvbnMpIHtcbiAgICAgIGF0dGFjaFBlcm1pc3Npb25zVG9Sb2xlKHJvbGUsIGRlZmF1bHRzLmZ1bmN0aW9uLnBlcm1pc3Npb25zKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcm9sZTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUmVnZW5lcmF0aW9uUXVldWUoKTogc3FzLlF1ZXVlIHtcbiAgICBjb25zdCB7IGNkayB9ID0gdGhpcy5wcm9wcztcblxuICAgIHJldHVybiBuZXcgc3FzLlF1ZXVlKHRoaXMsIFwiUmVnZW5lcmF0aW9uUXVldWVcIiwge1xuICAgICAgLi4uY2RrPy5yZWdlbmVyYXRpb25RdWV1ZSxcbiAgICAgIC8vIFdlIGNhbGwgdGhlIHF1ZXVlIHRoZSBzYW1lIG5hbWUgYXMgdGhlIGJ1Y2tldCBzbyB0aGF0IHdlIGNhbiBlYXNpbHlcbiAgICAgIC8vIHJlZmVyZW5jZSBpdCBmcm9tIHdpdGhpbiB0aGUgbGFtYmRhQGVkZ2UsIGdpdmVuIHdlIGNhbid0IHVzZSBlbnYgdmFyc1xuICAgICAgLy8gaW4gYSBsYW1iZGFAZWRnZVxuICAgICAgcXVldWVOYW1lOiBgJHt0aGlzLmNkay5idWNrZXQuYnVja2V0TmFtZX0uZmlmb2AsXG4gICAgICBmaWZvOiB0cnVlLFxuICAgICAgcmVtb3ZhbFBvbGljeTogUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVSZWdlbmVyYXRpb25GdW5jdGlvbigpOiBsYW1iZGEuRnVuY3Rpb24ge1xuICAgIC8vIFVzZSByZWFsIGNvZGUgaWY6XG4gICAgLy8gLSBOZXh0LmpzIGFwcCB3YXMgYnVpbGQ7IEFORFxuICAgIC8vIC0gdGhlIExhbWJkYSBjb2RlIGRpcmVjdG9yeSBpcyBub3QgZW1wdHlcbiAgICBsZXQgY29kZTtcbiAgICBsZXQgdXBkYXRlckNSO1xuICAgIGlmIChcbiAgICAgIHRoaXMuYnVpbGRPdXREaXIgJiZcbiAgICAgIGZzLnBhdGhFeGlzdHNTeW5jKFxuICAgICAgICBwYXRoLmpvaW4odGhpcy5idWlsZE91dERpciwgXCJyZWdlbmVyYXRpb24tbGFtYmRhXCIsIFwiaW5kZXguanNcIilcbiAgICAgIClcbiAgICApIHtcbiAgICAgIGNvbnN0IGFzc2V0ID0gbmV3IHMzQXNzZXRzLkFzc2V0KHRoaXMsIGBSZWdlbmVyYXRpb25GdW5jdGlvbkFzc2V0YCwge1xuICAgICAgICBwYXRoOiBwYXRoLmpvaW4odGhpcy5idWlsZE91dERpciwgXCJyZWdlbmVyYXRpb24tbGFtYmRhXCIpLFxuICAgICAgfSk7XG4gICAgICBjb2RlID0gbGFtYmRhLkNvZGUuZnJvbUFzc2V0KFxuICAgICAgICBwYXRoLmpvaW4odGhpcy5idWlsZE91dERpciwgXCJyZWdlbmVyYXRpb24tbGFtYmRhXCIpXG4gICAgICApO1xuICAgICAgdXBkYXRlckNSID0gdGhpcy5jcmVhdGVMYW1iZGFDb2RlUmVwbGFjZXIoXCJSZWdlbmVyYXRpb25cIiwgYXNzZXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb2RlID0gbGFtYmRhLkNvZGUuZnJvbUlubGluZShcIiAgXCIpO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBmdW5jdGlvblxuICAgIGNvbnN0IHsgZGVmYXVsdHMgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgZm4gPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIFwiUmVnZW5lcmF0aW9uRnVuY3Rpb25cIiwge1xuICAgICAgaGFuZGxlcjogXCJpbmRleC13cmFwcGVyLmhhbmRsZXJcIixcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xMl9YLFxuICAgICAgbWVtb3J5U2l6ZTogZGVmYXVsdHM/LmZ1bmN0aW9uPy5tZW1vcnlTaXplIHx8IDEwMjQsXG4gICAgICB0aW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKGRlZmF1bHRzPy5mdW5jdGlvbj8udGltZW91dCB8fCAzMCksXG4gICAgICBjb2RlLFxuICAgIH0pO1xuXG4gICAgZm4uYWRkRXZlbnRTb3VyY2UoXG4gICAgICBuZXcgbGFtYmRhRXZlbnRTb3VyY2VzLlNxc0V2ZW50U291cmNlKHRoaXMuY2RrLnJlZ2VuZXJhdGlvblF1ZXVlKVxuICAgICk7XG5cbiAgICAvLyBHcmFudCBwZXJtaXNzaW9uc1xuICAgIHRoaXMuY2RrLmJ1Y2tldC5ncmFudFJlYWRXcml0ZShmbik7XG5cbiAgICAvLyBEZXBsb3kgYWZ0ZXIgdGhlIGNvZGUgaXMgdXBkYXRlZFxuICAgIGlmICh1cGRhdGVyQ1IpIHtcbiAgICAgIGZuLm5vZGUuYWRkRGVwZW5kZW5jeSh1cGRhdGVyQ1IpO1xuICAgIH1cblxuICAgIHJldHVybiBmbjtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTGFtYmRhQ29kZVJlcGxhY2VyKFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICBhc3NldDogczNBc3NldHMuQXNzZXRcbiAgKTogQ3VzdG9tUmVzb3VyY2Uge1xuICAgIC8vIE5vdGU6IFNvdXJjZSBjb2RlIGZvciB0aGUgTGFtYmRhIGZ1bmN0aW9ucyBoYXZlIFwie3sgRU5WX0tFWSB9fVwiIGluIHRoZW0uXG4gICAgLy8gICAgICAgVGhleSBuZWVkIHRvIGJlIHJlcGxhY2VkIHdpdGggcmVhbCB2YWx1ZXMgYmVmb3JlIHRoZSBMYW1iZGFcbiAgICAvLyAgICAgICBmdW5jdGlvbnMgZ2V0IGRlcGxveWVkLlxuXG4gICAgY29uc3QgcHJvdmlkZXJJZCA9IFwiTGFtYmRhQ29kZVJlcGxhY2VyUHJvdmlkZXJcIjtcbiAgICBjb25zdCByZXNJZCA9IGAke25hbWV9TGFtYmRhQ29kZVJlcGxhY2VyYDtcbiAgICBjb25zdCBzdGFjayA9IFN0YWNrLm9mKHRoaXMpO1xuICAgIGxldCBwcm92aWRlciA9IHN0YWNrLm5vZGUudHJ5RmluZENoaWxkKHByb3ZpZGVySWQpIGFzIGxhbWJkYS5GdW5jdGlvbjtcblxuICAgIC8vIENyZWF0ZSBwcm92aWRlciBpZiBub3QgYWxyZWFkeSBjcmVhdGVkXG4gICAgaWYgKCFwcm92aWRlcikge1xuICAgICAgcHJvdmlkZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHN0YWNrLCBwcm92aWRlcklkLCB7XG4gICAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChcbiAgICAgICAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2Fzc2V0cy9OZXh0anNTaXRlL2N1c3RvbS1yZXNvdXJjZVwiKVxuICAgICAgICApLFxuICAgICAgICBsYXllcnM6IFt0aGlzLmF3c0NsaUxheWVyXSxcbiAgICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfNyxcbiAgICAgICAgaGFuZGxlcjogXCJsYW1iZGEtY29kZS11cGRhdGVyLmhhbmRsZXJcIixcbiAgICAgICAgdGltZW91dDogRHVyYXRpb24ubWludXRlcygxNSksXG4gICAgICAgIG1lbW9yeVNpemU6IDEwMjQsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBBbGxvdyBwcm92aWRlciB0byBwZXJmb3JtIHNlYXJjaC9yZXBsYWNlIG9uIHRoZSBhc3NldFxuICAgIHByb3ZpZGVyLnJvbGU/LmFkZFRvUHJpbmNpcGFsUG9saWN5KFxuICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgIGFjdGlvbnM6IFtcInMzOipcIl0sXG4gICAgICAgIHJlc291cmNlczogW2Bhcm46YXdzOnMzOjo6JHthc3NldC5zM0J1Y2tldE5hbWV9LyR7YXNzZXQuczNPYmplY3RLZXl9YF0sXG4gICAgICB9KVxuICAgICk7XG5cbiAgICAvLyBDcmVhdGUgY3VzdG9tIHJlc291cmNlXG4gICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgQ3VzdG9tUmVzb3VyY2UodGhpcywgcmVzSWQsIHtcbiAgICAgIHNlcnZpY2VUb2tlbjogcHJvdmlkZXIuZnVuY3Rpb25Bcm4sXG4gICAgICByZXNvdXJjZVR5cGU6IFwiQ3VzdG9tOjpTU1RMYW1iZGFDb2RlVXBkYXRlclwiLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICBTb3VyY2U6IHtcbiAgICAgICAgICBCdWNrZXROYW1lOiBhc3NldC5zM0J1Y2tldE5hbWUsXG4gICAgICAgICAgT2JqZWN0S2V5OiBhc3NldC5zM09iamVjdEtleSxcbiAgICAgICAgfSxcbiAgICAgICAgUmVwbGFjZVZhbHVlczogdGhpcy5nZXRMYW1iZGFDb250ZW50UmVwbGFjZVZhbHVlcygpLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHJldHVybiByZXNvdXJjZTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRBcHAoKTogc3RyaW5nIHtcbiAgICBjb25zdCB7IHBhdGg6IHNpdGVQYXRoIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgLy8gdmFsaWRhdGUgc2l0ZSBwYXRoIGV4aXN0c1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhzaXRlUGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYE5vIHBhdGggZm91bmQgYXQgXCIke3BhdGgucmVzb2x2ZShzaXRlUGF0aCl9XCIgZm9yIHRoZSBcIiR7XG4gICAgICAgICAgdGhpcy5ub2RlLmlkXG4gICAgICAgIH1cIiBOZXh0anNTaXRlLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQnVpbGQgY29tbWFuZFxuICAgIC8vIE5vdGU6IHByb2JhYmx5IGNvdWxkIHBhc3MgSlNPTiBzdHJpbmcgYWxzbywgYnV0IHRoaXMgZmVsdCBzYWZlci5cbiAgICBjb25zdCByb290ID0gdGhpcy5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIGNvbnN0IHBhdGhIYXNoID0gZ2V0SGFuZGxlckhhc2goc2l0ZVBhdGgpO1xuICAgIGNvbnN0IGJ1aWxkT3V0cHV0ID0gcGF0aC5qb2luKHJvb3QuYnVpbGREaXIsIHBhdGhIYXNoKTtcbiAgICBjb25zdCBjb25maWdCdWZmZXIgPSBCdWZmZXIuZnJvbShcbiAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgY3dkOiBwYXRoLnJlc29sdmUoc2l0ZVBhdGgpLFxuICAgICAgICBhcmdzOiBbXCJidWlsZFwiXSxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIC8vIFJ1biBidWlsZFxuICAgIGNvbnNvbGUubG9nKGNoYWxrLmdyZXkoYEJ1aWxkaW5nIE5leHQuanMgc2l0ZSAke3NpdGVQYXRofWApKTtcbiAgICBjb25zdCByZXN1bHQgPSBzcGF3bi5zeW5jKFxuICAgICAgXCJub2RlXCIsXG4gICAgICBbXG4gICAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL05leHRqc1NpdGUvYnVpbGQvYnVpbGQuanNcIiksXG4gICAgICAgIFwiLS1wYXRoXCIsXG4gICAgICAgIHBhdGgucmVzb2x2ZShzaXRlUGF0aCksXG4gICAgICAgIFwiLS1vdXRwdXRcIixcbiAgICAgICAgcGF0aC5yZXNvbHZlKGJ1aWxkT3V0cHV0KSxcbiAgICAgICAgXCItLWNvbmZpZ1wiLFxuICAgICAgICBjb25maWdCdWZmZXIudG9TdHJpbmcoXCJiYXNlNjRcIiksXG4gICAgICBdLFxuICAgICAge1xuICAgICAgICBjd2Q6IHNpdGVQYXRoLFxuICAgICAgICBzdGRpbzogXCJpbmhlcml0XCIsXG4gICAgICAgIGVudjoge1xuICAgICAgICAgIC4uLnByb2Nlc3MuZW52LFxuICAgICAgICAgIC4uLmdldEJ1aWxkQ21kRW52aXJvbm1lbnQodGhpcy5wcm9wcy5lbnZpcm9ubWVudCksXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgKTtcbiAgICBpZiAocmVzdWx0LnN0YXR1cyAhPT0gMCkge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgYFRoZXJlIHdhcyBhIHByb2JsZW0gYnVpbGRpbmcgdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgTmV4dGpzU2l0ZS5gXG4gICAgICApO1xuICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH1cblxuICAgIHJldHVybiBidWlsZE91dHB1dDtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUzNCdWNrZXQoKTogczMuQnVja2V0IHtcbiAgICBjb25zdCB7IGNkayB9ID0gdGhpcy5wcm9wcztcblxuICAgIHJldHVybiBuZXcgczMuQnVja2V0KHRoaXMsIFwiUzNCdWNrZXRcIiwge1xuICAgICAgcHVibGljUmVhZEFjY2VzczogdHJ1ZSxcbiAgICAgIGF1dG9EZWxldGVPYmplY3RzOiB0cnVlLFxuICAgICAgcmVtb3ZhbFBvbGljeTogUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgICAgLi4uY2RrPy5idWNrZXQsXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVMzRGVwbG95bWVudCgpOiBDdXN0b21SZXNvdXJjZSB7XG4gICAgLy8gQ3JlYXRlIGEgTGFtYmRhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBkb2luZyB0aGUgdXBsb2FkaW5nXG4gICAgY29uc3QgdXBsb2FkZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIFwiUzNVcGxvYWRlclwiLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL0Jhc2VTaXRlL2N1c3RvbS1yZXNvdXJjZVwiKVxuICAgICAgKSxcbiAgICAgIGxheWVyczogW3RoaXMuYXdzQ2xpTGF5ZXJdLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfNyxcbiAgICAgIGhhbmRsZXI6IFwiczMtdXBsb2FkLmhhbmRsZXJcIixcbiAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICB9KTtcbiAgICB0aGlzLmNkay5idWNrZXQuZ3JhbnRSZWFkV3JpdGUodXBsb2FkZXIpO1xuICAgIHRoaXMuYXNzZXRzLmZvckVhY2goKGFzc2V0KSA9PiBhc3NldC5ncmFudFJlYWQodXBsb2FkZXIpKTtcblxuICAgIC8vIENyZWF0ZSB0aGUgY3VzdG9tIHJlc291cmNlIGZ1bmN0aW9uXG4gICAgY29uc3QgaGFuZGxlciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgXCJTM0hhbmRsZXJcIiwge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KFxuICAgICAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2Fzc2V0cy9CYXNlU2l0ZS9jdXN0b20tcmVzb3VyY2VcIilcbiAgICAgICksXG4gICAgICBsYXllcnM6IFt0aGlzLmF3c0NsaUxheWVyXSxcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLlBZVEhPTl8zXzcsXG4gICAgICBoYW5kbGVyOiBcInMzLWhhbmRsZXIuaGFuZGxlclwiLFxuICAgICAgdGltZW91dDogRHVyYXRpb24ubWludXRlcygxNSksXG4gICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgVVBMT0FERVJfRlVOQ1RJT05fTkFNRTogdXBsb2FkZXIuZnVuY3Rpb25OYW1lLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICB0aGlzLmNkay5idWNrZXQuZ3JhbnRSZWFkV3JpdGUoaGFuZGxlcik7XG4gICAgdXBsb2FkZXIuZ3JhbnRJbnZva2UoaGFuZGxlcik7XG5cbiAgICAvLyBDcmVhdGUgY3VzdG9tIHJlc291cmNlXG4gICAgY29uc3QgZmlsZU9wdGlvbnMgPSBbXG4gICAgICB7XG4gICAgICAgIGV4Y2x1ZGU6IFwiKlwiLFxuICAgICAgICBpbmNsdWRlOiBcInB1YmxpYy8qXCIsXG4gICAgICAgIGNhY2hlQ29udHJvbDogXCJwdWJsaWMsbWF4LWFnZT0zMTUzNjAwMCxtdXN0LXJldmFsaWRhdGVcIixcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGV4Y2x1ZGU6IFwiKlwiLFxuICAgICAgICBpbmNsdWRlOiBcInN0YXRpYy8qXCIsXG4gICAgICAgIGNhY2hlQ29udHJvbDogXCJwdWJsaWMsbWF4LWFnZT0zMTUzNjAwMCxtdXN0LXJldmFsaWRhdGVcIixcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGV4Y2x1ZGU6IFwiKlwiLFxuICAgICAgICBpbmNsdWRlOiBcInN0YXRpYy1wYWdlcy8qXCIsXG4gICAgICAgIGNhY2hlQ29udHJvbDogXCJwdWJsaWMsbWF4LWFnZT0wLHMtbWF4YWdlPTI2Nzg0MDAsbXVzdC1yZXZhbGlkYXRlXCIsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBleGNsdWRlOiBcIipcIixcbiAgICAgICAgaW5jbHVkZTogXCJfbmV4dC9kYXRhLypcIixcbiAgICAgICAgY2FjaGVDb250cm9sOiBcInB1YmxpYyxtYXgtYWdlPTAscy1tYXhhZ2U9MjY3ODQwMCxtdXN0LXJldmFsaWRhdGVcIixcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGV4Y2x1ZGU6IFwiKlwiLFxuICAgICAgICBpbmNsdWRlOiBcIl9uZXh0L3N0YXRpYy8qXCIsXG4gICAgICAgIGNhY2hlQ29udHJvbDogXCJwdWJsaWMsbWF4LWFnZT0zMTUzNjAwMCxpbW11dGFibGVcIixcbiAgICAgIH0sXG4gICAgXTtcbiAgICByZXR1cm4gbmV3IEN1c3RvbVJlc291cmNlKHRoaXMsIFwiUzNEZXBsb3ltZW50XCIsIHtcbiAgICAgIHNlcnZpY2VUb2tlbjogaGFuZGxlci5mdW5jdGlvbkFybixcbiAgICAgIHJlc291cmNlVHlwZTogXCJDdXN0b206OlNTVEJ1Y2tldERlcGxveW1lbnRcIixcbiAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgU291cmNlczogdGhpcy5hc3NldHMubWFwKChhc3NldCkgPT4gKHtcbiAgICAgICAgICBCdWNrZXROYW1lOiBhc3NldC5zM0J1Y2tldE5hbWUsXG4gICAgICAgICAgT2JqZWN0S2V5OiBhc3NldC5zM09iamVjdEtleSxcbiAgICAgICAgfSkpLFxuICAgICAgICBEZXN0aW5hdGlvbkJ1Y2tldE5hbWU6IHRoaXMuY2RrLmJ1Y2tldC5idWNrZXROYW1lLFxuICAgICAgICBGaWxlT3B0aW9uczogKGZpbGVPcHRpb25zIHx8IFtdKS5tYXAoXG4gICAgICAgICAgKHsgZXhjbHVkZSwgaW5jbHVkZSwgY2FjaGVDb250cm9sIH0pID0+IHtcbiAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgIFwiLS1leGNsdWRlXCIsXG4gICAgICAgICAgICAgIGV4Y2x1ZGUsXG4gICAgICAgICAgICAgIFwiLS1pbmNsdWRlXCIsXG4gICAgICAgICAgICAgIGluY2x1ZGUsXG4gICAgICAgICAgICAgIFwiLS1jYWNoZS1jb250cm9sXCIsXG4gICAgICAgICAgICAgIGNhY2hlQ29udHJvbCxcbiAgICAgICAgICAgIF07XG4gICAgICAgICAgfVxuICAgICAgICApLFxuICAgICAgICBSZXBsYWNlVmFsdWVzOiB0aGlzLmdldFMzQ29udGVudFJlcGxhY2VWYWx1ZXMoKSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gQ2xvdWRGcm9udCBEaXN0cmlidXRpb25cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgcHJpdmF0ZSBjcmVhdGVDbG91ZEZyb250RGlzdHJpYnV0aW9uKCk6IGNsb3VkZnJvbnQuRGlzdHJpYnV0aW9uIHtcbiAgICBjb25zdCB7IGNkaywgY3VzdG9tRG9tYWluIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IGNmRGlzdHJpYnV0aW9uUHJvcHMgPSBjZGs/LmRpc3RyaWJ1dGlvbiB8fCB7fTtcblxuICAgIC8vIFZhbGlkYXRlIGlucHV0XG4gICAgaWYgKGNmRGlzdHJpYnV0aW9uUHJvcHMuY2VydGlmaWNhdGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYERvIG5vdCBjb25maWd1cmUgdGhlIFwiY2ZEaXN0cmlidXRpb24uY2VydGlmaWNhdGVcIi4gVXNlIHRoZSBcImN1c3RvbURvbWFpblwiIHRvIGNvbmZpZ3VyZSB0aGUgTmV4dGpzU2l0ZSBkb21haW4gY2VydGlmaWNhdGUuYFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKGNmRGlzdHJpYnV0aW9uUHJvcHMuZG9tYWluTmFtZXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYERvIG5vdCBjb25maWd1cmUgdGhlIFwiY2ZEaXN0cmlidXRpb24uZG9tYWluTmFtZXNcIi4gVXNlIHRoZSBcImN1c3RvbURvbWFpblwiIHRvIGNvbmZpZ3VyZSB0aGUgTmV4dGpzU2l0ZSBkb21haW4uYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBCdWlsZCBkb21haW5OYW1lc1xuICAgIGNvbnN0IGRvbWFpbk5hbWVzID0gW107XG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIC8vIG5vIGRvbWFpblxuICAgIH0gZWxzZSBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgZG9tYWluTmFtZXMucHVzaChjdXN0b21Eb21haW4pO1xuICAgIH0gZWxzZSB7XG4gICAgICBkb21haW5OYW1lcy5wdXNoKGN1c3RvbURvbWFpbi5kb21haW5OYW1lKTtcbiAgICB9XG5cbiAgICAvLyBCdWlsZCBiZWhhdmlvclxuICAgIGNvbnN0IG9yaWdpbiA9IG5ldyBvcmlnaW5zLlMzT3JpZ2luKHRoaXMuY2RrLmJ1Y2tldCk7XG4gICAgY29uc3Qgdmlld2VyUHJvdG9jb2xQb2xpY3kgPVxuICAgICAgY2xvdWRmcm9udC5WaWV3ZXJQcm90b2NvbFBvbGljeS5SRURJUkVDVF9UT19IVFRQUztcblxuICAgIGlmICh0aGlzLmlzUGxhY2Vob2xkZXIpIHtcbiAgICAgIHJldHVybiBuZXcgY2xvdWRmcm9udC5EaXN0cmlidXRpb24odGhpcywgXCJEaXN0cmlidXRpb25cIiwge1xuICAgICAgICBkZWZhdWx0Um9vdE9iamVjdDogXCJpbmRleC5odG1sXCIsXG4gICAgICAgIGVycm9yUmVzcG9uc2VzOiBidWlsZEVycm9yUmVzcG9uc2VzRm9yUmVkaXJlY3RUb0luZGV4KFwiaW5kZXguaHRtbFwiKSxcbiAgICAgICAgZG9tYWluTmFtZXMsXG4gICAgICAgIGNlcnRpZmljYXRlOiB0aGlzLmNkay5jZXJ0aWZpY2F0ZSxcbiAgICAgICAgZGVmYXVsdEJlaGF2aW9yOiB7XG4gICAgICAgICAgb3JpZ2luLFxuICAgICAgICAgIHZpZXdlclByb3RvY29sUG9saWN5LFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQnVpbGQgRWRnZSBmdW5jdGlvbnNcbiAgICBjb25zdCBlZGdlTGFtYmRhczogY2xvdWRmcm9udC5FZGdlTGFtYmRhW10gPSBbXG4gICAgICB7XG4gICAgICAgIGluY2x1ZGVCb2R5OiB0cnVlLFxuICAgICAgICBldmVudFR5cGU6IGNsb3VkZnJvbnQuTGFtYmRhRWRnZUV2ZW50VHlwZS5PUklHSU5fUkVRVUVTVCxcbiAgICAgICAgZnVuY3Rpb25WZXJzaW9uOiB0aGlzLm1haW5GdW5jdGlvblZlcnNpb24sXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBldmVudFR5cGU6IGNsb3VkZnJvbnQuTGFtYmRhRWRnZUV2ZW50VHlwZS5PUklHSU5fUkVTUE9OU0UsXG4gICAgICAgIGZ1bmN0aW9uVmVyc2lvbjogdGhpcy5tYWluRnVuY3Rpb25WZXJzaW9uLFxuICAgICAgfSxcbiAgICBdO1xuXG4gICAgLy8gQnVpbGQgY2FjaGUgcG9saWN5XG4gICAgY29uc3Qgc3RhdGljQ2FjaGVQb2xpY3kgPVxuICAgICAgY2RrPy5jYWNoZVBvbGljaWVzPy5zdGF0aWNDYWNoZVBvbGljeSA/P1xuICAgICAgdGhpcy5jcmVhdGVDbG91ZEZyb250U3RhdGljQ2FjaGVQb2xpY3koKTtcbiAgICBjb25zdCBpbWFnZUNhY2hlUG9saWN5ID1cbiAgICAgIGNkaz8uY2FjaGVQb2xpY2llcz8uaW1hZ2VDYWNoZVBvbGljeSA/P1xuICAgICAgdGhpcy5jcmVhdGVDbG91ZEZyb250SW1hZ2VDYWNoZVBvbGljeSgpO1xuICAgIGNvbnN0IGxhbWJkYUNhY2hlUG9saWN5ID1cbiAgICAgIGNkaz8uY2FjaGVQb2xpY2llcz8ubGFtYmRhQ2FjaGVQb2xpY3kgPz9cbiAgICAgIHRoaXMuY3JlYXRlQ2xvdWRGcm9udExhbWJkYUNhY2hlUG9saWN5KCk7XG5cbiAgICAvLyBDcmVhdGUgRGlzdHJpYnV0aW9uXG4gICAgcmV0dXJuIG5ldyBjbG91ZGZyb250LkRpc3RyaWJ1dGlvbih0aGlzLCBcIkRpc3RyaWJ1dGlvblwiLCB7XG4gICAgICAvLyB0aGVzZSB2YWx1ZXMgY2FuIGJlIG92ZXJ3cml0dGVuIGJ5IGNmRGlzdHJpYnV0aW9uUHJvcHNcbiAgICAgIGRlZmF1bHRSb290T2JqZWN0OiBcIlwiLFxuICAgICAgLy8gT3ZlcnJpZGUgcHJvcHMuXG4gICAgICAuLi5jZkRpc3RyaWJ1dGlvblByb3BzLFxuICAgICAgLy8gdGhlc2UgdmFsdWVzIGNhbiBOT1QgYmUgb3ZlcndyaXR0ZW4gYnkgY2ZEaXN0cmlidXRpb25Qcm9wc1xuICAgICAgZG9tYWluTmFtZXMsXG4gICAgICBjZXJ0aWZpY2F0ZTogdGhpcy5jZGsuY2VydGlmaWNhdGUsXG4gICAgICBkZWZhdWx0QmVoYXZpb3I6IHtcbiAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3ksXG4gICAgICAgIG9yaWdpbixcbiAgICAgICAgYWxsb3dlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQWxsb3dlZE1ldGhvZHMuQUxMT1dfR0VUX0hFQURfT1BUSU9OUyxcbiAgICAgICAgY2FjaGVkTWV0aG9kczogY2xvdWRmcm9udC5DYWNoZWRNZXRob2RzLkNBQ0hFX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgIGNvbXByZXNzOiB0cnVlLFxuICAgICAgICBjYWNoZVBvbGljeTogbGFtYmRhQ2FjaGVQb2xpY3ksXG4gICAgICAgIC4uLihjZkRpc3RyaWJ1dGlvblByb3BzLmRlZmF1bHRCZWhhdmlvciB8fCB7fSksXG4gICAgICAgIC8vIGNvbmNhdGVuYXRlIGVkZ2VMYW1iZGFzXG4gICAgICAgIGVkZ2VMYW1iZGFzOiBbXG4gICAgICAgICAgLi4uZWRnZUxhbWJkYXMsXG4gICAgICAgICAgLi4uKGNmRGlzdHJpYnV0aW9uUHJvcHMuZGVmYXVsdEJlaGF2aW9yPy5lZGdlTGFtYmRhcyB8fCBbXSksXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgICAgYWRkaXRpb25hbEJlaGF2aW9yczoge1xuICAgICAgICBbdGhpcy5wYXRoUGF0dGVybihcIl9uZXh0L2ltYWdlKlwiKV06IHtcbiAgICAgICAgICB2aWV3ZXJQcm90b2NvbFBvbGljeSxcbiAgICAgICAgICBvcmlnaW4sXG4gICAgICAgICAgYWxsb3dlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQWxsb3dlZE1ldGhvZHMuQUxMT1dfQUxMLFxuICAgICAgICAgIGNhY2hlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQ2FjaGVkTWV0aG9kcy5DQUNIRV9HRVRfSEVBRF9PUFRJT05TLFxuICAgICAgICAgIGNvbXByZXNzOiB0cnVlLFxuICAgICAgICAgIGNhY2hlUG9saWN5OiBpbWFnZUNhY2hlUG9saWN5LFxuICAgICAgICAgIG9yaWdpblJlcXVlc3RQb2xpY3k6IG5ldyBjbG91ZGZyb250Lk9yaWdpblJlcXVlc3RQb2xpY3koXG4gICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgXCJJbWFnZU9yaWdpblJlcXVlc3RcIixcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgcXVlcnlTdHJpbmdCZWhhdmlvcjpcbiAgICAgICAgICAgICAgICBjbG91ZGZyb250Lk9yaWdpblJlcXVlc3RRdWVyeVN0cmluZ0JlaGF2aW9yLmFsbCgpLFxuICAgICAgICAgICAgfVxuICAgICAgICAgICksXG4gICAgICAgICAgZWRnZUxhbWJkYXM6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgZXZlbnRUeXBlOiBjbG91ZGZyb250LkxhbWJkYUVkZ2VFdmVudFR5cGUuT1JJR0lOX1JFUVVFU1QsXG4gICAgICAgICAgICAgIGZ1bmN0aW9uVmVyc2lvbjogdGhpcy5pbWFnZUZ1bmN0aW9uVmVyc2lvbixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgICAgW3RoaXMucGF0aFBhdHRlcm4oXCJfbmV4dC9kYXRhLypcIildOiB7XG4gICAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3ksXG4gICAgICAgICAgb3JpZ2luLFxuICAgICAgICAgIGFsbG93ZWRNZXRob2RzOiBjbG91ZGZyb250LkFsbG93ZWRNZXRob2RzLkFMTE9XX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY2FjaGVkTWV0aG9kczogY2xvdWRmcm9udC5DYWNoZWRNZXRob2RzLkNBQ0hFX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY29tcHJlc3M6IHRydWUsXG4gICAgICAgICAgY2FjaGVQb2xpY3k6IGxhbWJkYUNhY2hlUG9saWN5LFxuICAgICAgICAgIGVkZ2VMYW1iZGFzLFxuICAgICAgICB9LFxuICAgICAgICBbdGhpcy5wYXRoUGF0dGVybihcIl9uZXh0LypcIildOiB7XG4gICAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3ksXG4gICAgICAgICAgb3JpZ2luLFxuICAgICAgICAgIGFsbG93ZWRNZXRob2RzOiBjbG91ZGZyb250LkFsbG93ZWRNZXRob2RzLkFMTE9XX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY2FjaGVkTWV0aG9kczogY2xvdWRmcm9udC5DYWNoZWRNZXRob2RzLkNBQ0hFX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY29tcHJlc3M6IHRydWUsXG4gICAgICAgICAgY2FjaGVQb2xpY3k6IHN0YXRpY0NhY2hlUG9saWN5LFxuICAgICAgICB9LFxuICAgICAgICBbdGhpcy5wYXRoUGF0dGVybihcInN0YXRpYy8qXCIpXToge1xuICAgICAgICAgIHZpZXdlclByb3RvY29sUG9saWN5LFxuICAgICAgICAgIG9yaWdpbixcbiAgICAgICAgICBhbGxvd2VkTWV0aG9kczogY2xvdWRmcm9udC5BbGxvd2VkTWV0aG9kcy5BTExPV19HRVRfSEVBRF9PUFRJT05TLFxuICAgICAgICAgIGNhY2hlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQ2FjaGVkTWV0aG9kcy5DQUNIRV9HRVRfSEVBRF9PUFRJT05TLFxuICAgICAgICAgIGNvbXByZXNzOiB0cnVlLFxuICAgICAgICAgIGNhY2hlUG9saWN5OiBzdGF0aWNDYWNoZVBvbGljeSxcbiAgICAgICAgfSxcbiAgICAgICAgW3RoaXMucGF0aFBhdHRlcm4oXCJhcGkvKlwiKV06IHtcbiAgICAgICAgICB2aWV3ZXJQcm90b2NvbFBvbGljeSxcbiAgICAgICAgICBvcmlnaW4sXG4gICAgICAgICAgYWxsb3dlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQWxsb3dlZE1ldGhvZHMuQUxMT1dfQUxMLFxuICAgICAgICAgIGNhY2hlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQ2FjaGVkTWV0aG9kcy5DQUNIRV9HRVRfSEVBRF9PUFRJT05TLFxuICAgICAgICAgIGNvbXByZXNzOiB0cnVlLFxuICAgICAgICAgIGNhY2hlUG9saWN5OiBsYW1iZGFDYWNoZVBvbGljeSxcbiAgICAgICAgICBlZGdlTGFtYmRhczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBpbmNsdWRlQm9keTogdHJ1ZSxcbiAgICAgICAgICAgICAgZXZlbnRUeXBlOiBjbG91ZGZyb250LkxhbWJkYUVkZ2VFdmVudFR5cGUuT1JJR0lOX1JFUVVFU1QsXG4gICAgICAgICAgICAgIGZ1bmN0aW9uVmVyc2lvbjogdGhpcy5hcGlGdW5jdGlvblZlcnNpb24sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICAgIC4uLihjZkRpc3RyaWJ1dGlvblByb3BzLmFkZGl0aW9uYWxCZWhhdmlvcnMgfHwge30pLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ2xvdWRGcm9udFN0YXRpY0NhY2hlUG9saWN5KCk6IGNsb3VkZnJvbnQuQ2FjaGVQb2xpY3kge1xuICAgIHJldHVybiBuZXcgY2xvdWRmcm9udC5DYWNoZVBvbGljeShcbiAgICAgIHRoaXMsXG4gICAgICBcIlN0YXRpY3NDYWNoZVwiLFxuICAgICAgTmV4dGpzU2l0ZS5zdGF0aWNDYWNoZVBvbGljeVByb3BzXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ2xvdWRGcm9udEltYWdlQ2FjaGVQb2xpY3koKTogY2xvdWRmcm9udC5DYWNoZVBvbGljeSB7XG4gICAgcmV0dXJuIG5ldyBjbG91ZGZyb250LkNhY2hlUG9saWN5KFxuICAgICAgdGhpcyxcbiAgICAgIFwiSW1hZ2VDYWNoZVwiLFxuICAgICAgTmV4dGpzU2l0ZS5pbWFnZUNhY2hlUG9saWN5UHJvcHNcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDbG91ZEZyb250TGFtYmRhQ2FjaGVQb2xpY3koKTogY2xvdWRmcm9udC5DYWNoZVBvbGljeSB7XG4gICAgcmV0dXJuIG5ldyBjbG91ZGZyb250LkNhY2hlUG9saWN5KFxuICAgICAgdGhpcyxcbiAgICAgIFwiTGFtYmRhQ2FjaGVcIixcbiAgICAgIE5leHRqc1NpdGUubGFtYmRhQ2FjaGVQb2xpY3lQcm9wc1xuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUNsb3VkRnJvbnRJbnZhbGlkYXRpb24oKTogQ3VzdG9tUmVzb3VyY2Uge1xuICAgIC8vIENyZWF0ZSBhIExhbWJkYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgZG9pbmcgdGhlIGludmFsaWRhdGlvblxuICAgIGNvbnN0IGludmFsaWRhdG9yID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBcIkNsb3VkRnJvbnRJbnZhbGlkYXRvclwiLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL0Jhc2VTaXRlL2N1c3RvbS1yZXNvdXJjZVwiKVxuICAgICAgKSxcbiAgICAgIGxheWVyczogW3RoaXMuYXdzQ2xpTGF5ZXJdLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfNyxcbiAgICAgIGhhbmRsZXI6IFwiY2YtaW52YWxpZGF0ZS5oYW5kbGVyXCIsXG4gICAgICB0aW1lb3V0OiBEdXJhdGlvbi5taW51dGVzKDE1KSxcbiAgICAgIG1lbW9yeVNpemU6IDEwMjQsXG4gICAgfSk7XG5cbiAgICAvLyBHcmFudCBwZXJtaXNzaW9ucyB0byBpbnZhbGlkYXRlIENGIERpc3RyaWJ1dGlvblxuICAgIGludmFsaWRhdG9yLmFkZFRvUm9sZVBvbGljeShcbiAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgXCJjbG91ZGZyb250OkdldEludmFsaWRhdGlvblwiLFxuICAgICAgICAgIFwiY2xvdWRmcm9udDpDcmVhdGVJbnZhbGlkYXRpb25cIixcbiAgICAgICAgXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbXCIqXCJdLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgLy8gbmVlZCB0aGUgQnVpbGRJZCBmaWVsZCBzbyB0aGlzIENSIGdldHMgdXBkYXRlZCBvbiBlYWNoIGRlcGxveVxuICAgIGxldCBidWlsZElkOiBzdHJpbmc7XG4gICAgaWYgKHRoaXMuaXNQbGFjZWhvbGRlcikge1xuICAgICAgYnVpbGRJZCA9IFwibGl2ZVwiO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBidWlsZElkRmlsZSA9IHBhdGgucmVzb2x2ZSh0aGlzLmJ1aWxkT3V0RGlyISwgXCJhc3NldHNcIiwgXCJCVUlMRF9JRFwiKTtcbiAgICAgIGJ1aWxkSWQgPSBmcy5yZWFkRmlsZVN5bmMoYnVpbGRJZEZpbGUpLnRvU3RyaW5nKCk7XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIGN1c3RvbSByZXNvdXJjZVxuICAgIGNvbnN0IHdhaXRGb3JJbnZhbGlkYXRpb24gPVxuICAgICAgdGhpcy5wcm9wcy53YWl0Rm9ySW52YWxpZGF0aW9uID09PSBmYWxzZSA/IGZhbHNlIDogdHJ1ZTtcbiAgICByZXR1cm4gbmV3IEN1c3RvbVJlc291cmNlKHRoaXMsIFwiQ2xvdWRGcm9udEludmFsaWRhdGlvblwiLCB7XG4gICAgICBzZXJ2aWNlVG9rZW46IGludmFsaWRhdG9yLmZ1bmN0aW9uQXJuLFxuICAgICAgcmVzb3VyY2VUeXBlOiBcIkN1c3RvbTo6U1NUQ2xvdWRGcm9udEludmFsaWRhdGlvblwiLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICBCdWlsZElkOiBidWlsZElkLFxuICAgICAgICBEaXN0cmlidXRpb25JZDogdGhpcy5jZGsuZGlzdHJpYnV0aW9uLmRpc3RyaWJ1dGlvbklkLFxuICAgICAgICBEaXN0cmlidXRpb25QYXRoczogW1wiLypcIl0sXG4gICAgICAgIFdhaXRGb3JJbnZhbGlkYXRpb246IHdhaXRGb3JJbnZhbGlkYXRpb24sXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vIEN1c3RvbSBEb21haW5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgcHJvdGVjdGVkIHZhbGlkYXRlQ3VzdG9tRG9tYWluU2V0dGluZ3MoKSB7XG4gICAgY29uc3QgeyBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG5cbiAgICBpZiAoIWN1c3RvbURvbWFpbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGN1c3RvbURvbWFpbi5pc0V4dGVybmFsRG9tYWluID09PSB0cnVlKSB7XG4gICAgICBpZiAoIWN1c3RvbURvbWFpbi5jZGs/LmNlcnRpZmljYXRlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQSB2YWxpZCBjZXJ0aWZpY2F0ZSBpcyByZXF1aXJlZCB3aGVuIFwiaXNFeHRlcm5hbERvbWFpblwiIGlzIHNldCB0byBcInRydWVcIi5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoY3VzdG9tRG9tYWluLmRvbWFpbkFsaWFzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgRG9tYWluIGFsaWFzIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBkb21haW5zIGhvc3RlZCBvbiBBbWF6b24gUm91dGUgNTMuIERvIG5vdCBzZXQgdGhlIFwiY3VzdG9tRG9tYWluLmRvbWFpbkFsaWFzXCIgd2hlbiBcImlzRXh0ZXJuYWxEb21haW5cIiBpcyBlbmFibGVkLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChjdXN0b21Eb21haW4uaG9zdGVkWm9uZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEhvc3RlZCB6b25lcyBjYW4gb25seSBiZSBjb25maWd1cmVkIGZvciBkb21haW5zIGhvc3RlZCBvbiBBbWF6b24gUm91dGUgNTMuIERvIG5vdCBzZXQgdGhlIFwiY3VzdG9tRG9tYWluLmhvc3RlZFpvbmVcIiB3aGVuIFwiaXNFeHRlcm5hbERvbWFpblwiIGlzIGVuYWJsZWQuYFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBsb29rdXBIb3N0ZWRab25lKCk6IHJvdXRlNTMuSUhvc3RlZFpvbmUgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHsgY3VzdG9tRG9tYWluIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgLy8gU2tpcCBpZiBjdXN0b21Eb21haW4gaXMgbm90IGNvbmZpZ3VyZWRcbiAgICBpZiAoIWN1c3RvbURvbWFpbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBob3N0ZWRab25lO1xuXG4gICAgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGhvc3RlZFpvbmUgPSByb3V0ZTUzLkhvc3RlZFpvbmUuZnJvbUxvb2t1cCh0aGlzLCBcIkhvc3RlZFpvbmVcIiwge1xuICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW4sXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKGN1c3RvbURvbWFpbi5jZGs/Lmhvc3RlZFpvbmUpIHtcbiAgICAgIGhvc3RlZFpvbmUgPSBjdXN0b21Eb21haW4uY2RrLmhvc3RlZFpvbmU7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGhvc3RlZFpvbmUgPSByb3V0ZTUzLkhvc3RlZFpvbmUuZnJvbUxvb2t1cCh0aGlzLCBcIkhvc3RlZFpvbmVcIiwge1xuICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW4uaG9zdGVkWm9uZSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGN1c3RvbURvbWFpbi5kb21haW5OYW1lID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAvLyBTa2lwIGlmIGRvbWFpbiBpcyBub3QgYSBSb3V0ZTUzIGRvbWFpblxuICAgICAgaWYgKGN1c3RvbURvbWFpbi5pc0V4dGVybmFsRG9tYWluID09PSB0cnVlKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaG9zdGVkWm9uZSA9IHJvdXRlNTMuSG9zdGVkWm9uZS5mcm9tTG9va3VwKHRoaXMsIFwiSG9zdGVkWm9uZVwiLCB7XG4gICAgICAgIGRvbWFpbk5hbWU6IGN1c3RvbURvbWFpbi5kb21haW5OYW1lLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGhvc3RlZFpvbmUgPSBjdXN0b21Eb21haW4uaG9zdGVkWm9uZTtcbiAgICB9XG5cbiAgICByZXR1cm4gaG9zdGVkWm9uZTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ2VydGlmaWNhdGUoKTogYWNtLklDZXJ0aWZpY2F0ZSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgeyBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG5cbiAgICBpZiAoIWN1c3RvbURvbWFpbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBhY21DZXJ0aWZpY2F0ZTtcblxuICAgIC8vIEhvc3RlZFpvbmUgaXMgc2V0IGZvciBSb3V0ZSA1MyBkb21haW5zXG4gICAgaWYgKHRoaXMuY2RrLmhvc3RlZFpvbmUpIHtcbiAgICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIGFjbUNlcnRpZmljYXRlID0gbmV3IGFjbS5EbnNWYWxpZGF0ZWRDZXJ0aWZpY2F0ZSh0aGlzLCBcIkNlcnRpZmljYXRlXCIsIHtcbiAgICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW4sXG4gICAgICAgICAgaG9zdGVkWm9uZTogdGhpcy5jZGsuaG9zdGVkWm9uZSxcbiAgICAgICAgICByZWdpb246IFwidXMtZWFzdC0xXCIsXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmIChjdXN0b21Eb21haW4uY2RrPy5jZXJ0aWZpY2F0ZSkge1xuICAgICAgICBhY21DZXJ0aWZpY2F0ZSA9IGN1c3RvbURvbWFpbi5jZGsuY2VydGlmaWNhdGU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhY21DZXJ0aWZpY2F0ZSA9IG5ldyBhY20uRG5zVmFsaWRhdGVkQ2VydGlmaWNhdGUodGhpcywgXCJDZXJ0aWZpY2F0ZVwiLCB7XG4gICAgICAgICAgZG9tYWluTmFtZTogY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUsXG4gICAgICAgICAgaG9zdGVkWm9uZTogdGhpcy5jZGsuaG9zdGVkWm9uZSxcbiAgICAgICAgICByZWdpb246IFwidXMtZWFzdC0xXCIsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyBIb3N0ZWRab25lIGlzIE5PVCBzZXQgZm9yIG5vbi1Sb3V0ZSA1MyBkb21haW5zXG4gICAgZWxzZSB7XG4gICAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgICBhY21DZXJ0aWZpY2F0ZSA9IGN1c3RvbURvbWFpbi5jZGs/LmNlcnRpZmljYXRlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBhY21DZXJ0aWZpY2F0ZTtcbiAgfVxuXG4gIHByb3RlY3RlZCBjcmVhdGVSb3V0ZTUzUmVjb3JkcygpOiB2b2lkIHtcbiAgICBjb25zdCB7IGN1c3RvbURvbWFpbiB9ID0gdGhpcy5wcm9wcztcblxuICAgIGlmICghY3VzdG9tRG9tYWluIHx8ICF0aGlzLmNkay5ob3N0ZWRab25lKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IHJlY29yZE5hbWU7XG4gICAgbGV0IGRvbWFpbkFsaWFzO1xuICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgICByZWNvcmROYW1lID0gY3VzdG9tRG9tYWluO1xuICAgIH0gZWxzZSB7XG4gICAgICByZWNvcmROYW1lID0gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWU7XG4gICAgICBkb21haW5BbGlhcyA9IGN1c3RvbURvbWFpbi5kb21haW5BbGlhcztcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgRE5TIHJlY29yZFxuICAgIGNvbnN0IHJlY29yZFByb3BzID0ge1xuICAgICAgcmVjb3JkTmFtZSxcbiAgICAgIHpvbmU6IHRoaXMuY2RrLmhvc3RlZFpvbmUsXG4gICAgICB0YXJnZXQ6IHJvdXRlNTMuUmVjb3JkVGFyZ2V0LmZyb21BbGlhcyhcbiAgICAgICAgbmV3IHJvdXRlNTNUYXJnZXRzLkNsb3VkRnJvbnRUYXJnZXQodGhpcy5jZGsuZGlzdHJpYnV0aW9uKVxuICAgICAgKSxcbiAgICB9O1xuICAgIG5ldyByb3V0ZTUzLkFSZWNvcmQodGhpcywgXCJBbGlhc1JlY29yZFwiLCByZWNvcmRQcm9wcyk7XG4gICAgbmV3IHJvdXRlNTMuQWFhYVJlY29yZCh0aGlzLCBcIkFsaWFzUmVjb3JkQUFBQVwiLCByZWNvcmRQcm9wcyk7XG5cbiAgICAvLyBDcmVhdGUgQWxpYXMgcmVkaXJlY3QgcmVjb3JkXG4gICAgaWYgKGRvbWFpbkFsaWFzKSB7XG4gICAgICBuZXcgcm91dGU1M1BhdHRlcm5zLkh0dHBzUmVkaXJlY3QodGhpcywgXCJSZWRpcmVjdFwiLCB7XG4gICAgICAgIHpvbmU6IHRoaXMuY2RrLmhvc3RlZFpvbmUsXG4gICAgICAgIHJlY29yZE5hbWVzOiBbZG9tYWluQWxpYXNdLFxuICAgICAgICB0YXJnZXREb21haW46IHJlY29yZE5hbWUsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gSGVscGVyIEZ1bmN0aW9uc1xuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICBwcml2YXRlIHBhdGhQYXR0ZXJuKHBhdHRlcm46IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgeyBiYXNlUGF0aCB9ID0gdGhpcy5yb3V0ZXNNYW5pZmVzdCB8fCB7fTtcbiAgICByZXR1cm4gYmFzZVBhdGggJiYgYmFzZVBhdGgubGVuZ3RoID4gMFxuICAgICAgPyBgJHtiYXNlUGF0aC5zbGljZSgxKX0vJHtwYXR0ZXJufWBcbiAgICAgIDogcGF0dGVybjtcbiAgfVxuXG4gIHByaXZhdGUgcmVhZFJvdXRlc01hbmlmZXN0KCk6IFJvdXRlc01hbmlmZXN0IHtcbiAgICByZXR1cm4gZnMucmVhZEpTT05TeW5jKFxuICAgICAgcGF0aC5qb2luKHRoaXMuYnVpbGRPdXREaXIhLCBcImRlZmF1bHQtbGFtYmRhL3JvdXRlcy1tYW5pZmVzdC5qc29uXCIpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UzNDb250ZW50UmVwbGFjZVZhbHVlcygpOiBCYXNlU2l0ZVJlcGxhY2VQcm9wc1tdIHtcbiAgICBjb25zdCByZXBsYWNlVmFsdWVzOiBCYXNlU2l0ZVJlcGxhY2VQcm9wc1tdID0gW107XG5cbiAgICBPYmplY3QuZW50cmllcyh0aGlzLnByb3BzLmVudmlyb25tZW50IHx8IHt9KVxuICAgICAgLmZpbHRlcigoWywgdmFsdWVdKSA9PiBUb2tlbi5pc1VucmVzb2x2ZWQodmFsdWUpKVxuICAgICAgLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgICBjb25zdCB0b2tlbiA9IGB7eyAke2tleX0gfX1gO1xuICAgICAgICByZXBsYWNlVmFsdWVzLnB1c2goXG4gICAgICAgICAge1xuICAgICAgICAgICAgZmlsZXM6IFwiKiovKi5odG1sXCIsXG4gICAgICAgICAgICBzZWFyY2g6IHRva2VuLFxuICAgICAgICAgICAgcmVwbGFjZTogdmFsdWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBmaWxlczogXCIqKi8qLmpzXCIsXG4gICAgICAgICAgICBzZWFyY2g6IHRva2VuLFxuICAgICAgICAgICAgcmVwbGFjZTogdmFsdWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBmaWxlczogXCIqKi8qLmpzb25cIixcbiAgICAgICAgICAgIHNlYXJjaDogdG9rZW4sXG4gICAgICAgICAgICByZXBsYWNlOiB2YWx1ZSxcbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICByZXR1cm4gcmVwbGFjZVZhbHVlcztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0TGFtYmRhQ29udGVudFJlcGxhY2VWYWx1ZXMoKTogQmFzZVNpdGVSZXBsYWNlUHJvcHNbXSB7XG4gICAgY29uc3QgcmVwbGFjZVZhbHVlczogQmFzZVNpdGVSZXBsYWNlUHJvcHNbXSA9IFtdO1xuXG4gICAgLy8gVGhlIE5leHQuanMgYXBwIGNhbiBoYXZlIGVudmlyb25tZW50IHZhcmlhYmxlcyBsaWtlXG4gICAgLy8gYHByb2Nlc3MuZW52LkFQSV9VUkxgIGluIHRoZSBKUyBjb2RlLiBgcHJvY2Vzcy5lbnYuQVBJX1VSTGAgbWlnaHQgb3JcbiAgICAvLyBtaWdodCBub3QgZ2V0IHJlc29sdmVkIG9uIGBuZXh0IGJ1aWxkYCBpZiBpdCBpcyB1c2VkIGluXG4gICAgLy8gc2VydmVyLXNpZGUgZnVuY3Rpb25zLCBpZS4gZ2V0U2VydmVyU2lkZVByb3BzKCkuXG4gICAgLy8gQmVjYXVzZSBMYW1iZGFARWRnZSBkb2VzIG5vdCBzdXBwb3J0IGVudmlyb25tZW50IHZhcmlhYmxlcywgd2Ugd2lsbFxuICAgIC8vIHVzZSB0aGUgdHJpY2sgb2YgcmVwbGFjaW5nIFwie3sgX1NTVF9ORVhUSlNfU0lURV9FTlZJUk9OTUVOVF8gfX1cIiB3aXRoXG4gICAgLy8gYSBKU09OIGVuY29kZWQgc3RyaW5nIG9mIGFsbCBlbnZpcm9ubWVudCBrZXktdmFsdWUgcGFpcnMuIFRoaXMgc3RyaW5nXG4gICAgLy8gd2lsbCB0aGVuIGdldCBkZWNvZGVkIGF0IHJ1biB0aW1lLlxuICAgIGNvbnN0IGxhbWJkYUVudnM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gPSB7fTtcblxuICAgIE9iamVjdC5lbnRyaWVzKHRoaXMucHJvcHMuZW52aXJvbm1lbnQgfHwge30pLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgY29uc3QgdG9rZW4gPSBge3sgJHtrZXl9IH19YDtcbiAgICAgIHJlcGxhY2VWYWx1ZXMucHVzaChcbiAgICAgICAge1xuICAgICAgICAgIGZpbGVzOiBcIioqLyouaHRtbFwiLFxuICAgICAgICAgIHNlYXJjaDogdG9rZW4sXG4gICAgICAgICAgcmVwbGFjZTogdmFsdWUsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBmaWxlczogXCIqKi8qLmpzXCIsXG4gICAgICAgICAgc2VhcmNoOiB0b2tlbixcbiAgICAgICAgICByZXBsYWNlOiB2YWx1ZSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGZpbGVzOiBcIioqLyouanNvblwiLFxuICAgICAgICAgIHNlYXJjaDogdG9rZW4sXG4gICAgICAgICAgcmVwbGFjZTogdmFsdWUsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICBsYW1iZGFFbnZzW2tleV0gPSB2YWx1ZTtcbiAgICB9KTtcblxuICAgIHJlcGxhY2VWYWx1ZXMucHVzaCh7XG4gICAgICBmaWxlczogXCIqKi8qLmpzXCIsXG4gICAgICBzZWFyY2g6ICdcInt7IF9TU1RfTkVYVEpTX1NJVEVfRU5WSVJPTk1FTlRfIH19XCInLFxuICAgICAgcmVwbGFjZTogSlNPTi5zdHJpbmdpZnkobGFtYmRhRW52cyksXG4gICAgfSk7XG5cbiAgICByZXR1cm4gcmVwbGFjZVZhbHVlcztcbiAgfVxuXG4gIHByaXZhdGUgcmVnaXN0ZXJTaXRlRW52aXJvbm1lbnQoKSB7XG4gICAgY29uc3QgZW52aXJvbm1lbnRPdXRwdXRzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXModGhpcy5wcm9wcy5lbnZpcm9ubWVudCB8fCB7fSkpIHtcbiAgICAgIGNvbnN0IG91dHB1dElkID0gYFNzdFNpdGVFbnZfJHtrZXl9YDtcbiAgICAgIGNvbnN0IG91dHB1dCA9IG5ldyBDZm5PdXRwdXQodGhpcywgb3V0cHV0SWQsIHsgdmFsdWUgfSk7XG4gICAgICBlbnZpcm9ubWVudE91dHB1dHNba2V5XSA9IFN0YWNrLm9mKHRoaXMpLmdldExvZ2ljYWxJZChvdXRwdXQpO1xuICAgIH1cblxuICAgIGNvbnN0IHJvb3QgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgcm9vdC5yZWdpc3RlclNpdGVFbnZpcm9ubWVudCh7XG4gICAgICBpZDogdGhpcy5ub2RlLmlkLFxuICAgICAgcGF0aDogdGhpcy5wcm9wcy5wYXRoLFxuICAgICAgc3RhY2s6IFN0YWNrLm9mKHRoaXMpLm5vZGUuaWQsXG4gICAgICBlbnZpcm9ubWVudE91dHB1dHMsXG4gICAgfSBhcyBCYXNlU2l0ZUVudmlyb25tZW50T3V0cHV0c0luZm8pO1xuICB9XG59XG4iXX0=