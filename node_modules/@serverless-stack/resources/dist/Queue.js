"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Queue = void 0;
const constructs_1 = require("constructs");
const sqs = __importStar(require("aws-cdk-lib/aws-sqs"));
const lambdaEventSources = __importStar(require("aws-cdk-lib/aws-lambda-event-sources"));
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
const duration_1 = require("./util/duration");
/////////////////////
// Construct
/////////////////////
/**
 * The `Queue` construct is a higher level CDK construct that makes it easy to create a [SQS Queues](https://aws.amazon.com/sqs/). You can create a queue by specifying a consumer function. And then publish to the queue from any part of your serverless app.
 *
 * This construct makes it easier to define a queue and a consumer. It also internally connects the consumer and queue together.
 *
 * @example
 * ### Using the minimal config
 *
 * ```js
 * import { Queue } from "@serverless-stack/resources";
 *
 * new Queue(stack, "Queue", {
 *   consumer: "src/queueConsumer.main",
 * });
 * ```
 */
class Queue extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.props = props || {};
        this.cdk = {};
        this.permissionsAttachedForAllConsumers = [];
        this.createQueue();
        if (props === null || props === void 0 ? void 0 : props.consumer) {
            this.addConsumer(this, props.consumer);
        }
    }
    /**
     * The ARN of the SQS Queue
     */
    get queueArn() {
        return this.cdk.queue.queueArn;
    }
    /**
     * The name of the SQS Queue
     */
    get queueName() {
        return this.cdk.queue.queueName;
    }
    /**
     * Adds a consumer after creating the queue. Note only one consumer can be added to a queue
     *
     * @example
     * ```js {3}
     * const queue = new Queue(stack, "Queue");
     * queue.addConsumer(props.stack, "src/function.handler");
     * ```
     */
    addConsumer(scope, consumer) {
        var _a;
        if (this.consumerFunction) {
            throw new Error("Cannot configure more than 1 consumer for a Queue");
        }
        // Parse consumer props
        let eventSourceProps;
        let functionDefinition;
        if (consumer.function) {
            consumer = consumer;
            eventSourceProps = (_a = consumer.cdk) === null || _a === void 0 ? void 0 : _a.eventSource;
            functionDefinition = consumer.function;
        }
        else {
            consumer = consumer;
            functionDefinition = consumer;
        }
        // Create function
        this.consumerFunction = Function_1.Function.fromDefinition(scope, `Consumer_${this.node.id}`, functionDefinition);
        this.consumerFunction.addEventSource(new lambdaEventSources.SqsEventSource(this.cdk.queue, eventSourceProps));
        // Attach permissions
        this.permissionsAttachedForAllConsumers.forEach((permissions) => {
            if (this.consumerFunction) {
                this.consumerFunction.attachPermissions(permissions);
            }
        });
    }
    /**
     * Attaches additional permissions to the consumer function
     *
     * @example
     * ```js
     * const queue = new Queue(stack, "Queue", {
     *   consumer: "src/function.handler",
     * });
     * queue.attachPermissions(["s3"]);
     * ```
     */
    attachPermissions(permissions) {
        if (this.consumerFunction) {
            this.consumerFunction.attachPermissions(permissions);
        }
        this.permissionsAttachedForAllConsumers.push(permissions);
    }
    getConstructMetadata() {
        return {
            type: "Queue",
            data: {
                name: this.cdk.queue.queueName,
                url: this.cdk.queue.queueUrl,
                consumer: (0, Construct_1.getFunctionRef)(this.consumerFunction),
            },
        };
    }
    createQueue() {
        const { cdk } = this.props;
        const root = this.node.root;
        const id = this.node.id;
        if ((0, Construct_1.isCDKConstruct)(cdk === null || cdk === void 0 ? void 0 : cdk.queue)) {
            this.cdk.queue = cdk === null || cdk === void 0 ? void 0 : cdk.queue;
        }
        else {
            const sqsQueueProps = (cdk === null || cdk === void 0 ? void 0 : cdk.queue) || {};
            // If debugIncreaseTimeout is enabled (ie. sst start):
            // - Set visibilityTimeout to > 900s. This is because Lambda timeout is
            //   set to 900s, and visibilityTimeout has to be greater or equal to it.
            //   This will give people more time to debug the function without timing
            //   out the request.
            let debugOverrideProps;
            if (root.debugIncreaseTimeout) {
                if (!sqsQueueProps.visibilityTimeout ||
                    sqsQueueProps.visibilityTimeout.toSeconds() < 900) {
                    // TODO
                    console.log((0, duration_1.toCdkDuration)("900 seconds"));
                    debugOverrideProps = {
                        visibilityTimeout: (0, duration_1.toCdkDuration)("900 seconds"),
                    };
                }
            }
            const name = root.logicalPrefixedName(id) + (sqsQueueProps.fifo ? ".fifo" : "");
            this.cdk.queue = new sqs.Queue(this, "Queue", Object.assign(Object.assign({ queueName: name }, sqsQueueProps), debugOverrideProps));
        }
    }
}
exports.Queue = Queue;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUXVldWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvUXVldWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBdUM7QUFDdkMseURBQTJDO0FBQzNDLHlGQUEyRTtBQUUzRSwyQ0FBMkU7QUFDM0UseUNBSW9CO0FBQ3BCLDhDQUFnRDtBQThFaEQscUJBQXFCO0FBQ3JCLFlBQVk7QUFDWixxQkFBcUI7QUFFckI7Ozs7Ozs7Ozs7Ozs7OztHQWVHO0FBQ0gsTUFBYSxLQUFNLFNBQVEsc0JBQVM7SUFjbEMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFrQjtRQUMxRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsR0FBRyxHQUFHLEVBQVMsQ0FBQztRQUNyQixJQUFJLENBQUMsa0NBQWtDLEdBQUcsRUFBRSxDQUFDO1FBRTdDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUVuQixJQUFJLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxRQUFRLEVBQUU7WUFDbkIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3hDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBVyxRQUFRO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDO0lBQ2pDLENBQUM7SUFFRDs7T0FFRztJQUNILElBQVcsU0FBUztRQUNsQixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQztJQUNsQyxDQUFDO0lBRUQ7Ozs7Ozs7O09BUUc7SUFDSSxXQUFXLENBQ2hCLEtBQWdCLEVBQ2hCLFFBQXVEOztRQUV2RCxJQUFJLElBQUksQ0FBQyxn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LGlCQUFpQixDQUFDLFNBQVMsRUFBRSxHQUFHLEdBQUcsRUFDakQ7b0JBQ0EsT0FBTztvQkFDUCxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUEsd0JBQWEsRUFBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO29CQUMxQyxrQkFBa0IsR0FBRzt3QkFDbkIsaUJBQWlCLEVBQUUsSUFBQSx3QkFBYSxFQUFDLGFBQWEsQ0FBQztxQkFDaEQsQ0FBQztpQkFDSDthQUNGO1lBRUQsTUFBTSxJQUFJLEdBQ1IsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNyRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLE9BQU8sZ0NBQzFDLFNBQVMsRUFBRSxJQUFJLElBQ1osYUFBYSxHQUNiLGtCQUFrQixFQUNyQixDQUFDO1NBQ0o7SUFDSCxDQUFDO0NBQ0Y7QUE3SkQsc0JBNkpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCAqIGFzIHNxcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXNxc1wiO1xuaW1wb3J0ICogYXMgbGFtYmRhRXZlbnRTb3VyY2VzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhLWV2ZW50LXNvdXJjZXNcIjtcbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgZ2V0RnVuY3Rpb25SZWYsIFNTVENvbnN0cnVjdCwgaXNDREtDb25zdHJ1Y3QgfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7XG4gIEZ1bmN0aW9uIGFzIEZuLFxuICBGdW5jdGlvbklubGluZURlZmluaXRpb24sXG4gIEZ1bmN0aW9uRGVmaW5pdGlvbixcbn0gZnJvbSBcIi4vRnVuY3Rpb25cIjtcbmltcG9ydCB7IHRvQ2RrRHVyYXRpb24gfSBmcm9tIFwiLi91dGlsL2R1cmF0aW9uXCI7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucyB9IGZyb20gXCIuL3V0aWwvcGVybWlzc2lvblwiO1xuaW1wb3J0IHsgVmFsaWRhdGUgfSBmcm9tIFwiLi91dGlsL3ZhbGlkYXRlXCI7XG5cbi8qKlxuICogVXNlZCB0byBkZWZpbmUgdGhlIGNvbnN1bWVyIGZvciB0aGUgcXVldWUgYW5kIGludm9jYXRpb24gZGV0YWlsc1xuICovXG5leHBvcnQgaW50ZXJmYWNlIFF1ZXVlQ29uc3VtZXJQcm9wcyB7XG4gIC8qKlxuICAgKiBVc2VkIHRvIGNyZWF0ZSB0aGUgY29uc3VtZXIgZnVuY3Rpb24gZm9yIHRoZSBxdWV1ZS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogbmV3IFF1ZXVlKHN0YWNrLCBcIlF1ZXVlXCIsIHtcbiAgICogICBjb25zdW1lcjoge1xuICAgKiAgICAgZnVuY3Rpb246IHtcbiAgICogICAgICAgaGFuZGxlcjogXCJzcmMvZnVuY3Rpb24uaGFuZGxlclwiLFxuICAgKiAgICAgICB0aW1lb3V0OiAxMCxcbiAgICogICAgIH0sXG4gICAqICAgfSxcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgZnVuY3Rpb246IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgY2RrPzoge1xuICAgIC8qKlxuICAgICAqIFRoaXMgYWxsb3dzIHlvdSB0byBvdmVycmlkZSB0aGUgZGVmYXVsdCBzZXR0aW5ncyB0aGlzIGNvbnN0cnVjdCB1c2VzIGludGVybmFsbHkgdG8gY3JlYXRlIHRoZSBjb25zdW1lci5cbiAgICAgKlxuICAgICAqIEBleGFtcGxlXG4gICAgICogYGBganNcbiAgICAgKiBuZXcgUXVldWUoc3RhY2ssIFwiUXVldWVcIiwge1xuICAgICAqICAgY29uc3VtZXI6IHtcbiAgICAgKiAgICAgZnVuY3Rpb246IFwidGVzdC9sYW1iZGEuaGFuZGxlclwiLFxuICAgICAqICAgICBjZGs6IHtcbiAgICAgKiAgICAgICBldmVudFNvdXJjZToge1xuICAgICAqICAgICAgICAgYmF0Y2hTaXplOiA1LFxuICAgICAqICAgICAgIH0sXG4gICAgICogICAgIH0sXG4gICAgICogICB9LFxuICAgICAqIH0pO1xuICAgICAqIGBgYFxuICAgICAqL1xuICAgIGV2ZW50U291cmNlPzogbGFtYmRhRXZlbnRTb3VyY2VzLlNxc0V2ZW50U291cmNlUHJvcHM7XG4gIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUXVldWVQcm9wcyB7XG4gIGNkaz86IHtcbiAgICAvKipcbiAgICAgKiBPdmVycmlkZSB0aGUgZGVmYXVsdCBzZXR0aW5ncyB0aGlzIGNvbnN0cnVjdCB1c2VzIGludGVybmFsbHkgdG8gY3JlYXRlIHRoZSBxdWV1ZS5cbiAgICAgKlxuICAgICAqIEBleGFtcGxlXG4gICAgICogYGBganNcbiAgICAgKiBuZXcgUXVldWUoc3RhY2ssIFwiUXVldWVcIiwge1xuICAgICAqICAgY29uc3VtZXI6IFwic3JjL2Z1bmN0aW9uLmhhbmRsZXJcIixcbiAgICAgKiAgIGNkazoge1xuICAgICAqICAgICBxdWV1ZToge1xuICAgICAqICAgICAgIGZpZm86IHRydWUsXG4gICAgICogICAgIH0sXG4gICAgICogICB9XG4gICAgICogfSk7XG4gICAgICogYGBgXG4gICAgICovXG4gICAgcXVldWU/OiBzcXMuSVF1ZXVlIHwgc3FzLlF1ZXVlUHJvcHM7XG4gIH07XG4gIC8qKlxuICAgKiBVc2VkIHRvIGNyZWF0ZSB0aGUgY29uc3VtZXIgZm9yIHRoZSBxdWV1ZS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogbmV3IFF1ZXVlKHN0YWNrLCBcIlF1ZXVlXCIsIHtcbiAgICogICBjb25zdW1lcjogXCJzcmMvZnVuY3Rpb24uaGFuZGxlclwiLFxuICAgKiB9KVxuICAgKiBgYGBcbiAgICovXG4gIGNvbnN1bWVyPzogRnVuY3Rpb25JbmxpbmVEZWZpbml0aW9uIHwgUXVldWVDb25zdW1lclByb3BzO1xufVxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIENvbnN0cnVjdFxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbi8qKlxuICogVGhlIGBRdWV1ZWAgY29uc3RydWN0IGlzIGEgaGlnaGVyIGxldmVsIENESyBjb25zdHJ1Y3QgdGhhdCBtYWtlcyBpdCBlYXN5IHRvIGNyZWF0ZSBhIFtTUVMgUXVldWVzXShodHRwczovL2F3cy5hbWF6b24uY29tL3Nxcy8pLiBZb3UgY2FuIGNyZWF0ZSBhIHF1ZXVlIGJ5IHNwZWNpZnlpbmcgYSBjb25zdW1lciBmdW5jdGlvbi4gQW5kIHRoZW4gcHVibGlzaCB0byB0aGUgcXVldWUgZnJvbSBhbnkgcGFydCBvZiB5b3VyIHNlcnZlcmxlc3MgYXBwLlxuICpcbiAqIFRoaXMgY29uc3RydWN0IG1ha2VzIGl0IGVhc2llciB0byBkZWZpbmUgYSBxdWV1ZSBhbmQgYSBjb25zdW1lci4gSXQgYWxzbyBpbnRlcm5hbGx5IGNvbm5lY3RzIHRoZSBjb25zdW1lciBhbmQgcXVldWUgdG9nZXRoZXIuXG4gKlxuICogQGV4YW1wbGVcbiAqICMjIyBVc2luZyB0aGUgbWluaW1hbCBjb25maWdcbiAqXG4gKiBgYGBqc1xuICogaW1wb3J0IHsgUXVldWUgfSBmcm9tIFwiQHNlcnZlcmxlc3Mtc3RhY2svcmVzb3VyY2VzXCI7XG4gKlxuICogbmV3IFF1ZXVlKHN0YWNrLCBcIlF1ZXVlXCIsIHtcbiAqICAgY29uc3VtZXI6IFwic3JjL3F1ZXVlQ29uc3VtZXIubWFpblwiLFxuICogfSk7XG4gKiBgYGBcbiAqL1xuZXhwb3J0IGNsYXNzIFF1ZXVlIGV4dGVuZHMgQ29uc3RydWN0IGltcGxlbWVudHMgU1NUQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IGNkazoge1xuICAgIC8qKlxuICAgICAqIFRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgQ0RLIGBRdWV1ZWAgaW5zdGFuY2UuXG4gICAgICovXG4gICAgcXVldWU6IHNxcy5JUXVldWU7XG4gIH07XG4gIC8qKlxuICAgKiBUaGUgaW50ZXJuYWxseSBjcmVhdGVkIGNvbnN1bWVyIGBGdW5jdGlvbmAgaW5zdGFuY2UuXG4gICAqL1xuICBwdWJsaWMgY29uc3VtZXJGdW5jdGlvbj86IEZuO1xuICBwcml2YXRlIHBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxDb25zdW1lcnM6IFBlcm1pc3Npb25zW107XG4gIHByaXZhdGUgcHJvcHM6IFF1ZXVlUHJvcHM7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBRdWV1ZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIHRoaXMucHJvcHMgPSBwcm9wcyB8fCB7fTtcbiAgICB0aGlzLmNkayA9IHt9IGFzIGFueTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxDb25zdW1lcnMgPSBbXTtcblxuICAgIHRoaXMuY3JlYXRlUXVldWUoKTtcblxuICAgIGlmIChwcm9wcz8uY29uc3VtZXIpIHtcbiAgICAgIHRoaXMuYWRkQ29uc3VtZXIodGhpcywgcHJvcHMuY29uc3VtZXIpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgQVJOIG9mIHRoZSBTUVMgUXVldWVcbiAgICovXG4gIHB1YmxpYyBnZXQgcXVldWVBcm4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jZGsucXVldWUucXVldWVBcm47XG4gIH1cblxuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIFNRUyBRdWV1ZVxuICAgKi9cbiAgcHVibGljIGdldCBxdWV1ZU5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jZGsucXVldWUucXVldWVOYW1lO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBjb25zdW1lciBhZnRlciBjcmVhdGluZyB0aGUgcXVldWUuIE5vdGUgb25seSBvbmUgY29uc3VtZXIgY2FuIGJlIGFkZGVkIHRvIGEgcXVldWVcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganMgezN9XG4gICAqIGNvbnN0IHF1ZXVlID0gbmV3IFF1ZXVlKHN0YWNrLCBcIlF1ZXVlXCIpO1xuICAgKiBxdWV1ZS5hZGRDb25zdW1lcihwcm9wcy5zdGFjaywgXCJzcmMvZnVuY3Rpb24uaGFuZGxlclwiKTtcbiAgICogYGBgXG4gICAqL1xuICBwdWJsaWMgYWRkQ29uc3VtZXIoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBjb25zdW1lcjogRnVuY3Rpb25JbmxpbmVEZWZpbml0aW9uIHwgUXVldWVDb25zdW1lclByb3BzXG4gICk6IHZvaWQge1xuICAgIGlmICh0aGlzLmNvbnN1bWVyRnVuY3Rpb24pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBjb25maWd1cmUgbW9yZSB0aGFuIDEgY29uc3VtZXIgZm9yIGEgUXVldWVcIik7XG4gICAgfVxuXG4gICAgLy8gUGFyc2UgY29uc3VtZXIgcHJvcHNcbiAgICBsZXQgZXZlbnRTb3VyY2VQcm9wcztcbiAgICBsZXQgZnVuY3Rpb25EZWZpbml0aW9uO1xuICAgIGlmICgoY29uc3VtZXIgYXMgUXVldWVDb25zdW1lclByb3BzKS5mdW5jdGlvbikge1xuICAgICAgY29uc3VtZXIgPSBjb25zdW1lciBhcyBRdWV1ZUNvbnN1bWVyUHJvcHM7XG4gICAgICBldmVudFNvdXJjZVByb3BzID0gY29uc3VtZXIuY2RrPy5ldmVudFNvdXJjZTtcbiAgICAgIGZ1bmN0aW9uRGVmaW5pdGlvbiA9IGNvbnN1bWVyLmZ1bmN0aW9uO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdW1lciA9IGNvbnN1bWVyIGFzIEZ1bmN0aW9uSW5saW5lRGVmaW5pdGlvbjtcbiAgICAgIGZ1bmN0aW9uRGVmaW5pdGlvbiA9IGNvbnN1bWVyO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBmdW5jdGlvblxuICAgIHRoaXMuY29uc3VtZXJGdW5jdGlvbiA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICBgQ29uc3VtZXJfJHt0aGlzLm5vZGUuaWR9YCxcbiAgICAgIGZ1bmN0aW9uRGVmaW5pdGlvblxuICAgICk7XG4gICAgdGhpcy5jb25zdW1lckZ1bmN0aW9uLmFkZEV2ZW50U291cmNlKFxuICAgICAgbmV3IGxhbWJkYUV2ZW50U291cmNlcy5TcXNFdmVudFNvdXJjZSh0aGlzLmNkay5xdWV1ZSwgZXZlbnRTb3VyY2VQcm9wcylcbiAgICApO1xuXG4gICAgLy8gQXR0YWNoIHBlcm1pc3Npb25zXG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsQ29uc3VtZXJzLmZvckVhY2goKHBlcm1pc3Npb25zKSA9PiB7XG4gICAgICBpZiAodGhpcy5jb25zdW1lckZ1bmN0aW9uKSB7XG4gICAgICAgIHRoaXMuY29uc3VtZXJGdW5jdGlvbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQXR0YWNoZXMgYWRkaXRpb25hbCBwZXJtaXNzaW9ucyB0byB0aGUgY29uc3VtZXIgZnVuY3Rpb25cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogY29uc3QgcXVldWUgPSBuZXcgUXVldWUoc3RhY2ssIFwiUXVldWVcIiwge1xuICAgKiAgIGNvbnN1bWVyOiBcInNyYy9mdW5jdGlvbi5oYW5kbGVyXCIsXG4gICAqIH0pO1xuICAgKiBxdWV1ZS5hdHRhY2hQZXJtaXNzaW9ucyhbXCJzM1wiXSk7XG4gICAqIGBgYFxuICAgKi9cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIGlmICh0aGlzLmNvbnN1bWVyRnVuY3Rpb24pIHtcbiAgICAgIHRoaXMuY29uc3VtZXJGdW5jdGlvbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gICAgfVxuXG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsQ29uc3VtZXJzLnB1c2gocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGdldENvbnN0cnVjdE1ldGFkYXRhKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiBcIlF1ZXVlXCIgYXMgY29uc3QsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIG5hbWU6IHRoaXMuY2RrLnF1ZXVlLnF1ZXVlTmFtZSxcbiAgICAgICAgdXJsOiB0aGlzLmNkay5xdWV1ZS5xdWV1ZVVybCxcbiAgICAgICAgY29uc3VtZXI6IGdldEZ1bmN0aW9uUmVmKHRoaXMuY29uc3VtZXJGdW5jdGlvbiksXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVF1ZXVlKCkge1xuICAgIGNvbnN0IHsgY2RrIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHJvb3QgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3QgaWQgPSB0aGlzLm5vZGUuaWQ7XG5cbiAgICBpZiAoaXNDREtDb25zdHJ1Y3QoY2RrPy5xdWV1ZSkpIHtcbiAgICAgIHRoaXMuY2RrLnF1ZXVlID0gY2RrPy5xdWV1ZSBhcyBzcXMuUXVldWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHNxc1F1ZXVlUHJvcHM6IHNxcy5RdWV1ZVByb3BzID0gY2RrPy5xdWV1ZSB8fCB7fTtcblxuICAgICAgLy8gSWYgZGVidWdJbmNyZWFzZVRpbWVvdXQgaXMgZW5hYmxlZCAoaWUuIHNzdCBzdGFydCk6XG4gICAgICAvLyAtIFNldCB2aXNpYmlsaXR5VGltZW91dCB0byA+IDkwMHMuIFRoaXMgaXMgYmVjYXVzZSBMYW1iZGEgdGltZW91dCBpc1xuICAgICAgLy8gICBzZXQgdG8gOTAwcywgYW5kIHZpc2liaWxpdHlUaW1lb3V0IGhhcyB0byBiZSBncmVhdGVyIG9yIGVxdWFsIHRvIGl0LlxuICAgICAgLy8gICBUaGlzIHdpbGwgZ2l2ZSBwZW9wbGUgbW9yZSB0aW1lIHRvIGRlYnVnIHRoZSBmdW5jdGlvbiB3aXRob3V0IHRpbWluZ1xuICAgICAgLy8gICBvdXQgdGhlIHJlcXVlc3QuXG4gICAgICBsZXQgZGVidWdPdmVycmlkZVByb3BzO1xuICAgICAgaWYgKHJvb3QuZGVidWdJbmNyZWFzZVRpbWVvdXQpIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICFzcXNRdWV1ZVByb3BzLnZpc2liaWxpdHlUaW1lb3V0IHx8XG4gICAgICAgICAgc3FzUXVldWVQcm9wcy52aXNpYmlsaXR5VGltZW91dC50b1NlY29uZHMoKSA8IDkwMFxuICAgICAgICApIHtcbiAgICAgICAgICAvLyBUT0RPXG4gICAgICAgICAgY29uc29sZS5sb2codG9DZGtEdXJhdGlvbihcIjkwMCBzZWNvbmRzXCIpKTtcbiAgICAgICAgICBkZWJ1Z092ZXJyaWRlUHJvcHMgPSB7XG4gICAgICAgICAgICB2aXNpYmlsaXR5VGltZW91dDogdG9DZGtEdXJhdGlvbihcIjkwMCBzZWNvbmRzXCIpLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29uc3QgbmFtZSA9XG4gICAgICAgIHJvb3QubG9naWNhbFByZWZpeGVkTmFtZShpZCkgKyAoc3FzUXVldWVQcm9wcy5maWZvID8gXCIuZmlmb1wiIDogXCJcIik7XG4gICAgICB0aGlzLmNkay5xdWV1ZSA9IG5ldyBzcXMuUXVldWUodGhpcywgXCJRdWV1ZVwiLCB7XG4gICAgICAgIHF1ZXVlTmFtZTogbmFtZSxcbiAgICAgICAgLi4uc3FzUXVldWVQcm9wcyxcbiAgICAgICAgLi4uZGVidWdPdmVycmlkZVByb3BzLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG59XG4iXX0=