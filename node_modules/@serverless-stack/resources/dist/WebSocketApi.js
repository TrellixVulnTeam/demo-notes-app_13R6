"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebSocketApi = void 0;
const constructs_1 = require("constructs");
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const apig = __importStar(require("@aws-cdk/aws-apigatewayv2-alpha"));
const apigAuthorizers = __importStar(require("@aws-cdk/aws-apigatewayv2-authorizers-alpha"));
const apigIntegrations = __importStar(require("@aws-cdk/aws-apigatewayv2-integrations-alpha"));
const Stack_1 = require("./Stack");
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
const apigV2Domain = __importStar(require("./util/apiGatewayV2Domain"));
const apigV2AccessLog = __importStar(require("./util/apiGatewayV2AccessLog"));
/////////////////////
// Construct
/////////////////////
/**
 * The `WebSocketApi` construct is a higher level CDK construct that makes it easy to create a WebSocket API. It provides a simple way to define your routes and allows you to configure the specific Lambda functions if necessary. It also allows you to configure authorization and custom domains. See the [examples](#examples) for more details.
 *
 * @example
 * ```js
 * import { WebSocketApi } from "@serverless-stack/resources";
 *
 * new WebSocketApi(stack, "Api", {
 *   routes: {
 *     $connect: "src/connect.main",
 *     $default: "src/default.main",
 *     $disconnect: "src/disconnect.main",
 *     sendMessage: "src/sendMessage.main",
 *   },
 * });
 * ```
 */
class WebSocketApi extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.props = props || {};
        this.cdk = {};
        this.functions = {};
        this.permissionsAttachedForAllRoutes = [];
        this.createWebSocketApi();
        this.createWebSocketStage();
        this.addAuthorizer();
        this.addRoutes(this, this.props.routes || {});
        // Allows functions to make ApiGatewayManagementApi.postToConnection calls.
        this.attachPermissions([
            new iam.PolicyStatement({
                effect: iam.Effect.ALLOW,
                actions: ["execute-api:ManageConnections"],
                resources: [this._connectionsArn],
            }),
        ]);
    }
    /**
     * Url of the WebSocket API
     */
    get url() {
        return this.cdk.webSocketStage.url;
    }
    /**
     * Custom domain url if it's configured
     */
    get customDomainUrl() {
        return this._customDomainUrl;
    }
    /**
     * List of routes of the websocket api
     */
    get routes() {
        return Object.keys(this.functions);
    }
    get _connectionsArn() {
        return Stack_1.Stack.of(this).formatArn({
            service: "execute-api",
            resourceName: `${this.cdk.webSocketStage.stageName}/POST/*`,
            resource: this.cdk.webSocketApi.apiId,
        });
    }
    /**
     * Add routes to an already created WebSocket API
     *
     * @example
     * ```js
     * api.addRoutes(stack, {
     *   "$connect": "src/connect.main",
     * })
     * ```
     */
    addRoutes(scope, routes) {
        Object.keys(routes).forEach((routeKey) => {
            // add route
            const fn = this.addRoute(scope, routeKey, routes[routeKey]);
            // attached existing permissions
            this.permissionsAttachedForAllRoutes.forEach((permissions) => fn.attachPermissions(permissions));
        });
    }
    /**
     * Get the instance of the internally created Function, for a given route key where the `routeKey` is the key used to define a route. For example, `$connect`.
     *
     * @example
     * ```js
     * const fn = api.getFunction("$connect");
     * ```
     */
    getFunction(routeKey) {
        return this.functions[this.normalizeRouteKey(routeKey)];
    }
    /**
     * Attaches the given list of permissions to all the routes. This allows the functions to access other AWS resources.
     *
     * @example
     *
     * ```js
     * api.attachPermissions(["s3"]);
     * ```
     */
    attachPermissions(permissions) {
        Object.values(this.functions).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllRoutes.push(permissions);
    }
    /**
     * Attaches the given list of permissions to a specific route. This allows that function to access other AWS resources.
     *
     * @example
     * ```js
     * api.attachPermissionsToRoute("$connect", ["s3"]);
     * ```
     *
     */
    attachPermissionsToRoute(routeKey, permissions) {
        const fn = this.getFunction(routeKey);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Route "${routeKey}" does not exist.`);
        }
        fn.attachPermissions(permissions);
    }
    getConstructMetadata() {
        return {
            type: "WebSocketApi",
            data: {
                httpApiId: this.cdk.webSocketApi.apiId,
                customDomainUrl: this._customDomainUrl,
                routes: Object.entries(this.functions).map(([routeKey, fn]) => ({
                    route: routeKey,
                    fn: (0, Construct_1.getFunctionRef)(fn),
                })),
            },
        };
    }
    createWebSocketApi() {
        const { cdk } = this.props;
        const id = this.node.id;
        const app = this.node.root;
        if ((0, Construct_1.isCDKConstruct)(cdk === null || cdk === void 0 ? void 0 : cdk.webSocketApi)) {
            this.cdk.webSocketApi = cdk === null || cdk === void 0 ? void 0 : cdk.webSocketApi;
        }
        else {
            // Validate input
            if ((0, Construct_1.isCDKConstruct)(cdk === null || cdk === void 0 ? void 0 : cdk.webSocketStage)) {
                throw new Error(`Cannot import the "webSocketStage" when the "webSocketApi" is not imported.`);
            }
            const webSocketApiProps = ((cdk === null || cdk === void 0 ? void 0 : cdk.webSocketApi) ||
                {});
            // Create WebSocket API
            this.cdk.webSocketApi = new apig.WebSocketApi(this, "Api", Object.assign({ apiName: app.logicalPrefixedName(id) }, webSocketApiProps));
        }
    }
    createWebSocketStage() {
        const { cdk, accessLog, customDomain } = this.props;
        if ((0, Construct_1.isCDKConstruct)(cdk === null || cdk === void 0 ? void 0 : cdk.webSocketStage)) {
            if (accessLog !== undefined) {
                throw new Error(`Cannot configure the "accessLog" when "webSocketStage" is a construct`);
            }
            if (customDomain !== undefined) {
                throw new Error(`Cannot configure the "customDomain" when "webSocketStage" is a construct`);
            }
            this.cdk.webSocketStage = cdk === null || cdk === void 0 ? void 0 : cdk.webSocketStage;
        }
        else {
            const webSocketStageProps = ((cdk === null || cdk === void 0 ? void 0 : cdk.webSocketStage) ||
                {});
            // Validate input
            if (webSocketStageProps.domainMapping !== undefined) {
                throw new Error(`Do not configure the "webSocketStage.domainMapping". Use the "customDomain" to configure the Api domain.`);
            }
            // Configure Custom Domain
            const customDomainData = apigV2Domain.buildCustomDomainData(this, customDomain);
            let domainMapping;
            if (customDomainData) {
                if (customDomainData.isApigDomainCreated) {
                    this.cdk.domainName = customDomainData.apigDomain;
                }
                if (customDomainData.isCertificatedCreated) {
                    this.cdk.certificate =
                        customDomainData.certificate;
                }
                domainMapping = {
                    domainName: customDomainData.apigDomain,
                    mappingKey: customDomainData.mappingKey,
                };
                this._customDomainUrl = `wss://${customDomainData.url}`;
            }
            // Create stage
            this.cdk.webSocketStage = new apig.WebSocketStage(this, "Stage", Object.assign({ webSocketApi: this.cdk.webSocketApi, stageName: this.node.root.stage, autoDeploy: true, domainMapping }, webSocketStageProps));
            // Configure Access Log
            this.cdk.accessLogGroup = apigV2AccessLog.buildAccessLogData(this, accessLog, this.cdk.webSocketStage, true);
        }
    }
    addAuthorizer() {
        var _a;
        const { authorizer } = this.props;
        if (!authorizer || authorizer === "none") {
            this.authorizer = "none";
        }
        else if (authorizer === "iam") {
            this.authorizer = "iam";
        }
        else if ((_a = authorizer.cdk) === null || _a === void 0 ? void 0 : _a.authorizer) {
            this.authorizer = authorizer.cdk.authorizer;
        }
        else if (!authorizer.function) {
            throw new Error(`Missing "function" for authorizer`);
        }
        else {
            this.authorizer = new apigAuthorizers.WebSocketLambdaAuthorizer("WebSocketAuthorizer", authorizer.function, {
                authorizerName: authorizer.name,
                identitySource: authorizer.identitySource,
            });
        }
    }
    addRoute(scope, routeKey, routeValue) {
        var _a;
        ///////////////////
        // Normalize routeKey
        ///////////////////
        routeKey = this.normalizeRouteKey(routeKey);
        if (this.functions[routeKey]) {
            throw new Error(`A route already exists for "${routeKey}"`);
        }
        ///////////////////
        // Create Function
        ///////////////////
        const lambda = Function_1.Function.fromDefinition(scope, routeKey, Function_1.Function.isInlineDefinition(routeValue) ? routeValue : routeValue.function, (_a = this.props.defaults) === null || _a === void 0 ? void 0 : _a.function, `The "defaults.function" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the routes using FunctionProps, so the Api construct can apply the "defaults.function" to them.`);
        ///////////////////
        // Get authorization
        ///////////////////
        const { authorizationType, authorizer } = this.buildRouteAuth();
        ///////////////////
        // Create route
        ///////////////////
        const route = new apig.WebSocketRoute(scope, `Route_${routeKey}`, {
            webSocketApi: this.cdk.webSocketApi,
            routeKey,
            integration: new apigIntegrations.WebSocketLambdaIntegration(`Integration_${routeKey}`, lambda),
            authorizer: routeKey === "$connect" ? authorizer : undefined,
        });
        ///////////////////
        // Configure authorization
        ///////////////////
        // Note: as of CDK v1.138.0, aws-apigatewayv2.WebSocketRoute does not
        //       support IAM authorization type. We need to manually configure it.
        if (routeKey === "$connect") {
            // Configure route authorization type
            // Note: we need to explicitly set `cfnRoute.authorizationType` to `NONE`
            //       because if it were set to `AWS_IAM`, and then it is removed from
            //       the CloudFormation template (ie. set to undefined), CloudFormation
            //       doesn't updates the route. The route's authorizationType would
            //       still be `AWS_IAM`.
            const cfnRoute = route.node.defaultChild;
            cfnRoute.authorizationType = authorizationType;
        }
        ///////////////////
        // Store function
        ///////////////////
        this.functions[routeKey] = lambda;
        return lambda;
    }
    buildRouteAuth() {
        if (this.authorizer === "none") {
            return { authorizationType: "NONE" };
        }
        else if (this.authorizer === "iam") {
            return { authorizationType: "AWS_IAM" };
        }
        return {
            authorizationType: "CUSTOM",
            authorizer: this.authorizer,
        };
    }
    normalizeRouteKey(routeKey) {
        return routeKey.trim();
    }
}
exports.WebSocketApi = WebSocketApi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2ViU29ja2V0QXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1dlYlNvY2tldEFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUF1QztBQUN2Qyx5REFBMkM7QUFJM0Msc0VBQXdEO0FBQ3hELDZGQUErRTtBQUMvRSwrRkFBaUY7QUFHakYsbUNBQWdDO0FBQ2hDLDJDQUEyRTtBQUMzRSx5Q0FLb0I7QUFFcEIsd0VBQTBEO0FBQzFELDhFQUFnRTtBQXlNaEUscUJBQXFCO0FBQ3JCLFlBQVk7QUFDWixxQkFBcUI7QUFFckI7Ozs7Ozs7Ozs7Ozs7Ozs7R0FnQkc7QUFDSCxNQUFhLFlBQWEsU0FBUSxzQkFBUztJQWdDekMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUF5QjtRQUNqRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsR0FBRyxHQUFHLEVBQVMsQ0FBQztRQUNyQixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsK0JBQStCLEdBQUcsRUFBRSxDQUFDO1FBRTFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQzFCLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsQ0FBQztRQUU5QywyRUFBMkU7UUFDM0UsSUFBSSxDQUFDLGlCQUFpQixDQUFDO1lBQ3JCLElBQUksR0FBRyxDQUFDLGVBQWUsQ0FBQztnQkFDdEIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSztnQkFDeEIsT0FBTyxF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Q0FBQyxVQUFVO1NBQzVCLENBQUM7SUFDSixDQUFDO0lBRU8saUJBQWlCLENBQUMsUUFBZ0I7UUFDeEMsT0FBTyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDekIsQ0FBQztDQUNGO0FBdlhELG9DQXVYQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCAqIGFzIGxvZ3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sb2dzXCI7XG5pbXBvcnQgKiBhcyBhY20gZnJvbSBcImF3cy1jZGstbGliL2F3cy1jZXJ0aWZpY2F0ZW1hbmFnZXJcIjtcbmltcG9ydCAqIGFzIGNmbkFwaWcgZnJvbSBcImF3cy1jZGstbGliL2F3cy1hcGlnYXRld2F5djJcIjtcbmltcG9ydCAqIGFzIGFwaWcgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djItYWxwaGFcIjtcbmltcG9ydCAqIGFzIGFwaWdBdXRob3JpemVycyBmcm9tIFwiQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXl2Mi1hdXRob3JpemVycy1hbHBoYVwiO1xuaW1wb3J0ICogYXMgYXBpZ0ludGVncmF0aW9ucyBmcm9tIFwiQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXl2Mi1pbnRlZ3JhdGlvbnMtYWxwaGFcIjtcblxuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vQXBwXCI7XG5pbXBvcnQgeyBTdGFjayB9IGZyb20gXCIuL1N0YWNrXCI7XG5pbXBvcnQgeyBnZXRGdW5jdGlvblJlZiwgU1NUQ29uc3RydWN0LCBpc0NES0NvbnN0cnVjdCB9IGZyb20gXCIuL0NvbnN0cnVjdFwiO1xuaW1wb3J0IHtcbiAgRnVuY3Rpb24gYXMgRm4sXG4gIEZ1bmN0aW9uUHJvcHMsXG4gIEZ1bmN0aW9uSW5saW5lRGVmaW5pdGlvbixcbiAgRnVuY3Rpb25EZWZpbml0aW9uLFxufSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcbmltcG9ydCAqIGFzIGFwaWdWMkRvbWFpbiBmcm9tIFwiLi91dGlsL2FwaUdhdGV3YXlWMkRvbWFpblwiO1xuaW1wb3J0ICogYXMgYXBpZ1YyQWNjZXNzTG9nIGZyb20gXCIuL3V0aWwvYXBpR2F0ZXdheVYyQWNjZXNzTG9nXCI7XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gSW50ZXJmYWNlc1xuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBpbnRlcmZhY2UgV2ViU29ja2V0QXBpRG9tYWluUHJvcHNcbiAgZXh0ZW5kcyBhcGlnVjJEb21haW4uQ3VzdG9tRG9tYWluUHJvcHMge31cbmV4cG9ydCBpbnRlcmZhY2UgV2ViU29ja2V0QXBpQWNjZXNzTG9nUHJvcHNcbiAgZXh0ZW5kcyBhcGlnVjJBY2Nlc3NMb2cuQWNjZXNzTG9nUHJvcHMge31cblxuZXhwb3J0IGludGVyZmFjZSBXZWJTb2NrZXRBcGlQcm9wcyB7XG4gIGNkaz86IHtcbiAgICAvKipcbiAgICAgKiBPdmVycmlkZSB0aGUgaW50ZXJuYWxseSBjcmVhdGVkIFdlYlNvY2tldCBBUElcbiAgICAgKlxuICAgICAqIEBleGFtcGxlXG4gICAgICogYGBganNcbiAgICAgKiBuZXcgV2ViU29ja2V0QXBpKHN0YWNrLCBcIldlYlNvY2tldEFwaVwiLCB7XG4gICAgICogICBjZGs6IHtcbiAgICAgKiAgICAgd2ViU29ja2V0QXBpOiB7XG4gICAgICogICAgICAgYXBpTmFtZTogXCJteS13ZWJzb2NrZXQtYXBpXCJcbiAgICAgKiAgICAgfVxuICAgICAqICAgfVxuICAgICAqIH0pXG4gICAgICogYGBgXG4gICAgICovXG4gICAgd2ViU29ja2V0QXBpPzogYXBpZy5JV2ViU29ja2V0QXBpIHwgYXBpZy5XZWJTb2NrZXRBcGlQcm9wcztcbiAgICAvKipcbiAgICAgKiBPdmVycmlkZSB0aGUgaW50ZXJuYWxseSBjcmVhdGVkIFdlYlNvY2tldCBTdGFnZVxuICAgICAqXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBgYGBqc1xuICAgICAqIG5ldyBXZWJTb2NrZXRBcGkoc3RhY2ssIFwiV2ViU29ja2V0QXBpXCIsIHtcbiAgICAgKiAgIGNkazoge1xuICAgICAqICAgICB3ZWJTb2NrZXRTdGFnZToge1xuICAgICAqICAgICAgIGF1dG9EZXBsb3k6IGZhbHNlXG4gICAgICogICAgIH1cbiAgICAgKiAgIH1cbiAgICAgKiB9KVxuICAgICAqIGBgYFxuICAgICAqL1xuICAgIHdlYlNvY2tldFN0YWdlPzogYXBpZy5JV2ViU29ja2V0U3RhZ2UgfCBXZWJTb2NrZXRBcGlDZGtTdGFnZVByb3BzO1xuICB9O1xuICAvKipcbiAgICogVGhlIHJvdXRlcyBmb3IgdGhlIFdlYnNvY2tldCBBUElcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogbmV3IFdlYlNvY2tldEFwaShzdGFjaywgXCJBcGlcIiwge1xuICAgKiAgIHJvdXRlczoge1xuICAgKiAgICAgJGNvbm5lY3QgICAgOiBcInNyYy9jb25uZWN0Lm1haW5cIixcbiAgICogICAgICRkZWZhdWx0ICAgIDogXCJzcmMvZGVmYXVsdC5tYWluXCIsXG4gICAqICAgICAkZGlzY29ubmVjdCA6IFwic3JjL2Rpc2Nvbm5lY3QubWFpblwiLFxuICAgKiAgICAgc2VuZE1lc3NhZ2UgOiBcInNyYy9zZW5kTWVzc2FnZS5tYWluXCIsXG4gICAqICAgfVxuICAgKiB9KVxuICAgKiBgYGBcbiAgICovXG4gIHJvdXRlcz86IFJlY29yZDxcbiAgICBzdHJpbmcsXG4gICAgRnVuY3Rpb25JbmxpbmVEZWZpbml0aW9uIHwgV2ViU29ja2V0QXBpRnVuY3Rpb25Sb3V0ZVByb3BzXG4gID47XG4gIC8qKlxuICAgKiBFbmFibGUgQ2xvdWRXYXRjaCBhY2Nlc3MgbG9ncyBmb3IgdGhpcyBBUElcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogbmV3IFdlYlNvY2tldEFwaShzdGFjaywgXCJBcGlcIiwge1xuICAgKiAgIGFjY2Vzc0xvZzogdHJ1ZVxuICAgKiB9KTtcbiAgICogYGBgXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIG5ldyBXZWJTb2NrZXRBcGkoc3RhY2ssIFwiQXBpXCIsIHtcbiAgICogICBhY2Nlc3NMb2c6IHtcbiAgICogICAgIHJldGVudGlvbjogXCJvbmVfd2Vla1wiLFxuICAgKiAgIH0sXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIGFjY2Vzc0xvZz86IGJvb2xlYW4gfCBzdHJpbmcgfCBXZWJTb2NrZXRBcGlBY2Nlc3NMb2dQcm9wcztcbiAgLyoqXG4gICAqIFNwZWNpZnkgYSBjdXN0b20gZG9tYWluIHRvIHVzZSBpbiBhZGRpdGlvbiB0byB0aGUgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQgb25lLiBTU1QgY3VycmVudGx5IHN1cHBvcnRzIGRvbWFpbnMgdGhhdCBhcmUgY29uZmlndXJlZCB1c2luZyBbUm91dGUgNTNdKGh0dHBzOi8vYXdzLmFtYXpvbi5jb20vcm91dGU1My8pXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIG5ldyBXZWJTb2NrZXRBcGkoc3RhY2ssIFwiQXBpXCIsIHtcbiAgICogICBjdXN0b21Eb21haW46IFwiYXBpLmV4YW1wbGUuY29tXCJcbiAgICogfSlcbiAgICogYGBgXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIG5ldyBXZWJTb2NrZXRBcGkoc3RhY2ssIFwiQXBpXCIsIHtcbiAgICogICBjdXN0b21Eb21haW46IHtcbiAgICogICAgIGRvbWFpbk5hbWU6IFwiYXBpLmV4YW1wbGUuY29tXCIsXG4gICAqICAgICBob3N0ZWRab25lOiBcImRvbWFpbi5jb21cIixcbiAgICogICAgIHBhdGg6IFwidjFcIlxuICAgKiAgIH1cbiAgICogfSlcbiAgICogYGBgXG4gICAqL1xuICBjdXN0b21Eb21haW4/OiBzdHJpbmcgfCBXZWJTb2NrZXRBcGlEb21haW5Qcm9wcztcblxuICAvKipcbiAgICogVGhlIGRlZmF1bHQgYXV0aG9yaXplciBmb3IgdGhlIEFQSS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogbmV3IFdlYlNvY2tldEFwaShzdGFjaywgXCJBcGlcIiwge1xuICAgKiAgIGF1dGhvcml6ZXI6IFwiaWFtXCIsXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogbmV3IFdlYlNvY2tldEFwaShzdGFjaywgXCJBcGlcIiwge1xuICAgKiAgIGF1dGhvcml6ZXI6IHtcbiAgICogICAgIHR5cGU6IFwibGFtYmRhXCIsXG4gICAqICAgICBmdW5jdGlvbjogbmV3IEZ1bmN0aW9uKHN0YWNrLCBcIkF1dGhvcml6ZXJcIiwge1xuICAgKiAgICAgICBoYW5kbGVyOiBcInRlc3QvbGFtYmRhLmhhbmRsZXJcIixcbiAgICogICAgIH0pLFxuICAgKiAgIH0sXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIGF1dGhvcml6ZXI/OiBcIm5vbmVcIiB8IFwiaWFtXCIgfCBXZWJTb2NrZXRBcGlMYW1iZGFBdXRob3JpemVyO1xuXG4gIGRlZmF1bHRzPzoge1xuICAgIC8qKlxuICAgICAqIFRoZSBkZWZhdWx0IGZ1bmN0aW9uIHByb3BzIHRvIGJlIGFwcGxpZWQgdG8gYWxsIHRoZSBMYW1iZGEgZnVuY3Rpb25zIGluIHRoZSBBUEkuIFRoZSBgZW52aXJvbm1lbnRgLCBgcGVybWlzc2lvbnNgIGFuZCBgbGF5ZXJzYCBwcm9wZXJ0aWVzIHdpbGwgYmUgbWVyZ2VkIHdpdGggcGVyIHJvdXRlIGRlZmluaXRpb25zIGlmIHRoZXkgYXJlIGRlZmluZWQuXG4gICAgICpcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIGBgYGpzXG4gICAgICogbmV3IFdlYlNvY2tldEFwaShzdGFjaywgXCJBcGlcIiwge1xuICAgICAqICAgZGVmYXVsdHM6IHtcbiAgICAgKiAgICAgZnVuY3Rpb246IHtcbiAgICAgKiAgICAgICB0aW1lb3V0OiAyMCxcbiAgICAgKiAgICAgICBlbnZpcm9ubWVudDogeyB0YWJsZU5hbWU6IHRhYmxlLnRhYmxlTmFtZSB9LFxuICAgICAqICAgICAgIHBlcm1pc3Npb25zOiBbdGFibGVdLFxuICAgICAqICAgICB9XG4gICAgICogICB9LFxuICAgICAqIH0pO1xuICAgICAqIGBgYFxuICAgICAqL1xuICAgIGZ1bmN0aW9uPzogRnVuY3Rpb25Qcm9wcztcbiAgfTtcbn1cblxuLyoqXG4gKiBTcGVjaWZ5IGEgZnVuY3Rpb24gcm91dGUgaGFuZGxlciBhbmQgY29uZmlndXJlIGFkZGl0aW9uYWwgb3B0aW9uc1xuICpcbiAqIEBleGFtcGxlXG4gKiBgYGBqc1xuICogYXBpLmFkZFJvdXRlcyhzdGFjaywge1xuICogICBzZW5kTWVzc2FnZSA6IHtcbiAqICAgICBmdW5jdGlvbjogXCJzcmMvc2VuZE1lc3NhZ2UubWFpblwiLFxuICogICB9XG4gKiB9KTtcbiAqIGBgYFxuICovXG5leHBvcnQgaW50ZXJmYWNlIFdlYlNvY2tldEFwaUZ1bmN0aW9uUm91dGVQcm9wcyB7XG4gIHR5cGU/OiBcImZ1bmN0aW9uXCI7XG4gIC8qKlxuICAgKlRoZSBmdW5jdGlvbiBkZWZpbml0aW9uIHVzZWQgdG8gY3JlYXRlIHRoZSBmdW5jdGlvbiBmb3IgdGhpcyByb3V0ZS5cbiAgICovXG4gIGZ1bmN0aW9uOiBGdW5jdGlvbkRlZmluaXRpb247XG59XG5cbi8qKlxuICogU3BlY2lmeSBhIExhbWJkYSBhdXRob3JpemVyIGFuZCBjb25maWd1cmUgYWRkaXRpb25hbCBvcHRpb25zLlxuICpcbiAqIEBleGFtcGxlXG4gKiBgYGBqc1xuICogbmV3IFdlYlNvY2tldEFwaShzdGFjaywgXCJBcGlcIiwge1xuICogICBhdXRob3JpemVyOiB7XG4gKiAgICAgdHlwZTogXCJsYW1iZGFcIixcbiAqICAgICBmdW5jdGlvbjogbmV3IEZ1bmN0aW9uKHN0YWNrLCBcIkF1dGhvcml6ZXJcIiwge1xuICogICAgICAgaGFuZGxlcjogXCJ0ZXN0L2xhbWJkYS5oYW5kbGVyXCIsXG4gKiAgICAgfSksXG4gKiAgIH0sXG4gKiB9KTtcbiAqIGBgYFxuICovXG5leHBvcnQgaW50ZXJmYWNlIFdlYlNvY2tldEFwaUxhbWJkYUF1dGhvcml6ZXIge1xuICB0eXBlOiBcImxhbWJkYVwiO1xuICBuYW1lPzogc3RyaW5nO1xuICBpZGVudGl0eVNvdXJjZT86IHN0cmluZ1tdO1xuICBmdW5jdGlvbj86IEZuO1xuICBjZGs/OiB7XG4gICAgYXV0aG9yaXplcjogYXBpZ0F1dGhvcml6ZXJzLldlYlNvY2tldExhbWJkYUF1dGhvcml6ZXI7XG4gIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgV2ViU29ja2V0QXBpQ2RrU3RhZ2VQcm9wc1xuICBleHRlbmRzIE9taXQ8YXBpZy5XZWJTb2NrZXRTdGFnZVByb3BzLCBcIndlYlNvY2tldEFwaVwiIHwgXCJzdGFnZU5hbWVcIj4ge1xuICBzdGFnZU5hbWU/OiBzdHJpbmc7XG59XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gQ29uc3RydWN0XG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuLyoqXG4gKiBUaGUgYFdlYlNvY2tldEFwaWAgY29uc3RydWN0IGlzIGEgaGlnaGVyIGxldmVsIENESyBjb25zdHJ1Y3QgdGhhdCBtYWtlcyBpdCBlYXN5IHRvIGNyZWF0ZSBhIFdlYlNvY2tldCBBUEkuIEl0IHByb3ZpZGVzIGEgc2ltcGxlIHdheSB0byBkZWZpbmUgeW91ciByb3V0ZXMgYW5kIGFsbG93cyB5b3UgdG8gY29uZmlndXJlIHRoZSBzcGVjaWZpYyBMYW1iZGEgZnVuY3Rpb25zIGlmIG5lY2Vzc2FyeS4gSXQgYWxzbyBhbGxvd3MgeW91IHRvIGNvbmZpZ3VyZSBhdXRob3JpemF0aW9uIGFuZCBjdXN0b20gZG9tYWlucy4gU2VlIHRoZSBbZXhhbXBsZXNdKCNleGFtcGxlcykgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBganNcbiAqIGltcG9ydCB7IFdlYlNvY2tldEFwaSB9IGZyb20gXCJAc2VydmVybGVzcy1zdGFjay9yZXNvdXJjZXNcIjtcbiAqXG4gKiBuZXcgV2ViU29ja2V0QXBpKHN0YWNrLCBcIkFwaVwiLCB7XG4gKiAgIHJvdXRlczoge1xuICogICAgICRjb25uZWN0OiBcInNyYy9jb25uZWN0Lm1haW5cIixcbiAqICAgICAkZGVmYXVsdDogXCJzcmMvZGVmYXVsdC5tYWluXCIsXG4gKiAgICAgJGRpc2Nvbm5lY3Q6IFwic3JjL2Rpc2Nvbm5lY3QubWFpblwiLFxuICogICAgIHNlbmRNZXNzYWdlOiBcInNyYy9zZW5kTWVzc2FnZS5tYWluXCIsXG4gKiAgIH0sXG4gKiB9KTtcbiAqIGBgYFxuICovXG5leHBvcnQgY2xhc3MgV2ViU29ja2V0QXBpIGV4dGVuZHMgQ29uc3RydWN0IGltcGxlbWVudHMgU1NUQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IGNkazoge1xuICAgIC8qKlxuICAgICAqIFRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgd2Vic29ja2V0IGFwaVxuICAgICAqL1xuICAgIHdlYlNvY2tldEFwaTogYXBpZy5XZWJTb2NrZXRBcGk7XG4gICAgLyoqXG4gICAgICogVGhlIGludGVybmFsbHkgY3JlYXRlZCB3ZWJzb2NrZXQgc3RhZ2VcbiAgICAgKi9cbiAgICB3ZWJTb2NrZXRTdGFnZTogYXBpZy5XZWJTb2NrZXRTdGFnZTtcbiAgICAvKipcbiAgICAgKiBUaGUgaW50ZXJuYWxseSBjcmVhdGVkIGxvZyBncm91cFxuICAgICAqL1xuICAgIGFjY2Vzc0xvZ0dyb3VwPzogbG9ncy5Mb2dHcm91cDtcbiAgICAvKipcbiAgICAgKiBUaGUgaW50ZXJuYWxseSBjcmVhdGVkIGRvbWFpbiBuYW1lXG4gICAgICovXG4gICAgZG9tYWluTmFtZT86IGFwaWcuRG9tYWluTmFtZTtcbiAgICAvKipcbiAgICAgKiBUaGUgaW50ZXJuYWxseSBjcmVhdGVkIGNlcnRpZmljYXRlXG4gICAgICovXG4gICAgY2VydGlmaWNhdGU/OiBhY20uQ2VydGlmaWNhdGU7XG4gIH07XG4gIHByaXZhdGUgX2N1c3RvbURvbWFpblVybD86IHN0cmluZztcbiAgcHJpdmF0ZSBmdW5jdGlvbnM6IHsgW2tleTogc3RyaW5nXTogRm4gfTtcbiAgcHJpdmF0ZSBwZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsUm91dGVzOiBQZXJtaXNzaW9uc1tdO1xuICBwcml2YXRlIGF1dGhvcml6ZXI/OlxuICAgIHwgXCJub25lXCJcbiAgICB8IFwiaWFtXCJcbiAgICB8IGFwaWdBdXRob3JpemVycy5XZWJTb2NrZXRMYW1iZGFBdXRob3JpemVyO1xuICBwcml2YXRlIHByb3BzOiBXZWJTb2NrZXRBcGlQcm9wcztcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IFdlYlNvY2tldEFwaVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIHRoaXMucHJvcHMgPSBwcm9wcyB8fCB7fTtcbiAgICB0aGlzLmNkayA9IHt9IGFzIGFueTtcbiAgICB0aGlzLmZ1bmN0aW9ucyA9IHt9O1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFJvdXRlcyA9IFtdO1xuXG4gICAgdGhpcy5jcmVhdGVXZWJTb2NrZXRBcGkoKTtcbiAgICB0aGlzLmNyZWF0ZVdlYlNvY2tldFN0YWdlKCk7XG4gICAgdGhpcy5hZGRBdXRob3JpemVyKCk7XG4gICAgdGhpcy5hZGRSb3V0ZXModGhpcywgdGhpcy5wcm9wcy5yb3V0ZXMgfHwge30pO1xuXG4gICAgLy8gQWxsb3dzIGZ1bmN0aW9ucyB0byBtYWtlIEFwaUdhdGV3YXlNYW5hZ2VtZW50QXBpLnBvc3RUb0Nvbm5lY3Rpb24gY2FsbHMuXG4gICAgdGhpcy5hdHRhY2hQZXJtaXNzaW9ucyhbXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogW1wiZXhlY3V0ZS1hcGk6TWFuYWdlQ29ubmVjdGlvbnNcIl0sXG4gICAgICAgIHJlc291cmNlczogW3RoaXMuX2Nvbm5lY3Rpb25zQXJuXSxcbiAgICAgIH0pLFxuICAgIF0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFVybCBvZiB0aGUgV2ViU29ja2V0IEFQSVxuICAgKi9cbiAgcHVibGljIGdldCB1cmwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jZGsud2ViU29ja2V0U3RhZ2UudXJsO1xuICB9XG5cbiAgLyoqXG4gICAqIEN1c3RvbSBkb21haW4gdXJsIGlmIGl0J3MgY29uZmlndXJlZFxuICAgKi9cbiAgcHVibGljIGdldCBjdXN0b21Eb21haW5VcmwoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5fY3VzdG9tRG9tYWluVXJsO1xuICB9XG5cbiAgLyoqXG4gICAqIExpc3Qgb2Ygcm91dGVzIG9mIHRoZSB3ZWJzb2NrZXQgYXBpXG4gICAqL1xuICBwdWJsaWMgZ2V0IHJvdXRlcygpOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuZnVuY3Rpb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgX2Nvbm5lY3Rpb25zQXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIFN0YWNrLm9mKHRoaXMpLmZvcm1hdEFybih7XG4gICAgICBzZXJ2aWNlOiBcImV4ZWN1dGUtYXBpXCIsXG4gICAgICByZXNvdXJjZU5hbWU6IGAke3RoaXMuY2RrLndlYlNvY2tldFN0YWdlLnN0YWdlTmFtZX0vUE9TVC8qYCxcbiAgICAgIHJlc291cmNlOiB0aGlzLmNkay53ZWJTb2NrZXRBcGkuYXBpSWQsXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIHJvdXRlcyB0byBhbiBhbHJlYWR5IGNyZWF0ZWQgV2ViU29ja2V0IEFQSVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqc1xuICAgKiBhcGkuYWRkUm91dGVzKHN0YWNrLCB7XG4gICAqICAgXCIkY29ubmVjdFwiOiBcInNyYy9jb25uZWN0Lm1haW5cIixcbiAgICogfSlcbiAgICogYGBgXG4gICAqL1xuICBwdWJsaWMgYWRkUm91dGVzKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgcm91dGVzOiBSZWNvcmQ8XG4gICAgICBzdHJpbmcsXG4gICAgICBGdW5jdGlvbklubGluZURlZmluaXRpb24gfCBXZWJTb2NrZXRBcGlGdW5jdGlvblJvdXRlUHJvcHNcbiAgICA+XG4gICk6IHZvaWQge1xuICAgIE9iamVjdC5rZXlzKHJvdXRlcykuZm9yRWFjaCgocm91dGVLZXk6IHN0cmluZykgPT4ge1xuICAgICAgLy8gYWRkIHJvdXRlXG4gICAgICBjb25zdCBmbiA9IHRoaXMuYWRkUm91dGUoc2NvcGUsIHJvdXRlS2V5LCByb3V0ZXNbcm91dGVLZXldKTtcblxuICAgICAgLy8gYXR0YWNoZWQgZXhpc3RpbmcgcGVybWlzc2lvbnNcbiAgICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFJvdXRlcy5mb3JFYWNoKChwZXJtaXNzaW9ucykgPT5cbiAgICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpXG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgaW5zdGFuY2Ugb2YgdGhlIGludGVybmFsbHkgY3JlYXRlZCBGdW5jdGlvbiwgZm9yIGEgZ2l2ZW4gcm91dGUga2V5IHdoZXJlIHRoZSBgcm91dGVLZXlgIGlzIHRoZSBrZXkgdXNlZCB0byBkZWZpbmUgYSByb3V0ZS4gRm9yIGV4YW1wbGUsIGAkY29ubmVjdGAuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIGNvbnN0IGZuID0gYXBpLmdldEZ1bmN0aW9uKFwiJGNvbm5lY3RcIik7XG4gICAqIGBgYFxuICAgKi9cbiAgcHVibGljIGdldEZ1bmN0aW9uKHJvdXRlS2V5OiBzdHJpbmcpOiBGbiB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuZnVuY3Rpb25zW3RoaXMubm9ybWFsaXplUm91dGVLZXkocm91dGVLZXkpXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBdHRhY2hlcyB0aGUgZ2l2ZW4gbGlzdCBvZiBwZXJtaXNzaW9ucyB0byBhbGwgdGhlIHJvdXRlcy4gVGhpcyBhbGxvd3MgdGhlIGZ1bmN0aW9ucyB0byBhY2Nlc3Mgb3RoZXIgQVdTIHJlc291cmNlcy5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogYGBganNcbiAgICogYXBpLmF0dGFjaFBlcm1pc3Npb25zKFtcInMzXCJdKTtcbiAgICogYGBgXG4gICAqL1xuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKTogdm9pZCB7XG4gICAgT2JqZWN0LnZhbHVlcyh0aGlzLmZ1bmN0aW9ucykuZm9yRWFjaCgoZm4pID0+XG4gICAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucylcbiAgICApO1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFJvdXRlcy5wdXNoKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBdHRhY2hlcyB0aGUgZ2l2ZW4gbGlzdCBvZiBwZXJtaXNzaW9ucyB0byBhIHNwZWNpZmljIHJvdXRlLiBUaGlzIGFsbG93cyB0aGF0IGZ1bmN0aW9uIHRvIGFjY2VzcyBvdGhlciBBV1MgcmVzb3VyY2VzLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqc1xuICAgKiBhcGkuYXR0YWNoUGVybWlzc2lvbnNUb1JvdXRlKFwiJGNvbm5lY3RcIiwgW1wiczNcIl0pO1xuICAgKiBgYGBcbiAgICpcbiAgICovXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9uc1RvUm91dGUoXG4gICAgcm91dGVLZXk6IHN0cmluZyxcbiAgICBwZXJtaXNzaW9uczogUGVybWlzc2lvbnNcbiAgKTogdm9pZCB7XG4gICAgY29uc3QgZm4gPSB0aGlzLmdldEZ1bmN0aW9uKHJvdXRlS2V5KTtcbiAgICBpZiAoIWZuKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gYXR0YWNoIHBlcm1pc3Npb25zLiBSb3V0ZSBcIiR7cm91dGVLZXl9XCIgZG9lcyBub3QgZXhpc3QuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q29uc3RydWN0TWV0YWRhdGEoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwiV2ViU29ja2V0QXBpXCIgYXMgY29uc3QsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGh0dHBBcGlJZDogdGhpcy5jZGsud2ViU29ja2V0QXBpLmFwaUlkLFxuICAgICAgICBjdXN0b21Eb21haW5Vcmw6IHRoaXMuX2N1c3RvbURvbWFpblVybCxcbiAgICAgICAgcm91dGVzOiBPYmplY3QuZW50cmllcyh0aGlzLmZ1bmN0aW9ucykubWFwKChbcm91dGVLZXksIGZuXSkgPT4gKHtcbiAgICAgICAgICByb3V0ZTogcm91dGVLZXksXG4gICAgICAgICAgZm46IGdldEZ1bmN0aW9uUmVmKGZuKSxcbiAgICAgICAgfSkpLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVXZWJTb2NrZXRBcGkoKSB7XG4gICAgY29uc3QgeyBjZGsgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgaWQgPSB0aGlzLm5vZGUuaWQ7XG4gICAgY29uc3QgYXBwID0gdGhpcy5ub2RlLnJvb3QgYXMgQXBwO1xuXG4gICAgaWYgKGlzQ0RLQ29uc3RydWN0KGNkaz8ud2ViU29ja2V0QXBpKSkge1xuICAgICAgdGhpcy5jZGsud2ViU29ja2V0QXBpID0gY2RrPy53ZWJTb2NrZXRBcGkgYXMgYXBpZy5XZWJTb2NrZXRBcGk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFZhbGlkYXRlIGlucHV0XG4gICAgICBpZiAoaXNDREtDb25zdHJ1Y3QoY2RrPy53ZWJTb2NrZXRTdGFnZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgaW1wb3J0IHRoZSBcIndlYlNvY2tldFN0YWdlXCIgd2hlbiB0aGUgXCJ3ZWJTb2NrZXRBcGlcIiBpcyBub3QgaW1wb3J0ZWQuYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB3ZWJTb2NrZXRBcGlQcm9wcyA9IChjZGs/LndlYlNvY2tldEFwaSB8fFxuICAgICAgICB7fSkgYXMgYXBpZy5XZWJTb2NrZXRBcGlQcm9wcztcblxuICAgICAgLy8gQ3JlYXRlIFdlYlNvY2tldCBBUElcbiAgICAgIHRoaXMuY2RrLndlYlNvY2tldEFwaSA9IG5ldyBhcGlnLldlYlNvY2tldEFwaSh0aGlzLCBcIkFwaVwiLCB7XG4gICAgICAgIGFwaU5hbWU6IGFwcC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKSxcbiAgICAgICAgLi4ud2ViU29ja2V0QXBpUHJvcHMsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVdlYlNvY2tldFN0YWdlKCkge1xuICAgIGNvbnN0IHsgY2RrLCBhY2Nlc3NMb2csIGN1c3RvbURvbWFpbiB9ID0gdGhpcy5wcm9wcztcblxuICAgIGlmIChpc0NES0NvbnN0cnVjdChjZGs/LndlYlNvY2tldFN0YWdlKSkge1xuICAgICAgaWYgKGFjY2Vzc0xvZyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJhY2Nlc3NMb2dcIiB3aGVuIFwid2ViU29ja2V0U3RhZ2VcIiBpcyBhIGNvbnN0cnVjdGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChjdXN0b21Eb21haW4gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiY3VzdG9tRG9tYWluXCIgd2hlbiBcIndlYlNvY2tldFN0YWdlXCIgaXMgYSBjb25zdHJ1Y3RgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICB0aGlzLmNkay53ZWJTb2NrZXRTdGFnZSA9IGNkaz8ud2ViU29ja2V0U3RhZ2UgYXMgYXBpZy5XZWJTb2NrZXRTdGFnZTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgd2ViU29ja2V0U3RhZ2VQcm9wcyA9IChjZGs/LndlYlNvY2tldFN0YWdlIHx8XG4gICAgICAgIHt9KSBhcyBXZWJTb2NrZXRBcGlDZGtTdGFnZVByb3BzO1xuXG4gICAgICAvLyBWYWxpZGF0ZSBpbnB1dFxuICAgICAgaWYgKHdlYlNvY2tldFN0YWdlUHJvcHMuZG9tYWluTWFwcGluZyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgRG8gbm90IGNvbmZpZ3VyZSB0aGUgXCJ3ZWJTb2NrZXRTdGFnZS5kb21haW5NYXBwaW5nXCIuIFVzZSB0aGUgXCJjdXN0b21Eb21haW5cIiB0byBjb25maWd1cmUgdGhlIEFwaSBkb21haW4uYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBDb25maWd1cmUgQ3VzdG9tIERvbWFpblxuICAgICAgY29uc3QgY3VzdG9tRG9tYWluRGF0YSA9IGFwaWdWMkRvbWFpbi5idWlsZEN1c3RvbURvbWFpbkRhdGEoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGN1c3RvbURvbWFpblxuICAgICAgKTtcbiAgICAgIGxldCBkb21haW5NYXBwaW5nO1xuICAgICAgaWYgKGN1c3RvbURvbWFpbkRhdGEpIHtcbiAgICAgICAgaWYgKGN1c3RvbURvbWFpbkRhdGEuaXNBcGlnRG9tYWluQ3JlYXRlZCkge1xuICAgICAgICAgIHRoaXMuY2RrLmRvbWFpbk5hbWUgPSBjdXN0b21Eb21haW5EYXRhLmFwaWdEb21haW4gYXMgYXBpZy5Eb21haW5OYW1lO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjdXN0b21Eb21haW5EYXRhLmlzQ2VydGlmaWNhdGVkQ3JlYXRlZCkge1xuICAgICAgICAgIHRoaXMuY2RrLmNlcnRpZmljYXRlID1cbiAgICAgICAgICAgIGN1c3RvbURvbWFpbkRhdGEuY2VydGlmaWNhdGUgYXMgYWNtLkNlcnRpZmljYXRlO1xuICAgICAgICB9XG4gICAgICAgIGRvbWFpbk1hcHBpbmcgPSB7XG4gICAgICAgICAgZG9tYWluTmFtZTogY3VzdG9tRG9tYWluRGF0YS5hcGlnRG9tYWluLFxuICAgICAgICAgIG1hcHBpbmdLZXk6IGN1c3RvbURvbWFpbkRhdGEubWFwcGluZ0tleSxcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5fY3VzdG9tRG9tYWluVXJsID0gYHdzczovLyR7Y3VzdG9tRG9tYWluRGF0YS51cmx9YDtcbiAgICAgIH1cblxuICAgICAgLy8gQ3JlYXRlIHN0YWdlXG4gICAgICB0aGlzLmNkay53ZWJTb2NrZXRTdGFnZSA9IG5ldyBhcGlnLldlYlNvY2tldFN0YWdlKHRoaXMsIFwiU3RhZ2VcIiwge1xuICAgICAgICB3ZWJTb2NrZXRBcGk6IHRoaXMuY2RrLndlYlNvY2tldEFwaSxcbiAgICAgICAgc3RhZ2VOYW1lOiAodGhpcy5ub2RlLnJvb3QgYXMgQXBwKS5zdGFnZSxcbiAgICAgICAgYXV0b0RlcGxveTogdHJ1ZSxcbiAgICAgICAgZG9tYWluTWFwcGluZyxcbiAgICAgICAgLi4ud2ViU29ja2V0U3RhZ2VQcm9wcyxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBDb25maWd1cmUgQWNjZXNzIExvZ1xuICAgICAgdGhpcy5jZGsuYWNjZXNzTG9nR3JvdXAgPSBhcGlnVjJBY2Nlc3NMb2cuYnVpbGRBY2Nlc3NMb2dEYXRhKFxuICAgICAgICB0aGlzLFxuICAgICAgICBhY2Nlc3NMb2csXG4gICAgICAgIHRoaXMuY2RrLndlYlNvY2tldFN0YWdlLFxuICAgICAgICB0cnVlXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkQXV0aG9yaXplcigpIHtcbiAgICBjb25zdCB7IGF1dGhvcml6ZXIgfSA9IHRoaXMucHJvcHM7XG5cbiAgICBpZiAoIWF1dGhvcml6ZXIgfHwgYXV0aG9yaXplciA9PT0gXCJub25lXCIpIHtcbiAgICAgIHRoaXMuYXV0aG9yaXplciA9IFwibm9uZVwiO1xuICAgIH0gZWxzZSBpZiAoYXV0aG9yaXplciA9PT0gXCJpYW1cIikge1xuICAgICAgdGhpcy5hdXRob3JpemVyID0gXCJpYW1cIjtcbiAgICB9IGVsc2UgaWYgKGF1dGhvcml6ZXIuY2RrPy5hdXRob3JpemVyKSB7XG4gICAgICB0aGlzLmF1dGhvcml6ZXIgPSBhdXRob3JpemVyLmNkay5hdXRob3JpemVyO1xuICAgIH0gZWxzZSBpZiAoIWF1dGhvcml6ZXIuZnVuY3Rpb24pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBcImZ1bmN0aW9uXCIgZm9yIGF1dGhvcml6ZXJgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5hdXRob3JpemVyID0gbmV3IGFwaWdBdXRob3JpemVycy5XZWJTb2NrZXRMYW1iZGFBdXRob3JpemVyKFxuICAgICAgICBcIldlYlNvY2tldEF1dGhvcml6ZXJcIixcbiAgICAgICAgYXV0aG9yaXplci5mdW5jdGlvbixcbiAgICAgICAge1xuICAgICAgICAgIGF1dGhvcml6ZXJOYW1lOiBhdXRob3JpemVyLm5hbWUsXG4gICAgICAgICAgaWRlbnRpdHlTb3VyY2U6IGF1dGhvcml6ZXIuaWRlbnRpdHlTb3VyY2UsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGRSb3V0ZShcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHJvdXRlS2V5OiBzdHJpbmcsXG4gICAgcm91dGVWYWx1ZTogRnVuY3Rpb25JbmxpbmVEZWZpbml0aW9uIHwgV2ViU29ja2V0QXBpRnVuY3Rpb25Sb3V0ZVByb3BzXG4gICk6IEZuIHtcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gTm9ybWFsaXplIHJvdXRlS2V5XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIHJvdXRlS2V5ID0gdGhpcy5ub3JtYWxpemVSb3V0ZUtleShyb3V0ZUtleSk7XG4gICAgaWYgKHRoaXMuZnVuY3Rpb25zW3JvdXRlS2V5XSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBBIHJvdXRlIGFscmVhZHkgZXhpc3RzIGZvciBcIiR7cm91dGVLZXl9XCJgKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIEZ1bmN0aW9uXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IGxhbWJkYSA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICByb3V0ZUtleSxcbiAgICAgIEZuLmlzSW5saW5lRGVmaW5pdGlvbihyb3V0ZVZhbHVlKSA/IHJvdXRlVmFsdWUgOiByb3V0ZVZhbHVlLmZ1bmN0aW9uLFxuICAgICAgdGhpcy5wcm9wcy5kZWZhdWx0cz8uZnVuY3Rpb24sXG4gICAgICBgVGhlIFwiZGVmYXVsdHMuZnVuY3Rpb25cIiBjYW5ub3QgYmUgYXBwbGllZCBpZiBhbiBpbnN0YW5jZSBvZiBhIEZ1bmN0aW9uIGNvbnN0cnVjdCBpcyBwYXNzZWQgaW4uIE1ha2Ugc3VyZSB0byBkZWZpbmUgYWxsIHRoZSByb3V0ZXMgdXNpbmcgRnVuY3Rpb25Qcm9wcywgc28gdGhlIEFwaSBjb25zdHJ1Y3QgY2FuIGFwcGx5IHRoZSBcImRlZmF1bHRzLmZ1bmN0aW9uXCIgdG8gdGhlbS5gXG4gICAgKTtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBHZXQgYXV0aG9yaXphdGlvblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCB7IGF1dGhvcml6YXRpb25UeXBlLCBhdXRob3JpemVyIH0gPSB0aGlzLmJ1aWxkUm91dGVBdXRoKCk7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIHJvdXRlXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IHJvdXRlID0gbmV3IGFwaWcuV2ViU29ja2V0Um91dGUoc2NvcGUsIGBSb3V0ZV8ke3JvdXRlS2V5fWAsIHtcbiAgICAgIHdlYlNvY2tldEFwaTogdGhpcy5jZGsud2ViU29ja2V0QXBpLFxuICAgICAgcm91dGVLZXksXG4gICAgICBpbnRlZ3JhdGlvbjogbmV3IGFwaWdJbnRlZ3JhdGlvbnMuV2ViU29ja2V0TGFtYmRhSW50ZWdyYXRpb24oXG4gICAgICAgIGBJbnRlZ3JhdGlvbl8ke3JvdXRlS2V5fWAsXG4gICAgICAgIGxhbWJkYVxuICAgICAgKSxcbiAgICAgIGF1dGhvcml6ZXI6IHJvdXRlS2V5ID09PSBcIiRjb25uZWN0XCIgPyBhdXRob3JpemVyIDogdW5kZWZpbmVkLFxuICAgIH0pO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENvbmZpZ3VyZSBhdXRob3JpemF0aW9uXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgLy8gTm90ZTogYXMgb2YgQ0RLIHYxLjEzOC4wLCBhd3MtYXBpZ2F0ZXdheXYyLldlYlNvY2tldFJvdXRlIGRvZXMgbm90XG4gICAgLy8gICAgICAgc3VwcG9ydCBJQU0gYXV0aG9yaXphdGlvbiB0eXBlLiBXZSBuZWVkIHRvIG1hbnVhbGx5IGNvbmZpZ3VyZSBpdC5cbiAgICBpZiAocm91dGVLZXkgPT09IFwiJGNvbm5lY3RcIikge1xuICAgICAgLy8gQ29uZmlndXJlIHJvdXRlIGF1dGhvcml6YXRpb24gdHlwZVxuICAgICAgLy8gTm90ZTogd2UgbmVlZCB0byBleHBsaWNpdGx5IHNldCBgY2ZuUm91dGUuYXV0aG9yaXphdGlvblR5cGVgIHRvIGBOT05FYFxuICAgICAgLy8gICAgICAgYmVjYXVzZSBpZiBpdCB3ZXJlIHNldCB0byBgQVdTX0lBTWAsIGFuZCB0aGVuIGl0IGlzIHJlbW92ZWQgZnJvbVxuICAgICAgLy8gICAgICAgdGhlIENsb3VkRm9ybWF0aW9uIHRlbXBsYXRlIChpZS4gc2V0IHRvIHVuZGVmaW5lZCksIENsb3VkRm9ybWF0aW9uXG4gICAgICAvLyAgICAgICBkb2Vzbid0IHVwZGF0ZXMgdGhlIHJvdXRlLiBUaGUgcm91dGUncyBhdXRob3JpemF0aW9uVHlwZSB3b3VsZFxuICAgICAgLy8gICAgICAgc3RpbGwgYmUgYEFXU19JQU1gLlxuICAgICAgY29uc3QgY2ZuUm91dGUgPSByb3V0ZS5ub2RlLmRlZmF1bHRDaGlsZCBhcyBjZm5BcGlnLkNmblJvdXRlO1xuICAgICAgY2ZuUm91dGUuYXV0aG9yaXphdGlvblR5cGUgPSBhdXRob3JpemF0aW9uVHlwZTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gU3RvcmUgZnVuY3Rpb25cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgdGhpcy5mdW5jdGlvbnNbcm91dGVLZXldID0gbGFtYmRhO1xuXG4gICAgcmV0dXJuIGxhbWJkYTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRSb3V0ZUF1dGgoKSB7XG4gICAgaWYgKHRoaXMuYXV0aG9yaXplciA9PT0gXCJub25lXCIpIHtcbiAgICAgIHJldHVybiB7IGF1dGhvcml6YXRpb25UeXBlOiBcIk5PTkVcIiB9O1xuICAgIH0gZWxzZSBpZiAodGhpcy5hdXRob3JpemVyID09PSBcImlhbVwiKSB7XG4gICAgICByZXR1cm4geyBhdXRob3JpemF0aW9uVHlwZTogXCJBV1NfSUFNXCIgfTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgYXV0aG9yaXphdGlvblR5cGU6IFwiQ1VTVE9NXCIsXG4gICAgICBhdXRob3JpemVyOiB0aGlzLmF1dGhvcml6ZXIsXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgbm9ybWFsaXplUm91dGVLZXkocm91dGVLZXk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHJvdXRlS2V5LnRyaW0oKTtcbiAgfVxufVxuIl19