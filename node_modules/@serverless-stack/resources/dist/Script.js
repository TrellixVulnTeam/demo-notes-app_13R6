"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Script = void 0;
const path_1 = __importDefault(require("path"));
const constructs_1 = require("constructs");
const cdk = __importStar(require("aws-cdk-lib"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
/**
 * The `Script` construct is a higher level CDK construct that makes it easy to run a script in a Lambda function during the deployment process. It provides a simple way to build and bundle the script function; and allows you to pass parameter values based on outputs from other constructs in your SST app. So you don't have to hard code values in your script. You can configure a script to run before or after any of the stacks or resources are deployed in your app.
 *
 * Since the script is running inside a Lambda function, it can interact with resources like the RDS databases, that are inside a VPC; and make AWS API calls to services that the IAM credentials in your local environment or CI might not have permissions to.
 *
 * A few things to note:
 * - It does not run locally. It runs inside a Lambda function.
 * - It gets run on every deployment.
 * - It can run for a maximum of 15 minutes.
 * - [Live Lambda Dev](/live-lambda-development.md) is not enabled for these functions.
 *
 * @example
 * ### Minimal config
 *
 * ```js
 * import { Script } from "@serverless-stack/resources";
 *
 * new Script(stack, "Script", {
 *   onCreate: "src/function.create",
 *   onUpdate: "src/function.update",
 *   onDelete: "src/function.delete",
 * });
 * ```
 *
 */
class Script extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        if (props.function)
            this.checkDeprecatedFunction();
        // Validate deprecated "function" prop
        // Validate at least 1 function is provided
        if (!props.onCreate && !props.onUpdate && !props.onDelete) {
            throw new Error(`Need to provide at least one of "onCreate", "onUpdate", or "onDelete" functions for the "${this.node.id}" Script`);
        }
        const root = scope.node.root;
        this.props = props;
        this.createFunction = this.createUserFunction("onCreate", props.onCreate);
        this.updateFunction = this.createUserFunction("onUpdate", props.onUpdate);
        this.deleteFunction = this.createUserFunction("onDelete", props.onDelete);
        const crFunction = this.createCustomResourceFunction();
        this.createCustomResource(root, crFunction);
    }
    /**
     * Grants additional permissions to the script
     *
     * @example
     * ```js
     * script.attachPermissions(["s3"]);
     * ```
     */
    attachPermissions(permissions) {
        var _a, _b, _c;
        (_a = this.createFunction) === null || _a === void 0 ? void 0 : _a.attachPermissions(permissions);
        (_b = this.updateFunction) === null || _b === void 0 ? void 0 : _b.attachPermissions(permissions);
        (_c = this.deleteFunction) === null || _c === void 0 ? void 0 : _c.attachPermissions(permissions);
    }
    createUserFunction(type, fnDef) {
        var _a, _b, _c;
        if (!fnDef) {
            return;
        }
        // function is construct => return function directly
        if (fnDef instanceof Function_1.Function) {
            // validate live dev is not enabled
            if (fnDef._isLiveDevEnabled) {
                throw new Error(`Live Lambda Dev cannot be enabled for functions in the Script construct. Set the "enableLiveDev" prop for the function to "false".`);
            }
            return Function_1.Function.fromDefinition(this, `${type}Function`, fnDef, (_a = this.props.defaults) === null || _a === void 0 ? void 0 : _a.function, `The "defaults.function" cannot be applied if an instance of a Function construct is passed in. Make sure to define the "${type}" function using FunctionProps, so the Script construct can apply the "defaults.function" to them.`);
        }
        // function is string => create function
        else if (typeof fnDef === "string") {
            return Function_1.Function.fromDefinition(this, `${type}Function`, {
                handler: fnDef,
                enableLiveDev: false,
            }, Object.assign({ timeout: 900 }, (_b = this.props.defaults) === null || _b === void 0 ? void 0 : _b.function));
        }
        // function is props => create function
        return Function_1.Function.fromDefinition(this, `${type}Function`, Object.assign(Object.assign({}, fnDef), { enableLiveDev: false }), Object.assign({ timeout: 900 }, (_c = this.props.defaults) === null || _c === void 0 ? void 0 : _c.function));
    }
    createCustomResourceFunction() {
        var _a, _b, _c;
        const handler = new lambda.Function(this, "ScriptHandler", {
            code: lambda.Code.fromAsset(path_1.default.join(__dirname, "Script")),
            runtime: lambda.Runtime.NODEJS_16_X,
            handler: "index.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        (_a = this.createFunction) === null || _a === void 0 ? void 0 : _a.grantInvoke(handler);
        (_b = this.updateFunction) === null || _b === void 0 ? void 0 : _b.grantInvoke(handler);
        (_c = this.deleteFunction) === null || _c === void 0 ? void 0 : _c.grantInvoke(handler);
        return handler;
    }
    createCustomResource(app, crFunction) {
        var _a, _b, _c;
        // Note: "BuiltAt" is set to current timestamp to ensure the Custom
        //       Resource function is run on every update.
        //
        //       Do not use the current timestamp in Live mode, b/c we want the
        //       this custom resource to remain the same in CloudFormation template
        //       when rebuilding infrastructure. Otherwise, there will always be
        //       a change when rebuilding infrastructure b/c the "BuildAt" property
        //       changes on each build.
        const builtAt = app.local ? app.debugStartedAt : Date.now();
        new cdk.CustomResource(this, "ScriptResource", {
            serviceToken: crFunction.functionArn,
            resourceType: "Custom::SSTScript",
            properties: {
                UserCreateFunction: (_a = this.createFunction) === null || _a === void 0 ? void 0 : _a.functionName,
                UserUpdateFunction: (_b = this.updateFunction) === null || _b === void 0 ? void 0 : _b.functionName,
                UserDeleteFunction: (_c = this.deleteFunction) === null || _c === void 0 ? void 0 : _c.functionName,
                UserParams: JSON.stringify(this.props.params || {}),
                BuiltAt: builtAt,
            },
        });
    }
    checkDeprecatedFunction() {
        throw new Error(`The "function" property has been replaced by "onCreate" and "onUpdate". More details on upgrading - https://docs.serverless-stack.com/constructs/Script#upgrading-to-v0460`);
    }
}
exports.Script = Script;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2NyaXB0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1NjcmlwdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGdEQUF3QjtBQUN4QiwyQ0FBdUM7QUFDdkMsaURBQW1DO0FBQ25DLCtEQUFpRDtBQUVqRCx5Q0FBK0U7QUF3RS9FLHFCQUFxQjtBQUNyQixZQUFZO0FBQ1oscUJBQXFCO0FBRXJCOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F3Qkc7QUFDSCxNQUFhLE1BQU8sU0FBUSxzQkFBUztJQWVuQyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQWtCO1FBQzFELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDakIsSUFBSyxLQUFhLENBQUMsUUFBUTtZQUFFLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1FBRTVELHNDQUFzQztRQUV0QywyQ0FBMkM7UUFDM0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRTtZQUN6RCxNQUFNLElBQUksS0FBSyxDQUNiLDRGQUE0RixJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsVUFBVSxDQUNuSCxDQUFDO1NBQ0g7UUFFRCxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUNwQyxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUVuQixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzFFLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUUsSUFBSSxDQUFDLGNBQWMsR0FBRyxJ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Q0YsdUVBQXVFO1FBQ3ZFLDJFQUEyRTtRQUMzRSx3RUFBd0U7UUFDeEUsMkVBQTJFO1FBQzNFLCtCQUErQjtRQUMvQixNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDNUQsSUFBSSxHQUFHLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBRTtZQUM3QyxZQUFZLEVBQUUsVUFBVSxDQUFDLFdBQVc7WUFDcEMsWUFBWSxFQUFFLG1CQUFtQjtZQUNqQyxVQUFVLEVBQUU7Z0JBQ1Ysa0JBQWtCLEVBQUUsTUFBQSxJQUFJLENBQUMsY0FBYywwQ0FBRSxZQUFZO2dCQUNyRCxrQkFBa0IsRUFBRSxNQUFBLElBQUksQ0FBQyxjQUFjLDBDQUFFLFlBQVk7Z0JBQ3JELGtCQUFrQixFQUFFLE1BQUEsSUFBSSxDQUFDLGNBQWMsMENBQUUsWUFBWTtnQkFDckQsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDO2dCQUNuRCxPQUFPLEVBQUUsT0FBTzthQUNqQjtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyx1QkFBdUI7UUFDN0IsTUFBTSxJQUFJLEtBQUssQ0FDYiw0S0FBNEssQ0FDN0ssQ0FBQztJQUNKLENBQUM7Q0FDRjtBQXhKRCx3QkF3SkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCAqIGFzIGNkayBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYVwiO1xuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vQXBwXCI7XG5pbXBvcnQgeyBGdW5jdGlvbiBhcyBGbiwgRnVuY3Rpb25Qcm9wcywgRnVuY3Rpb25EZWZpbml0aW9uIH0gZnJvbSBcIi4vRnVuY3Rpb25cIjtcbmltcG9ydCB7IFBlcm1pc3Npb25zIH0gZnJvbSBcIi4vdXRpbC9wZXJtaXNzaW9uXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2NyaXB0UHJvcHMge1xuICAvKipcbiAgICogQW4gb2JqZWN0IG9mIGlucHV0IHBhcmFtZXRlcnMgdG8gYmUgcGFzc2VkIHRvIHRoZSBzY3JpcHQuIE1hZGUgYXZhaWxhYmxlIGluIHRoZSBgZXZlbnRgIG9iamVjdCBvZiB0aGUgZnVuY3Rpb24uXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIGltcG9ydCB7IFNjcmlwdCB9IGZyb20gXCJAc2VydmVybGVzcy1zdGFjay9yZXNvdXJjZXNcIjtcbiAgICpcbiAgICogbmV3IFNjcmlwdChzdGFjaywgXCJTY3JpcHRcIiwge1xuICAgKiAgIG9uQ3JlYXRlOiBcInNyYy9zY3JpcHQuY3JlYXRlXCIsXG4gICAqICAgcGFyYW1zOiB7XG4gICAqICAgICBoZWxsbzogXCJ3b3JsZFwiLFxuICAgKiAgIH0sXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIHBhcmFtcz86IFJlY29yZDxzdHJpbmcsIGFueT47XG4gIGRlZmF1bHRzPzoge1xuICAgIC8qKlxuICAgICAqIFRoZSBkZWZhdWx0IGZ1bmN0aW9uIHByb3BzIHRvIGJlIGFwcGxpZWQgdG8gYWxsIHRoZSBMYW1iZGEgZnVuY3Rpb25zIGluIHRoZSBBUEkuIFRoZSBgZW52aXJvbm1lbnRgLCBgcGVybWlzc2lvbnNgIGFuZCBgbGF5ZXJzYCBwcm9wZXJ0aWVzIHdpbGwgYmUgbWVyZ2VkIHdpdGggcGVyIHJvdXRlIGRlZmluaXRpb25zIGlmIHRoZXkgYXJlIGRlZmluZWQuXG4gICAgICpcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIGBgYGpzXG4gICAgICogbmV3IFNjcmlwdChzdGFjaywgXCJBcGlcIiwge1xuICAgICAqICAgZGVmYXVsdHM6IHtcbiAgICAgKiAgICAgZnVuY3Rpb246IHtcbiAgICAgKiAgICAgICB0aW1lb3V0OiAyMCxcbiAgICAgKiAgICAgfVxuICAgICAqICAgfVxuICAgICAqIH0pO1xuICAgICAqIGBgYFxuICAgICAqL1xuICAgIGZ1bmN0aW9uPzogRnVuY3Rpb25Qcm9wcztcbiAgfTtcbiAgLyoqXG4gICAqIENyZWF0ZXMgdGhlIGZ1bmN0aW9uIHRoYXQgcnVucyB3aGVuIHRoZSBTY3JpcHQgaXMgY3JlYXRlZC5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogbmV3IFNjcmlwdChzdGFjaywgXCJBcGlcIiwge1xuICAgKiAgIG9uQ3JlYXRlOiBcInNyYy9mdW5jdGlvbi5oYW5kbGVyXCIsXG4gICAqIH0pXG4gICAqIGBgYFxuICAgKi9cbiAgb25DcmVhdGU/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIC8qKlxuICAgKiBDcmVhdGVzIHRoZSBmdW5jdGlvbiB0aGF0IHJ1bnMgb24gZXZlcnkgZGVwbG95IGFmdGVyIHRoZSBTY3JpcHQgaXMgY3JlYXRlZFxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqc1xuICAgKiBuZXcgU2NyaXB0KHN0YWNrLCBcIkFwaVwiLCB7XG4gICAqICAgb25VcGRhdGU6IFwic3JjL2Z1bmN0aW9uLmhhbmRsZXJcIixcbiAgICogfSlcbiAgICogYGBgXG4gICAqL1xuICBvblVwZGF0ZT86IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgLyoqXG4gICAqIENyZWF0ZSB0aGUgZnVuY3Rpb24gdGhhdCBydW5zIHdoZW4gdGhlIFNjcmlwdCBpcyBkZWxldGVkIGZyb20gdGhlIHN0YWNrLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqc1xuICAgKiBuZXcgU2NyaXB0KHN0YWNrLCBcIkFwaVwiLCB7XG4gICAqICAgb25EZWxldGU6IFwic3JjL2Z1bmN0aW9uLmhhbmRsZXJcIixcbiAgICogfSlcbiAgICogYGBgXG4gICAqL1xuICBvbkRlbGV0ZT86IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBDb25zdHJ1Y3Rcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4vKipcbiAqIFRoZSBgU2NyaXB0YCBjb25zdHJ1Y3QgaXMgYSBoaWdoZXIgbGV2ZWwgQ0RLIGNvbnN0cnVjdCB0aGF0IG1ha2VzIGl0IGVhc3kgdG8gcnVuIGEgc2NyaXB0IGluIGEgTGFtYmRhIGZ1bmN0aW9uIGR1cmluZyB0aGUgZGVwbG95bWVudCBwcm9jZXNzLiBJdCBwcm92aWRlcyBhIHNpbXBsZSB3YXkgdG8gYnVpbGQgYW5kIGJ1bmRsZSB0aGUgc2NyaXB0IGZ1bmN0aW9uOyBhbmQgYWxsb3dzIHlvdSB0byBwYXNzIHBhcmFtZXRlciB2YWx1ZXMgYmFzZWQgb24gb3V0cHV0cyBmcm9tIG90aGVyIGNvbnN0cnVjdHMgaW4geW91ciBTU1QgYXBwLiBTbyB5b3UgZG9uJ3QgaGF2ZSB0byBoYXJkIGNvZGUgdmFsdWVzIGluIHlvdXIgc2NyaXB0LiBZb3UgY2FuIGNvbmZpZ3VyZSBhIHNjcmlwdCB0byBydW4gYmVmb3JlIG9yIGFmdGVyIGFueSBvZiB0aGUgc3RhY2tzIG9yIHJlc291cmNlcyBhcmUgZGVwbG95ZWQgaW4geW91ciBhcHAuXG4gKlxuICogU2luY2UgdGhlIHNjcmlwdCBpcyBydW5uaW5nIGluc2lkZSBhIExhbWJkYSBmdW5jdGlvbiwgaXQgY2FuIGludGVyYWN0IHdpdGggcmVzb3VyY2VzIGxpa2UgdGhlIFJEUyBkYXRhYmFzZXMsIHRoYXQgYXJlIGluc2lkZSBhIFZQQzsgYW5kIG1ha2UgQVdTIEFQSSBjYWxscyB0byBzZXJ2aWNlcyB0aGF0IHRoZSBJQU0gY3JlZGVudGlhbHMgaW4geW91ciBsb2NhbCBlbnZpcm9ubWVudCBvciBDSSBtaWdodCBub3QgaGF2ZSBwZXJtaXNzaW9ucyB0by5cbiAqXG4gKiBBIGZldyB0aGluZ3MgdG8gbm90ZTpcbiAqIC0gSXQgZG9lcyBub3QgcnVuIGxvY2FsbHkuIEl0IHJ1bnMgaW5zaWRlIGEgTGFtYmRhIGZ1bmN0aW9uLlxuICogLSBJdCBnZXRzIHJ1biBvbiBldmVyeSBkZXBsb3ltZW50LlxuICogLSBJdCBjYW4gcnVuIGZvciBhIG1heGltdW0gb2YgMTUgbWludXRlcy5cbiAqIC0gW0xpdmUgTGFtYmRhIERldl0oL2xpdmUtbGFtYmRhLWRldmVsb3BtZW50Lm1kKSBpcyBub3QgZW5hYmxlZCBmb3IgdGhlc2UgZnVuY3Rpb25zLlxuICpcbiAqIEBleGFtcGxlXG4gKiAjIyMgTWluaW1hbCBjb25maWdcbiAqXG4gKiBgYGBqc1xuICogaW1wb3J0IHsgU2NyaXB0IH0gZnJvbSBcIkBzZXJ2ZXJsZXNzLXN0YWNrL3Jlc291cmNlc1wiO1xuICpcbiAqIG5ldyBTY3JpcHQoc3RhY2ssIFwiU2NyaXB0XCIsIHtcbiAqICAgb25DcmVhdGU6IFwic3JjL2Z1bmN0aW9uLmNyZWF0ZVwiLFxuICogICBvblVwZGF0ZTogXCJzcmMvZnVuY3Rpb24udXBkYXRlXCIsXG4gKiAgIG9uRGVsZXRlOiBcInNyYy9mdW5jdGlvbi5kZWxldGVcIixcbiAqIH0pO1xuICogYGBgXG4gKlxuICovXG5leHBvcnQgY2xhc3MgU2NyaXB0IGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgLyoqXG4gICAqIFRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgb25DcmVhdGUgYEZ1bmN0aW9uYCBpbnN0YW5jZS5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBjcmVhdGVGdW5jdGlvbj86IEZuO1xuICAvKipcbiAgICogVGhlIGludGVybmFsbHkgY3JlYXRlZCBvblVwZGF0ZSBgRnVuY3Rpb25gIGluc3RhbmNlLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHVwZGF0ZUZ1bmN0aW9uPzogRm47XG4gIC8qKlxuICAgKiBUaGUgaW50ZXJuYWxseSBjcmVhdGVkIG9uRGVsZXRlIGBGdW5jdGlvbmAgaW5zdGFuY2UuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgZGVsZXRlRnVuY3Rpb24/OiBGbjtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IHByb3BzOiBTY3JpcHRQcm9wcztcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogU2NyaXB0UHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuICAgIGlmICgocHJvcHMgYXMgYW55KS5mdW5jdGlvbikgdGhpcy5jaGVja0RlcHJlY2F0ZWRGdW5jdGlvbigpO1xuXG4gICAgLy8gVmFsaWRhdGUgZGVwcmVjYXRlZCBcImZ1bmN0aW9uXCIgcHJvcFxuXG4gICAgLy8gVmFsaWRhdGUgYXQgbGVhc3QgMSBmdW5jdGlvbiBpcyBwcm92aWRlZFxuICAgIGlmICghcHJvcHMub25DcmVhdGUgJiYgIXByb3BzLm9uVXBkYXRlICYmICFwcm9wcy5vbkRlbGV0ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgTmVlZCB0byBwcm92aWRlIGF0IGxlYXN0IG9uZSBvZiBcIm9uQ3JlYXRlXCIsIFwib25VcGRhdGVcIiwgb3IgXCJvbkRlbGV0ZVwiIGZ1bmN0aW9ucyBmb3IgdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgU2NyaXB0YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCByb290ID0gc2NvcGUubm9kZS5yb290IGFzIEFwcDtcbiAgICB0aGlzLnByb3BzID0gcHJvcHM7XG5cbiAgICB0aGlzLmNyZWF0ZUZ1bmN0aW9uID0gdGhpcy5jcmVhdGVVc2VyRnVuY3Rpb24oXCJvbkNyZWF0ZVwiLCBwcm9wcy5vbkNyZWF0ZSk7XG4gICAgdGhpcy51cGRhdGVGdW5jdGlvbiA9IHRoaXMuY3JlYXRlVXNlckZ1bmN0aW9uKFwib25VcGRhdGVcIiwgcHJvcHMub25VcGRhdGUpO1xuICAgIHRoaXMuZGVsZXRlRnVuY3Rpb24gPSB0aGlzLmNyZWF0ZVVzZXJGdW5jdGlvbihcIm9uRGVsZXRlXCIsIHByb3BzLm9uRGVsZXRlKTtcbiAgICBjb25zdCBjckZ1bmN0aW9uID0gdGhpcy5jcmVhdGVDdXN0b21SZXNvdXJjZUZ1bmN0aW9uKCk7XG4gICAgdGhpcy5jcmVhdGVDdXN0b21SZXNvdXJjZShyb290LCBjckZ1bmN0aW9uKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHcmFudHMgYWRkaXRpb25hbCBwZXJtaXNzaW9ucyB0byB0aGUgc2NyaXB0XG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIHNjcmlwdC5hdHRhY2hQZXJtaXNzaW9ucyhbXCJzM1wiXSk7XG4gICAqIGBgYFxuICAgKi9cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIHRoaXMuY3JlYXRlRnVuY3Rpb24/LmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcbiAgICB0aGlzLnVwZGF0ZUZ1bmN0aW9uPy5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gICAgdGhpcy5kZWxldGVGdW5jdGlvbj8uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGNyZWF0ZVVzZXJGdW5jdGlvbihcbiAgICB0eXBlOiBzdHJpbmcsXG4gICAgZm5EZWY/OiBGdW5jdGlvbkRlZmluaXRpb25cbiAgKTogRm4gfCB1bmRlZmluZWQge1xuICAgIGlmICghZm5EZWYpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBmdW5jdGlvbiBpcyBjb25zdHJ1Y3QgPT4gcmV0dXJuIGZ1bmN0aW9uIGRpcmVjdGx5XG4gICAgaWYgKGZuRGVmIGluc3RhbmNlb2YgRm4pIHtcbiAgICAgIC8vIHZhbGlkYXRlIGxpdmUgZGV2IGlzIG5vdCBlbmFibGVkXG4gICAgICBpZiAoZm5EZWYuX2lzTGl2ZURldkVuYWJsZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBMaXZlIExhbWJkYSBEZXYgY2Fubm90IGJlIGVuYWJsZWQgZm9yIGZ1bmN0aW9ucyBpbiB0aGUgU2NyaXB0IGNvbnN0cnVjdC4gU2V0IHRoZSBcImVuYWJsZUxpdmVEZXZcIiBwcm9wIGZvciB0aGUgZnVuY3Rpb24gdG8gXCJmYWxzZVwiLmBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgICB0aGlzLFxuICAgICAgICBgJHt0eXBlfUZ1bmN0aW9uYCxcbiAgICAgICAgZm5EZWYsXG4gICAgICAgIHRoaXMucHJvcHMuZGVmYXVsdHM/LmZ1bmN0aW9uLFxuICAgICAgICBgVGhlIFwiZGVmYXVsdHMuZnVuY3Rpb25cIiBjYW5ub3QgYmUgYXBwbGllZCBpZiBhbiBpbnN0YW5jZSBvZiBhIEZ1bmN0aW9uIGNvbnN0cnVjdCBpcyBwYXNzZWQgaW4uIE1ha2Ugc3VyZSB0byBkZWZpbmUgdGhlIFwiJHt0eXBlfVwiIGZ1bmN0aW9uIHVzaW5nIEZ1bmN0aW9uUHJvcHMsIHNvIHRoZSBTY3JpcHQgY29uc3RydWN0IGNhbiBhcHBseSB0aGUgXCJkZWZhdWx0cy5mdW5jdGlvblwiIHRvIHRoZW0uYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBmdW5jdGlvbiBpcyBzdHJpbmcgPT4gY3JlYXRlIGZ1bmN0aW9uXG4gICAgZWxzZSBpZiAodHlwZW9mIGZuRGVmID09PSBcInN0cmluZ1wiKSB7XG4gICAgICByZXR1cm4gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3R5cGV9RnVuY3Rpb25gLFxuICAgICAgICB7XG4gICAgICAgICAgaGFuZGxlcjogZm5EZWYsXG4gICAgICAgICAgZW5hYmxlTGl2ZURldjogZmFsc2UsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICB0aW1lb3V0OiA5MDAsXG4gICAgICAgICAgLi4udGhpcy5wcm9wcy5kZWZhdWx0cz8uZnVuY3Rpb24sXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gZnVuY3Rpb24gaXMgcHJvcHMgPT4gY3JlYXRlIGZ1bmN0aW9uXG4gICAgcmV0dXJuIEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgdGhpcyxcbiAgICAgIGAke3R5cGV9RnVuY3Rpb25gLFxuICAgICAge1xuICAgICAgICAuLi5mbkRlZixcbiAgICAgICAgZW5hYmxlTGl2ZURldjogZmFsc2UsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICB0aW1lb3V0OiA5MDAsXG4gICAgICAgIC4uLnRoaXMucHJvcHMuZGVmYXVsdHM/LmZ1bmN0aW9uLFxuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUN1c3RvbVJlc291cmNlRnVuY3Rpb24oKTogbGFtYmRhLkZ1bmN0aW9uIHtcbiAgICBjb25zdCBoYW5kbGVyID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBcIlNjcmlwdEhhbmRsZXJcIiwge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsIFwiU2NyaXB0XCIpKSxcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xNl9YLFxuICAgICAgaGFuZGxlcjogXCJpbmRleC5oYW5kbGVyXCIsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24ubWludXRlcygxNSksXG4gICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgIH0pO1xuICAgIHRoaXMuY3JlYXRlRnVuY3Rpb24/LmdyYW50SW52b2tlKGhhbmRsZXIpO1xuICAgIHRoaXMudXBkYXRlRnVuY3Rpb24/LmdyYW50SW52b2tlKGhhbmRsZXIpO1xuICAgIHRoaXMuZGVsZXRlRnVuY3Rpb24/LmdyYW50SW52b2tlKGhhbmRsZXIpO1xuXG4gICAgcmV0dXJuIGhhbmRsZXI7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUN1c3RvbVJlc291cmNlKGFwcDogQXBwLCBjckZ1bmN0aW9uOiBsYW1iZGEuRnVuY3Rpb24pOiB2b2lkIHtcbiAgICAvLyBOb3RlOiBcIkJ1aWx0QXRcIiBpcyBzZXQgdG8gY3VycmVudCB0aW1lc3RhbXAgdG8gZW5zdXJlIHRoZSBDdXN0b21cbiAgICAvLyAgICAgICBSZXNvdXJjZSBmdW5jdGlvbiBpcyBydW4gb24gZXZlcnkgdXBkYXRlLlxuICAgIC8vXG4gICAgLy8gICAgICAgRG8gbm90IHVzZSB0aGUgY3VycmVudCB0aW1lc3RhbXAgaW4gTGl2ZSBtb2RlLCBiL2Mgd2Ugd2FudCB0aGVcbiAgICAvLyAgICAgICB0aGlzIGN1c3RvbSByZXNvdXJjZSB0byByZW1haW4gdGhlIHNhbWUgaW4gQ2xvdWRGb3JtYXRpb24gdGVtcGxhdGVcbiAgICAvLyAgICAgICB3aGVuIHJlYnVpbGRpbmcgaW5mcmFzdHJ1Y3R1cmUuIE90aGVyd2lzZSwgdGhlcmUgd2lsbCBhbHdheXMgYmVcbiAgICAvLyAgICAgICBhIGNoYW5nZSB3aGVuIHJlYnVpbGRpbmcgaW5mcmFzdHJ1Y3R1cmUgYi9jIHRoZSBcIkJ1aWxkQXRcIiBwcm9wZXJ0eVxuICAgIC8vICAgICAgIGNoYW5nZXMgb24gZWFjaCBidWlsZC5cbiAgICBjb25zdCBidWlsdEF0ID0gYXBwLmxvY2FsID8gYXBwLmRlYnVnU3RhcnRlZEF0IDogRGF0ZS5ub3coKTtcbiAgICBuZXcgY2RrLkN1c3RvbVJlc291cmNlKHRoaXMsIFwiU2NyaXB0UmVzb3VyY2VcIiwge1xuICAgICAgc2VydmljZVRva2VuOiBjckZ1bmN0aW9uLmZ1bmN0aW9uQXJuLFxuICAgICAgcmVzb3VyY2VUeXBlOiBcIkN1c3RvbTo6U1NUU2NyaXB0XCIsXG4gICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIFVzZXJDcmVhdGVGdW5jdGlvbjogdGhpcy5jcmVhdGVGdW5jdGlvbj8uZnVuY3Rpb25OYW1lLFxuICAgICAgICBVc2VyVXBkYXRlRnVuY3Rpb246IHRoaXMudXBkYXRlRnVuY3Rpb24/LmZ1bmN0aW9uTmFtZSxcbiAgICAgICAgVXNlckRlbGV0ZUZ1bmN0aW9uOiB0aGlzLmRlbGV0ZUZ1bmN0aW9uPy5mdW5jdGlvbk5hbWUsXG4gICAgICAgIFVzZXJQYXJhbXM6IEpTT04uc3RyaW5naWZ5KHRoaXMucHJvcHMucGFyYW1zIHx8IHt9KSxcbiAgICAgICAgQnVpbHRBdDogYnVpbHRBdCxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNoZWNrRGVwcmVjYXRlZEZ1bmN0aW9uKCk6IHZvaWQge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBUaGUgXCJmdW5jdGlvblwiIHByb3BlcnR5IGhhcyBiZWVuIHJlcGxhY2VkIGJ5IFwib25DcmVhdGVcIiBhbmQgXCJvblVwZGF0ZVwiLiBNb3JlIGRldGFpbHMgb24gdXBncmFkaW5nIC0gaHR0cHM6Ly9kb2NzLnNlcnZlcmxlc3Mtc3RhY2suY29tL2NvbnN0cnVjdHMvU2NyaXB0I3VwZ3JhZGluZy10by12MDQ2MGBcbiAgICApO1xuICB9XG59XG4iXX0=