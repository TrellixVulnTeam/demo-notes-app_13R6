"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.EventBus = void 0;
const constructs_1 = require("constructs");
const events = __importStar(require("aws-cdk-lib/aws-events"));
const eventsTargets = __importStar(require("aws-cdk-lib/aws-events-targets"));
const Queue_1 = require("./Queue");
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
/**
 * The `EventBus` construct is a higher level CDK construct that makes it easy to create an [EventBridge Event Bus](https://aws.amazon.com/eventbridge/). You can create a bus that has a list of rules and targets. And you can publish messages to it from any part of your serverless app.
 *
 * You can have two types of targets; Function targets (with a Lambda function) or Queue targets (with an SQS queue). See the [examples](#examples) for more details.
 *
 * @example
 *
 * ### Using the minimal config
 *
 * ```js
 * import { EventBus } from "@serverless-stack/resources";
 *
 * new EventBus(stack, "Bus", {
 *   rules: {
 *     rule1: {
 *       pattern: { source: ["myevent"] },
 *       targets: {
 *         myTarget1: "src/function1.handler",
 *         myTarget2: "src/function2.handler"
 *       },
 *     },
 *   },
 * });
 * ```
 *
 * Note that, `rule1` here is simply a key to identify the rule.
 */
class EventBus extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.props = props || {};
        this.cdk = {};
        this.targetsData = {};
        this.permissionsAttachedForAllTargets = [];
        this.createEventBus();
        this.addRules(this, (props === null || props === void 0 ? void 0 : props.rules) || {});
    }
    /**
     * The ARN of the internally created `EventBus` instance.
     */
    get eventBusArn() {
        return this.cdk.eventBus.eventBusArn;
    }
    /**
     * The name of the internally created `EventBus` instance.
     */
    get eventBusName() {
        return this.cdk.eventBus.eventBusName;
    }
    /**
     * Add rules after the EventBus has been created.
     *
     * @example
     * ```js
     * bus.addRules(stack, {
     *   rule2: {
     *     pattern: { source: ["myevent"] },
     *       targets: {
     *         myTarget3: "src/function3.handler"
     *         myTarget4: "src/function4.handler"
     *       },
     *   },
     * });
     * ```
     */
    addRules(scope, rules) {
        Object.entries(rules).forEach(([ruleKey, rule]) => this.addRule(scope, ruleKey, rule));
    }
    /**
     * Add permissions to all event targets in this EventBus.
     *
     * @example
     * ```js {10}
     * bus.attachPermissions(["s3"]);
     * ```
     */
    attachPermissions(permissions) {
        Object.values(this.targetsData).forEach((rule) => Object.values(rule)
            .filter((target) => target instanceof Function_1.Function)
            .forEach((target) => target.attachPermissions(permissions)));
        this.permissionsAttachedForAllTargets.push(permissions);
    }
    /**
     * Add permissions to a specific event bus rule target
     *
     * @example
     * ```js {10}
     * const bus = new EventBus(stack, "Bus", {
     *   rules: {
     *     rule1: {
     *       pattern: { source: ["myevent"] },
     *       targets: {
     *         myTarget1: "src/function1.handler"
     *         myTarget2: "src/function2.handler"
     *       },
     *     },
     *   },
     * });
     *
     * bus.attachPermissionsToTarget("rule1", 0, ["s3"]);
     * ```
     */
    attachPermissionsToTarget(ruleKey, targetName, permissions) {
        const rule = this.targetsData[ruleKey];
        if (!rule) {
            throw new Error(`Cannot find the rule "${ruleKey}" in the "${this.node.id}" EventBus.`);
        }
        const target = rule[targetName];
        if (!(target instanceof Function_1.Function)) {
            throw new Error(`Cannot attach permissions to the "${this.node.id}" EventBus target because it's not a Lambda function`);
        }
        target.attachPermissions(permissions);
    }
    getConstructMetadata() {
        return {
            type: "EventBus",
            data: {
                eventBusName: this.cdk.eventBus.eventBusName,
                rules: Object.entries(this.targetsData).map(([ruleName, rule]) => ({
                    key: ruleName,
                    targets: Object.values(rule).map(Construct_1.getFunctionRef),
                    targetNames: Object.keys(rule),
                })),
            },
        };
    }
    createEventBus() {
        const app = this.node.root;
        const id = this.node.id;
        const { cdk } = this.props;
        if ((0, Construct_1.isCDKConstruct)(cdk === null || cdk === void 0 ? void 0 : cdk.eventBus)) {
            this.cdk.eventBus = cdk === null || cdk === void 0 ? void 0 : cdk.eventBus;
        }
        else {
            const ebProps = ((cdk === null || cdk === void 0 ? void 0 : cdk.eventBus) || {});
            this.cdk.eventBus = new events.EventBus(this, "EventBus", Object.assign({ 
                // Note: Set default eventBusName only if eventSourceName is not configured.
                //       This is because both cannot be configured at the same time.
                eventBusName: ebProps.eventSourceName
                    ? undefined
                    : app.logicalPrefixedName(id) }, ebProps));
        }
    }
    addRule(scope, ruleKey, rule) {
        var _a, _b, _c, _d;
        // Validate input
        // @ts-expect-error "eventBus" is not a prop
        if ((_a = rule.cdk) === null || _a === void 0 ? void 0 : _a.rule.eventBus) {
            throw new Error(`Cannot configure the "rule.cdk.rule.eventBus" in the "${this.node.id}" EventBus`);
        }
        // Validate rule not redefined
        if (this.targetsData[ruleKey]) {
            throw new Error(`A rule already exists for "${ruleKey}"`);
        }
        // Create Rule
        const root = this.node.root;
        const eventsRule = new events.Rule(scope, ruleKey, Object.assign(Object.assign({ ruleName: root.logicalPrefixedName(ruleKey) }, (_b = rule.cdk) === null || _b === void 0 ? void 0 : _b.rule), { eventPattern: rule.pattern
                ? Object.assign({}, rule.pattern) : (_d = (_c = rule.cdk) === null || _c === void 0 ? void 0 : _c.rule) === null || _d === void 0 ? void 0 : _d.eventPattern, eventBus: this.cdk.eventBus, targets: [] }));
        // Create Targets
        Object.entries(rule.targets || {}).forEach(([targetName, target]) => this.addTarget(scope, ruleKey, eventsRule, targetName, target));
    }
    addTarget(scope, ruleKey, eventsRule, targetName, target) {
        this.targetsData[ruleKey] = this.targetsData[ruleKey] || {};
        if (target instanceof Queue_1.Queue || target.queue) {
            target = target;
            this.addQueueTarget(scope, ruleKey, eventsRule, targetName, target);
        }
        else {
            target = target;
            this.addFunctionTarget(scope, ruleKey, eventsRule, targetName, target);
        }
    }
    addQueueTarget(scope, ruleKey, eventsRule, targetName, target) {
        var _a;
        // Parse target props
        let targetProps;
        let queue;
        if (target instanceof Queue_1.Queue) {
            target = target;
            queue = target;
        }
        else {
            target = target;
            targetProps = (_a = target.cdk) === null || _a === void 0 ? void 0 : _a.target;
            queue = target.queue;
        }
        this.targetsData[ruleKey][targetName] = queue;
        // Create target
        eventsRule.addTarget(new eventsTargets.SqsQueue(queue.cdk.queue, targetProps));
    }
    addFunctionTarget(scope, ruleKey, eventsRule, targetName, target) {
        var _a, _b;
        // Parse target props
        let targetProps;
        let functionDefinition;
        if (target.function) {
            target = target;
            targetProps = (_a = target.cdk) === null || _a === void 0 ? void 0 : _a.target;
            functionDefinition = target.function;
        }
        else {
            target = target;
            functionDefinition = target;
        }
        // Create function
        const fn = Function_1.Function.fromDefinition(scope, `Target_${this.node.id}_${ruleKey}_${targetName}`, functionDefinition, (_b = this.props.defaults) === null || _b === void 0 ? void 0 : _b.function, `The "defaults.function" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the targets using FunctionProps, so the EventBus construct can apply the "defaults.function" to them.`);
        this.targetsData[ruleKey][targetName] = fn;
        // Create target
        eventsRule.addTarget(new eventsTargets.LambdaFunction(fn, targetProps));
        // Attach existing permissions
        this.permissionsAttachedForAllTargets.forEach((permissions) => fn.attachPermissions(permissions));
    }
}
exports.EventBus = EventBus;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXZlbnRCdXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvRXZlbnRCdXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBdUM7QUFDdkMsK0RBQWlEO0FBQ2pELDhFQUFnRTtBQUVoRSxtQ0FBZ0M7QUFDaEMsMkNBQTJFO0FBQzNFLHlDQUtvQjtBQThOcEIscUJBQXFCO0FBQ3JCLFlBQVk7QUFDWixxQkFBcUI7QUFFckI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBMEJHO0FBQ0gsTUFBYSxRQUFTLFNBQVEsc0JBQVM7SUFXckMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFxQjtRQUM3RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsR0FBRyxHQUFHLEVBQVMsQ0FBQztRQUNyQixJQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsZ0NBQWdDLEdBQUcsRUFBRSxDQUFDO1FBRTNDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFBLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxLQUFLLEtBQUksRUFBRSxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBVyxXQUFXO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDO0lBQ3ZDLENBQUM7SUFFRDs7T0FFRztJQUNILElBQVcsWUFBWTtRQUNyQixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQztJQUN4QyxDQUFDO0lBRUQ7Ozs7Ozs7Ozs7Ozs7OztPQWVHO0lBQ0ksUUFBUSxDQUNiLEtB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QixFQUNsQixNQUFBLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSwwQ0FBRSxRQUFRLEVBQzdCLDhOQUE4TixDQUMvTixDQUFDO1FBQ0YsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFM0MsZ0JBQWdCO1FBQ2hCLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxhQUFhLENBQUMsY0FBYyxDQUFDLEVBQUUsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDO1FBRXhFLDhCQUE4QjtRQUM5QixJQUFJLENBQUMsZ0NBQWdDLENBQUMsT0FBTyxDQUFDLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FDNUQsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUNsQyxDQUFDO0lBQ0osQ0FBQztDQUNGO0FBcFJELDRCQW9SQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBldmVudHMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1ldmVudHNcIjtcbmltcG9ydCAqIGFzIGV2ZW50c1RhcmdldHMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1ldmVudHMtdGFyZ2V0c1wiO1xuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vQXBwXCI7XG5pbXBvcnQgeyBRdWV1ZSB9IGZyb20gXCIuL1F1ZXVlXCI7XG5pbXBvcnQgeyBnZXRGdW5jdGlvblJlZiwgU1NUQ29uc3RydWN0LCBpc0NES0NvbnN0cnVjdCB9IGZyb20gXCIuL0NvbnN0cnVjdFwiO1xuaW1wb3J0IHtcbiAgRnVuY3Rpb24gYXMgRm4sXG4gIEZ1bmN0aW9uUHJvcHMsXG4gIEZ1bmN0aW9uSW5saW5lRGVmaW5pdGlvbixcbiAgRnVuY3Rpb25EZWZpbml0aW9uLFxufSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuLyoqXG4gKiBVc2VkIHRvIGNvbmZpZ3VyZSBhbiBFdmVudEJ1cyBmdW5jdGlvbiB0YXJnZXRcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFdmVudEJ1c0Z1bmN0aW9uVGFyZ2V0UHJvcHMge1xuICAvKipcbiAgICogU3RyaW5nIGxpdGVyYWwgdG8gc2lnbmlmeSB0aGF0IHRoZSB0YXJnZXQgaXMgYSBmdW5jdGlvblxuICAgKi9cbiAgdHlwZT86IFwiZnVuY3Rpb25cIjtcbiAgLyoqXG4gICAqIFRoZSBmdW5jdGlvbiB0byB0cmlnZ2VyXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIG5ldyBFdmVudEJ1cyhzdGFjaywgXCJCdXNcIiwge1xuICAgKiAgIHJ1bGVzOiB7XG4gICAqICAgICBydWxlMToge1xuICAgKiAgICAgICB0YXJnZXRzOiB7XG4gICAqICAgICAgICAgbXlUYXJnZXQ6IHsgZnVuY3Rpb246IFwic3JjL2Z1bmN0aW9uLmhhbmRsZXJcIiB9LFxuICAgKiAgICAgICB9XG4gICAqICAgICB9LFxuICAgKiAgIH0sXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIGZ1bmN0aW9uOiBGdW5jdGlvbkRlZmluaXRpb247XG4gIGNkaz86IHtcbiAgICB0YXJnZXQ/OiBldmVudHNUYXJnZXRzLkxhbWJkYUZ1bmN0aW9uUHJvcHM7XG4gIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRCdXNRdWV1ZVRhcmdldFByb3BzIHtcbiAgLyoqXG4gICAqIFN0cmluZyBsaXRlcmFsIHRvIHNpZ25pZnkgdGhhdCB0aGUgdGFyZ2V0IGlzIGEgcXVldWVcbiAgICovXG4gIHR5cGU6IFwicXVldWVcIjtcbiAgLyoqXG4gICAqIFRoZSBxdWV1ZSB0byB0cmlnZ2VyXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIG5ldyBFdmVudEJ1cyhzdGFjaywgXCJCdXNcIiwge1xuICAgKiAgIHJ1bGVzOiB7XG4gICAqICAgICBydWxlMToge1xuICAgKiAgICAgICB0YXJnZXRzOiB7XG4gICAqICAgICAgICAgbXlUYXJnZXQ6IHtcbiAgICogICAgICAgICAgIHR5cGU6IFwicXVldWVcIixcbiAgICogICAgICAgICAgIHF1ZXVlOiBuZXcgUXVldWUoc3RhY2ssIFwiUXVldWVcIilcbiAgICogICAgICAgICB9XG4gICAqICAgICAgIH1cbiAgICogICAgIH0sXG4gICAqICAgfSxcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgcXVldWU6IFF1ZXVlO1xuICBjZGs/OiB7XG4gICAgdGFyZ2V0PzogZXZlbnRzVGFyZ2V0cy5TcXNRdWV1ZVByb3BzO1xuICB9O1xufVxuLyoqXG4gKiBVc2VkIHRvIGNvbmZpZ3VyZSBhbiBFdmVudEJ1cyBydWxlXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRCdXNSdWxlUHJvcHMge1xuICBwYXR0ZXJuPzoge1xuICAgIC8qKlxuICAgICAqIEEgbGlzdCBvZiBzb3VyY2VzIHRvIGZpbHRlciBvblxuICAgICAqXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBgYGBqc1xuICAgICAqIG5ldyBFdmVudEJ1cyhzdGFjaywgXCJCdXNcIiwge1xuICAgICAqICAgcnVsZXM6IHtcbiAgICAgKiAgICAgcnVsZTE6IHtcbiAgICAgKiAgICAgICBwYXR0ZXJuOiB7IHNvdXJjZTogW1wibXlldmVudFwiXSB9LFxuICAgICAqICAgICB9LFxuICAgICAqICAgfSxcbiAgICAgKiB9KTtcbiAgICAgKiBgYGBcbiAgICAgKi9cbiAgICBzb3VyY2U/OiBzdHJpbmdbXTtcbiAgICAvKipcbiAgICAgKiBGaWVsZHMgdG8gbWF0Y2ggb24gdGhlIGRldGFpbCBmaWVsZFxuICAgICAqXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBgYGBqc1xuICAgICAqIG5ldyBFdmVudEJ1cyhzdGFjaywgXCJCdXNcIiwge1xuICAgICAqICAgcnVsZXM6IHtcbiAgICAgKiAgICAgcnVsZTE6IHtcbiAgICAgKiAgICAgICBwYXR0ZXJuOiB7IGRldGFpbDogeyBGT086IDEgfSAgfSxcbiAgICAgKiAgICAgfSxcbiAgICAgKiAgIH0sXG4gICAgICogfSk7XG4gICAgICogYGBgXG4gICAgICovXG4gICAgZGV0YWlsPzogeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbiAgICAvKipcbiAgICAgKiBBIGxpc3Qgb2YgZGV0YWlsVHlwZXMgdG8gZmlsdGVyIG9uXG4gICAgICpcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIGBgYGpzXG4gICAgICogbmV3IEV2ZW50QnVzKHN0YWNrLCBcIkJ1c1wiLCB7XG4gICAgICogICBydWxlczoge1xuICAgICAqICAgICBydWxlMToge1xuICAgICAqICAgICAgIHBhdHRlcm46IHsgZGV0YWlsVHlwZXM6IFtcImZvb1wiXSAgfSxcbiAgICAgKiAgICAgfSxcbiAgICAgKiAgIH0sXG4gICAgICogfSk7XG4gICAgICogYGBgXG4gICAgICovXG4gICAgZGV0YWlsVHlwZT86IHN0cmluZ1tdO1xuICB9O1xuICAvKipcbiAgICogQ29uZmlndXJlIHRhcmdldHMgZm9yIHRoaXMgcnVsZS4gQ2FuIGJlIGEgZnVuY3Rpb24gb3IgcXVldWVcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganNcbiAgICogbmV3IEV2ZW50QnVzKHN0YWNrLCBcIkJ1c1wiLCB7XG4gICAqICAgcnVsZXM6IHtcbiAgICogICAgIHJ1bGUxOiB7XG4gICAqICAgICAgIHRhcmdldHM6IHtcbiAgICogICAgICAgICBteVRhcmdldDE6IFwic3JjL2Z1bmN0aW9uLmhhbmRsZXJcIixcbiAgICogICAgICAgICBteVRhcmdldDI6IG5ldyBRdWV1ZShzdGFjaywgXCJNeVF1ZXVlXCIpLFxuICAgKiAgICAgICB9XG4gICAqICAgICB9LFxuICAgKiAgIH0sXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIHRhcmdldHM/OiBSZWNvcmQ8XG4gICAgc3RyaW5nLFxuICAgIHwgRnVuY3Rpb25JbmxpbmVEZWZpbml0aW9uXG4gICAgfCBFdmVudEJ1c0Z1bmN0aW9uVGFyZ2V0UHJvcHNcbiAgICB8IFF1ZXVlXG4gICAgfCBFdmVudEJ1c1F1ZXVlVGFyZ2V0UHJvcHNcbiAgPjtcbiAgY2RrPzoge1xuICAgIC8qKlxuICAgICAqIENvbmZpZ3VyZSB0aGUgaW50ZXJuYWxseSBjcmVhdGVkIENESyBgUnVsZWAgaW5zdGFuY2UuXG4gICAgICpcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIGBgYGpzIHs1LTh9XG4gICAgICogbmV3IEV2ZW50QnVzKHN0YWNrLCBcIkJ1c1wiLCB7XG4gICAgICogICBydWxlczoge1xuICAgICAqICAgICBydWxlMToge1xuICAgICAqICAgICAgIGNkazoge1xuICAgICAqICAgICAgICAgcnVsZToge1xuICAgICAqICAgICAgICAgICBydWxlTmFtZTogXCJteS1ydWxlXCIsXG4gICAgICogICAgICAgICAgIGVuYWJsZWQ6IGZhbHNlLFxuICAgICAqICAgICAgICAgfSxcbiAgICAgKiAgICAgICB9LFxuICAgICAqICAgICAgIHRhcmdldHM6IHtcbiAgICAgKiAgICAgICAgIG15VGFyZ2V0MTogXCJ0ZXN0L2xhbWJkYS5oYW5kbGVyXCIsXG4gICAgICogICAgICAgfSxcbiAgICAgKiAgICAgfSxcbiAgICAgKiAgIH0sXG4gICAgICogfSk7XG4gICAgICogYGBgXG4gICAgICovXG4gICAgcnVsZT86IE9taXQ8ZXZlbnRzLlJ1bGVQcm9wcywgXCJldmVudEJ1c1wiIHwgXCJ0YXJnZXRzXCI+O1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEV2ZW50QnVzUHJvcHMge1xuICBkZWZhdWx0cz86IHtcbiAgICAvKipcbiAgICAgKiBUaGUgZGVmYXVsdCBmdW5jdGlvbiBwcm9wcyB0byBiZSBhcHBsaWVkIHRvIGFsbCB0aGUgTGFtYmRhIGZ1bmN0aW9ucyBpbiB0aGUgRXZlbnRCdXMuIFRoZSBgZW52aXJvbm1lbnRgLCBgcGVybWlzc2lvbnNgIGFuZCBgbGF5ZXJzYCBwcm9wZXJ0aWVzIHdpbGwgYmUgbWVyZ2VkIHdpdGggcGVyIHJvdXRlIGRlZmluaXRpb25zIGlmIHRoZXkgYXJlIGRlZmluZWQuXG4gICAgICpcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIGBgYGpzXG4gICAgICogbmV3IEV2ZW50QnVzKHN0YWNrLCBcIkJ1c1wiLCB7XG4gICAgICogICBkZWZhdWx0czoge1xuICAgICAqICAgICBmdW5jdGlvbjoge1xuICAgICAqICAgICAgIHRpbWVvdXQ6IDIwLFxuICAgICAqICAgICB9XG4gICAgICogICB9LFxuICAgICAqIH0pO1xuICAgICAqIGBgYFxuICAgICAqL1xuICAgIGZ1bmN0aW9uPzogRnVuY3Rpb25Qcm9wcztcbiAgfTtcbiAgLyoqXG4gICAqIFRoZSBydWxlcyBmb3IgdGhlIGV2ZW50YnVzXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzIHs1fVxuICAgKiBuZXcgRXZlbnRCdXMoc3RhY2ssIFwiQnVzXCIsIHtcbiAgICogICBydWxlczoge1xuICAgKiAgICAgcnVsZTE6IHtcbiAgICogICAgICAgcGF0dGVybjogeyBzb3VyY2U6IFtcIm15ZXZlbnRcIl0gfSxcbiAgICogICAgICAgdGFyZ2V0czoge1xuICAgKiAgICAgICAgIG15VGFyZ2V0OiBcInNyYy9mdW5jdGlvbi5oYW5kbGVyXCJcbiAgICogICAgICAgfSxcbiAgICogICAgIH0sXG4gICAqICAgfSxcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgcnVsZXM/OiBSZWNvcmQ8c3RyaW5nLCBFdmVudEJ1c1J1bGVQcm9wcz47XG4gIGNkaz86IHtcbiAgICAvKipcbiAgICAgKiBPdmVycmlkZSB0aGUgaW50ZXJuYWxseSBjcmVhdGVkIEV2ZW50QnVzXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBgYGBqc1xuICAgICAqIG5ldyBFdmVudEJ1cyhzdGFjaywgXCJCdXNcIiwge1xuICAgICAqICAgY2RrOiB7XG4gICAgICogICAgIGV2ZW50QnVzOiB7XG4gICAgICogICAgICAgZXZlbnRCdXNOYW1lOiBcIk15RXZlbnRCdXNcIixcbiAgICAgKiAgICAgfSxcbiAgICAgKiAgIH1cbiAgICAgKiB9KTtcbiAgICAgKiBgYGBcbiAgICAgKi9cbiAgICBldmVudEJ1cz86IGV2ZW50cy5JRXZlbnRCdXMgfCBldmVudHMuRXZlbnRCdXNQcm9wcztcbiAgfTtcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBDb25zdHJ1Y3Rcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4vKipcbiAqIFRoZSBgRXZlbnRCdXNgIGNvbnN0cnVjdCBpcyBhIGhpZ2hlciBsZXZlbCBDREsgY29uc3RydWN0IHRoYXQgbWFrZXMgaXQgZWFzeSB0byBjcmVhdGUgYW4gW0V2ZW50QnJpZGdlIEV2ZW50IEJ1c10oaHR0cHM6Ly9hd3MuYW1hem9uLmNvbS9ldmVudGJyaWRnZS8pLiBZb3UgY2FuIGNyZWF0ZSBhIGJ1cyB0aGF0IGhhcyBhIGxpc3Qgb2YgcnVsZXMgYW5kIHRhcmdldHMuIEFuZCB5b3UgY2FuIHB1Ymxpc2ggbWVzc2FnZXMgdG8gaXQgZnJvbSBhbnkgcGFydCBvZiB5b3VyIHNlcnZlcmxlc3MgYXBwLlxuICpcbiAqIFlvdSBjYW4gaGF2ZSB0d28gdHlwZXMgb2YgdGFyZ2V0czsgRnVuY3Rpb24gdGFyZ2V0cyAod2l0aCBhIExhbWJkYSBmdW5jdGlvbikgb3IgUXVldWUgdGFyZ2V0cyAod2l0aCBhbiBTUVMgcXVldWUpLiBTZWUgdGhlIFtleGFtcGxlc10oI2V4YW1wbGVzKSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIEBleGFtcGxlXG4gKlxuICogIyMjIFVzaW5nIHRoZSBtaW5pbWFsIGNvbmZpZ1xuICpcbiAqIGBgYGpzXG4gKiBpbXBvcnQgeyBFdmVudEJ1cyB9IGZyb20gXCJAc2VydmVybGVzcy1zdGFjay9yZXNvdXJjZXNcIjtcbiAqXG4gKiBuZXcgRXZlbnRCdXMoc3RhY2ssIFwiQnVzXCIsIHtcbiAqICAgcnVsZXM6IHtcbiAqICAgICBydWxlMToge1xuICogICAgICAgcGF0dGVybjogeyBzb3VyY2U6IFtcIm15ZXZlbnRcIl0gfSxcbiAqICAgICAgIHRhcmdldHM6IHtcbiAqICAgICAgICAgbXlUYXJnZXQxOiBcInNyYy9mdW5jdGlvbjEuaGFuZGxlclwiLFxuICogICAgICAgICBteVRhcmdldDI6IFwic3JjL2Z1bmN0aW9uMi5oYW5kbGVyXCJcbiAqICAgICAgIH0sXG4gKiAgICAgfSxcbiAqICAgfSxcbiAqIH0pO1xuICogYGBgXG4gKlxuICogTm90ZSB0aGF0LCBgcnVsZTFgIGhlcmUgaXMgc2ltcGx5IGEga2V5IHRvIGlkZW50aWZ5IHRoZSBydWxlLlxuICovXG5leHBvcnQgY2xhc3MgRXZlbnRCdXMgZXh0ZW5kcyBDb25zdHJ1Y3QgaW1wbGVtZW50cyBTU1RDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgY2RrOiB7XG4gICAgLyoqXG4gICAgICogVGhlIGludGVybmFsbHkgY3JlYXRlZCBDREsgYEV2ZW50QnVzYCBpbnN0YW5jZS5cbiAgICAgKi9cbiAgICBldmVudEJ1czogZXZlbnRzLklFdmVudEJ1cztcbiAgfTtcbiAgcHJpdmF0ZSByZWFkb25seSB0YXJnZXRzRGF0YTogUmVjb3JkPHN0cmluZywgUmVjb3JkPHN0cmluZywgRm4gfCBRdWV1ZT4+O1xuICBwcml2YXRlIHJlYWRvbmx5IHBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxUYXJnZXRzOiBQZXJtaXNzaW9uc1tdO1xuICBwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBFdmVudEJ1c1Byb3BzO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogRXZlbnRCdXNQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICB0aGlzLnByb3BzID0gcHJvcHMgfHwge307XG4gICAgdGhpcy5jZGsgPSB7fSBhcyBhbnk7XG4gICAgdGhpcy50YXJnZXRzRGF0YSA9IHt9O1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFRhcmdldHMgPSBbXTtcblxuICAgIHRoaXMuY3JlYXRlRXZlbnRCdXMoKTtcbiAgICB0aGlzLmFkZFJ1bGVzKHRoaXMsIHByb3BzPy5ydWxlcyB8fCB7fSk7XG4gIH1cblxuICAvKipcbiAgICogVGhlIEFSTiBvZiB0aGUgaW50ZXJuYWxseSBjcmVhdGVkIGBFdmVudEJ1c2AgaW5zdGFuY2UuXG4gICAqL1xuICBwdWJsaWMgZ2V0IGV2ZW50QnVzQXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuY2RrLmV2ZW50QnVzLmV2ZW50QnVzQXJuO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgYEV2ZW50QnVzYCBpbnN0YW5jZS5cbiAgICovXG4gIHB1YmxpYyBnZXQgZXZlbnRCdXNOYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuY2RrLmV2ZW50QnVzLmV2ZW50QnVzTmFtZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgcnVsZXMgYWZ0ZXIgdGhlIEV2ZW50QnVzIGhhcyBiZWVuIGNyZWF0ZWQuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIGJ1cy5hZGRSdWxlcyhzdGFjaywge1xuICAgKiAgIHJ1bGUyOiB7XG4gICAqICAgICBwYXR0ZXJuOiB7IHNvdXJjZTogW1wibXlldmVudFwiXSB9LFxuICAgKiAgICAgICB0YXJnZXRzOiB7XG4gICAqICAgICAgICAgbXlUYXJnZXQzOiBcInNyYy9mdW5jdGlvbjMuaGFuZGxlclwiXG4gICAqICAgICAgICAgbXlUYXJnZXQ0OiBcInNyYy9mdW5jdGlvbjQuaGFuZGxlclwiXG4gICAqICAgICAgIH0sXG4gICAqICAgfSxcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgcHVibGljIGFkZFJ1bGVzKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgcnVsZXM6IFJlY29yZDxzdHJpbmcsIEV2ZW50QnVzUnVsZVByb3BzPlxuICApOiB2b2lkIHtcbiAgICBPYmplY3QuZW50cmllcyhydWxlcykuZm9yRWFjaCgoW3J1bGVLZXksIHJ1bGVdKSA9PlxuICAgICAgdGhpcy5hZGRSdWxlKHNjb3BlLCBydWxlS2V5LCBydWxlKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIHBlcm1pc3Npb25zIHRvIGFsbCBldmVudCB0YXJnZXRzIGluIHRoaXMgRXZlbnRCdXMuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzIHsxMH1cbiAgICogYnVzLmF0dGFjaFBlcm1pc3Npb25zKFtcInMzXCJdKTtcbiAgICogYGBgXG4gICAqL1xuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKTogdm9pZCB7XG4gICAgT2JqZWN0LnZhbHVlcyh0aGlzLnRhcmdldHNEYXRhKS5mb3JFYWNoKChydWxlKSA9PlxuICAgICAgT2JqZWN0LnZhbHVlcyhydWxlKVxuICAgICAgICAuZmlsdGVyKCh0YXJnZXQpID0+IHRhcmdldCBpbnN0YW5jZW9mIEZuKVxuICAgICAgICAuZm9yRWFjaCgodGFyZ2V0KSA9PiB0YXJnZXQuYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpKVxuICAgICk7XG5cbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxUYXJnZXRzLnB1c2gocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBwZXJtaXNzaW9ucyB0byBhIHNwZWNpZmljIGV2ZW50IGJ1cyBydWxlIHRhcmdldFxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqcyB7MTB9XG4gICAqIGNvbnN0IGJ1cyA9IG5ldyBFdmVudEJ1cyhzdGFjaywgXCJCdXNcIiwge1xuICAgKiAgIHJ1bGVzOiB7XG4gICAqICAgICBydWxlMToge1xuICAgKiAgICAgICBwYXR0ZXJuOiB7IHNvdXJjZTogW1wibXlldmVudFwiXSB9LFxuICAgKiAgICAgICB0YXJnZXRzOiB7XG4gICAqICAgICAgICAgbXlUYXJnZXQxOiBcInNyYy9mdW5jdGlvbjEuaGFuZGxlclwiXG4gICAqICAgICAgICAgbXlUYXJnZXQyOiBcInNyYy9mdW5jdGlvbjIuaGFuZGxlclwiXG4gICAqICAgICAgIH0sXG4gICAqICAgICB9LFxuICAgKiAgIH0sXG4gICAqIH0pO1xuICAgKlxuICAgKiBidXMuYXR0YWNoUGVybWlzc2lvbnNUb1RhcmdldChcInJ1bGUxXCIsIDAsIFtcInMzXCJdKTtcbiAgICogYGBgXG4gICAqL1xuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNUb1RhcmdldChcbiAgICBydWxlS2V5OiBzdHJpbmcsXG4gICAgdGFyZ2V0TmFtZTogc3RyaW5nLFxuICAgIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uc1xuICApOiB2b2lkIHtcbiAgICBjb25zdCBydWxlID0gdGhpcy50YXJnZXRzRGF0YVtydWxlS2V5XTtcbiAgICBpZiAoIXJ1bGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYENhbm5vdCBmaW5kIHRoZSBydWxlIFwiJHtydWxlS2V5fVwiIGluIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIEV2ZW50QnVzLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgdGFyZ2V0ID0gcnVsZVt0YXJnZXROYW1lXTtcbiAgICBpZiAoISh0YXJnZXQgaW5zdGFuY2VvZiBGbikpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYENhbm5vdCBhdHRhY2ggcGVybWlzc2lvbnMgdG8gdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgRXZlbnRCdXMgdGFyZ2V0IGJlY2F1c2UgaXQncyBub3QgYSBMYW1iZGEgZnVuY3Rpb25gXG4gICAgICApO1xuICAgIH1cbiAgICB0YXJnZXQuYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGdldENvbnN0cnVjdE1ldGFkYXRhKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiBcIkV2ZW50QnVzXCIgYXMgY29uc3QsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGV2ZW50QnVzTmFtZTogdGhpcy5jZGsuZXZlbnRCdXMuZXZlbnRCdXNOYW1lLFxuICAgICAgICBydWxlczogT2JqZWN0LmVudHJpZXModGhpcy50YXJnZXRzRGF0YSkubWFwKChbcnVsZU5hbWUsIHJ1bGVdKSA9PiAoe1xuICAgICAgICAgIGtleTogcnVsZU5hbWUsXG4gICAgICAgICAgdGFyZ2V0czogT2JqZWN0LnZhbHVlcyhydWxlKS5tYXAoZ2V0RnVuY3Rpb25SZWYpLFxuICAgICAgICAgIHRhcmdldE5hbWVzOiBPYmplY3Qua2V5cyhydWxlKSxcbiAgICAgICAgfSkpLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVFdmVudEJ1cygpIHtcbiAgICBjb25zdCBhcHAgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3QgaWQgPSB0aGlzLm5vZGUuaWQ7XG4gICAgY29uc3QgeyBjZGsgfSA9IHRoaXMucHJvcHM7XG5cbiAgICBpZiAoaXNDREtDb25zdHJ1Y3QoY2RrPy5ldmVudEJ1cykpIHtcbiAgICAgIHRoaXMuY2RrLmV2ZW50QnVzID0gY2RrPy5ldmVudEJ1cyBhcyBldmVudHMuRXZlbnRCdXM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGViUHJvcHMgPSAoY2RrPy5ldmVudEJ1cyB8fCB7fSkgYXMgZXZlbnRzLkV2ZW50QnVzUHJvcHM7XG4gICAgICB0aGlzLmNkay5ldmVudEJ1cyA9IG5ldyBldmVudHMuRXZlbnRCdXModGhpcywgXCJFdmVudEJ1c1wiLCB7XG4gICAgICAgIC8vIE5vdGU6IFNldCBkZWZhdWx0IGV2ZW50QnVzTmFtZSBvbmx5IGlmIGV2ZW50U291cmNlTmFtZSBpcyBub3QgY29uZmlndXJlZC5cbiAgICAgICAgLy8gICAgICAgVGhpcyBpcyBiZWNhdXNlIGJvdGggY2Fubm90IGJlIGNvbmZpZ3VyZWQgYXQgdGhlIHNhbWUgdGltZS5cbiAgICAgICAgZXZlbnRCdXNOYW1lOiBlYlByb3BzLmV2ZW50U291cmNlTmFtZVxuICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgOiBhcHAubG9naWNhbFByZWZpeGVkTmFtZShpZCksXG4gICAgICAgIC4uLmViUHJvcHMsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFkZFJ1bGUoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBydWxlS2V5OiBzdHJpbmcsXG4gICAgcnVsZTogRXZlbnRCdXNSdWxlUHJvcHNcbiAgKTogdm9pZCB7XG4gICAgLy8gVmFsaWRhdGUgaW5wdXRcbiAgICAvLyBAdHMtZXhwZWN0LWVycm9yIFwiZXZlbnRCdXNcIiBpcyBub3QgYSBwcm9wXG4gICAgaWYgKHJ1bGUuY2RrPy5ydWxlLmV2ZW50QnVzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcInJ1bGUuY2RrLnJ1bGUuZXZlbnRCdXNcIiBpbiB0aGUgXCIke3RoaXMubm9kZS5pZH1cIiBFdmVudEJ1c2BcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgcnVsZSBub3QgcmVkZWZpbmVkXG4gICAgaWYgKHRoaXMudGFyZ2V0c0RhdGFbcnVsZUtleV0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQSBydWxlIGFscmVhZHkgZXhpc3RzIGZvciBcIiR7cnVsZUtleX1cImApO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBSdWxlXG4gICAgY29uc3Qgcm9vdCA9IHRoaXMubm9kZS5yb290IGFzIEFwcDtcbiAgICBjb25zdCBldmVudHNSdWxlID0gbmV3IGV2ZW50cy5SdWxlKHNjb3BlLCBydWxlS2V5LCB7XG4gICAgICBydWxlTmFtZTogcm9vdC5sb2dpY2FsUHJlZml4ZWROYW1lKHJ1bGVLZXkpLFxuICAgICAgLi4ucnVsZS5jZGs/LnJ1bGUsXG4gICAgICBldmVudFBhdHRlcm46IHJ1bGUucGF0dGVyblxuICAgICAgICA/IHsgLi4ucnVsZS5wYXR0ZXJuIH1cbiAgICAgICAgOiBydWxlLmNkaz8ucnVsZT8uZXZlbnRQYXR0ZXJuLFxuICAgICAgZXZlbnRCdXM6IHRoaXMuY2RrLmV2ZW50QnVzLFxuICAgICAgdGFyZ2V0czogW10sXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgVGFyZ2V0c1xuICAgIE9iamVjdC5lbnRyaWVzKHJ1bGUudGFyZ2V0cyB8fCB7fSkuZm9yRWFjaCgoW3RhcmdldE5hbWUsIHRhcmdldF0pID0+XG4gICAgICB0aGlzLmFkZFRhcmdldChzY29wZSwgcnVsZUtleSwgZXZlbnRzUnVsZSwgdGFyZ2V0TmFtZSwgdGFyZ2V0KVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGFkZFRhcmdldChcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHJ1bGVLZXk6IHN0cmluZyxcbiAgICBldmVudHNSdWxlOiBldmVudHMuUnVsZSxcbiAgICB0YXJnZXROYW1lOiBzdHJpbmcsXG4gICAgdGFyZ2V0OlxuICAgICAgfCBGdW5jdGlvbklubGluZURlZmluaXRpb25cbiAgICAgIHwgRXZlbnRCdXNGdW5jdGlvblRhcmdldFByb3BzXG4gICAgICB8IFF1ZXVlXG4gICAgICB8IEV2ZW50QnVzUXVldWVUYXJnZXRQcm9wc1xuICApOiB2b2lkIHtcbiAgICB0aGlzLnRhcmdldHNEYXRhW3J1bGVLZXldID0gdGhpcy50YXJnZXRzRGF0YVtydWxlS2V5XSB8fCB7fTtcblxuICAgIGlmICh0YXJnZXQgaW5zdGFuY2VvZiBRdWV1ZSB8fCAodGFyZ2V0IGFzIEV2ZW50QnVzUXVldWVUYXJnZXRQcm9wcykucXVldWUpIHtcbiAgICAgIHRhcmdldCA9IHRhcmdldCBhcyBRdWV1ZSB8IEV2ZW50QnVzUXVldWVUYXJnZXRQcm9wcztcbiAgICAgIHRoaXMuYWRkUXVldWVUYXJnZXQoc2NvcGUsIHJ1bGVLZXksIGV2ZW50c1J1bGUsIHRhcmdldE5hbWUsIHRhcmdldCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRhcmdldCA9IHRhcmdldCBhcyBGdW5jdGlvbklubGluZURlZmluaXRpb24gfCBFdmVudEJ1c0Z1bmN0aW9uVGFyZ2V0UHJvcHM7XG4gICAgICB0aGlzLmFkZEZ1bmN0aW9uVGFyZ2V0KHNjb3BlLCBydWxlS2V5LCBldmVudHNSdWxlLCB0YXJnZXROYW1lLCB0YXJnZXQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkUXVldWVUYXJnZXQoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBydWxlS2V5OiBzdHJpbmcsXG4gICAgZXZlbnRzUnVsZTogZXZlbnRzLlJ1bGUsXG4gICAgdGFyZ2V0TmFtZTogc3RyaW5nLFxuICAgIHRhcmdldDogUXVldWUgfCBFdmVudEJ1c1F1ZXVlVGFyZ2V0UHJvcHNcbiAgKTogdm9pZCB7XG4gICAgLy8gUGFyc2UgdGFyZ2V0IHByb3BzXG4gICAgbGV0IHRhcmdldFByb3BzO1xuICAgIGxldCBxdWV1ZTtcbiAgICBpZiAodGFyZ2V0IGluc3RhbmNlb2YgUXVldWUpIHtcbiAgICAgIHRhcmdldCA9IHRhcmdldCBhcyBRdWV1ZTtcbiAgICAgIHF1ZXVlID0gdGFyZ2V0O1xuICAgIH0gZWxzZSB7XG4gICAgICB0YXJnZXQgPSB0YXJnZXQgYXMgRXZlbnRCdXNRdWV1ZVRhcmdldFByb3BzO1xuICAgICAgdGFyZ2V0UHJvcHMgPSB0YXJnZXQuY2RrPy50YXJnZXQ7XG4gICAgICBxdWV1ZSA9IHRhcmdldC5xdWV1ZTtcbiAgICB9XG4gICAgdGhpcy50YXJnZXRzRGF0YVtydWxlS2V5XVt0YXJnZXROYW1lXSA9IHF1ZXVlO1xuXG4gICAgLy8gQ3JlYXRlIHRhcmdldFxuICAgIGV2ZW50c1J1bGUuYWRkVGFyZ2V0KFxuICAgICAgbmV3IGV2ZW50c1RhcmdldHMuU3FzUXVldWUocXVldWUuY2RrLnF1ZXVlLCB0YXJnZXRQcm9wcylcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRGdW5jdGlvblRhcmdldChcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIHJ1bGVLZXk6IHN0cmluZyxcbiAgICBldmVudHNSdWxlOiBldmVudHMuUnVsZSxcbiAgICB0YXJnZXROYW1lOiBzdHJpbmcsXG4gICAgdGFyZ2V0OiBGdW5jdGlvbklubGluZURlZmluaXRpb24gfCBFdmVudEJ1c0Z1bmN0aW9uVGFyZ2V0UHJvcHNcbiAgKTogdm9pZCB7XG4gICAgLy8gUGFyc2UgdGFyZ2V0IHByb3BzXG4gICAgbGV0IHRhcmdldFByb3BzO1xuICAgIGxldCBmdW5jdGlvbkRlZmluaXRpb247XG4gICAgaWYgKCh0YXJnZXQgYXMgRXZlbnRCdXNGdW5jdGlvblRhcmdldFByb3BzKS5mdW5jdGlvbikge1xuICAgICAgdGFyZ2V0ID0gdGFyZ2V0IGFzIEV2ZW50QnVzRnVuY3Rpb25UYXJnZXRQcm9wcztcbiAgICAgIHRhcmdldFByb3BzID0gdGFyZ2V0LmNkaz8udGFyZ2V0O1xuICAgICAgZnVuY3Rpb25EZWZpbml0aW9uID0gdGFyZ2V0LmZ1bmN0aW9uO1xuICAgIH0gZWxzZSB7XG4gICAgICB0YXJnZXQgPSB0YXJnZXQgYXMgRnVuY3Rpb25JbmxpbmVEZWZpbml0aW9uO1xuICAgICAgZnVuY3Rpb25EZWZpbml0aW9uID0gdGFyZ2V0O1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBmdW5jdGlvblxuICAgIGNvbnN0IGZuID0gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICBzY29wZSxcbiAgICAgIGBUYXJnZXRfJHt0aGlzLm5vZGUuaWR9XyR7cnVsZUtleX1fJHt0YXJnZXROYW1lfWAsXG4gICAgICBmdW5jdGlvbkRlZmluaXRpb24sXG4gICAgICB0aGlzLnByb3BzLmRlZmF1bHRzPy5mdW5jdGlvbixcbiAgICAgIGBUaGUgXCJkZWZhdWx0cy5mdW5jdGlvblwiIGNhbm5vdCBiZSBhcHBsaWVkIGlmIGFuIGluc3RhbmNlIG9mIGEgRnVuY3Rpb24gY29uc3RydWN0IGlzIHBhc3NlZCBpbi4gTWFrZSBzdXJlIHRvIGRlZmluZSBhbGwgdGhlIHRhcmdldHMgdXNpbmcgRnVuY3Rpb25Qcm9wcywgc28gdGhlIEV2ZW50QnVzIGNvbnN0cnVjdCBjYW4gYXBwbHkgdGhlIFwiZGVmYXVsdHMuZnVuY3Rpb25cIiB0byB0aGVtLmBcbiAgICApO1xuICAgIHRoaXMudGFyZ2V0c0RhdGFbcnVsZUtleV1bdGFyZ2V0TmFtZV0gPSBmbjtcblxuICAgIC8vIENyZWF0ZSB0YXJnZXRcbiAgICBldmVudHNSdWxlLmFkZFRhcmdldChuZXcgZXZlbnRzVGFyZ2V0cy5MYW1iZGFGdW5jdGlvbihmbiwgdGFyZ2V0UHJvcHMpKTtcblxuICAgIC8vIEF0dGFjaCBleGlzdGluZyBwZXJtaXNzaW9uc1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFRhcmdldHMuZm9yRWFjaCgocGVybWlzc2lvbnMpID0+XG4gICAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucylcbiAgICApO1xuICB9XG59XG4iXX0=