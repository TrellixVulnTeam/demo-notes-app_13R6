"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RDS = void 0;
const path_1 = __importDefault(require("path"));
const glob_1 = __importDefault(require("glob"));
const fs = __importStar(require("fs-extra"));
const crypto = __importStar(require("crypto"));
const constructs_1 = require("constructs");
const cdk = __importStar(require("aws-cdk-lib"));
const ec2 = __importStar(require("aws-cdk-lib/aws-ec2"));
const rds = __importStar(require("aws-cdk-lib/aws-rds"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
/**
 * The `RDS` construct is a higher level CDK construct that makes it easy to create an [RDS Serverless Cluster](https://aws.amazon.com/rds/). It uses the following defaults:
 *
 * - Defaults to using the [Serverless v1 On-Demand autoscaling configuration](https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-serverless.html) to make it serverless.
 * - Provides a built-in interface for running schema migrations using [Kysely](https://koskimas.github.io/kysely/#migrations).
 * - Enables [Data API](https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/data-api.html) to allow your Lambda functions to access the database cluster without needing to deploy the functions in a VPC (virtual private cloud).
 * - Enables [Backup Snapshot](https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/BackupRestoreAurora.html) to make sure that you don't lose your data.
 *
 * @example
 * ### Using the minimal config
 *
 * ```js
 * import { RDS } from "@serverless-stack/resources";
 *
 * new RDS(stack, "Database", {
 *   engine: "postgresql10.14",
 *   defaultDatabaseName: "my_database",
 * });
 * ```
 *
 */
class RDS extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const app = scope.node.root;
        const { cdk, engine, defaultDatabaseName, scaling, migrations } = props || {};
        this.cdk = {};
        ////////////////////
        // Create Bucket
        ////////////////////
        const rdsServerlessClusterProps = ((cdk === null || cdk === void 0 ? void 0 : cdk.cluster) ||
            {});
        this.validateRDSServerlessClusterProps(rdsServerlessClusterProps);
        this.validateRequiredProps(props || {});
        this.engine = engine;
        this.defaultDatabaseName = defaultDatabaseName;
        this.cdk.cluster = new rds.ServerlessCluster(this, "Cluster", Object.assign(Object.assign({ clusterIdentifier: app.logicalPrefixedName(id) }, rdsServerlessClusterProps), { defaultDatabaseName, enableDataApi: true, engine: this.getEngine(engine), scaling: this.getScaling(scaling), vpc: this.getVpc(rdsServerlessClusterProps), vpcSubnets: this.getVpcSubnets(rdsServerlessClusterProps) }));
        ///////////////////////////
        // Create Migrations
        ///////////////////////////
        if (migrations) {
            this.validateMigrationsFileExists(migrations);
            this.migratorFunction = this.createMigrationsFunction(engine, defaultDatabaseName, migrations);
            this.createMigrationCustomResource(migrations);
        }
    }
    /**
     * The ARN of the internally created RDS Serverless Cluster.
     */
    get clusterArn() {
        return this.cdk.cluster.clusterArn;
    }
    /**
     * The ARN of the internally created RDS Serverless Cluster.
     */
    get clusterIdentifier() {
        return this.cdk.cluster.clusterIdentifier;
    }
    /**
     * The ARN of the internally created RDS Serverless Cluster.
     */
    get clusterEndpoint() {
        return this.cdk.cluster.clusterEndpoint;
    }
    /**
     * The ARN of the internally created Secrets Manager Secret.
     */
    get secretArn() {
        return this.cdk.cluster.secret.secretArn;
    }
    getConstructMetadata() {
        return {
            type: "RDS",
            data: {
                engine: this.engine,
                secretArn: this.secretArn,
                clusterArn: this.clusterArn,
                clusterIdentifier: this.clusterIdentifier,
                defaultDatabaseName: this.defaultDatabaseName,
                migrator: this.migratorFunction && (0, Construct_1.getFunctionRef)(this.migratorFunction),
            },
        };
    }
    validateRDSServerlessClusterProps(props) {
        // Validate "engine" is passed in from the top level
        if (props.engine) {
            throw new Error(`Use "engine" instead of "cdk.cluster.engine" to configure the RDS database engine.`);
        }
        // Validate "defaultDatabaseName" is passed in from the top level
        if (props.defaultDatabaseName) {
            throw new Error(`Use "defaultDatabaseName" instead of "cdk.cluster.defaultDatabaseName" to configure the RDS database engine.`);
        }
        // Validate "scaling" is passed in from the top level
        if (props.scaling) {
            throw new Error(`Use "scaling" instead of "cdk.cluster.scaling" to configure the RDS database auto-scaling.`);
        }
        // Validate "enableDataApi" is not passed in
        if (props.enableDataApi === false) {
            throw new Error(`Do not configure the "cdk.cluster.enableDataApi". Data API is always enabled for this construct.`);
        }
        // Validate Secrets Manager is used for "credentials"
        if (props.credentials && !props.credentials.secret) {
            throw new Error(`Only credentials managed by SecretManager are supported for the "cdk.cluster.credentials".`);
        }
    }
    validateRequiredProps(props) {
        if (!props.engine) {
            throw new Error(`Missing "engine" in the "${this.node.id}" RDS`);
        }
        if (!props.defaultDatabaseName) {
            throw new Error(`Missing "defaultDatabaseName" in the "${this.node.id}" RDS`);
        }
    }
    validateMigrationsFileExists(migrations) {
        if (!fs.existsSync(migrations))
            throw new Error(`Cannot find the migrations in "${path_1.default.resolve(migrations)}".`);
    }
    getEngine(engine) {
        if (engine === "mysql5.6") {
            return rds.DatabaseClusterEngine.aurora({
                version: rds.AuroraEngineVersion.VER_10A,
            });
        }
        else if (engine === "mysql5.7") {
            return rds.DatabaseClusterEngine.auroraMysql({
                version: rds.AuroraMysqlEngineVersion.VER_2_07_1,
            });
        }
        else if (engine === "postgresql10.14") {
            return rds.DatabaseClusterEngine.auroraPostgres({
                version: rds.AuroraPostgresEngineVersion.VER_10_14,
            });
        }
        throw new Error(`The specified "engine" is not supported for sst.RDS. Only mysql5.6, mysql5.7, and postgresql10.14 engines are currently supported.`);
    }
    getScaling(scaling) {
        return {
            autoPause: (scaling === null || scaling === void 0 ? void 0 : scaling.autoPause) === false
                ? cdk.Duration.minutes(0)
                : (scaling === null || scaling === void 0 ? void 0 : scaling.autoPause) === true || (scaling === null || scaling === void 0 ? void 0 : scaling.autoPause) === undefined
                    ? cdk.Duration.minutes(5)
                    : cdk.Duration.minutes(scaling === null || scaling === void 0 ? void 0 : scaling.autoPause),
            minCapacity: rds.AuroraCapacityUnit[(scaling === null || scaling === void 0 ? void 0 : scaling.minCapacity) || "ACU_2"],
            maxCapacity: rds.AuroraCapacityUnit[(scaling === null || scaling === void 0 ? void 0 : scaling.maxCapacity) || "ACU_16"],
        };
    }
    getVpc(props) {
        if (props.vpc) {
            return props.vpc;
        }
        return new ec2.Vpc(this, "vpc", {
            natGateways: 0,
        });
    }
    getVpcSubnets(props) {
        if (props.vpc) {
            return props.vpcSubnets;
        }
        return {
            subnetType: ec2.SubnetType.PRIVATE_ISOLATED,
        };
    }
    createMigrationsFunction(engine, defaultDatabaseName, migrations) {
        const app = this.node.root;
        // path to migration scripts inside the Lambda function
        const migrationsDestination = "sst_rds_migration_scripts";
        // fullpath of the migrator Lambda function
        // Note:
        // - when invoked from `sst build`, __dirname is `resources/dist`
        // - when running resources tests, __dirname is `resources/src`
        // For now we will do `__dirname/../dist` to make both cases work.
        const srcPath = path_1.default.resolve(path_1.default.join(__dirname, "../dist/RDS_migrator"));
        const fn = new Function_1.Function(this, "MigrationFunction", {
            srcPath,
            handler: "index.handler",
            runtime: "nodejs16.x",
            timeout: 900,
            memorySize: 1024,
            environment: {
                RDS_ARN: this.cdk.cluster.clusterArn,
                RDS_SECRET: this.cdk.cluster.secret.secretArn,
                RDS_DATABASE: defaultDatabaseName,
                RDS_ENGINE_MODE: engine === "postgresql10.14" ? "postgres" : "mysql",
                // for live development, perserve the migrations path so the migrator
                // can locate the migration files
                RDS_MIGRATIONS_PATH: app.local ? migrations : migrationsDestination,
            },
            bundle: {
                // Note that we need to generate a relative path of the migrations off the
                // srcPath because sst.Function internally builds the copy "from" path by
                // joining the srcPath and the from path.
                copyFiles: [
                    {
                        from: path_1.default.relative(path_1.default.resolve(srcPath), path_1.default.resolve(migrations)),
                        to: migrationsDestination,
                    },
                ],
            },
        });
        fn.attachPermissions([this.cdk.cluster]);
        return fn;
    }
    createMigrationCustomResource(migrations) {
        var _a, _b, _c;
        const app = this.node.root;
        // Create custom resource handler
        const handler = new lambda.Function(this, "MigrationHandler", {
            code: lambda.Code.fromAsset(path_1.default.join(__dirname, "Script")),
            runtime: lambda.Runtime.NODEJS_16_X,
            handler: "index.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        (_a = this.migratorFunction) === null || _a === void 0 ? void 0 : _a.grantInvoke(handler);
        // Note: "MigrationsHash" is generated to ensure the Custom Resource function
        //       is only run when migration files change.
        //
        //       Do not use the hash in Live mode, b/c we want the custom resource
        //       to remain the same in CloudFormation template when rebuilding
        //       infrastructure. Otherwise, there will always be a change when
        //       rebuilding infrastructure b/c the "BuildAt" property changes on
        //       each build.
        const hash = app.local ? 0 : this.generateMigrationsHash(migrations);
        new cdk.CustomResource(this, "MigrationResource", {
            serviceToken: handler.functionArn,
            resourceType: "Custom::SSTScript",
            properties: {
                UserCreateFunction: app.local
                    ? undefined
                    : (_b = this.migratorFunction) === null || _b === void 0 ? void 0 : _b.functionName,
                UserUpdateFunction: app.local
                    ? undefined
                    : (_c = this.migratorFunction) === null || _c === void 0 ? void 0 : _c.functionName,
                UserParams: JSON.stringify({}),
                MigrationsHash: hash,
            },
        });
    }
    generateMigrationsHash(migrations) {
        // Get all files inside the migrations folder
        const files = glob_1.default.sync("**", {
            dot: true,
            nodir: true,
            follow: true,
            cwd: migrations,
        });
        // Calculate hash of all files content
        return crypto
            .createHash("md5")
            .update(files
            .map((file) => fs.readFileSync(path_1.default.join(migrations, file)))
            .join(""))
            .digest("hex");
    }
}
exports.RDS = RDS;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUkRTLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1JEUy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGdEQUF3QjtBQUN4QixnREFBd0I7QUFDeEIsNkNBQStCO0FBQy9CLCtDQUFpQztBQUNqQywyQ0FBdUM7QUFDdkMsaURBQW1DO0FBQ25DLHlEQUEyQztBQUMzQyx5REFBMkM7QUFDM0MsK0RBQWlEO0FBRWpELDJDQUEyRDtBQUMzRCx5Q0FBNEM7QUFrRzVDLHFCQUFxQjtBQUNyQixZQUFZO0FBQ1oscUJBQXFCO0FBRXJCOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRztBQUNILE1BQWEsR0FBSSxTQUFRLHNCQUFTO0lBY2hDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBZTtRQUN2RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ25DLE1BQU0sRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLG1CQUFtQixFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FDN0QsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUNkLElBQUksQ0FBQyxHQUFHLEdBQUcsRUFBUyxDQUFDO1FBRXJCLG9CQUFvQjtRQUNwQixnQkFBZ0I7UUFDaEIsb0JBQW9CO1FBRXBCLE1BQU0seUJBQXlCLEdBQUcsQ0FBQyxDQUFBLEdBQUcsYUFBSCxHQUFHLHVCQUFILEdBQUcsQ0FBRSxPQUFPO1lBQzdDLEVBQUUsQ0FBaUMsQ0FBQztRQUV0QyxJQUFJLENBQUMsaUNBQWlDLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUNsRSxJQUFJLENBQUMscUJBQXFCLENBQUMsS0FBSyxJQUFLLEVBQWUsQ0FBQyxDQUFDO1FBRXRELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxt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LEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsY0FBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQzthQUMzRCxJQUFJLENBQUMsRUFBRSxDQUFDLENBQ1o7YUFDQSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbkIsQ0FBQztDQUNGO0FBelVELGtCQXlVQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgZ2xvYiBmcm9tIFwiZ2xvYlwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzLWV4dHJhXCI7XG5pbXBvcnQgKiBhcyBjcnlwdG8gZnJvbSBcImNyeXB0b1wiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCAqIGFzIGNkayBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCAqIGFzIGVjMiBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVjMlwiO1xuaW1wb3J0ICogYXMgcmRzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtcmRzXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGFcIjtcbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgZ2V0RnVuY3Rpb25SZWYsIFNTVENvbnN0cnVjdCB9IGZyb20gXCIuL0NvbnN0cnVjdFwiO1xuaW1wb3J0IHsgRnVuY3Rpb24gYXMgRm4gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIEludGVyZmFjZXNcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5leHBvcnQgaW50ZXJmYWNlIFJEU1Byb3BzIHtcbiAgLyoqXG4gICAqIERhdGFiYXNlIGVuZ2luZSBvZiB0aGUgY2x1c3Rlci4gQ2Fubm90IGJlIGNoYW5nZWQgb25jZSBzZXQuXG4gICAqL1xuICBlbmdpbmU6IFwibXlzcWw1LjZcIiB8IFwibXlzcWw1LjdcIiB8IFwicG9zdGdyZXNxbDEwLjE0XCI7XG5cbiAgLyoqXG4gICAqIE5hbWUgb2YgYSBkYXRhYmFzZSB3aGljaCBpcyBhdXRvbWF0aWNhbGx5IGNyZWF0ZWQgaW5zaWRlIHRoZSBjbHVzdGVyLlxuICAgKi9cbiAgZGVmYXVsdERhdGFiYXNlTmFtZTogc3RyaW5nO1xuXG4gIHNjYWxpbmc/OiB7XG4gICAgLyoqXG4gICAgICogVGhlIHRpbWUgYmVmb3JlIHRoZSBjbHVzdGVyIGlzIHBhdXNlZC5cbiAgICAgKlxuICAgICAqIFBhc3MgaW4gdHJ1ZSB0byBwYXVzZSBhZnRlciA1IG1pbnV0ZXMgb2YgaW5hY3RpdmUuIEFuZCBwYXNzIGluIGZhbHNlIHRvXG4gICAgICogZGlzYWJsZSBwYXVzaW5nLlxuICAgICAqXG4gICAgICogT3IgcGFzcyBpbiB0aGUgbnVtYmVyIG9mIG1pbnV0ZXMgdG8gd2FpdCBiZWZvcmUgdGhlIGNsdXN0ZXIgaXMgcGF1c2VkLlxuICAgICAqXG4gICAgICogQGRlZmF1bHQgdHJ1ZVxuICAgICAqXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBgYGBqc1xuICAgICAqIG5ldyBSRFMoc3RhY2ssIFwiRGF0YWJhc2VcIiwge1xuICAgICAqICAgc2NhbGluZzoge1xuICAgICAqICAgICBhdXRvUGF1c2U6IHByb3BzLmFwcC5zdGFnZSAhPT0gXCJwcm9kXCJcbiAgICAgKiAgIH1cbiAgICAgKiB9KVxuICAgICAqIGBgYFxuICAgICAqL1xuICAgIGF1dG9QYXVzZT86IGJvb2xlYW4gfCBudW1iZXI7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgbWluaW11bSBjYXBhY2l0eSBmb3IgdGhlIGNsdXN0ZXIuXG4gICAgICpcbiAgICAgKiBAZGVmYXVsdCBcIkFDVV8yXCJcbiAgICAgKi9cbiAgICBtaW5DYXBhY2l0eT86IGtleW9mIHR5cGVvZiByZHMuQXVyb3JhQ2FwYWNpdHlVbml0O1xuXG4gICAgLyoqXG4gICAgICogVGhlIG1heGltdW0gY2FwYWNpdHkgZm9yIHRoZSBjbHVzdGVyLlxuICAgICAqXG4gICAgICogQGRlZmF1bHQgXCJBQ1VfMTZcIlxuICAgICAqL1xuICAgIG1heENhcGFjaXR5Pzoga2V5b2YgdHlwZW9mIHJkcy5BdXJvcmFDYXBhY2l0eVVuaXQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIFBhdGggdG8gdGhlIGRpcmVjdG9yeSB0aGF0IGNvbnRhaW5zIHRoZSBtaWdyYXRpb24gc2NyaXB0cy4gVGhlIGBSRFNgIGNvbnN0cnVjdCB1c2VzIFtLeXNlbHldKGh0dHBzOi8va29za2ltYXMuZ2l0aHViLmlvL2t5c2VseS8pIHRvIHJ1biBhbmQgbWFuYWdlIHNjaGVtYSBtaWdyYXRpb25zLiBUaGUgYG1pZ3JhdGlvbnNgIHByb3Agc2hvdWxkIHBvaW50IHRvIHRoZSBmb2xkZXIgd2hlcmUgeW91ciBtaWdyYXRpb24gZmlsZXMgYXJlLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBgYGBqc1xuICAgKiBuZXcgUkRTKHN0YWNrLCBcIkRhdGFiYXNlXCIsIHtcbiAgICogICBlbmdpbmU6IFwicG9zdGdyZXNxbDEwLjE0XCIsXG4gICAqICAgZGVmYXVsdERhdGFiYXNlTmFtZTogXCJhY21lXCIsXG4gICAqICAgbWlncmF0aW9uczogXCJwYXRoL3RvL21pZ3JhdGlvbi9zY3JpcHRzXCIsXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIG1pZ3JhdGlvbnM/OiBzdHJpbmc7XG5cbiAgY2RrPzoge1xuICAgIC8qKlxuICAgICAqIENvbmZpZ3VyZSB0aGUgaW50ZXJuYWxsbHkgY3JlYXRlZCBSRFMgY2x1c3Rlci5cbiAgICAgKlxuICAgICAqIEBleGFtcGxlXG4gICAgICogYGBganNcbiAgICAgKiBuZXcgUkRTKHN0YWNrLCBcIkRhdGFiYXNlXCIsIHtcbiAgICAgKiAgIGNkazoge1xuICAgICAqICAgICBjbHVzdGVyOiB7XG4gICAgICogICAgICAgY2x1c3RlcklkZW50aWZpZXI6IFwibXktY2x1c3RlclwiLFxuICAgICAqICAgICB9XG4gICAgICogICB9LFxuICAgICAqIH0pO1xuICAgICAqIGBgYFxuICAgICAqL1xuICAgIGNsdXN0ZXI/OiBSRFNDZGtTZXJ2ZXJsZXNzQ2x1c3RlclByb3BzO1xuICB9O1xufVxuXG5leHBvcnQgdHlwZSBSRFNFbmdpbmVUeXBlID0gXCJteXNxbDUuNlwiIHwgXCJteXNxbDUuN1wiIHwgXCJwb3N0Z3Jlc3FsMTAuMTRcIjtcblxuZXhwb3J0IGludGVyZmFjZSBSRFNDZGtTZXJ2ZXJsZXNzQ2x1c3RlclByb3BzXG4gIGV4dGVuZHMgT21pdDxcbiAgICByZHMuU2VydmVybGVzc0NsdXN0ZXJQcm9wcyxcbiAgICBcInZwY1wiIHwgXCJlbmdpbmVcIiB8IFwiZGVmYXVsdERhdGFiYXNlTmFtZVwiIHwgXCJzY2FsaW5nXCJcbiAgPiB7XG4gIHZwYz86IGVjMi5JVnBjO1xufVxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIENvbnN0cnVjdFxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbi8qKlxuICogVGhlIGBSRFNgIGNvbnN0cnVjdCBpcyBhIGhpZ2hlciBsZXZlbCBDREsgY29uc3RydWN0IHRoYXQgbWFrZXMgaXQgZWFzeSB0byBjcmVhdGUgYW4gW1JEUyBTZXJ2ZXJsZXNzIENsdXN0ZXJdKGh0dHBzOi8vYXdzLmFtYXpvbi5jb20vcmRzLykuIEl0IHVzZXMgdGhlIGZvbGxvd2luZyBkZWZhdWx0czpcbiAqXG4gKiAtIERlZmF1bHRzIHRvIHVzaW5nIHRoZSBbU2VydmVybGVzcyB2MSBPbi1EZW1hbmQgYXV0b3NjYWxpbmcgY29uZmlndXJhdGlvbl0oaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL0FtYXpvblJEUy9sYXRlc3QvQXVyb3JhVXNlckd1aWRlL2F1cm9yYS1zZXJ2ZXJsZXNzLmh0bWwpIHRvIG1ha2UgaXQgc2VydmVybGVzcy5cbiAqIC0gUHJvdmlkZXMgYSBidWlsdC1pbiBpbnRlcmZhY2UgZm9yIHJ1bm5pbmcgc2NoZW1hIG1pZ3JhdGlvbnMgdXNpbmcgW0t5c2VseV0oaHR0cHM6Ly9rb3NraW1hcy5naXRodWIuaW8va3lzZWx5LyNtaWdyYXRpb25zKS5cbiAqIC0gRW5hYmxlcyBbRGF0YSBBUEldKGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9BbWF6b25SRFMvbGF0ZXN0L0F1cm9yYVVzZXJHdWlkZS9kYXRhLWFwaS5odG1sKSB0byBhbGxvdyB5b3VyIExhbWJkYSBmdW5jdGlvbnMgdG8gYWNjZXNzIHRoZSBkYXRhYmFzZSBjbHVzdGVyIHdpdGhvdXQgbmVlZGluZyB0byBkZXBsb3kgdGhlIGZ1bmN0aW9ucyBpbiBhIFZQQyAodmlydHVhbCBwcml2YXRlIGNsb3VkKS5cbiAqIC0gRW5hYmxlcyBbQmFja3VwIFNuYXBzaG90XShodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vQW1hem9uUkRTL2xhdGVzdC9BdXJvcmFVc2VyR3VpZGUvQmFja3VwUmVzdG9yZUF1cm9yYS5odG1sKSB0byBtYWtlIHN1cmUgdGhhdCB5b3UgZG9uJ3QgbG9zZSB5b3VyIGRhdGEuXG4gKlxuICogQGV4YW1wbGVcbiAqICMjIyBVc2luZyB0aGUgbWluaW1hbCBjb25maWdcbiAqXG4gKiBgYGBqc1xuICogaW1wb3J0IHsgUkRTIH0gZnJvbSBcIkBzZXJ2ZXJsZXNzLXN0YWNrL3Jlc291cmNlc1wiO1xuICpcbiAqIG5ldyBSRFMoc3RhY2ssIFwiRGF0YWJhc2VcIiwge1xuICogICBlbmdpbmU6IFwicG9zdGdyZXNxbDEwLjE0XCIsXG4gKiAgIGRlZmF1bHREYXRhYmFzZU5hbWU6IFwibXlfZGF0YWJhc2VcIixcbiAqIH0pO1xuICogYGBgXG4gKlxuICovXG5leHBvcnQgY2xhc3MgUkRTIGV4dGVuZHMgQ29uc3RydWN0IGltcGxlbWVudHMgU1NUQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IGNkazoge1xuICAgIC8qKlxuICAgICAqIFRoZSBBUk4gb2YgdGhlIGludGVybmFsbHkgY3JlYXRlZCBDREsgU2VydmVybGVzc0NsdXN0ZXIgaW5zdGFuY2UuXG4gICAgICovXG4gICAgY2x1c3RlcjogcmRzLlNlcnZlcmxlc3NDbHVzdGVyO1xuICB9O1xuICBwdWJsaWMgcmVhZG9ubHkgZGVmYXVsdERhdGFiYXNlTmFtZTogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIEFSTiBvZiB0aGUgaW50ZXJuYWxseSBjcmVhdGVkIENESyBTZXJ2ZXJsZXNzQ2x1c3RlciBpbnN0YW5jZS5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBtaWdyYXRvckZ1bmN0aW9uPzogRm47XG4gIHByaXZhdGUgZW5naW5lOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFJEU1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IGFwcCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3QgeyBjZGssIGVuZ2luZSwgZGVmYXVsdERhdGFiYXNlTmFtZSwgc2NhbGluZywgbWlncmF0aW9ucyB9ID1cbiAgICAgIHByb3BzIHx8IHt9O1xuICAgIHRoaXMuY2RrID0ge30gYXMgYW55O1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgQnVja2V0XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGNvbnN0IHJkc1NlcnZlcmxlc3NDbHVzdGVyUHJvcHMgPSAoY2RrPy5jbHVzdGVyIHx8XG4gICAgICB7fSkgYXMgUkRTQ2RrU2VydmVybGVzc0NsdXN0ZXJQcm9wcztcblxuICAgIHRoaXMudmFsaWRhdGVSRFNTZXJ2ZXJsZXNzQ2x1c3RlclByb3BzKHJkc1NlcnZlcmxlc3NDbHVzdGVyUHJvcHMpO1xuICAgIHRoaXMudmFsaWRhdGVSZXF1aXJlZFByb3BzKHByb3BzIHx8ICh7fSBhcyBSRFNQcm9wcykpO1xuXG4gICAgdGhpcy5lbmdpbmUgPSBlbmdpbmU7XG4gICAgdGhpcy5kZWZhdWx0RGF0YWJhc2VOYW1lID0gZGVmYXVsdERhdGFiYXNlTmFtZTtcbiAgICB0aGlzLmNkay5jbHVzdGVyID0gbmV3IHJkcy5TZXJ2ZXJsZXNzQ2x1c3Rlcih0aGlzLCBcIkNsdXN0ZXJcIiwge1xuICAgICAgY2x1c3RlcklkZW50aWZpZXI6IGFwcC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKSxcbiAgICAgIC4uLnJkc1NlcnZlcmxlc3NDbHVzdGVyUHJvcHMsXG4gICAgICBkZWZhdWx0RGF0YWJhc2VOYW1lLFxuICAgICAgZW5hYmxlRGF0YUFwaTogdHJ1ZSxcbiAgICAgIGVuZ2luZTogdGhpcy5nZXRFbmdpbmUoZW5naW5lKSxcbiAgICAgIHNjYWxpbmc6IHRoaXMuZ2V0U2NhbGluZyhzY2FsaW5nKSxcbiAgICAgIHZwYzogdGhpcy5nZXRWcGMocmRzU2VydmVybGVzc0NsdXN0ZXJQcm9wcyksXG4gICAgICB2cGNTdWJuZXRzOiB0aGlzLmdldFZwY1N1Ym5ldHMocmRzU2VydmVybGVzc0NsdXN0ZXJQcm9wcyksXG4gICAgfSk7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgTWlncmF0aW9uc1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgaWYgKG1pZ3JhdGlvbnMpIHtcbiAgICAgIHRoaXMudmFsaWRhdGVNaWdyYXRpb25zRmlsZUV4aXN0cyhtaWdyYXRpb25zKTtcblxuICAgICAgdGhpcy5taWdyYXRvckZ1bmN0aW9uID0gdGhpcy5jcmVhdGVNaWdyYXRpb25zRnVuY3Rpb24oXG4gICAgICAgIGVuZ2luZSxcbiAgICAgICAgZGVmYXVsdERhdGFiYXNlTmFtZSxcbiAgICAgICAgbWlncmF0aW9uc1xuICAgICAgKTtcbiAgICAgIHRoaXMuY3JlYXRlTWlncmF0aW9uQ3VzdG9tUmVzb3VyY2UobWlncmF0aW9ucyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBBUk4gb2YgdGhlIGludGVybmFsbHkgY3JlYXRlZCBSRFMgU2VydmVybGVzcyBDbHVzdGVyLlxuICAgKi9cbiAgcHVibGljIGdldCBjbHVzdGVyQXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuY2RrLmNsdXN0ZXIuY2x1c3RlckFybjtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgQVJOIG9mIHRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgUkRTIFNlcnZlcmxlc3MgQ2x1c3Rlci5cbiAgICovXG4gIHB1YmxpYyBnZXQgY2x1c3RlcklkZW50aWZpZXIoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jZGsuY2x1c3Rlci5jbHVzdGVySWRlbnRpZmllcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgQVJOIG9mIHRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgUkRTIFNlcnZlcmxlc3MgQ2x1c3Rlci5cbiAgICovXG4gIHB1YmxpYyBnZXQgY2x1c3RlckVuZHBvaW50KCk6IHJkcy5FbmRwb2ludCB7XG4gICAgcmV0dXJuIHRoaXMuY2RrLmNsdXN0ZXIuY2x1c3RlckVuZHBvaW50O1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBBUk4gb2YgdGhlIGludGVybmFsbHkgY3JlYXRlZCBTZWNyZXRzIE1hbmFnZXIgU2VjcmV0LlxuICAgKi9cbiAgcHVibGljIGdldCBzZWNyZXRBcm4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jZGsuY2x1c3Rlci5zZWNyZXQhLnNlY3JldEFybjtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25zdHJ1Y3RNZXRhZGF0YSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogXCJSRFNcIiBhcyBjb25zdCxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgZW5naW5lOiB0aGlzLmVuZ2luZSxcbiAgICAgICAgc2VjcmV0QXJuOiB0aGlzLnNlY3JldEFybixcbiAgICAgICAgY2x1c3RlckFybjogdGhpcy5jbHVzdGVyQXJuLFxuICAgICAgICBjbHVzdGVySWRlbnRpZmllcjogdGhpcy5jbHVzdGVySWRlbnRpZmllcixcbiAgICAgICAgZGVmYXVsdERhdGFiYXNlTmFtZTogdGhpcy5kZWZhdWx0RGF0YWJhc2VOYW1lLFxuICAgICAgICBtaWdyYXRvcjpcbiAgICAgICAgICB0aGlzLm1pZ3JhdG9yRnVuY3Rpb24gJiYgZ2V0RnVuY3Rpb25SZWYodGhpcy5taWdyYXRvckZ1bmN0aW9uKSxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgdmFsaWRhdGVSRFNTZXJ2ZXJsZXNzQ2x1c3RlclByb3BzKFxuICAgIHByb3BzOiBSRFNDZGtTZXJ2ZXJsZXNzQ2x1c3RlclByb3BzXG4gICkge1xuICAgIC8vIFZhbGlkYXRlIFwiZW5naW5lXCIgaXMgcGFzc2VkIGluIGZyb20gdGhlIHRvcCBsZXZlbFxuICAgIGlmICgocHJvcHMgYXMgYW55KS5lbmdpbmUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFVzZSBcImVuZ2luZVwiIGluc3RlYWQgb2YgXCJjZGsuY2x1c3Rlci5lbmdpbmVcIiB0byBjb25maWd1cmUgdGhlIFJEUyBkYXRhYmFzZSBlbmdpbmUuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBcImRlZmF1bHREYXRhYmFzZU5hbWVcIiBpcyBwYXNzZWQgaW4gZnJvbSB0aGUgdG9wIGxldmVsXG4gICAgaWYgKChwcm9wcyBhcyBhbnkpLmRlZmF1bHREYXRhYmFzZU5hbWUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFVzZSBcImRlZmF1bHREYXRhYmFzZU5hbWVcIiBpbnN0ZWFkIG9mIFwiY2RrLmNsdXN0ZXIuZGVmYXVsdERhdGFiYXNlTmFtZVwiIHRvIGNvbmZpZ3VyZSB0aGUgUkRTIGRhdGFiYXNlIGVuZ2luZS5gXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIFwic2NhbGluZ1wiIGlzIHBhc3NlZCBpbiBmcm9tIHRoZSB0b3AgbGV2ZWxcbiAgICBpZiAoKHByb3BzIGFzIGFueSkuc2NhbGluZykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgVXNlIFwic2NhbGluZ1wiIGluc3RlYWQgb2YgXCJjZGsuY2x1c3Rlci5zY2FsaW5nXCIgdG8gY29uZmlndXJlIHRoZSBSRFMgZGF0YWJhc2UgYXV0by1zY2FsaW5nLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgXCJlbmFibGVEYXRhQXBpXCIgaXMgbm90IHBhc3NlZCBpblxuICAgIGlmIChwcm9wcy5lbmFibGVEYXRhQXBpID09PSBmYWxzZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRG8gbm90IGNvbmZpZ3VyZSB0aGUgXCJjZGsuY2x1c3Rlci5lbmFibGVEYXRhQXBpXCIuIERhdGEgQVBJIGlzIGFsd2F5cyBlbmFibGVkIGZvciB0aGlzIGNvbnN0cnVjdC5gXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIFNlY3JldHMgTWFuYWdlciBpcyB1c2VkIGZvciBcImNyZWRlbnRpYWxzXCJcbiAgICBpZiAocHJvcHMuY3JlZGVudGlhbHMgJiYgIXByb3BzLmNyZWRlbnRpYWxzLnNlY3JldCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgT25seSBjcmVkZW50aWFscyBtYW5hZ2VkIGJ5IFNlY3JldE1hbmFnZXIgYXJlIHN1cHBvcnRlZCBmb3IgdGhlIFwiY2RrLmNsdXN0ZXIuY3JlZGVudGlhbHNcIi5gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdmFsaWRhdGVSZXF1aXJlZFByb3BzKHByb3BzOiBSRFNQcm9wcykge1xuICAgIGlmICghcHJvcHMuZW5naW5lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgXCJlbmdpbmVcIiBpbiB0aGUgXCIke3RoaXMubm9kZS5pZH1cIiBSRFNgKTtcbiAgICB9XG5cbiAgICBpZiAoIXByb3BzLmRlZmF1bHREYXRhYmFzZU5hbWUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYE1pc3NpbmcgXCJkZWZhdWx0RGF0YWJhc2VOYW1lXCIgaW4gdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgUkRTYFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlTWlncmF0aW9uc0ZpbGVFeGlzdHMobWlncmF0aW9uczogc3RyaW5nKSB7XG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKG1pZ3JhdGlvbnMpKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQ2Fubm90IGZpbmQgdGhlIG1pZ3JhdGlvbnMgaW4gXCIke3BhdGgucmVzb2x2ZShtaWdyYXRpb25zKX1cIi5gXG4gICAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRFbmdpbmUoZW5naW5lOiBSRFNFbmdpbmVUeXBlKTogcmRzLklDbHVzdGVyRW5naW5lIHtcbiAgICBpZiAoZW5naW5lID09PSBcIm15c3FsNS42XCIpIHtcbiAgICAgIHJldHVybiByZHMuRGF0YWJhc2VDbHVzdGVyRW5naW5lLmF1cm9yYSh7XG4gICAgICAgIHZlcnNpb246IHJkcy5BdXJvcmFFbmdpbmVWZXJzaW9uLlZFUl8xMEEsXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKGVuZ2luZSA9PT0gXCJteXNxbDUuN1wiKSB7XG4gICAgICByZXR1cm4gcmRzLkRhdGFiYXNlQ2x1c3RlckVuZ2luZS5hdXJvcmFNeXNxbCh7XG4gICAgICAgIHZlcnNpb246IHJkcy5BdXJvcmFNeXNxbEVuZ2luZVZlcnNpb24uVkVSXzJfMDdfMSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAoZW5naW5lID09PSBcInBvc3RncmVzcWwxMC4xNFwiKSB7XG4gICAgICByZXR1cm4gcmRzLkRhdGFiYXNlQ2x1c3RlckVuZ2luZS5hdXJvcmFQb3N0Z3Jlcyh7XG4gICAgICAgIHZlcnNpb246IHJkcy5BdXJvcmFQb3N0Z3Jlc0VuZ2luZVZlcnNpb24uVkVSXzEwXzE0LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYFRoZSBzcGVjaWZpZWQgXCJlbmdpbmVcIiBpcyBub3Qgc3VwcG9ydGVkIGZvciBzc3QuUkRTLiBPbmx5IG15c3FsNS42LCBteXNxbDUuNywgYW5kIHBvc3RncmVzcWwxMC4xNCBlbmdpbmVzIGFyZSBjdXJyZW50bHkgc3VwcG9ydGVkLmBcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRTY2FsaW5nKFxuICAgIHNjYWxpbmc/OiBSRFNQcm9wc1tcInNjYWxpbmdcIl1cbiAgKTogcmRzLlNlcnZlcmxlc3NTY2FsaW5nT3B0aW9ucyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGF1dG9QYXVzZTpcbiAgICAgICAgc2NhbGluZz8uYXV0b1BhdXNlID09PSBmYWxzZVxuICAgICAgICAgID8gY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMClcbiAgICAgICAgICA6IHNjYWxpbmc/LmF1dG9QYXVzZSA9PT0gdHJ1ZSB8fCBzY2FsaW5nPy5hdXRvUGF1c2UgPT09IHVuZGVmaW5lZFxuICAgICAgICAgID8gY2RrLkR1cmF0aW9uLm1pbnV0ZXMoNSlcbiAgICAgICAgICA6IGNkay5EdXJhdGlvbi5taW51dGVzKHNjYWxpbmc/LmF1dG9QYXVzZSksXG4gICAgICBtaW5DYXBhY2l0eTogcmRzLkF1cm9yYUNhcGFjaXR5VW5pdFtzY2FsaW5nPy5taW5DYXBhY2l0eSB8fCBcIkFDVV8yXCJdLFxuICAgICAgbWF4Q2FwYWNpdHk6IHJkcy5BdXJvcmFDYXBhY2l0eVVuaXRbc2NhbGluZz8ubWF4Q2FwYWNpdHkgfHwgXCJBQ1VfMTZcIl0sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VnBjKHByb3BzOiBSRFNDZGtTZXJ2ZXJsZXNzQ2x1c3RlclByb3BzKTogZWMyLklWcGMge1xuICAgIGlmIChwcm9wcy52cGMpIHtcbiAgICAgIHJldHVybiBwcm9wcy52cGM7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBlYzIuVnBjKHRoaXMsIFwidnBjXCIsIHtcbiAgICAgIG5hdEdhdGV3YXlzOiAwLFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRWcGNTdWJuZXRzKFxuICAgIHByb3BzOiBSRFNDZGtTZXJ2ZXJsZXNzQ2x1c3RlclByb3BzXG4gICk6IGVjMi5TdWJuZXRTZWxlY3Rpb24gfCB1bmRlZmluZWQge1xuICAgIGlmIChwcm9wcy52cGMpIHtcbiAgICAgIHJldHVybiBwcm9wcy52cGNTdWJuZXRzO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdWJuZXRUeXBlOiBlYzIuU3VibmV0VHlwZS5QUklWQVRFX0lTT0xBVEVELFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZU1pZ3JhdGlvbnNGdW5jdGlvbihcbiAgICBlbmdpbmU6IHN0cmluZyxcbiAgICBkZWZhdWx0RGF0YWJhc2VOYW1lOiBzdHJpbmcsXG4gICAgbWlncmF0aW9uczogc3RyaW5nXG4gICkge1xuICAgIGNvbnN0IGFwcCA9IHRoaXMubm9kZS5yb290IGFzIEFwcDtcblxuICAgIC8vIHBhdGggdG8gbWlncmF0aW9uIHNjcmlwdHMgaW5zaWRlIHRoZSBMYW1iZGEgZnVuY3Rpb25cbiAgICBjb25zdCBtaWdyYXRpb25zRGVzdGluYXRpb24gPSBcInNzdF9yZHNfbWlncmF0aW9uX3NjcmlwdHNcIjtcblxuICAgIC8vIGZ1bGxwYXRoIG9mIHRoZSBtaWdyYXRvciBMYW1iZGEgZnVuY3Rpb25cbiAgICAvLyBOb3RlOlxuICAgIC8vIC0gd2hlbiBpbnZva2VkIGZyb20gYHNzdCBidWlsZGAsIF9fZGlybmFtZSBpcyBgcmVzb3VyY2VzL2Rpc3RgXG4gICAgLy8gLSB3aGVuIHJ1bm5pbmcgcmVzb3VyY2VzIHRlc3RzLCBfX2Rpcm5hbWUgaXMgYHJlc291cmNlcy9zcmNgXG4gICAgLy8gRm9yIG5vdyB3ZSB3aWxsIGRvIGBfX2Rpcm5hbWUvLi4vZGlzdGAgdG8gbWFrZSBib3RoIGNhc2VzIHdvcmsuXG4gICAgY29uc3Qgc3JjUGF0aCA9IHBhdGgucmVzb2x2ZShwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2Rpc3QvUkRTX21pZ3JhdG9yXCIpKTtcblxuICAgIGNvbnN0IGZuID0gbmV3IEZuKHRoaXMsIFwiTWlncmF0aW9uRnVuY3Rpb25cIiwge1xuICAgICAgc3JjUGF0aCxcbiAgICAgIGhhbmRsZXI6IFwiaW5kZXguaGFuZGxlclwiLFxuICAgICAgcnVudGltZTogXCJub2RlanMxNi54XCIsXG4gICAgICB0aW1lb3V0OiA5MDAsXG4gICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgUkRTX0FSTjogdGhpcy5jZGsuY2x1c3Rlci5jbHVzdGVyQXJuLFxuICAgICAgICBSRFNfU0VDUkVUOiB0aGlzLmNkay5jbHVzdGVyLnNlY3JldCEuc2VjcmV0QXJuLFxuICAgICAgICBSRFNfREFUQUJBU0U6IGRlZmF1bHREYXRhYmFzZU5hbWUsXG4gICAgICAgIFJEU19FTkdJTkVfTU9ERTogZW5naW5lID09PSBcInBvc3RncmVzcWwxMC4xNFwiID8gXCJwb3N0Z3Jlc1wiIDogXCJteXNxbFwiLFxuICAgICAgICAvLyBmb3IgbGl2ZSBkZXZlbG9wbWVudCwgcGVyc2VydmUgdGhlIG1pZ3JhdGlvbnMgcGF0aCBzbyB0aGUgbWlncmF0b3JcbiAgICAgICAgLy8gY2FuIGxvY2F0ZSB0aGUgbWlncmF0aW9uIGZpbGVzXG4gICAgICAgIFJEU19NSUdSQVRJT05TX1BBVEg6IGFwcC5sb2NhbCA/IG1pZ3JhdGlvbnMgOiBtaWdyYXRpb25zRGVzdGluYXRpb24sXG4gICAgICB9LFxuICAgICAgYnVuZGxlOiB7XG4gICAgICAgIC8vIE5vdGUgdGhhdCB3ZSBuZWVkIHRvIGdlbmVyYXRlIGEgcmVsYXRpdmUgcGF0aCBvZiB0aGUgbWlncmF0aW9ucyBvZmYgdGhlXG4gICAgICAgIC8vIHNyY1BhdGggYmVjYXVzZSBzc3QuRnVuY3Rpb24gaW50ZXJuYWxseSBidWlsZHMgdGhlIGNvcHkgXCJmcm9tXCIgcGF0aCBieVxuICAgICAgICAvLyBqb2luaW5nIHRoZSBzcmNQYXRoIGFuZCB0aGUgZnJvbSBwYXRoLlxuICAgICAgICBjb3B5RmlsZXM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBmcm9tOiBwYXRoLnJlbGF0aXZlKFxuICAgICAgICAgICAgICBwYXRoLnJlc29sdmUoc3JjUGF0aCksXG4gICAgICAgICAgICAgIHBhdGgucmVzb2x2ZShtaWdyYXRpb25zKVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHRvOiBtaWdyYXRpb25zRGVzdGluYXRpb24sXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhbdGhpcy5jZGsuY2x1c3Rlcl0pO1xuXG4gICAgcmV0dXJuIGZuO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVNaWdyYXRpb25DdXN0b21SZXNvdXJjZShtaWdyYXRpb25zOiBzdHJpbmcpIHtcbiAgICBjb25zdCBhcHAgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG5cbiAgICAvLyBDcmVhdGUgY3VzdG9tIHJlc291cmNlIGhhbmRsZXJcbiAgICBjb25zdCBoYW5kbGVyID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBcIk1pZ3JhdGlvbkhhbmRsZXJcIiwge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsIFwiU2NyaXB0XCIpKSxcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xNl9YLFxuICAgICAgaGFuZGxlcjogXCJpbmRleC5oYW5kbGVyXCIsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24ubWludXRlcygxNSksXG4gICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgIH0pO1xuICAgIHRoaXMubWlncmF0b3JGdW5jdGlvbj8uZ3JhbnRJbnZva2UoaGFuZGxlcik7XG5cbiAgICAvLyBOb3RlOiBcIk1pZ3JhdGlvbnNIYXNoXCIgaXMgZ2VuZXJhdGVkIHRvIGVuc3VyZSB0aGUgQ3VzdG9tIFJlc291cmNlIGZ1bmN0aW9uXG4gICAgLy8gICAgICAgaXMgb25seSBydW4gd2hlbiBtaWdyYXRpb24gZmlsZXMgY2hhbmdlLlxuICAgIC8vXG4gICAgLy8gICAgICAgRG8gbm90IHVzZSB0aGUgaGFzaCBpbiBMaXZlIG1vZGUsIGIvYyB3ZSB3YW50IHRoZSBjdXN0b20gcmVzb3VyY2VcbiAgICAvLyAgICAgICB0byByZW1haW4gdGhlIHNhbWUgaW4gQ2xvdWRGb3JtYXRpb24gdGVtcGxhdGUgd2hlbiByZWJ1aWxkaW5nXG4gICAgLy8gICAgICAgaW5mcmFzdHJ1Y3R1cmUuIE90aGVyd2lzZSwgdGhlcmUgd2lsbCBhbHdheXMgYmUgYSBjaGFuZ2Ugd2hlblxuICAgIC8vICAgICAgIHJlYnVpbGRpbmcgaW5mcmFzdHJ1Y3R1cmUgYi9jIHRoZSBcIkJ1aWxkQXRcIiBwcm9wZXJ0eSBjaGFuZ2VzIG9uXG4gICAgLy8gICAgICAgZWFjaCBidWlsZC5cbiAgICBjb25zdCBoYXNoID0gYXBwLmxvY2FsID8gMCA6IHRoaXMuZ2VuZXJhdGVNaWdyYXRpb25zSGFzaChtaWdyYXRpb25zKTtcbiAgICBuZXcgY2RrLkN1c3RvbVJlc291cmNlKHRoaXMsIFwiTWlncmF0aW9uUmVzb3VyY2VcIiwge1xuICAgICAgc2VydmljZVRva2VuOiBoYW5kbGVyLmZ1bmN0aW9uQXJuLFxuICAgICAgcmVzb3VyY2VUeXBlOiBcIkN1c3RvbTo6U1NUU2NyaXB0XCIsXG4gICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIFVzZXJDcmVhdGVGdW5jdGlvbjogYXBwLmxvY2FsXG4gICAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgICA6IHRoaXMubWlncmF0b3JGdW5jdGlvbj8uZnVuY3Rpb25OYW1lLFxuICAgICAgICBVc2VyVXBkYXRlRnVuY3Rpb246IGFwcC5sb2NhbFxuICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgOiB0aGlzLm1pZ3JhdG9yRnVuY3Rpb24/LmZ1bmN0aW9uTmFtZSxcbiAgICAgICAgVXNlclBhcmFtczogSlNPTi5zdHJpbmdpZnkoe30pLFxuICAgICAgICBNaWdyYXRpb25zSGFzaDogaGFzaCxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlTWlncmF0aW9uc0hhc2gobWlncmF0aW9uczogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvLyBHZXQgYWxsIGZpbGVzIGluc2lkZSB0aGUgbWlncmF0aW9ucyBmb2xkZXJcbiAgICBjb25zdCBmaWxlcyA9IGdsb2Iuc3luYyhcIioqXCIsIHtcbiAgICAgIGRvdDogdHJ1ZSxcbiAgICAgIG5vZGlyOiB0cnVlLFxuICAgICAgZm9sbG93OiB0cnVlLFxuICAgICAgY3dkOiBtaWdyYXRpb25zLFxuICAgIH0pO1xuXG4gICAgLy8gQ2FsY3VsYXRlIGhhc2ggb2YgYWxsIGZpbGVzIGNvbnRlbnRcbiAgICByZXR1cm4gY3J5cHRvXG4gICAgICAuY3JlYXRlSGFzaChcIm1kNVwiKVxuICAgICAgLnVwZGF0ZShcbiAgICAgICAgZmlsZXNcbiAgICAgICAgICAubWFwKChmaWxlKSA9PiBmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKG1pZ3JhdGlvbnMsIGZpbGUpKSlcbiAgICAgICAgICAuam9pbihcIlwiKVxuICAgICAgKVxuICAgICAgLmRpZ2VzdChcImhleFwiKTtcbiAgfVxufVxuIl19