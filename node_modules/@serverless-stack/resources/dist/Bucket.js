"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Bucket = void 0;
const constructs_1 = require("constructs");
const s3 = __importStar(require("aws-cdk-lib/aws-s3"));
const s3Notifications = __importStar(require("aws-cdk-lib/aws-s3-notifications"));
const Queue_1 = require("./Queue");
const Topic_1 = require("./Topic");
const Construct_1 = require("./Construct");
const Function_1 = require("./Function");
const duration_1 = require("./util/duration");
/////////////////////
// Construct
/////////////////////
/**
 * The `Bucket` construct is a higher level CDK construct that makes it easy to create an S3 Bucket and to define its notifications. It also internally connects the notifications and bucket together.
 *
 * @example
 * ### Using the minimal config
 *
 * ```js
 * import { Bucket } from "@serverless-stack/resources";
 *
 * new Bucket(stack, "Bucket");
 * ```
 */
class Bucket extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.props = props || {};
        this.cdk = {};
        this.notifications = {};
        this.permissionsAttachedForAllNotifications = [];
        this.createBucket();
        this.addNotifications(this, (props === null || props === void 0 ? void 0 : props.notifications) || {});
    }
    /**
     * The ARN of the internally created `Bucket` instance.
     */
    get bucketArn() {
        return this.cdk.bucket.bucketArn;
    }
    /**
     * The name of the internally created `Bucket` instance.
     */
    get bucketName() {
        return this.cdk.bucket.bucketName;
    }
    /**
     * A list of the internally created functions for the notifications.
     */
    get notificationFunctions() {
        return Object.values(this.notifications).filter((notification) => notification instanceof Function_1.Function);
    }
    /**
     * Add notification subscriptions after the bucket has been created
     *
     * @example
     * ```js {3}
     * const bucket = new Bucket(stack, "Bucket");
     * bucket.addNotifications(stack, ["src/notification.main"]);
     * ```
     */
    addNotifications(scope, notifications) {
        Object.entries(notifications).forEach(([notificationName, notification]) => {
            this.addNotification(scope, notificationName, notification);
        });
    }
    /**
     * Attaches additional permissions to all bucket notifications
     * @example
     * ```js {20}
     * const bucket = new Bucket(stack, "Bucket", {
     *   notifications: {
     *     myNotification: "src/function.handler",
     *   }
     * });
     *
     * bucket.attachPermissions(["s3"]);
     * ```
     */
    attachPermissions(permissions) {
        this.notificationFunctions.forEach((notification) => notification.attachPermissions(permissions));
        this.permissionsAttachedForAllNotifications.push(permissions);
    }
    /**
     * Attaches additional permissions to a specific bucket notification
     *
     * @example
     * ```js {20}
     * const bucket = new Bucket(stack, "Bucket", {
     *   notifications: {
     *     myNotification: "src/function.handler",
     *   }
     * });
     *
     * bucket.attachPermissions("myNotification", ["s3"]);
     * ```
     */
    attachPermissionsToNotification(notificationName, permissions) {
        const notification = this.notifications[notificationName];
        if (!(notification instanceof Function_1.Function)) {
            throw new Error(`Cannot attach permissions to the "${this.node.id}" Bucket notification because it's not a Lambda function`);
        }
        notification.attachPermissions(permissions);
    }
    getConstructMetadata() {
        return {
            type: "Bucket",
            data: {
                name: this.cdk.bucket.bucketName,
                notifications: Object.values(this.notifications).map(Construct_1.getFunctionRef),
                notificationNames: Object.keys(this.notifications),
            },
        };
    }
    createBucket() {
        const { name, cors, cdk } = this.props;
        if ((0, Construct_1.isCDKConstruct)(cdk === null || cdk === void 0 ? void 0 : cdk.bucket)) {
            if (cors !== undefined) {
                throw new Error(`Cannot configure the "cors" when "cdk.bucket" is a construct`);
            }
            this.cdk.bucket = cdk === null || cdk === void 0 ? void 0 : cdk.bucket;
        }
        else {
            this.cdk.bucket = new s3.Bucket(this, "Bucket", Object.assign({ bucketName: name, cors: this.buildCorsConfig(cors) }, cdk === null || cdk === void 0 ? void 0 : cdk.bucket));
        }
    }
    addNotification(scope, notificationName, notification) {
        if (notification instanceof Queue_1.Queue ||
            notification.queue) {
            notification = notification;
            this.addQueueNotification(scope, notificationName, notification);
        }
        else if (notification instanceof Topic_1.Topic ||
            notification.topic) {
            notification = notification;
            this.addTopicNotification(scope, notificationName, notification);
        }
        else {
            notification = notification;
            this.addFunctionNotification(scope, notificationName, notification);
        }
    }
    addQueueNotification(scope, notificationName, notification) {
        // Parse notification props
        let notificationProps;
        let queue;
        if (notification instanceof Queue_1.Queue) {
            notification = notification;
            queue = notification;
        }
        else {
            notification = notification;
            notificationProps = {
                events: notification.events,
                filters: notification.filters,
            };
            queue = notification.queue;
        }
        this.notifications[notificationName] = queue;
        // Create Notifications
        const events = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.events) || [
            "object_created",
            "object_removed",
        ];
        const filters = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.filters) || [];
        events.forEach((event) => this.cdk.bucket.addEventNotification(s3.EventType[event.toUpperCase()], new s3Notifications.SqsDestination(queue.cdk.queue), ...filters));
    }
    addTopicNotification(scope, notificationName, notification) {
        // Parse notification props
        let notificationProps;
        let topic;
        if (notification instanceof Topic_1.Topic) {
            notification = notification;
            topic = notification;
        }
        else {
            notification = notification;
            notificationProps = {
                events: notification.events,
                filters: notification.filters,
            };
            topic = notification.topic;
        }
        this.notifications[notificationName] = topic;
        // Create Notifications
        const events = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.events) || [
            "object_created",
            "object_removed",
        ];
        const filters = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.filters) || [];
        events.forEach((event) => this.cdk.bucket.addEventNotification(s3.EventType[event.toUpperCase()], new s3Notifications.SnsDestination(topic.cdk.topic), ...filters));
    }
    addFunctionNotification(scope, notificationName, notification) {
        var _a;
        // parse notification
        let notificationFunction, notificationProps;
        if (notification.function) {
            notification = notification;
            notificationFunction = notification.function;
            notificationProps = {
                events: notification.events,
                filters: notification.filters,
            };
        }
        else {
            notificationFunction = notification;
        }
        // create function
        const fn = Function_1.Function.fromDefinition(scope, `Notification_${this.node.id}_${notificationName}`, notificationFunction, (_a = this.props.defaults) === null || _a === void 0 ? void 0 : _a.function, `The "defaults.function" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the consumers using FunctionProps, so the Table construct can apply the "defaults.function" to them.`);
        this.notifications[notificationName] = fn;
        // create Notifications
        const events = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.events) || [
            "object_created",
            "object_removed",
        ];
        const filters = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.filters) || [];
        events.forEach((event) => this.cdk.bucket.addEventNotification(s3.EventType[event.toUpperCase()], new s3Notifications.LambdaDestination(fn), ...filters));
        // attached permissions
        this.permissionsAttachedForAllNotifications.forEach((permissions) => fn.attachPermissions(permissions));
    }
    buildCorsConfig(cors) {
        if (cors === undefined || cors === false) {
            return;
        }
        if (cors === true) {
            return [
                {
                    allowedHeaders: ["*"],
                    allowedMethods: [
                        s3.HttpMethods.GET,
                        s3.HttpMethods.PUT,
                        s3.HttpMethods.HEAD,
                        s3.HttpMethods.POST,
                        s3.HttpMethods.DELETE,
                    ],
                    allowedOrigins: ["*"],
                },
            ];
        }
        return cors.map((e) => ({
            allowedMethods: (e.allowedMethods || []).map((method) => s3.HttpMethods[method]),
            allowedOrigins: e.allowedOrigins,
            allowedHeaders: e.allowedHeaders,
            exposedHeaders: e.exposedHeaders,
            id: e.id,
            maxAge: e.maxAge && (0, duration_1.toCdkDuration)(e.maxAge).toSeconds(),
        }));
    }
}
exports.Bucket = Bucket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQnVja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0J1Y2tldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUF1QztBQUN2Qyx1REFBeUM7QUFDekMsa0ZBQW9FO0FBQ3BFLG1DQUFnQztBQUNoQyxtQ0FBZ0M7QUFDaEMsMkNBQTJFO0FBQzNFLHlDQUtvQjtBQUVwQiw4Q0FBMEQ7QUEyTzFELHFCQUFxQjtBQUNyQixZQUFZO0FBQ1oscUJBQXFCO0FBRXJCOzs7Ozs7Ozs7OztHQVdHO0FBQ0gsTUFBYSxNQUFPLFNBQVEsc0JBQVM7SUFXbkMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFtQjtRQUMzRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsR0FBRyxHQUFHLEVBQVMsQ0FBQztRQUNyQixJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsc0NBQXNDLEdBQUcsRUFBRSxDQUFDO1FBRWpELElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLENBQUEsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLGFBQWEsS0FBSSxFQUFFLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxJQUFXLFNBQVM7UUFDbEIsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUM7SUFDbkMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBVyxVQUFVO1FBQ25CLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDO0lBQ3BDLENBQUM7SUFFRDs7T0FFRztJQUNILElBQVcscUJBQXFCO1FBQzlC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YUFDRixDQUFDO1NBQ0g7UUFFRCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDdEIsY0FBYyxFQUFFLENBQUMsQ0FBQyxDQUFDLGNBQWMsSUFBSSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQzFDLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLE1BQXFDLENBQUMsQ0FDbEU7WUFDRCxjQUFjLEVBQUUsQ0FBQyxDQUFDLGNBQWM7WUFDaEMsY0FBYyxFQUFFLENBQUMsQ0FBQyxjQUFjO1lBQ2hDLGNBQWMsRUFBRSxDQUFDLENBQUMsY0FBYztZQUNoQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUU7WUFDUixNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sSUFBSSxJQUFBLHdCQUFhLEVBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFNBQVMsRUFBRTtTQUN4RCxDQUFDLENBQUMsQ0FBQztJQUNOLENBQUM7Q0FDRjtBQS9VRCx3QkErVUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgczMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zM1wiO1xuaW1wb3J0ICogYXMgczNOb3RpZmljYXRpb25zIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtczMtbm90aWZpY2F0aW9uc1wiO1xuaW1wb3J0IHsgUXVldWUgfSBmcm9tIFwiLi9RdWV1ZVwiO1xuaW1wb3J0IHsgVG9waWMgfSBmcm9tIFwiLi9Ub3BpY1wiO1xuaW1wb3J0IHsgZ2V0RnVuY3Rpb25SZWYsIFNTVENvbnN0cnVjdCwgaXNDREtDb25zdHJ1Y3QgfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7XG4gIEZ1bmN0aW9uIGFzIEZuLFxuICBGdW5jdGlvblByb3BzLFxuICBGdW5jdGlvbklubGluZURlZmluaXRpb24sXG4gIEZ1bmN0aW9uRGVmaW5pdGlvbixcbn0gZnJvbSBcIi4vRnVuY3Rpb25cIjtcbmltcG9ydCB7IFBlcm1pc3Npb25zIH0gZnJvbSBcIi4vdXRpbC9wZXJtaXNzaW9uXCI7XG5pbXBvcnQgeyBEdXJhdGlvbiwgdG9DZGtEdXJhdGlvbiB9IGZyb20gXCIuL3V0aWwvZHVyYXRpb25cIjtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBCdWNrZXRDb3JzUnVsZSB7XG4gIC8qKlxuICAgKiBUaGUgY29sbGVjdGlvbiBvZiBhbGxvd2VkIEhUVFAgbWV0aG9kcy5cbiAgICovXG4gIGFsbG93ZWRNZXRob2RzOiAoa2V5b2YgdHlwZW9mIHMzLkh0dHBNZXRob2RzKVtdO1xuICAvKipcbiAgICogVGhlIGNvbGxlY3Rpb24gb2YgYWxsb3dlZCBvcmlnaW5zLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqc1xuICAgKiAvLyBBbGxvdyBhbGwgb3JpZ2luc1xuICAgKiBhbGxvd09yaWdpbnM6IFtcIipcIl1cbiAgICpcbiAgICogLy8gQWxsb3cgc3BlY2lmaWMgb3JpZ2lucy4gTm90ZSB0aGF0IHRoZSB1cmwgcHJvdG9jb2wsIGllLiBcImh0dHBzOi8vXCIsIGlzIHJlcXVpcmVkLlxuICAgKiBhbGxvd09yaWdpbnM6IFtcImh0dHBzOi8vZG9tYWluLmNvbVwiXVxuICAgKiBgYGBcbiAgICovXG4gIGFsbG93ZWRPcmlnaW5zOiBzdHJpbmdbXTtcbiAgLyoqXG4gICAqIFRoZSBjb2xsZWN0aW9uIG9mIGFsbG93ZWQgaGVhZGVycy5cbiAgICovXG4gIGFsbG93ZWRIZWFkZXJzPzogc3RyaW5nW107XG4gIC8qKlxuICAgKiBUaGUgY29sbGVjdGlvbiBvZiBleHBvc2VkIGhlYWRlcnMuXG4gICAqL1xuICBleHBvc2VkSGVhZGVycz86IHN0cmluZ1tdO1xuICAvKipcbiAgICogQSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhpcyBydWxlLlxuICAgKi9cbiAgaWQ/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBTcGVjaWZ5IGhvdyBsb25nIHRoZSByZXN1bHRzIG9mIGEgcHJlZmxpZ2h0IHJlc3BvbnNlIGNhbiBiZSBjYWNoZWRcbiAgICovXG4gIG1heEFnZT86IER1cmF0aW9uO1xufVxuXG5pbnRlcmZhY2UgQnVja2V0QmFzZU5vdGlmaWNhdGlvblByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBTMyBldmVudCB0eXBlcyB0aGF0IHdpbGwgdHJpZ2dlciB0aGUgbm90aWZpY2F0aW9uLlxuICAgKi9cbiAgZXZlbnRzPzogTG93ZXJjYXNlPGtleW9mIHR5cGVvZiBzMy5FdmVudFR5cGU+W107XG4gIC8qKlxuICAgKiBTMyBvYmplY3Qga2V5IGZpbHRlciBydWxlcyB0byBkZXRlcm1pbmUgd2hpY2ggb2JqZWN0cyB0cmlnZ2VyIHRoaXMgZXZlbnQuXG4gICAqL1xuICBmaWx0ZXJzPzogQnVja2V0RmlsdGVyW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQnVja2V0RmlsdGVyIHtcbiAgLyoqXG4gICAqIEZpbHRlciB3aGF0IHRoZSBrZXkgc3RhcnRzIHdpdGhcbiAgICovXG4gIHByZWZpeD86IHN0cmluZztcbiAgLyoqXG4gICAqIEZpbHRlciB3aGF0IHRoZSBrZXkgZW5kcyB3aXRoXG4gICAqL1xuICBzdWZmaXg/OiBzdHJpbmc7XG59XG5cbi8qKlxuICogVXNlZCB0byBkZWZpbmUgYSBmdW5jdGlvbiBsaXN0ZW5lciBmb3IgdGhlIGJ1Y2tldFxuICpcbiAqIEBleGFtcGxlXG4gKiBgYGBqc1xuICogbmV3IEJ1Y2tldChzdGFjaywgXCJCdWNrZXRcIiwge1xuICogICBub3RpZmljYXRpb25zOiB7XG4gKiAgICAgbXlOb3RpZmljYXRpb246IHtcbiAqICAgICAgIGZ1bmN0aW9uOiBcInNyYy9ub3RpZmljYXRpb24ubWFpblwiXG4gKiAgICAgfVxuICogICB9XG4gKiB9XG4gKiBgYGBcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBCdWNrZXRGdW5jdGlvbk5vdGlmaWNhdGlvblByb3BzXG4gIGV4dGVuZHMgQnVja2V0QmFzZU5vdGlmaWNhdGlvblByb3BzIHtcbiAgLyoqXG4gICAqIFN0cmluZyBsaXRlcmFsIHRvIHNpZ25pZnkgdGhhdCB0aGUgbm90aWZpY2F0aW9uIGlzIGEgZnVuY3Rpb25cbiAgICovXG4gIHR5cGU/OiBcImZ1bmN0aW9uXCI7XG4gIC8qKlxuICAgKiBUaGUgZnVuY3Rpb24gdG8gc2VuZCBub3RpZmljYXRpb25zIHRvXG4gICAqL1xuICBmdW5jdGlvbjogRnVuY3Rpb25EZWZpbml0aW9uO1xufVxuXG4vKipcbiAqIFVzZWQgdG8gZGVmaW5lIGEgcXVldWUgbGlzdGVuZXIgZm9yIHRoZSBidWNrZXRcbiAqXG4gKiBAZXhhbXBsZVxuICogYGBganNcbiAqIG5ldyBCdWNrZXQoc3RhY2ssIFwiQnVja2V0XCIsIHtcbiAqICAgbm90aWZpY2F0aW9uczoge1xuICogICAgIG15Tm90aWZpY2F0aW9uOiB7XG4gKiAgICAgICB0eXBlOiBcInF1ZXVlXCIsXG4gKiAgICAgICBxdWV1ZTogbmV3IFF1ZXVlKHN0YWNrLCBcIlF1ZXVlXCIpXG4gKiAgICAgfVxuICogICB9XG4gKiB9XG4gKiBgYGBcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBCdWNrZXRRdWV1ZU5vdGlmaWNhdGlvblByb3BzXG4gIGV4dGVuZHMgQnVja2V0QmFzZU5vdGlmaWNhdGlvblByb3BzIHtcbiAgLyoqXG4gICAqIFN0cmluZyBsaXRlcmFsIHRvIHNpZ25pZnkgdGhhdCB0aGUgbm90aWZpY2F0aW9uIGlzIGEgcXVldWVcbiAgICovXG4gIHR5cGU6IFwicXVldWVcIjtcbiAgLyoqXG4gICAqIFRoZSBxdWV1ZSB0byBzZW5kIG5vdGlmaWNhdGlvbnMgdG9cbiAgICovXG4gIHF1ZXVlOiBRdWV1ZTtcbn1cblxuLyoqXG4gKiBVc2VkIHRvIGRlZmluZSBhIHRvcGljIGxpc3RlbmVyIGZvciB0aGUgYnVja2V0XG4gKlxuICogQGV4YW1wbGVcbiAqIGBgYGpzXG4gKiBuZXcgQnVja2V0KHN0YWNrLCBcIkJ1Y2tldFwiLCB7XG4gKiAgIG5vdGlmaWNhdGlvbnM6IHtcbiAqICAgICBteU5vdGlmaWNhdGlvbjoge1xuICogICAgICAgdHlwZTogXCJ0b3BpY1wiLFxuICogICAgICAgdG9waWM6IG5ldyBUb3BpYyhzdGFjaywgXCJUb3BpY1wiKVxuICogICAgIH1cbiAqICAgfV0sXG4gKiB9XG4gKiBgYGBcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBCdWNrZXRUb3BpY05vdGlmaWNhdGlvblByb3BzXG4gIGV4dGVuZHMgQnVja2V0QmFzZU5vdGlmaWNhdGlvblByb3BzIHtcbiAgdHlwZTogXCJ0b3BpY1wiO1xuICAvKipcbiAgICogVGhlIHRvcGljIHRvIHNlbmQgbm90aWZpY2F0aW9ucyB0b1xuICAgKi9cbiAgdG9waWM6IFRvcGljO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEJ1Y2tldFByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSBidWNrZXQuXG4gICAqXG4gICAqIE5vdGUgdGhhdCBpdCdzIG5vdCByZWNvbW1lbmRlZCB0byBoYXJkIGNvZGUgYSBuYW1lIGZvciB0aGUgYnVja2V0LCBiZWNhdXNlIHRoZXkgbXVzdCBiZSBnbG9iYWxseSB1bmlxdWUuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIG5ldyBCdWNrZXQoc3RhY2ssIFwiQnVja2V0XCIsIHtcbiAgICogICBuYW1lOiBcIm15LWJ1Y2tldFwiLFxuICAgKiB9KTtcbiAgICogYGBgXG4gICAqL1xuICBuYW1lPzogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIENPUlMgY29uZmlndXJhdGlvbiBvZiB0aGlzIGJ1Y2tldC5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogYGBganNcbiAgICogbmV3IEJ1Y2tldChzdGFjaywgXCJCdWNrZXRcIiwge1xuICAgKiAgIGNvcnM6IHRydWUsXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICpcbiAgICogYGBganNcbiAgICogbmV3IEJ1Y2tldChzdGFjaywgXCJCdWNrZXRcIiwge1xuICAgKiAgIGNvcnM6IFtcbiAgICogICAgIHtcbiAgICogICAgICAgYWxsb3dlZE1ldGhvZHM6IFtcIkdFVFwiXSxcbiAgICogICAgICAgYWxsb3dlZE9yaWdpbnM6IFtcImh0dHBzOi8vd3d3LmV4YW1wbGUuY29tXCJdLFxuICAgKiAgICAgfVxuICAgKiAgIF0sXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIGNvcnM/OiBib29sZWFuIHwgQnVja2V0Q29yc1J1bGVbXTtcbiAgLyoqXG4gICAqIFRoZSBkZWZhdWx0IGZ1bmN0aW9uIHByb3BzIHRvIGJlIGFwcGxpZWQgdG8gYWxsIHRoZSBMYW1iZGEgZnVuY3Rpb25zIGluIHRoZSBBUEkuIFRoZSBgZW52aXJvbm1lbnRgLCBgcGVybWlzc2lvbnNgIGFuZCBgbGF5ZXJzYCBwcm9wZXJ0aWVzIHdpbGwgYmUgbWVyZ2VkIHdpdGggcGVyIHJvdXRlIGRlZmluaXRpb25zIGlmIHRoZXkgYXJlIGRlZmluZWQuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIG5ldyBCdWNrZXQoc3RhY2ssIFwiQnVja2V0XCIsIHtcbiAgICogICBkZWZhdWx0czoge1xuICAgKiAgICAgZnVuY3Rpb246IHtcbiAgICogICAgICAgdGltZW91dDogMjAsXG4gICAqICAgICB9XG4gICAqICAgfSxcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgZGVmYXVsdHM/OiB7XG4gICAgZnVuY3Rpb24/OiBGdW5jdGlvblByb3BzO1xuICB9O1xuICAvKipcbiAgICogVXNlZCB0byBjcmVhdGUgbm90aWZpY2F0aW9ucyBmb3IgdmFyaW91cyBidWNrZXQgZXZlbnRzXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYGpzXG4gICAqIG5ldyBCdWNrZXQoc3RhY2ssIFwiQnVja2V0XCIsIHtcbiAgICogICBub3RpZmljYXRpb25zOiB7XG4gICAqICAgICBteU5vdGlmaWNhdGlvbjogXCJzcmMvbm90aWZpY2F0aW9uLm1haW5cIixcbiAgICogICB9XG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIG5vdGlmaWNhdGlvbnM/OiBSZWNvcmQ8XG4gICAgc3RyaW5nLFxuICAgIHwgRnVuY3Rpb25JbmxpbmVEZWZpbml0aW9uXG4gICAgfCBCdWNrZXRGdW5jdGlvbk5vdGlmaWNhdGlvblByb3BzXG4gICAgfCBRdWV1ZVxuICAgIHwgQnVja2V0UXVldWVOb3RpZmljYXRpb25Qcm9wc1xuICAgIHwgVG9waWNcbiAgICB8IEJ1Y2tldFRvcGljTm90aWZpY2F0aW9uUHJvcHNcbiAgPjtcbiAgY2RrPzoge1xuICAgIC8qKlxuICAgICAqIEFsbG93cyB5b3UgdG8gb3ZlcnJpZGUgZGVmYXVsdCBzZXR0aW5ncyB0aGlzIGNvbnN0cnVjdCB1c2VzIGludGVybmFsbHkgdG8gY2VhdGUgdGhlIGJ1Y2tldFxuICAgICAqXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBgYGBqc1xuICAgICAqIG5ldyBCdWNrZXQoc3RhY2ssIFwiQnVja2V0XCIsIHtcbiAgICAgKiAgIGNkazoge1xuICAgICAqICAgICBidWNrZXQ6IHtcbiAgICAgKiAgICAgICBidWNrZXROYW1lOiBcIm15LWJ1Y2tldFwiLFxuICAgICAqICAgICB9LFxuICAgICAqICAgfVxuICAgICAqIH0pO1xuICAgICAqIGBgYFxuICAgICAqL1xuICAgIGJ1Y2tldD86IHMzLkJ1Y2tldCB8IHMzLkJ1Y2tldFByb3BzO1xuICB9O1xufVxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIENvbnN0cnVjdFxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbi8qKlxuICogVGhlIGBCdWNrZXRgIGNvbnN0cnVjdCBpcyBhIGhpZ2hlciBsZXZlbCBDREsgY29uc3RydWN0IHRoYXQgbWFrZXMgaXQgZWFzeSB0byBjcmVhdGUgYW4gUzMgQnVja2V0IGFuZCB0byBkZWZpbmUgaXRzIG5vdGlmaWNhdGlvbnMuIEl0IGFsc28gaW50ZXJuYWxseSBjb25uZWN0cyB0aGUgbm90aWZpY2F0aW9ucyBhbmQgYnVja2V0IHRvZ2V0aGVyLlxuICpcbiAqIEBleGFtcGxlXG4gKiAjIyMgVXNpbmcgdGhlIG1pbmltYWwgY29uZmlnXG4gKlxuICogYGBganNcbiAqIGltcG9ydCB7IEJ1Y2tldCB9IGZyb20gXCJAc2VydmVybGVzcy1zdGFjay9yZXNvdXJjZXNcIjtcbiAqXG4gKiBuZXcgQnVja2V0KHN0YWNrLCBcIkJ1Y2tldFwiKTtcbiAqIGBgYFxuICovXG5leHBvcnQgY2xhc3MgQnVja2V0IGV4dGVuZHMgQ29uc3RydWN0IGltcGxlbWVudHMgU1NUQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IGNkazoge1xuICAgIC8qKlxuICAgICAqIFRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgQ0RLIGBCdWNrZXRgIGluc3RhbmNlLlxuICAgICAqL1xuICAgIGJ1Y2tldDogczMuQnVja2V0O1xuICB9O1xuICByZWFkb25seSBub3RpZmljYXRpb25zOiBSZWNvcmQ8c3RyaW5nLCBGbiB8IFF1ZXVlIHwgVG9waWM+O1xuICByZWFkb25seSBwZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsTm90aWZpY2F0aW9uczogUGVybWlzc2lvbnNbXTtcbiAgcmVhZG9ubHkgcHJvcHM6IEJ1Y2tldFByb3BzO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogQnVja2V0UHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgdGhpcy5wcm9wcyA9IHByb3BzIHx8IHt9O1xuICAgIHRoaXMuY2RrID0ge30gYXMgYW55O1xuICAgIHRoaXMubm90aWZpY2F0aW9ucyA9IHt9O1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbE5vdGlmaWNhdGlvbnMgPSBbXTtcblxuICAgIHRoaXMuY3JlYXRlQnVja2V0KCk7XG4gICAgdGhpcy5hZGROb3RpZmljYXRpb25zKHRoaXMsIHByb3BzPy5ub3RpZmljYXRpb25zIHx8IHt9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgQVJOIG9mIHRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgYEJ1Y2tldGAgaW5zdGFuY2UuXG4gICAqL1xuICBwdWJsaWMgZ2V0IGJ1Y2tldEFybigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmNkay5idWNrZXQuYnVja2V0QXJuO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgYEJ1Y2tldGAgaW5zdGFuY2UuXG4gICAqL1xuICBwdWJsaWMgZ2V0IGJ1Y2tldE5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jZGsuYnVja2V0LmJ1Y2tldE5hbWU7XG4gIH1cblxuICAvKipcbiAgICogQSBsaXN0IG9mIHRoZSBpbnRlcm5hbGx5IGNyZWF0ZWQgZnVuY3Rpb25zIGZvciB0aGUgbm90aWZpY2F0aW9ucy5cbiAgICovXG4gIHB1YmxpYyBnZXQgbm90aWZpY2F0aW9uRnVuY3Rpb25zKCk6IEZuW10ge1xuICAgIHJldHVybiBPYmplY3QudmFsdWVzKHRoaXMubm90aWZpY2F0aW9ucykuZmlsdGVyKFxuICAgICAgKG5vdGlmaWNhdGlvbikgPT4gbm90aWZpY2F0aW9uIGluc3RhbmNlb2YgRm5cbiAgICApIGFzIEZuW107XG4gIH1cblxuICAvKipcbiAgICogQWRkIG5vdGlmaWNhdGlvbiBzdWJzY3JpcHRpb25zIGFmdGVyIHRoZSBidWNrZXQgaGFzIGJlZW4gY3JlYXRlZFxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqcyB7M31cbiAgICogY29uc3QgYnVja2V0ID0gbmV3IEJ1Y2tldChzdGFjaywgXCJCdWNrZXRcIik7XG4gICAqIGJ1Y2tldC5hZGROb3RpZmljYXRpb25zKHN0YWNrLCBbXCJzcmMvbm90aWZpY2F0aW9uLm1haW5cIl0pO1xuICAgKiBgYGBcbiAgICovXG4gIHB1YmxpYyBhZGROb3RpZmljYXRpb25zKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgbm90aWZpY2F0aW9uczogUmVjb3JkPFxuICAgICAgc3RyaW5nLFxuICAgICAgfCBGdW5jdGlvbklubGluZURlZmluaXRpb25cbiAgICAgIHwgQnVja2V0RnVuY3Rpb25Ob3RpZmljYXRpb25Qcm9wc1xuICAgICAgfCBRdWV1ZVxuICAgICAgfCBCdWNrZXRRdWV1ZU5vdGlmaWNhdGlvblByb3BzXG4gICAgICB8IFRvcGljXG4gICAgICB8IEJ1Y2tldFRvcGljTm90aWZpY2F0aW9uUHJvcHNcbiAgICA+XG4gICk6IHZvaWQge1xuICAgIE9iamVjdC5lbnRyaWVzKG5vdGlmaWNhdGlvbnMpLmZvckVhY2goXG4gICAgICAoW25vdGlmaWNhdGlvbk5hbWUsIG5vdGlmaWNhdGlvbl0pID0+IHtcbiAgICAgICAgdGhpcy5hZGROb3RpZmljYXRpb24oc2NvcGUsIG5vdGlmaWNhdGlvbk5hbWUsIG5vdGlmaWNhdGlvbik7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBdHRhY2hlcyBhZGRpdGlvbmFsIHBlcm1pc3Npb25zIHRvIGFsbCBidWNrZXQgbm90aWZpY2F0aW9uc1xuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqcyB7MjB9XG4gICAqIGNvbnN0IGJ1Y2tldCA9IG5ldyBCdWNrZXQoc3RhY2ssIFwiQnVja2V0XCIsIHtcbiAgICogICBub3RpZmljYXRpb25zOiB7XG4gICAqICAgICBteU5vdGlmaWNhdGlvbjogXCJzcmMvZnVuY3Rpb24uaGFuZGxlclwiLFxuICAgKiAgIH1cbiAgICogfSk7XG4gICAqXG4gICAqIGJ1Y2tldC5hdHRhY2hQZXJtaXNzaW9ucyhbXCJzM1wiXSk7XG4gICAqIGBgYFxuICAgKi9cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIHRoaXMubm90aWZpY2F0aW9uRnVuY3Rpb25zLmZvckVhY2goKG5vdGlmaWNhdGlvbikgPT5cbiAgICAgIG5vdGlmaWNhdGlvbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucylcbiAgICApO1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbE5vdGlmaWNhdGlvbnMucHVzaChwZXJtaXNzaW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogQXR0YWNoZXMgYWRkaXRpb25hbCBwZXJtaXNzaW9ucyB0byBhIHNwZWNpZmljIGJ1Y2tldCBub3RpZmljYXRpb25cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBganMgezIwfVxuICAgKiBjb25zdCBidWNrZXQgPSBuZXcgQnVja2V0KHN0YWNrLCBcIkJ1Y2tldFwiLCB7XG4gICAqICAgbm90aWZpY2F0aW9uczoge1xuICAgKiAgICAgbXlOb3RpZmljYXRpb246IFwic3JjL2Z1bmN0aW9uLmhhbmRsZXJcIixcbiAgICogICB9XG4gICAqIH0pO1xuICAgKlxuICAgKiBidWNrZXQuYXR0YWNoUGVybWlzc2lvbnMoXCJteU5vdGlmaWNhdGlvblwiLCBbXCJzM1wiXSk7XG4gICAqIGBgYFxuICAgKi9cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zVG9Ob3RpZmljYXRpb24oXG4gICAgbm90aWZpY2F0aW9uTmFtZTogc3RyaW5nLFxuICAgIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uc1xuICApOiB2b2lkIHtcbiAgICBjb25zdCBub3RpZmljYXRpb24gPSB0aGlzLm5vdGlmaWNhdGlvbnNbbm90aWZpY2F0aW9uTmFtZV07XG4gICAgaWYgKCEobm90aWZpY2F0aW9uIGluc3RhbmNlb2YgRm4pKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDYW5ub3QgYXR0YWNoIHBlcm1pc3Npb25zIHRvIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIEJ1Y2tldCBub3RpZmljYXRpb24gYmVjYXVzZSBpdCdzIG5vdCBhIExhbWJkYSBmdW5jdGlvbmBcbiAgICAgICk7XG4gICAgfVxuICAgIG5vdGlmaWNhdGlvbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q29uc3RydWN0TWV0YWRhdGEoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwiQnVja2V0XCIgYXMgY29uc3QsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIG5hbWU6IHRoaXMuY2RrLmJ1Y2tldC5idWNrZXROYW1lLFxuICAgICAgICBub3RpZmljYXRpb25zOiBPYmplY3QudmFsdWVzKHRoaXMubm90aWZpY2F0aW9ucykubWFwKGdldEZ1bmN0aW9uUmVmKSxcbiAgICAgICAgbm90aWZpY2F0aW9uTmFtZXM6IE9iamVjdC5rZXlzKHRoaXMubm90aWZpY2F0aW9ucyksXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUJ1Y2tldCgpIHtcbiAgICBjb25zdCB7IG5hbWUsIGNvcnMsIGNkayB9ID0gdGhpcy5wcm9wcztcblxuICAgIGlmIChpc0NES0NvbnN0cnVjdChjZGs/LmJ1Y2tldCkpIHtcbiAgICAgIGlmIChjb3JzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImNvcnNcIiB3aGVuIFwiY2RrLmJ1Y2tldFwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgdGhpcy5jZGsuYnVja2V0ID0gY2RrPy5idWNrZXQgYXMgczMuQnVja2V0O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNkay5idWNrZXQgPSBuZXcgczMuQnVja2V0KHRoaXMsIFwiQnVja2V0XCIsIHtcbiAgICAgICAgYnVja2V0TmFtZTogbmFtZSxcbiAgICAgICAgY29yczogdGhpcy5idWlsZENvcnNDb25maWcoY29ycyksXG4gICAgICAgIC4uLmNkaz8uYnVja2V0LFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGROb3RpZmljYXRpb24oXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBub3RpZmljYXRpb25OYW1lOiBzdHJpbmcsXG4gICAgbm90aWZpY2F0aW9uOlxuICAgICAgfCBGdW5jdGlvbklubGluZURlZmluaXRpb25cbiAgICAgIHwgQnVja2V0RnVuY3Rpb25Ob3RpZmljYXRpb25Qcm9wc1xuICAgICAgfCBRdWV1ZVxuICAgICAgfCBCdWNrZXRRdWV1ZU5vdGlmaWNhdGlvblByb3BzXG4gICAgICB8IFRvcGljXG4gICAgICB8IEJ1Y2tldFRvcGljTm90aWZpY2F0aW9uUHJvcHNcbiAgKTogdm9pZCB7XG4gICAgaWYgKFxuICAgICAgbm90aWZpY2F0aW9uIGluc3RhbmNlb2YgUXVldWUgfHxcbiAgICAgIChub3RpZmljYXRpb24gYXMgQnVja2V0UXVldWVOb3RpZmljYXRpb25Qcm9wcykucXVldWVcbiAgICApIHtcbiAgICAgIG5vdGlmaWNhdGlvbiA9IG5vdGlmaWNhdGlvbiBhcyBRdWV1ZSB8IEJ1Y2tldFF1ZXVlTm90aWZpY2F0aW9uUHJvcHM7XG4gICAgICB0aGlzLmFkZFF1ZXVlTm90aWZpY2F0aW9uKHNjb3BlLCBub3RpZmljYXRpb25OYW1lLCBub3RpZmljYXRpb24pO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICBub3RpZmljYXRpb24gaW5zdGFuY2VvZiBUb3BpYyB8fFxuICAgICAgKG5vdGlmaWNhdGlvbiBhcyBCdWNrZXRUb3BpY05vdGlmaWNhdGlvblByb3BzKS50b3BpY1xuICAgICkge1xuICAgICAgbm90aWZpY2F0aW9uID0gbm90aWZpY2F0aW9uIGFzIFRvcGljIHwgQnVja2V0VG9waWNOb3RpZmljYXRpb25Qcm9wcztcbiAgICAgIHRoaXMuYWRkVG9waWNOb3RpZmljYXRpb24oc2NvcGUsIG5vdGlmaWNhdGlvbk5hbWUsIG5vdGlmaWNhdGlvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5vdGlmaWNhdGlvbiA9IG5vdGlmaWNhdGlvbiBhc1xuICAgICAgICB8IEZ1bmN0aW9uSW5saW5lRGVmaW5pdGlvblxuICAgICAgICB8IEJ1Y2tldEZ1bmN0aW9uTm90aWZpY2F0aW9uUHJvcHM7XG4gICAgICB0aGlzLmFkZEZ1bmN0aW9uTm90aWZpY2F0aW9uKHNjb3BlLCBub3RpZmljYXRpb25OYW1lLCBub3RpZmljYXRpb24pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkUXVldWVOb3RpZmljYXRpb24oXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBub3RpZmljYXRpb25OYW1lOiBzdHJpbmcsXG4gICAgbm90aWZpY2F0aW9uOiBRdWV1ZSB8IEJ1Y2tldFF1ZXVlTm90aWZpY2F0aW9uUHJvcHNcbiAgKTogdm9pZCB7XG4gICAgLy8gUGFyc2Ugbm90aWZpY2F0aW9uIHByb3BzXG4gICAgbGV0IG5vdGlmaWNhdGlvblByb3BzO1xuICAgIGxldCBxdWV1ZTogUXVldWU7XG4gICAgaWYgKG5vdGlmaWNhdGlvbiBpbnN0YW5jZW9mIFF1ZXVlKSB7XG4gICAgICBub3RpZmljYXRpb24gPSBub3RpZmljYXRpb24gYXMgUXVldWU7XG4gICAgICBxdWV1ZSA9IG5vdGlmaWNhdGlvbjtcbiAgICB9IGVsc2Uge1xuICAgICAgbm90aWZpY2F0aW9uID0gbm90aWZpY2F0aW9uIGFzIEJ1Y2tldFF1ZXVlTm90aWZpY2F0aW9uUHJvcHM7XG4gICAgICBub3RpZmljYXRpb25Qcm9wcyA9IHtcbiAgICAgICAgZXZlbnRzOiBub3RpZmljYXRpb24uZXZlbnRzLFxuICAgICAgICBmaWx0ZXJzOiBub3RpZmljYXRpb24uZmlsdGVycyxcbiAgICAgIH07XG4gICAgICBxdWV1ZSA9IG5vdGlmaWNhdGlvbi5xdWV1ZTtcbiAgICB9XG4gICAgdGhpcy5ub3RpZmljYXRpb25zW25vdGlmaWNhdGlvbk5hbWVdID0gcXVldWU7XG5cbiAgICAvLyBDcmVhdGUgTm90aWZpY2F0aW9uc1xuICAgIGNvbnN0IGV2ZW50cyA9IG5vdGlmaWNhdGlvblByb3BzPy5ldmVudHMgfHwgW1xuICAgICAgXCJvYmplY3RfY3JlYXRlZFwiLFxuICAgICAgXCJvYmplY3RfcmVtb3ZlZFwiLFxuICAgIF07XG4gICAgY29uc3QgZmlsdGVycyA9IG5vdGlmaWNhdGlvblByb3BzPy5maWx0ZXJzIHx8IFtdO1xuICAgIGV2ZW50cy5mb3JFYWNoKChldmVudCkgPT5cbiAgICAgIHRoaXMuY2RrLmJ1Y2tldC5hZGRFdmVudE5vdGlmaWNhdGlvbihcbiAgICAgICAgczMuRXZlbnRUeXBlW2V2ZW50LnRvVXBwZXJDYXNlKCkgYXMga2V5b2YgdHlwZW9mIHMzLkV2ZW50VHlwZV0sXG4gICAgICAgIG5ldyBzM05vdGlmaWNhdGlvbnMuU3FzRGVzdGluYXRpb24ocXVldWUuY2RrLnF1ZXVlKSxcbiAgICAgICAgLi4uZmlsdGVyc1xuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGFkZFRvcGljTm90aWZpY2F0aW9uKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgbm90aWZpY2F0aW9uTmFtZTogc3RyaW5nLFxuICAgIG5vdGlmaWNhdGlvbjogVG9waWMgfCBCdWNrZXRUb3BpY05vdGlmaWNhdGlvblByb3BzXG4gICk6IHZvaWQge1xuICAgIC8vIFBhcnNlIG5vdGlmaWNhdGlvbiBwcm9wc1xuICAgIGxldCBub3RpZmljYXRpb25Qcm9wcztcbiAgICBsZXQgdG9waWM6IFRvcGljO1xuICAgIGlmIChub3RpZmljYXRpb24gaW5zdGFuY2VvZiBUb3BpYykge1xuICAgICAgbm90aWZpY2F0aW9uID0gbm90aWZpY2F0aW9uIGFzIFRvcGljO1xuICAgICAgdG9waWMgPSBub3RpZmljYXRpb247XG4gICAgfSBlbHNlIHtcbiAgICAgIG5vdGlmaWNhdGlvbiA9IG5vdGlmaWNhdGlvbiBhcyBCdWNrZXRUb3BpY05vdGlmaWNhdGlvblByb3BzO1xuICAgICAgbm90aWZpY2F0aW9uUHJvcHMgPSB7XG4gICAgICAgIGV2ZW50czogbm90aWZpY2F0aW9uLmV2ZW50cyxcbiAgICAgICAgZmlsdGVyczogbm90aWZpY2F0aW9uLmZpbHRlcnMsXG4gICAgICB9O1xuICAgICAgdG9waWMgPSBub3RpZmljYXRpb24udG9waWM7XG4gICAgfVxuICAgIHRoaXMubm90aWZpY2F0aW9uc1tub3RpZmljYXRpb25OYW1lXSA9IHRvcGljO1xuXG4gICAgLy8gQ3JlYXRlIE5vdGlmaWNhdGlvbnNcbiAgICBjb25zdCBldmVudHMgPSBub3RpZmljYXRpb25Qcm9wcz8uZXZlbnRzIHx8IFtcbiAgICAgIFwib2JqZWN0X2NyZWF0ZWRcIixcbiAgICAgIFwib2JqZWN0X3JlbW92ZWRcIixcbiAgICBdO1xuICAgIGNvbnN0IGZpbHRlcnMgPSBub3RpZmljYXRpb25Qcm9wcz8uZmlsdGVycyB8fCBbXTtcbiAgICBldmVudHMuZm9yRWFjaCgoZXZlbnQpID0+XG4gICAgICB0aGlzLmNkay5idWNrZXQuYWRkRXZlbnROb3RpZmljYXRpb24oXG4gICAgICAgIHMzLkV2ZW50VHlwZVtldmVudC50b1VwcGVyQ2FzZSgpIGFzIGtleW9mIHR5cGVvZiBzMy5FdmVudFR5cGVdLFxuICAgICAgICBuZXcgczNOb3RpZmljYXRpb25zLlNuc0Rlc3RpbmF0aW9uKHRvcGljLmNkay50b3BpYyksXG4gICAgICAgIC4uLmZpbHRlcnNcbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRGdW5jdGlvbk5vdGlmaWNhdGlvbihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIG5vdGlmaWNhdGlvbk5hbWU6IHN0cmluZyxcbiAgICBub3RpZmljYXRpb246IEZ1bmN0aW9uSW5saW5lRGVmaW5pdGlvbiB8IEJ1Y2tldEZ1bmN0aW9uTm90aWZpY2F0aW9uUHJvcHNcbiAgKTogdm9pZCB7XG4gICAgLy8gcGFyc2Ugbm90aWZpY2F0aW9uXG4gICAgbGV0IG5vdGlmaWNhdGlvbkZ1bmN0aW9uLCBub3RpZmljYXRpb25Qcm9wcztcbiAgICBpZiAoKG5vdGlmaWNhdGlvbiBhcyBCdWNrZXRGdW5jdGlvbk5vdGlmaWNhdGlvblByb3BzKS5mdW5jdGlvbikge1xuICAgICAgbm90aWZpY2F0aW9uID0gbm90aWZpY2F0aW9uIGFzIEJ1Y2tldEZ1bmN0aW9uTm90aWZpY2F0aW9uUHJvcHM7XG4gICAgICBub3RpZmljYXRpb25GdW5jdGlvbiA9IG5vdGlmaWNhdGlvbi5mdW5jdGlvbjtcbiAgICAgIG5vdGlmaWNhdGlvblByb3BzID0ge1xuICAgICAgICBldmVudHM6IG5vdGlmaWNhdGlvbi5ldmVudHMsXG4gICAgICAgIGZpbHRlcnM6IG5vdGlmaWNhdGlvbi5maWx0ZXJzLFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgbm90aWZpY2F0aW9uRnVuY3Rpb24gPSBub3RpZmljYXRpb24gYXMgRnVuY3Rpb25JbmxpbmVEZWZpbml0aW9uO1xuICAgIH1cblxuICAgIC8vIGNyZWF0ZSBmdW5jdGlvblxuICAgIGNvbnN0IGZuID0gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICBzY29wZSxcbiAgICAgIGBOb3RpZmljYXRpb25fJHt0aGlzLm5vZGUuaWR9XyR7bm90aWZpY2F0aW9uTmFtZX1gLFxuICAgICAgbm90aWZpY2F0aW9uRnVuY3Rpb24sXG4gICAgICB0aGlzLnByb3BzLmRlZmF1bHRzPy5mdW5jdGlvbixcbiAgICAgIGBUaGUgXCJkZWZhdWx0cy5mdW5jdGlvblwiIGNhbm5vdCBiZSBhcHBsaWVkIGlmIGFuIGluc3RhbmNlIG9mIGEgRnVuY3Rpb24gY29uc3RydWN0IGlzIHBhc3NlZCBpbi4gTWFrZSBzdXJlIHRvIGRlZmluZSBhbGwgdGhlIGNvbnN1bWVycyB1c2luZyBGdW5jdGlvblByb3BzLCBzbyB0aGUgVGFibGUgY29uc3RydWN0IGNhbiBhcHBseSB0aGUgXCJkZWZhdWx0cy5mdW5jdGlvblwiIHRvIHRoZW0uYFxuICAgICk7XG4gICAgdGhpcy5ub3RpZmljYXRpb25zW25vdGlmaWNhdGlvbk5hbWVdID0gZm47XG5cbiAgICAvLyBjcmVhdGUgTm90aWZpY2F0aW9uc1xuICAgIGNvbnN0IGV2ZW50cyA9IG5vdGlmaWNhdGlvblByb3BzPy5ldmVudHMgfHwgW1xuICAgICAgXCJvYmplY3RfY3JlYXRlZFwiLFxuICAgICAgXCJvYmplY3RfcmVtb3ZlZFwiLFxuICAgIF07XG4gICAgY29uc3QgZmlsdGVycyA9IG5vdGlmaWNhdGlvblByb3BzPy5maWx0ZXJzIHx8IFtdO1xuICAgIGV2ZW50cy5mb3JFYWNoKChldmVudCkgPT5cbiAgICAgIHRoaXMuY2RrLmJ1Y2tldC5hZGRFdmVudE5vdGlmaWNhdGlvbihcbiAgICAgICAgczMuRXZlbnRUeXBlW2V2ZW50LnRvVXBwZXJDYXNlKCkgYXMga2V5b2YgdHlwZW9mIHMzLkV2ZW50VHlwZV0sXG4gICAgICAgIG5ldyBzM05vdGlmaWNhdGlvbnMuTGFtYmRhRGVzdGluYXRpb24oZm4pLFxuICAgICAgICAuLi5maWx0ZXJzXG4gICAgICApXG4gICAgKTtcblxuICAgIC8vIGF0dGFjaGVkIHBlcm1pc3Npb25zXG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsTm90aWZpY2F0aW9ucy5mb3JFYWNoKChwZXJtaXNzaW9ucykgPT5cbiAgICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkQ29yc0NvbmZpZyhcbiAgICBjb3JzPzogYm9vbGVhbiB8IEJ1Y2tldENvcnNSdWxlW11cbiAgKTogczMuQ29yc1J1bGVbXSB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKGNvcnMgPT09IHVuZGVmaW5lZCB8fCBjb3JzID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoY29ycyA9PT0gdHJ1ZSkge1xuICAgICAgcmV0dXJuIFtcbiAgICAgICAge1xuICAgICAgICAgIGFsbG93ZWRIZWFkZXJzOiBbXCIqXCJdLFxuICAgICAgICAgIGFsbG93ZWRNZXRob2RzOiBbXG4gICAgICAgICAgICBzMy5IdHRwTWV0aG9kcy5HRVQsXG4gICAgICAgICAgICBzMy5IdHRwTWV0aG9kcy5QVVQsXG4gICAgICAgICAgICBzMy5IdHRwTWV0aG9kcy5IRUFELFxuICAgICAgICAgICAgczMuSHR0cE1ldGhvZHMuUE9TVCxcbiAgICAgICAgICAgIHMzLkh0dHBNZXRob2RzLkRFTEVURSxcbiAgICAgICAgICBdLFxuICAgICAgICAgIGFsbG93ZWRPcmlnaW5zOiBbXCIqXCJdLFxuICAgICAgICB9LFxuICAgICAgXTtcbiAgICB9XG5cbiAgICByZXR1cm4gY29ycy5tYXAoKGUpID0+ICh7XG4gICAgICBhbGxvd2VkTWV0aG9kczogKGUuYWxsb3dlZE1ldGhvZHMgfHwgW10pLm1hcChcbiAgICAgICAgKG1ldGhvZCkgPT4gczMuSHR0cE1ldGhvZHNbbWV0aG9kIGFzIGtleW9mIHR5cGVvZiBzMy5IdHRwTWV0aG9kc11cbiAgICAgICksXG4gICAgICBhbGxvd2VkT3JpZ2luczogZS5hbGxvd2VkT3JpZ2lucyxcbiAgICAgIGFsbG93ZWRIZWFkZXJzOiBlLmFsbG93ZWRIZWFkZXJzLFxuICAgICAgZXhwb3NlZEhlYWRlcnM6IGUuZXhwb3NlZEhlYWRlcnMsXG4gICAgICBpZDogZS5pZCxcbiAgICAgIG1heEFnZTogZS5tYXhBZ2UgJiYgdG9DZGtEdXJhdGlvbihlLm1heEFnZSkudG9TZWNvbmRzKCksXG4gICAgfSkpO1xuICB9XG59XG4iXX0=